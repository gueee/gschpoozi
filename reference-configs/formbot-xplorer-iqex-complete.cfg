################################################################################
# FORMBOT XPLORER IQEX - COMPLETE SINGLE-FILE KLIPPER CONFIGURATION
################################################################################
#
# This is a comprehensive, standalone IQEX (Independent Quad Extruder) Klipper 
# configuration compiled from Formbot's official Xplorer config. All includes 
# have been expanded into this single file for reference purposes.
#
# SOURCE: https://github.com/FORMBOT/Xplorer_UpdateManager
# COMPILED: January 2026
# PRINTER: Formbot Xplorer IQEX (V1.1)
#
# HARDWARE CONFIGURATION:
# - Control Board: Dual gantry system (2 independent Y axes)
# - Kinematics: Generic Cartesian with IQEX
# - Build Volume: 420 x 420 x 500mm
# - Max Velocity: 500mm/s
# - FOUR Independent Toolheads (T0, T1, T2, T3)
# - Dual X Carriages per gantry (4 extruders total)
# - Heated Bed: 420x420mm
# - Z-Probe: Inductive probe on each toolhead
# - 3-point Z-tilt leveling
#
# KEY IQEX FEATURES:
# - 4 independent extruders with independent X/Y control
# - Tool change macros (T0/T1/T2/T3) with automatic parking
# - Dual gantry system (2 Y axes)
# - COPY and MIRROR modes for dual extrusion
# - QUAD mode for all 4 extruders
# - Independent offset calibration for T1, T2, T3
# - Smart filament sensors on all 4 toolheads
# - Power loss recovery (PLR) support
# - Bed mesh leveling (8x8)
# - Z-tilt compensation (3-point)
#
# IMPORTANT NOTES:
# - Update MCU serial paths to match your system
# - Calibrate XYZ offsets for T1, T2, T3 using calibration macros
# - Calibrate Z-offset for all 4 probes
# - Test tool changes at low speed initially
# - Verify all 4 carriages can move safely
#
# SAFETY:
# - Test homing and all carriage movements carefully
# - Ensure all 4 toolheads clear the bed and each other
# - Verify safe X/Y positions for all carriages
# - Check collision avoidance in all modes
#
################################################################################


################################################################################
### XPLORER VARIABLES
################################################################################

#####################################################################
#Variables Xplorer
#####################################################################

[gcode_macro _XPLORER_VARIABLES] 
variable_spd_1e:        350    # Speed max 1 Extruder config
variable_acc_1e:        15000  # Acceleration max 1 Extruder config
variable_sp_tch:        35000  # Speed tool change X
variable_sp_tchy:       13000  # Speed tool change Y
variable_x_cop_idex:    200    # X position copied Carriage IDEX
variable_x_mir_idex:    420    # X position mirrored Carriage IDEX
variable_x_cop_dg:    0   # X position copied Carriage 2xGantry
variable_x_mir_dg:    0    # X position mirrored Carriage 2xGantry
variable_y_cop_dg:    172    # Y position copied Carriage 2xGantry
variable_y_mir_dg:    57.5    # Y position mirrored Carriage 2xGantry
variable_y_off_dg:    57.5    # Y axis offset for the seond gantry
variable_fil_uld:      -60     # mm Fil unload display Macro
variable_fil_ld:        80     # mm Fil load display Macro
variable_tmp_ld:        235    # temp Fil load display Macro
variable_tmp_uld:       185    # temp Fil unload display Macro
variable_res_x:         210    # X coordinate input shaper calibration for the Tools
variable_res_y:         200    # Y coordinate input shaper calibration for the Tools
variable_res_z:         50    # Y coordinate input shaper calibration for the Tools
variable_res_xmicp:     110    # X coordinate input shaper calibration for the Copy/Mirror Mode Dual Tool
variable_res_ymicp2e:   210    # Y coordinate input shaper calibration for the Copy/Mirror Mode Dual Tool
variable_res_xmicpdg:     210    # X coordinate input shaper calibration for the Copy/Mirror Mode Dual Gantry
variable_res_y1micp4e:  280    # Y coordinate input shaper calibration for the Copy/Mirror IQEX Gantry 1
variable_res_y2micp4e:  350    # Y coordinate input shaper calibration for the Copy/Mirror IQEX Gantry 2
variable_sp_pmode:      8000   # Speed for printheads when changing printing modes
variable_calp_x:      177.5    # X pos nozzle Probe
variable_calp_y:        406    # Y pos nozzle Probe
variable_calp_z:         10    # Z pos nozzle Probe
variable_xrest0:        11     # X value for T0 when resting after Cancel Print or end print
variable_xrest1:        409     # X value for T1 when resting after Cancel Print or end print
variable_yrest1:        410     # Y value for Gantry1 when resting after Cancel Print or end print - 2xGantry
variable_yrest2:        0    # Y value for Gantry1 when resting after Cancel Print or end print - IQEX
variable_tmpout:        43200   # Time in seconds to turn off the printer after pause or M600
variable_s_mzx:          50    # X probepoint TILT_Z Motor Z Single
variable_s_mzy:          40    # X probepoint TILT_Z Motor Z Single
variable_s_mz1x:         210    # X probepoint TILT_Z Motor Z1 Single
variable_s_mz1y:         360    # X probepoint TILT_Z Motor Z1 Single
variable_s_mz2x:         370    # X probepoint TILT_Z Motor Z2 Single
variable_s_mz2y:         40    # X probepoint TILT_Z Motor Z2 Single
variable_idex_mzx:       80    # X probepoint TILT_Z Motor Z IDEX
variable_idex_mzy:       40    # X probepoint TILT_Z Motor Z IDEX
variable_idex_mz1x:     210    # X probepoint TILT_Z Motor Z1 IDEX
variable_idex_mz1y:     360    # X probepoint TILT_Z Motor Z1 IDEX
variable_idex_mz2x:     340    # X probepoint TILT_Z Motor Z2 IDEX
variable_idex_mz2y:      40    # X probepoint TILT_Z Motor Z2 IDEX
variable_dg_mzx:       80    # X probepoint TILT_Z Motor Z 2xGantry
variable_dg_mzy:       92    # X probepoint TILT_Z Motor Z 2xGantry
variable_dg_mz1x:     210    # X probepoint TILT_Z Motor Z1 2xGantry
variable_dg_mz1y:     360    # X probepoint TILT_Z Motor Z1 2xGantry
variable_dg_mz2x:     340    # X probepoint TILT_Z Motor Z2 2xGantry
variable_dg_mz2y:      92    # X probepoint TILT_Z Motor Z2 2xGantry
variable_tc_zhop:      2     # Z hop for tool changes
gcode:


################################################################################
### BASIC SETTINGS (MCU, Bed, Chamber, Probe, etc.)
################################################################################

##################################
# Specs Xplorer 
##################################

[printer]
max_velocity: 300
max_accel: 5000 
max_z_velocity: 40
max_z_accel: 100
minimum_cruise_ratio: 0.5
square_corner_velocity: 5.0

##################################
#  Xplorer specific modules
##################################

[xplorer]               # imports the py modules for the Xplorer into klippy/extras

[trsync_patch]          # when 'True' it increases TRSYNC_TIMEOUT to 0.050 (Klipper default is 0.025) in order to avoid communication errors between the MCUs and the host.
enabled: True

##################################
# Folder to save variables
##################################

[save_variables]
filename:~/printer_data/config/variables.cfg

##################################
# Force Move 
##################################

[force_move]
enable_force_move: True

##################################
# Input Shaper
##################################

[input_shaper]

##################################
# Calibrate endstop phases
##################################

[endstop_phase]

##################################
# Support SDCard looping
##################################

[sdcard_loop]

##################################
# Exclude Objects
##################################

[exclude_object]

##################################
# Enable skew correction
##################################

[skew_correction] 

##################################
# Enable arcs support
##################################

[gcode_arcs]
resolution: 0.5

##################################
# idle timeout
##################################

[idle_timeout]
TIMEOUT: 3600 #1 hour

##################################
# Respond
##################################

[respond]
default_type: echo

##################################
# Temperature Sensors
##################################

[temperature_sensor Mainboard]
sensor_type: temperature_mcu
sensor_mcu: mcu

[temperature_sensor Host]
sensor_type: temperature_host

##################################
# Temperature Fans
##################################

[temperature_fan chamber_fan]
pin: PF7 # BTT M8P V2.0 // PE6 #BTT M8P V1.1
max_power: 1.0
shutdown_speed: 0.0
kick_start_time: 5.0
cycle_time:0.01
off_below:0.1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PB0 # BTT M8P V2.0 //  PA1 #BTT M8P V1.1
min_temp: 0
target_temp:40
max_temp: 65
control: watermark
gcode_id: C

#[temperature_fan Electronics_fan]
#pin:PA4 # BTT M8P V2.0 // PE4 #BTT M8P V1.1
#max_power:1.0
#control:watermark
#max_delta:2
#sensor_type:temperature_host
#min_temp:0
#max_temp:85
#target_temp:50

[controller_fan Electronics_fan]
pin: PA4 #Manta M8P V2.0 # PC12 # Manta M8P V1.1
max_power: 1.0
shutdown_speed: 0
fan_speed: 1.0
idle_timeout: 60

##################################
# Print bed
##################################

[heater_bed]
heater_pin: PA0 # BTT M8P V2.0 // PE3 #BTT M8P V1.1                    
sensor_type: Generic 3950
sensor_pin: PB1 # BTT M8P V2.0 // PA0 #BTT M8P V1.1                       
min_temp: 0
max_temp: 125

[verify_heater heater_bed]
max_error: 10
check_gain_time: 120
hysteresis: 2


##################################
# Case light
##################################

[output_pin caselight]
pin: PA1 # BTT M8P V2.0 // PB5 #BTT M8P V1.1 
pwm:true
cycle_time: 0.01
value: 1
shutdown_value: 0

##################################
# Power ON/OFF
##################################

[output_pin Power]
pin: PD14 # BTT M8P V2.0 // PC3 #BTT M8P V1.1
value: 1


################################################################################
### EXTRUDER T0 (Tool 0)
################################################################################

##################################
# extruder--Tool 0
##################################

[extruder]
step_pin: Tool0: PD0                               
dir_pin: Tool0: PD1                                 
enable_pin: !Tool0: PD2    

microsteps: 32
full_steps_per_rotation: 200
rotation_distance: 4.800 #4.228 #4.405 #4.637
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_only_distance: 500
max_extrude_only_velocity: 120
pressure_advance: 0.030 #0.025 
pressure_advance_smooth_time: 0.04
max_extrude_cross_section: 10 

heater_pin: Tool0: PB13                             
sensor_pin: Tool0: PA3                             
sensor_type: ATC Semitec 104NT-4-R025H42G
min_temp: 0                                 
max_temp: 330
min_extrude_temp:180

[verify_heater extruder]
max_error: 20
check_gain_time: 60
hysteresis: 10

[tmc2209 extruder]
uart_pin: Tool0: PA15                              
run_current: 0.8
interpolate: true
hold_current: 0.100
sense_resistor: 0.11 
stealthchop_threshold: 0
driver_TBL: 0
driver_HEND: 6
driver_HSTRT: 7
driver_TOFF: 4



[fan_generic Tool_0_partfan]
pin: Tool0: PA0                                    

[heater_fan hotend_T0_fan]
pin: Tool0: PA1                                    
heater: extruder
heater_temp: 50.0

##########################################
#Tool Light
##########################################


[output_pin LED_Tool0]
pin: Tool0: PD3
value: 1
shutdown_value: 0

[gcode_macro LED_Tool0_ON]
description: Helper: T0 Light on
gcode: SET_PIN PIN=LED_Tool0 VALUE=1
    
[gcode_macro LED_Tool0_OFF]
description: Helper: T0 Light off
gcode:SET_PIN PIN=LED_Tool0 VALUE=0

##########################################
#Temp extruder stepper driver
##########################################

[temperature_sensor Tool0]
sensor_type: temperature_mcu
sensor_mcu: Tool0

##################################
# Z Probe 
##################################

[probe]
pin: Tool0: PB9
x_offset: 0
y_offset: -18.5
speed: 8
samples: 3
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.025
samples_tolerance_retries: 10
lift_speed: 8
activate_gcode:M204 S5000

##################################
# Acceleration Sensor
##################################

[adxl345 Tool0]
cs_pin: Tool0: PB12
spi_software_sclk_pin: Tool0: PB10
spi_software_mosi_pin: Tool0: PB11
spi_software_miso_pin: Tool0: PB2
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345 Tool0
probe_points: 210, 200, 50


################################################################################
### EXTRUDER T1 (Tool 1)
################################################################################

##################################
# extruder1--Tool 1
##################################

[extruder1]
step_pin: Tool1: PD0                               
dir_pin: Tool1: PD1                                 
enable_pin: !Tool1: PD2                            

microsteps: 32
full_steps_per_rotation: 200
rotation_distance: 4.800
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_only_distance: 500
max_extrude_only_velocity: 120
pressure_advance: 0.030 #0.025 
pressure_advance_smooth_time: 0.04
max_extrude_cross_section: 10 

heater_pin: Tool1: PB13                             
sensor_pin: Tool1: PA3                             
sensor_type: ATC Semitec 104NT-4-R025H42G
min_temp: 0                                 
max_temp: 330
min_extrude_temp:180

[verify_heater extruder1]
max_error: 20
check_gain_time: 60
hysteresis: 10

[tmc2209 extruder1]
uart_pin: Tool1: PA15                              
run_current: 0.8
interpolate: true
hold_current: 0.100
sense_resistor: 0.11 
stealthchop_threshold: 0
driver_TBL: 0
driver_HEND: 6
driver_HSTRT: 7
driver_TOFF: 4



[fan_generic Tool_1_partfan]
pin: Tool1: PA0                                    

[heater_fan hotend_T1_fan]
pin: Tool1: PA1                                    
heater: extruder1
heater_temp: 50.0

##########################################
#Tool Light
##########################################


[output_pin LED_Tool1]
pin: Tool1:PD3
value:1
shutdown_value:0

[gcode_macro LED_Tool1_ON]
description: Helper: T1 Light on
gcode: SET_PIN PIN=LED_Tool1 VALUE=1
    
[gcode_macro LED_Tool1_OFF]
description: Helper: T1 Light off
gcode:SET_PIN PIN=LED_Tool1 VALUE=0

##########################################
#Temp extruder1 stepper driver
##########################################

[temperature_sensor Tool1]
sensor_type: temperature_mcu
sensor_mcu: Tool1


##################################
# Acceleration Sensor
##################################

[adxl345 Tool1]
cs_pin: Tool1: PB12
spi_software_sclk_pin: Tool1: PB10
spi_software_mosi_pin: Tool1: PB11
spi_software_miso_pin: Tool1: PB2
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345 Tool1
probe_points: 210, 200, 50


################################################################################
### EXTRUDER T2 (Tool 2)
################################################################################

##################################
# extruder2--Tool 2
##################################

[extruder2]
step_pin: Tool2: PD0                               
dir_pin: Tool2: PD1                                 
enable_pin: !Tool2: PD2                            

microsteps: 32
full_steps_per_rotation: 200
rotation_distance: 4.800
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_only_distance: 500
max_extrude_only_velocity: 120
pressure_advance: 0.030 #0.025 
pressure_advance_smooth_time: 0.04
max_extrude_cross_section: 10 

heater_pin: Tool2: PB13                             
sensor_pin: Tool2: PA3                             
sensor_type: ATC Semitec 104NT-4-R025H42G
min_temp: 0                                 
max_temp: 330
min_extrude_temp:180

[verify_heater extruder2]
max_error: 20
check_gain_time: 60
hysteresis: 10

[tmc2209 extruder2]
uart_pin: Tool2: PA15                              
run_current: 0.8
interpolate: true
hold_current: 0.100
sense_resistor: 0.11 
stealthchop_threshold: 0
driver_TBL: 0
driver_HEND: 6
driver_HSTRT: 7
driver_TOFF: 4



[fan_generic Tool_2_partfan]
pin: Tool2: PA0                                    

[heater_fan hotend_T2_fan]
pin: Tool2: PA1                                    
heater: extruder2
heater_temp: 50.0

##########################################
#Tool Light
##########################################


[output_pin LED_Tool2]
pin: Tool2:PD3
value:1
shutdown_value:0

[gcode_macro LED_Tool2_ON]
description: Helper: T2 Light on
gcode: SET_PIN PIN=LED_Tool2 VALUE=1
    
[gcode_macro LED_Tool2_OFF]
description: Helper: T2 Light off
gcode:SET_PIN PIN=LED_Tool2 VALUE=0

##########################################
#Temp extruder1 stepper driver
##########################################

[temperature_sensor Tool2]
sensor_type: temperature_mcu
sensor_mcu: Tool2


##################################
# Acceleration Sensor
##################################

[adxl345 Tool2]
cs_pin: Tool2: PB12
spi_software_sclk_pin: Tool2: PB10
spi_software_mosi_pin: Tool2: PB11
spi_software_miso_pin: Tool2: PB2
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345 Tool2
probe_points: 210, 200, 50


################################################################################
### EXTRUDER T3 (Tool 3)
################################################################################

##################################
# extruder3--Tool 3
##################################

[extruder3]
step_pin: Tool3: PD0                               
dir_pin: Tool3: PD1                                 
enable_pin: !Tool3: PD2                            

microsteps: 32
full_steps_per_rotation: 200
rotation_distance: 4.800
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_only_distance: 500
max_extrude_only_velocity: 120
pressure_advance: 0.030 #0.025 
pressure_advance_smooth_time: 0.04
max_extrude_cross_section: 10 

heater_pin: Tool3: PB13                             
sensor_pin: Tool3: PA3                             
sensor_type: ATC Semitec 104NT-4-R025H42G
min_temp: 0                                 
max_temp: 330
min_extrude_temp:180

[verify_heater extruder3]
max_error: 20
check_gain_time: 60
hysteresis: 10

[tmc2209 extruder3]
uart_pin: Tool3: PA15                              
run_current: 0.8
interpolate: true
hold_current: 0.100
sense_resistor: 0.11 
stealthchop_threshold: 0
driver_TBL: 0
driver_HEND: 6
driver_HSTRT: 7
driver_TOFF: 4



[fan_generic Tool_3_partfan]
pin: Tool3: PA0                                    

[heater_fan hotend_T3_fan]
pin: Tool3: PA1                                    
heater: extruder3
heater_temp: 50.0

##########################################
#Tool Light
##########################################


[output_pin LED_Tool3]
pin: Tool3:PD3
value:1
shutdown_value:0

[gcode_macro LED_Tool3_ON]
description: Helper: T3 Light on
gcode: SET_PIN PIN=LED_Tool3 VALUE=1
    
[gcode_macro LED_Tool3_OFF]
description: Helper: T3 Light off
gcode:SET_PIN PIN=LED_Tool3 VALUE=0

##########################################
#Temp extruder3 stepper driver
##########################################

[temperature_sensor Tool3]
sensor_type: temperature_mcu
sensor_mcu: Tool3


##################################
# Acceleration Sensor
##################################

[adxl345 Tool3]
cs_pin: Tool3: PB12
spi_software_sclk_pin: Tool3: PB10
spi_software_mosi_pin: Tool3: PB11
spi_software_miso_pin: Tool3: PB2
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345 Tool3
probe_points: 210, 200, 50


################################################################################
### X AXIS - IQEX (4 Independent X Carriages)
################################################################################

##################################
# Axis X -- Carriage Tool0
##################################

[carriage t0]
axis: x
#gantry: gantry0
endstop_pin:~Tool0:PB6
position_min: -1
position_endstop: 0
position_max: 421 
homing_speed: 180
homing_retract_dist: 5.0
homing_retract_speed: 50
second_homing_speed: 10
#homing_positive_dir:

[stepper x]
carriages: t0
step_pin: PB8 # BTT M8P V2.0 // PD7 #BTT M8P V1.1
dir_pin: PB7  # BTT M8P V2.0 // PD6 #BTT M8P V1.1
enable_pin: !PE0 # BTT M8P V2.0 // !PF10 #BTT M8P V1.1
microsteps: 64 #32
rotation_distance: 32                  

[tmc2209 stepper x]
uart_pin: PB9 # BTT M8P V2.0 // PF9 #BTT M8P V1.1
run_current: 0.95
interpolate: false
hold_current: 0.500
sense_resistor: 0.11 
stealthchop_threshold: 0
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 2
driver_HSTRT: 0

##################################
# Axis X -- Carriage Tool1
##################################

[dual_carriage t1]
primary_carriage: t0
safe_distance:80
endstop_pin: ~Tool1:PB6 
position_min: -1 #80
position_endstop: 421 
position_max: 422
homing_speed: 180
homing_retract_dist: 5.0
homing_retract_speed: 50
second_homing_speed: 10
#homing_positive_dir:

[stepper x1]
carriages: t1
step_pin: PE2 # BTT M8P V2.0 // PF12 #BTT M8P V1.1
dir_pin: PE1 # BTT M8P V2.0 // PF11 #BTT M8P V1.1
enable_pin: !PE4 # BTT M8P V2.0 // !PB3 #BTT M8P V1.1
microsteps: 64 #32
rotation_distance: 32 

[tmc2209 stepper x1]
uart_pin: PE3  # BTT M8P V2.0 // PF13 #BTT M8P V1.1
run_current: 0.95
interpolate: false
hold_current: 0.500
sense_resistor: 0.11 
stealthchop_threshold: 0
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 2
driver_HSTRT: 0

##################################
# Axis X -- Carriage Tool2
##################################

[dual_carriage t2]
axis: x
#gantry: gantry1
endstop_pin:~Tool2:PB6
position_min: -1
position_endstop: 0
position_max: 421
homing_speed: 180
homing_retract_dist: 5.0
homing_retract_speed: 50
second_homing_speed: 10
#homing_positive_dir:

[stepper x2]
carriages: t2
step_pin: ext:gpio11
dir_pin: ext:gpio10
enable_pin: !ext:gpio12
microsteps: 32
rotation_distance: 32         

[tmc2209 stepper x2]
uart_pin: ext:gpio9 # BTT PICO
tx_pin: ext:gpio8 # BTT PICO
uart_address: 0
run_current: 0.95
interpolate: false
hold_current: 0.500
sense_resistor: 0.11 
stealthchop_threshold: 0
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 2
driver_HSTRT: 0

##################################
# Axis X -- Carriage Tool3
##################################

[dual_carriage t3]
primary_carriage: t2
safe_distance:80
endstop_pin: ~Tool3:PB6 
position_min: -1 #80
position_endstop: 421 
position_max: 422
homing_speed: 180
homing_retract_dist: 5.0
homing_retract_speed: 50
second_homing_speed: 10
#homing_positive_dir:

[stepper x3]
carriages: t3
step_pin: ext:gpio14
dir_pin: ext:gpio13
enable_pin: !ext:gpio15
microsteps: 32
rotation_distance: 32

[tmc2209 stepper x3]
uart_pin: ext:gpio9 # BTT PICO
tx_pin: ext:gpio8 # BTT PICO
uart_address: 3
run_current: 0.95
interpolate: false
hold_current: 0.500
sense_resistor: 0.11 
stealthchop_threshold: 0
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 2
driver_HSTRT: 0


################################################################################
### Y AXIS - DUAL GANTRY (2 Independent Y Axes)
################################################################################

##################################
# Axis Y --
#################################
#       BACK side of the printer    ##
#                                   ##
#       Y                   Y1      ##
#                                   ##
#       Y2                   Y3     ##
#     Front side of the printer    ##


#  Back side of the printer  ##

[carriage gantry0]
axis: y
endstop_pin: ~PF3 # BTT M8P V2.0 // ~PF4 #BTT M8P V1.1
position_endstop: 449
position_max: 450
position_min: -1 #92
homing_speed: 150
homing_retract_dist: 5.0
homing_retract_speed: 50
second_homing_speed: 10

[stepper y]
carriages: gantry0
step_pin: PG13 # BTT M8P V2.0 // PC9 #BTT M8P V1.1
dir_pin: !PG12  # BTT M8P V2.0 // !PC8 #BTT M8P V1.1
enable_pin: !PG15 # BTT M8P V2.0 // !PD1 #BTT M8P V1.1
microsteps: 32
rotation_distance: 40

[tmc2209 stepper y]
uart_pin: PG14 # BTT M8P V2.0 // PD0 #BTT M8P V1.1
run_current: 1.5
interpolate: true
hold_current: 0.7
stealthchop_threshold: 99999

###########################################################

#[extra_carriage gantry01]
#primary_carriage: gantry0
#endstop_pin: ?? # 

[stepper y1]
carriages: gantry0
step_pin: PB4 # BTT M8P V2.0 // PD3 #BTT M8P V1.1
dir_pin: PB3  # BTT M8P V2.0 // PD2 #BTT M8P V1.1
enable_pin: !PB6 # BTT M8P V2.0 // !PD5 #BTT M8P V1.1
microsteps: 32
rotation_distance: 40

[tmc2209 stepper y1]
uart_pin: PB5 # BTT M8P V2.0 // PD4 #BTT M8P V1.1
run_current: 1.5
interpolate: true
hold_current: 0.7
stealthchop_threshold: 99999

###########################################################

#  Front side of the printer  ###

[dual_carriage gantry1]
safe_distance:70 
primary_carriage: gantry0
endstop_pin: ~ext:gpio25 # BTT PICO
position_endstop: 0
position_max: 450 
position_min: -1
homing_speed: 150
homing_retract_dist: 5.0
homing_retract_speed: 50
second_homing_speed: 10

[stepper y2]                       # Left side of the printer
carriages:gantry1
step_pin: ext:gpio6 # BTT PICO
dir_pin: ext:gpio5 # BTT PICO
enable_pin: !ext:gpio7 # BTT PICO
microsteps: 32
rotation_distance: 40

[tmc2209 stepper y2]
uart_pin: ext:gpio9 # BTT PICO
tx_pin: ext:gpio8 # BTT PICO
uart_address: 2
run_current: 1.5
interpolate: true
hold_current: 0.7
stealthchop_threshold: 99999

###########################################################

#[extra_carriage gantry11]
#primary_carriage: gantry1
#endstop_pin: ?? # 

[stepper y3]
carriages: gantry1
step_pin: ext:gpio19 # BTT PICO
dir_pin: !ext:gpio28 # BTT PICO
enable_pin: !ext:gpio2 # BTT PICO
microsteps: 32
rotation_distance: 40

[tmc2209 stepper y3]
uart_pin: ext:gpio9 # BTT PICO
tx_pin: ext:gpio8 # BTT PICO
uart_address: 1
run_current: 1.5
interpolate: true
hold_current: 0.7
stealthchop_threshold: 99999


################################################################################
### Z AXIS - DUAL GANTRY (3 Motors for Z-Tilt)
################################################################################

##################################
# Z Axis -- 3 Steppers
##################################

#   BACK of the printer   #
#                         #
#           Z1            #
#                         #
#       Z       Z2        #
#                         #
#   FRONT of the printer  #


#  Stepper Left  ###########

[carriage z]
endstop_pin: PC15 # BTT M8P V2.0 // PC2  #BTT M8P V1.1
position_endstop: 401
position_max: 401
position_min: -3
homing_speed: 20
homing_retract_dist: 10.0
homing_retract_speed: 10
second_homing_speed: 5

[stepper z]
carriages: z
step_pin: PC7 # BTT M8P V2.0 // PD8 #BTT M8P V1.1
dir_pin: PC8 # BTT M8P V2.0 // !PC6 #BTT M8P V1.1
enable_pin: !PD2 # BTT M8P V2.0 // !PC7  #BTT M8P V1.1
microsteps: 32
rotation_distance: 40
gear_ratio: 80:16

[tmc2209 stepper z]
uart_pin: PC6 # BTT M8P V2.0 // PD10  #BTT M8P V1.1
run_current: 1.4
hold_current: 0.9
stealthchop_threshold: 999999


#  Stepper Back  ############

[extra_carriage z1]
primary_carriage: z
endstop_pin: PF0 # BTT M8P V2.0 // PC1 #BTT M8P V1.1

[stepper z1]
carriages: z1
step_pin: PD4 # BTT M8P V2.0 // PD11 #BTT M8P V1.1
dir_pin: !PD3 # BTT M8P V2.0 // PD9 #BTT M8P V1.1
enable_pin: !PD6 # BTT M8P V2.0 // !PD15 #BTT M8P V1.1
microsteps: 32
rotation_distance: 40
gear_ratio: 80:16

[tmc2209 stepper z1]
uart_pin: PD5 # BTT M8P V2.0 // PD14 #BTT M8P V1.1
run_current: 1.4
hold_current: 0.9
stealthchop_threshold: 999999


#  Stepper Right  #########

[extra_carriage z2]
primary_carriage: z
endstop_pin: PF1 # BTT M8P V2.0 // PC0  #BTT M8P V1.1

[stepper z2]
carriages: z2
step_pin: PG9 # BTT M8P V2.0 // PA10  #BTT M8P V1.1
dir_pin: !PD7 # BTT M8P V2.0 // PA14  #BTT M8P V1.1
enable_pin: !PG11 # BTT M8P V2.0 // !PA15  #BTT M8P V1.1
microsteps: 32
rotation_distance: 40
gear_ratio: 80:16

[tmc2209 stepper z2]
uart_pin: PG10  # BTT M8P V2.0 // PF8  #BTT M8P V1.1
run_current: 1.4
hold_current: 0.9
stealthchop_threshold: 999999


################################################################################
### PRINTER SPECS & MESH/TILT (from main config)
################################################################################

[printer]
kinematics: generic_cartesian

##################################################################

##################################
# Z Stepper Align
##################################


[z_tilt]
z_positions: -60.1, -3.9            # Z Belt position relativ to origin  (left Z Motor)
               210, 537.5           # Z1 Belt position relativ to origin (back Z Motor)          
              481.1, -3.9           # Z2 Belt position relativ to origin (right Z Motor) 
              

points: 80, 130      # probing point left Z Motor
        210, 360    # probing point back Z Motor       
        340, 130     # probing point right Z Motor 
       

speed: 200
horizontal_move_z: 7
retries: 10
retry_tolerance: 0.025

##################################
# Bed Mesh
##################################


[bed_mesh]
speed: 200
horizontal_move_z: 5
mesh_min: 80, 130
mesh_max: 340, 380         
probe_count: 8,8 
mesh_pps: 3, 3
algorithm: bicubic 
bicubic_tension: 0.2
move_check_distance: 5
split_delta_z: .025
fade_start: 1
fade_end: 10
fade_target: 0                                             



[controller_fan Expansion_fan]
pin: ext:gpio20 # BTT PICO
max_power: 1.0
shutdown_speed: 0
fan_speed: 1.0
idle_timeout: 60


################################################################################
### SMART SENSORS - T0
################################################################################

#################################################################################################################
################################# Orbiter Sensor CONFIGURATION ##################################################
#################################################################################################################


#### CONFIG BASED ON THE OFICIAL ORBITER Smart SENSOR Config ( Klipper Config/Orbiter2_SmartSensor.cfg // #config file version v3.0.02 // #release date: 22.12.2023 ). https://www.orbiterprojects.com/smart-sensor-for-orbiter-v2/  ####
                          #### Many Thanks to Dr. Róbert Lőrincz for this great project !!! ###

#########Setting Up For More Tools##################

# 'n' is the tool number begining with 0

#1. Copy the Confing and change the name of the config: 'Tn_OrbiterSensor.cfg'
#2. Overall in the config: replace 'T0' with 'Tn'
#3. Overall in the config: replace 't0' with 'tn'
#4. Overall in the config: replace 'Tool0' with 'Tooln'
#5. Overall in the config: replace 'filament_change_state1' with 'filament_change_state1n'
#6. Overall in the config: replace 'filament_change_state2' with 'filament_change_state2n'
#7. Overall in the config: replace  'extruder' with 'extrudern' 
#8. Give the corresponding pin for 'filament_switch_sensor' and 'gcode_button unload_Tool0'
#9. Insert the config in 'printer.cfg': [include Tn_OrbiterSensor.cfg]


#################################################################################################################
################################# CHANGE HERE MACRO CONFIGURABLES################################################
#################################################################################################################




#///////////////////////////filament sensor button macros/////////////////////////////////////////////////

[filament_switch_sensor T0_sensor]
switch_pin: Tool0: PB3
pause_on_runout: False
runout_gcode: 
  runnout_init_t0
insert_gcode: startload_Tool0
event_delay: 1.0
pause_delay: 0.1

#********************************************************************************************************

#////////////////////////////////////////Filament Unload macros/////////////////////////////////////////////////
[gcode_button unload_Tool0]
pin: Tool0: PB4 # remove the negation "!" for sensor v1 - use just PA9 as example
press_gcode:  # filament unload procedure
    unload_tangle_t0
release_gcode: # do not add any macro call here

#################################################################################################################################
####################################### DO NOT CHANGE ANYTHING BELOW THIS LINE!!! ###############################################
#################################################################################################################################
####################################### UNLESS YOU KNOW WHAT YOU ARE DOING OR YOU ARE BORED AND NEED TO DO SOMETHING OR YOU ARE ALONE AND NEED SOMETHING TO MESS UP YOUR LIFE OR YOU CAN DO IT BETTER THAN ME OR YOU ARE A REAL SMARTASS OR JUST BECAUSE YOU CAN OR YOU RUN OUT OF BEAR OR HAS NOTHING BETTER TO DO OR ANY UNREASONABLE REASON
#################################################################################################################################

[respond]
default_type: echo

[force_move]
enable_force_move: True

[gcode_macro runnout_init_t0]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% if svv.ttovr == 2 %}
     TTOVER1
    {% elif svv.ttovr == 3 %}
     TTOVER2
    {% elif svv.ttovr == 4 %}
     TTOVER3 
    {% else %}
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    {% set sensor = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}  
     {% if(sensor.t0_disable_runnout|lower == 'false') %}
      filament_change_state1
     {% else %}
    M118 Filament Tool0 runnout is disabled in the sensor config file!   
     {% endif %}
   {% endif %} 

[gcode_macro filament_change_state1]
variable_changet0busy: 0
variable_temp_target: 0
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}  
  {% if changet0busy == 0 %}
    M600 # call printer pause macro          
    M118 Filament Tool0 runnout!       
    {% if (sensor.t0_disable_autochange|lower == 'false') %}
      SET_GCODE_VARIABLE MACRO=filament_change_state1 VARIABLE=changet0busy VALUE=1       
      filament_change_state2   # comment this line if you do not want to automatically unload filament in case there is a runnout detected.
    {% endif %}  
  {% endif %}

[gcode_macro filament_change_state2]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}  
  SET_GCODE_VARIABLE MACRO=unload_tangle_t0 VARIABLE=loadt0busy VALUE=1  
  {% if (sensor.t0_enable_beep|lower == 'true') %} 
    M300 # beep sound
  {% endif %}
  M118 Unloading Tool0 ...   
  M83
  G92 E0   
  # {% if printer[printer.toolhead.extruder].temperature < 185 %} # hardcoded threshold
  {% if (printer.extruder.can_extrude|lower != 'true')%} # checing for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder config (to about 185)
      M118 Tool0 heating!        
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={sensor.t0_unload_temp} # restore user temp if it was set before loading
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={sensor.t0_unload_temp} #wait for reaching filament unload temp
      {% endif %}     
  {% if(printer.extruder.target == 0) %} # checing for set temperature if is zero than set to 200 / hotend hot but cooling due to set target temp 0
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={sensor.t0_unload_temp} # restore user temp if it was set before loading
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={sensor.t0_unload_temp} #wait for reaching filament unload temp
  {% endif %} 
  G0 E-5 F3600 	#extract filament to cold end
  G4 P2000 # wait for two seconds
  G0 E5 F3600 # push the filament back 
  G0 E-5 F3600 	#extract filament to cold end
  G0 E-{sensor.t0_unload_distance} F300	# continue extraction slow allow filament to be cooled enough before reaches the gears  
  M400   
  M118 Load new filament in Tool0! Wait until is loaded, then resume printing.  
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0 # swicth off heater
  UPDATE_DELAYED_GCODE ID=clear_loadt0busy DURATION=0.5
  UPDATE_DELAYED_GCODE ID=clear_changet0busy DURATION=0.5

[gcode_macro startload_Tool0]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}
  {% if (printer.print_stats.state != "printing") %}
    {% if(sensor.t0_disable_autoload|lower == 'false') %}
      SET_GCODE_VARIABLE MACRO=unload_tangle_t0 VARIABLE=loadt0busy VALUE=1
      load_Tool0
    {% else %}
    M118 Filament auto-load is disabled in the sensor config file!   
    {% endif %} 
  {% else %}    
    M118 Printing! Can't load filament right now!    
  {% endif %} 
 # SET_GCODE_VARIABLE MACRO=unload_Tool0 VARIABLE=filamentpresent VALUE=1
  #UPDATE_DELAYED_GCODE ID=clear_changet0busy DURATION=2  

[gcode_macro load_Tool0]
variable_USER_TEMP: 0
variable_LOAD_TEMP: 0
gcode:
    ACTIVATE_EXTRUDER EXTRUDER=extruder    
    {% set sensor = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}
      {% set USER_TEMP = printer.extruder.target %} # save user set temperature before loading
      {% set LOAD_TEMP = 0 %} 
      #M118 USER TEMP {USER_TEMP}      # echo back for debug only      
        {% if (printer.extruder.can_extrude|lower != 'true') or (printer.extruder.target < sensor.t0_load_min_temp) %} # checking for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder config (to about 185)                        
          SET_HEATER_TEMPERATURE HEATER=extruder TARGET={sensor.t0_load_temp} # set user defined load temperature
          {% set LOAD_TEMP = sensor.t0_load_temp %} # save user set temperature before loading           
         M118 Tool0 heating! 
        {% endif %}     
    {% if (sensor.t0_enable_beep|lower == 'true') %} 
      M300 # beep sound
    {% endif %}
    M118 Tool0 loading!  
    M82           #set extruder to absolute mode
    G92 E0
    G4 P1500        # wait for 1.5 seconds
    FORCE_MOVE STEPPER=extruder DISTANCE=15 VELOCITY=10 ACCEL=1000  # load filament inside the gears force move needs to be enabled    
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={LOAD_TEMP} # wait for reaching set temperature    
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={USER_TEMP} # wait for reaching set temperature    
    G1 E{sensor.t0_purge_length} F{sensor.t0_purge_speed} # extrude preconfigured purge length
    M400 # wait to complete nozzle purge
    {% if (printer.extruder.target > 0) %} # checking if a temperature was previous set
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={USER_TEMP} # restore user temp if it was set before loading                     
    {% else %}
      M104 S185 T0 # the hotend will remain warm         
      M118 Tool0 remains warm
    {% endif %} 
    M118 Tool0 load complete!   
    UPDATE_DELAYED_GCODE ID=clear_loadt0busy DURATION=2   
 

#############################################END filament auto load macro section END***********************************************************
#############################################filament auto unload and Tangle macro section*****************************************************************
[gcode_macro unload_tangle_t0]
variable_loadt0busy: 0
gcode:
    {% set sensor = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}
  {% if (printer.print_stats.state == "printing") %} # filament tangle detection during printing  
    {% if(sensor.t0_disable_tangle|lower == 'false') %} # run tangle detection macro if enabled
      filament_tangle_t0   
    {% else %} #filament tangle disabled send message to console
      M118 Filament tangle detected on Tool0, action disabled!
    {% endif %} 
  {% else %} #filament unload button pressed
      #{% if (printer.print_stats.state != "paused" and loadt0busy == 0) %} #enable unload if not printing and not paused
      {% if (loadt0busy == 0) %} #enable unload if not printing 
        {% if(sensor.t0_disable_autounload|lower == 'false') %} # run unload macro if enabled
          unload_Tool0
        {% endif %}
      {% endif %}
  {% endif %}

[gcode_macro unload_Tool0] 
#variable_filamentpresent: 0
gcode:
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    {% set sensor = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}
      {% if (sensor.t0_enable_beep|lower == 'true') %} 
        M300 # beep sound
      {% endif %}
      M118 Tool0 unloading!    
      M83
      G92 E0     
      {% if (printer.extruder.can_extrude|lower != 'true')%} # checing for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder config (to about 185)
        M118 Tool0 heating!          
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={sensor.t0_unload_temp} # restore user temp if it was set before loading
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={sensor.t0_unload_temp} # wait for reaching configured unload temperature
      {% endif %}
      {% if(printer.extruder.target == 0) %} # checing for set temperature if is zero than set to 185 / hotend hot but cooling due to set target temp 0
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={sensor.t0_unload_temp} # wait for reaching configured unload temperature
      {% endif %}
      G0 E10 F500 # extruder 20mm of filament before extracting 
      G0 E-5 F3600 	#extract filament to cold end
      G4 P2000 # wait for two seconds
      G0 E6 F3600 # push the filament back 
      G0 E-10 F3600 	#extract filament to cold end
      G0 E-{sensor.t0_unload_distance} F300	# continue extraction slow allow filament to be cooled enough before reaches the gears  
      #M104 S0 T0 # the hotend will remain warm
      M400 # wait to complete unload
      M118 Tool0 unload complete!    

[gcode_macro filament_tangle_t0] 
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}
  M118 Filament tangle detected on Tool0, print paused!
  M600
  {% if (sensor.t0_enable_beep|lower == 'true') %} 
    M300 # beep sound
  {% endif %}
  M600
    

#############################################END filament auto unload macro section END***********************************************************

[delayed_gcode clear_unloadt0busy]
gcode:
  SET_GCODE_VARIABLE MACRO=unload_Tool0 VARIABLE=unloadt0busy VALUE=0
  #M118 Clear Unload busy! 

[delayed_gcode clear_changet0busy]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_change_state1 VARIABLE=changet0busy VALUE=0
  #M118 Clear Load busy!  

[delayed_gcode clear_loadt0busy]
gcode:
  SET_GCODE_VARIABLE MACRO=unload_tangle_t0 VARIABLE=loadt0busy VALUE=0
  #M118 Clear Load busy!


################################################################################
### SMART SENSORS - T1
################################################################################

#################################################################################################################
################################# Orbiter Sensor CONFIGURATION ##################################################
#################################################################################################################


#### CONFIG BASED ON THE OFICIAL ORBITER Smart SENSOR Config ( Klipper Config/Orbiter2_SmartSensor.cfg // #config file version v3.0.02 // #release date: 22.12.2023 ). https://www.orbiterprojects.com/smart-sensor-for-orbiter-v2/  ####
                          #### Many Thanks to Dr. Róbert Lőrincz for this great project !!! ###

#########Setting Up For More Tools##################

# 'n' is the tool number begining with 0

#1. Copy the Confing and change the name of the config: 'Tn_OrbiterSensor.cfg'
#2. Overall in the config: replace 'T1' with 'Tn'
#3. Overall in the config: replace 't1' with 'tn'
#4. Overall in the config: replace 'Tool1' with 'Tooln'
#5. Overall in the config: replace 'filament_change_state11' with 'filament_change_state11n'
#6. Overall in the config: replace 'filament_change_state21' with 'filament_change_state21n'
#7. Overall in the config: replace  'extruder1' with 'extruder1n' 
#8. Give the corresponding pin for 'filament_switch_sensor' and 'gcode_button unload_Tool1'
#9. Insert the config in 'printer.cfg': [include Tn_OrbiterSensor.cfg]


#################################################################################################################
################################# CHANGE HERE MACRO CONFIGURABLES################################################
#################################################################################################################




#///////////////////////////filament sensor button macros/////////////////////////////////////////////////

[filament_switch_sensor T1_sensor]
switch_pin: Tool1: PB3
pause_on_runout: False
runout_gcode: 
  runnout_init_t1
insert_gcode: startload_Tool1
event_delay: 1.0
pause_delay: 0.1

#********************************************************************************************************

#////////////////////////////////////////Filament Unload macros/////////////////////////////////////////////////
[gcode_button unload_Tool1]
pin: Tool1: PB4 # remove the negation "!" for sensor v1 - use just PA9 as example
press_gcode:  # filament unload procedure
    unload_tangle_t1
release_gcode: # do not add any macro call here

#################################################################################################################################
####################################### DO NOT CHANGE ANYTHING BELOW THIS LINE!!! ###############################################
#################################################################################################################################
####################################### UNLESS YOU KNOW WHAT YOU ARE DOING OR YOU ARE BORED AND NEED TO DO SOMETHING OR YOU ARE ALONE AND NEED SOMETHING TO MESS UP YOUR LIFE OR YOU CAN DO IT BETTER THAN ME OR YOU ARE A REAL SMARTASS OR JUST BECAUSE YOU CAN OR YOU RUN OUT OF BEAR OR HAS NOTHING BETTER TO DO OR ANY UNREASONABLE REASON
#################################################################################################################################

[respond]
default_type: echo

[force_move]
enable_force_move: True

[gcode_macro runnout_init_t1]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% if svv.ttovr == 1 %}
     TTOVER0
    {% elif svv.ttovr == 3 %}
     TTOVER2
    {% elif svv.ttovr == 4 %}
     TTOVER3 
    {% else %}
  ACTIVATE_EXTRUDER EXTRUDER=extruder1
  {% set sensor = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}  
  {% if(sensor.t1_disable_runnout|lower == 'false') %}
      filament_change_state11
  {% else %}
    M118 Filament Tool1 runnout is disabled in the sensor config file!   
  {% endif %}
  {% endif %}

[gcode_macro filament_change_state11]
variable_changet1busy: 0
variable_temp_target: 0
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}  
  {% if changet1busy == 0 %}
    M600 # call printer pause macro          
    M118 Filament Tool1 runnout!       
    {% if (sensor.t1_disable_autochange|lower == 'false') %}
      SET_GCODE_VARIABLE MACRO=filament_change_state11 VARIABLE=changet1busy VALUE=1       
      filament_change_state21   # comment this line if you do not want to automatically unload filament in case there is a runnout detected.
    {% endif %}  
  {% endif %}

[gcode_macro filament_change_state21]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}  
  SET_GCODE_VARIABLE MACRO=unload_tangle_t1 VARIABLE=loadt1busy VALUE=1  
  {% if (sensor.t1_enable_beep|lower == 'true') %} 
    M300 # beep sound
  {% endif %}
  M118 Unloading Tool1 ...   
  M83
  G92 E0   
  # {% if printer[printer.toolhead.extruder1].temperature < 185 %} # hardcoded threshold
  {% if (printer.extruder1.can_extrude|lower != 'true')%} # checing for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder1 config (to about 185)
      M118 Tool1 heating!        
      SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET={sensor.t1_unload_temp} # restore user temp if it was set before loading
      TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={sensor.t1_unload_temp} #wait for reaching filament unload temp
      {% endif %}     
  {% if(printer.extruder1.target == 0) %} # checing for set temperature if is zero than set to 200 / hotend hot but cooling due to set target temp 0
      SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET={sensor.t1_unload_temp} # restore user temp if it was set before loading
      TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={sensor.t1_unload_temp} #wait for reaching filament unload temp
  {% endif %} 
  G0 E-5 F3600 	#extract filament to cold end
  G4 P2000 # wait for two seconds
  G0 E5 F3600 # push the filament back 
  G0 E-5 F3600 	#extract filament to cold end
  G0 E-{sensor.t1_unload_distance} F300	# continue extraction slow allow filament to be cooled enough before reaches the gears  
  M400   
  M118 Load new filament in Tool1! Wait until is loaded, then resume printing.  
  SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET=0 # swicth off heater
  UPDATE_DELAYED_GCODE ID=clear_loadt1busy DURATION=0.5
  UPDATE_DELAYED_GCODE ID=clear_changet1busy DURATION=0.5

[gcode_macro startload_Tool1]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}
  {% if (printer.print_stats.state != "printing") %}
    {% if(sensor.t1_disable_autoload|lower == 'false') %}
      SET_GCODE_VARIABLE MACRO=unload_tangle_t1 VARIABLE=loadt1busy VALUE=1
      load_Tool1
    {% else %}
    M118 Filament auto-load is disabled in the sensor config file!   
    {% endif %} 
  {% else %}    
    M118 Printing! Can't load filament right now!    
  {% endif %} 
 # SET_GCODE_VARIABLE MACRO=unload_Tool1 VARIABLE=filamentpresent VALUE=1
  #UPDATE_DELAYED_GCODE ID=clear_changet1busy DURATION=2  

[gcode_macro load_Tool1]
variable_USER_TEMP: 0
variable_LOAD_TEMP: 0
gcode:
    ACTIVATE_EXTRUDER EXTRUDER=extruder1    
    {% set sensor = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}
      {% set USER_TEMP = printer.extruder1.target %} # save user set temperature before loading
      {% set LOAD_TEMP = 0 %} 
      #M118 USER TEMP {USER_TEMP}      # echo back for debug only      
        {% if (printer.extruder1.can_extrude|lower != 'true') or (printer.extruder1.target < sensor.t1_load_min_temp) %} # checking for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder1 config (to about 185)                        
          SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET={sensor.t1_load_temp} # set user defined load temperature
          {% set LOAD_TEMP = sensor.t1_load_temp %} # save user set temperature before loading           
         M118 Tool1 heating! 
        {% endif %}     
    {% if (sensor.t1_enable_beep|lower == 'true') %} 
      M300 # beep sound
    {% endif %}
    M118 Tool1 loading!  
    M82           #set extruder1 to absolute mode
    G92 E0
    G4 P1500        # wait for 1.5 seconds
    FORCE_MOVE STEPPER=extruder1 DISTANCE=15 VELOCITY=10 ACCEL=1000  # load filament inside the gears force move needs to be enabled    
    TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={LOAD_TEMP} # wait for reaching set temperature    
    TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={USER_TEMP} # wait for reaching set temperature    
    G1 E{sensor.t1_purge_length} F{sensor.t1_purge_speed} # extrude preconfigured purge length
    M400 # wait to complete nozzle purge
    {% if (printer.extruder1.target > 0) %} # checking if a temperature was previous set
      SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET={USER_TEMP} # restore user temp if it was set before loading                     
    {% else %}
      M104 S185 T1 # the hotend will remain warm         
      M118 Tool1 remains warm
    {% endif %} 
    M118 Tool1 load complete!   
    UPDATE_DELAYED_GCODE ID=clear_loadt1busy DURATION=2   
 

#############################################END filament auto load macro section END***********************************************************
#############################################filament auto unload and Tangle macro section*****************************************************************
[gcode_macro unload_tangle_t1]
variable_loadt1busy: 0
gcode:
    {% set sensor = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}
  {% if (printer.print_stats.state == "printing") %} # filament tangle detection during printing  
    {% if(sensor.t1_disable_tangle|lower == 'false') %} # run tangle detection macro if enabled
      filament_tangle_t1   
    {% else %} #filament tangle disabled send message to console
      M118 Filament tangle detected on Tool1, action disabled!
    {% endif %} 
  {% else %} #filament unload button pressed
      #{% if (printer.print_stats.state != "paused" and loadt1busy == 0) %} #enable unload if not printing and not paused
      {% if (loadt1busy == 0) %} #enable unload if not printing 
        {% if(sensor.t1_disable_autounload|lower == 'false') %} # run unload macro if enabled
          unload_Tool1
        {% endif %}
      {% endif %}
  {% endif %}

[gcode_macro unload_Tool1] 
#variable_filamentpresent: 0
gcode:
    ACTIVATE_EXTRUDER EXTRUDER=extruder1
    {% set sensor = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}
      {% if (sensor.t1_enable_beep|lower == 'true') %} 
        M300 # beep sound
      {% endif %}
      M118 Tool1 unloading!    
      M83
      G92 E0     
      {% if (printer.extruder1.can_extrude|lower != 'true')%} # checing for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder1 config (to about 185)
        M118 Tool1 heating!          
        SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET={sensor.t1_unload_temp} # restore user temp if it was set before loading
        TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={sensor.t1_unload_temp} # wait for reaching configured unload temperature
      {% endif %}
      {% if(printer.extruder1.target == 0) %} # checing for set temperature if is zero than set to 185 / hotend hot but cooling due to set target temp 0
        TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={sensor.t1_unload_temp} # wait for reaching configured unload temperature
      {% endif %}
      G0 E10 F500 # extruder1 20mm of filament before extracting 
      G0 E-5 F3600 	#extract filament to cold end
      G4 P2000 # wait for two seconds
      G0 E6 F3600 # push the filament back 
      G0 E-10 F3600 	#extract filament to cold end
      G0 E-{sensor.t1_unload_distance} F300	# continue extraction slow allow filament to be cooled enough before reaches the gears  
      #M104 S0 T1 # the hotend will remain warm
      M400 # wait to complete unload
      M118 Tool1 unload complete!    

[gcode_macro filament_tangle_t1] 
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}
  M118 Filament tangle detected on Tool1, print paused!
  M600
  {% if (sensor.t1_enable_beep|lower == 'true') %} 
    M300 # beep sound
  {% endif %}
  M600
    

#############################################END filament auto unload macro section END***********************************************************

[delayed_gcode clear_unloadt1busy]
gcode:
  SET_GCODE_VARIABLE MACRO=unload_Tool1 VARIABLE=unloadt1busy VALUE=0
  #M118 Clear Unload busy! 

[delayed_gcode clear_changet1busy]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_change_state11 VARIABLE=changet1busy VALUE=0
  #M118 Clear Load busy!  

[delayed_gcode clear_loadt1busy]
gcode:
  SET_GCODE_VARIABLE MACRO=unload_tangle_t1 VARIABLE=loadt1busy VALUE=0
  #M118 Clear Load busy!


################################################################################
### SMART SENSORS - T2
################################################################################

#################################################################################################################
################################# Orbiter Sensor CONFIGURATION ##################################################
#################################################################################################################


#### CONFIG BASED ON THE OFICIAL ORBITER Smart SENSOR Config ( Klipper Config/Orbiter2_SmartSensor.cfg // #config file version v3.0.02 // #release date: 22.12.2023 ). https://www.orbiterprojects.com/smart-sensor-for-orbiter-v2/  ####
                          #### Many Thanks to Dr. Róbert Lőrincz for this great project !!! ###

#########Setting Up For More Tools##################

# 'n' is the tool number begining with 0

#1. Copy the Confing and change the name of the config: 'Tn_OrbiterSensor.cfg'
#2. Overall in the config: replace 'T2' with 'Tn'
#3. Overall in the config: replace 't2' with 'tn'
#4. Overall in the config: replace 'Tool2' with 'Tooln'
#5. Overall in the config: replace 'filament_change_state12' with 'filament_change_state12n'
#6. Overall in the config: replace 'filament_change_state22' with 'filament_change_state22n'
#7. Overall in the config: replace  'extruder2' with 'extruder2n' 
#8. Give the corresponding pin for 'filament_switch_sensor' and 'gcode_button unload_Tool2'
#9. Insert the config in 'printer.cfg': [include Tn_OrbiterSensor.cfg]


#################################################################################################################
################################# CHANGE HERE MACRO CONFIGURABLES################################################
#################################################################################################################




#///////////////////////////filament sensor button macros/////////////////////////////////////////////////

[filament_switch_sensor T2_sensor]
switch_pin: Tool2: PB3
pause_on_runout: False
runout_gcode: 
  runnout_init_t2
insert_gcode: startload_Tool2
event_delay: 1.0
pause_delay: 0.1

#********************************************************************************************************

#////////////////////////////////////////Filament Unload macros/////////////////////////////////////////////////
[gcode_button unload_Tool2]
pin: Tool2: PB4 # remove the negation "!" for sensor v1 - use just PA9 as example
press_gcode:  # filament unload procedure
    unload_tangle_t2
release_gcode: # do not add any macro call here

#################################################################################################################################
####################################### DO NOT CHANGE ANYTHING BELOW THIS LINE!!! ###############################################
#################################################################################################################################
####################################### UNLESS YOU KNOW WHAT YOU ARE DOING OR YOU ARE BORED AND NEED TO DO SOMETHING OR YOU ARE ALONE AND NEED SOMETHING TO MESS UP YOUR LIFE OR YOU CAN DO IT BETTER THAN ME OR YOU ARE A REAL SMARTASS OR JUST BECAUSE YOU CAN OR YOU RUN OUT OF BEAR OR HAS NOTHING BETTER TO DO OR ANY UNREASONABLE REASON
#################################################################################################################################

[respond]
default_type: echo

[force_move]
enable_force_move: True

[gcode_macro runnout_init_t2]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% if svv.ttovr == 1 %}
     TTOVER0
    {% elif svv.ttovr == 2 %}
     TTOVER1
    {% elif svv.ttovr == 4 %}
     TTOVER2 
    {% else %}
  ACTIVATE_EXTRUDER EXTRUDER=extruder2
  {% set sensor = printer['gcode_macro _SENSOR_t2_VARIABLES'] %}  
  {% if(sensor.t2_disable_runnout|lower == 'false') %}
      filament_change_state12
  {% else %}
    M118 Filament Tool2 runnout is disabled in the sensor config file!   
  {% endif %}
  {% endif %}

[gcode_macro filament_change_state12]
variable_changet2busy: 0
variable_temp_target: 0
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t2_VARIABLES'] %}  
  {% if changet2busy == 0 %}
    M600 # call printer pause macro          
    M118 Filament Tool2 runnout!       
    {% if (sensor.t2_disable_autochange|lower == 'false') %}
      SET_GCODE_VARIABLE MACRO=filament_change_state12 VARIABLE=changet2busy VALUE=1       
      filament_change_state22   # comment this line if you do not want to automatically unload filament in case there is a runnout detected.
    {% endif %}  
  {% endif %}

[gcode_macro filament_change_state22]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t2_VARIABLES'] %}  
  SET_GCODE_VARIABLE MACRO=unload_tangle_t2 VARIABLE=loadt2busy VALUE=1  
  {% if (sensor.t2_enable_beep|lower == 'true') %} 
    M300 # beep sound
  {% endif %}
  M118 Unloading Tool2 ...   
  M83
  G92 E0   
  # {% if printer[printer.toolhead.extruder2].temperature < 185 %} # hardcoded threshold
  {% if (printer.extruder2.can_extrude|lower != 'true')%} # checing for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder2 config (to about 185)
      M118 Tool2 heating!        
      SET_HEATER_TEMPERATURE HEATER=extruder2 TARGET={sensor.t2_unload_temp} # restore user temp if it was set before loading
      TEMPERATURE_WAIT SENSOR=extruder2 MINIMUM={sensor.t2_unload_temp} #wait for reaching filament unload temp
      {% endif %}     
  {% if(printer.extruder2.target == 0) %} # checing for set temperature if is zero than set to 200 / hotend hot but cooling due to set target temp 0
      SET_HEATER_TEMPERATURE HEATER=extruder2 TARGET={sensor.t2_unload_temp} # restore user temp if it was set before loading
      TEMPERATURE_WAIT SENSOR=extruder2 MINIMUM={sensor.t2_unload_temp} #wait for reaching filament unload temp
  {% endif %} 
  G0 E-5 F3600 	#extract filament to cold end
  G4 P2000 # wait for two seconds
  G0 E5 F3600 # push the filament back 
  G0 E-5 F3600 	#extract filament to cold end
  G0 E-{sensor.t2_unload_distance} F300	# continue extraction slow allow filament to be cooled enough before reaches the gears  
  M400   
  M118 Load new filament in Tool2! Wait until is loaded, then resume printing.  
  SET_HEATER_TEMPERATURE HEATER=extruder2 TARGET=0 # swicth off heater
  UPDATE_DELAYED_GCODE ID=clear_loadt2busy DURATION=0.5
  UPDATE_DELAYED_GCODE ID=clear_changet2busy DURATION=0.5

[gcode_macro startload_Tool2]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t2_VARIABLES'] %}
  {% if (printer.print_stats.state != "printing") %}
    {% if(sensor.t2_disable_autoload|lower == 'false') %}
      SET_GCODE_VARIABLE MACRO=unload_tangle_t2 VARIABLE=loadt2busy VALUE=1
      load_Tool2
    {% else %}
    M118 Filament auto-load is disabled in the sensor config file!   
    {% endif %} 
  {% else %}    
    M118 Printing! Can't load filament right now!    
  {% endif %} 
 # SET_GCODE_VARIABLE MACRO=unload_Tool2 VARIABLE=filamentpresent VALUE=1
  #UPDATE_DELAYED_GCODE ID=clear_changet2busy DURATION=2  

[gcode_macro load_Tool2]
variable_USER_TEMP: 0
variable_LOAD_TEMP: 0
gcode:
    ACTIVATE_EXTRUDER EXTRUDER=extruder2    
    {% set sensor = printer['gcode_macro _SENSOR_t2_VARIABLES'] %}
      {% set USER_TEMP = printer.extruder2.target %} # save user set temperature before loading
      {% set LOAD_TEMP = 0 %} 
      #M118 USER TEMP {USER_TEMP}      # echo back for debug only      
        {% if (printer.extruder2.can_extrude|lower != 'true') or (printer.extruder2.target < sensor.t2_load_min_temp) %} # checking for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder2 config (to about 185)                        
          SET_HEATER_TEMPERATURE HEATER=extruder2 TARGET={sensor.t2_load_temp} # set user defined load temperature
          {% set LOAD_TEMP = sensor.t2_load_temp %} # save user set temperature before loading           
         M118 Tool2 heating! 
        {% endif %}     
    {% if (sensor.t2_enable_beep|lower == 'true') %} 
      M300 # beep sound
    {% endif %}
    M118 Tool2 loading!  
    M82           #set extruder2 to absolute mode
    G92 E0
    G4 P1500        # wait for 1.5 seconds
    FORCE_MOVE STEPPER=extruder2 DISTANCE=15 VELOCITY=10 ACCEL=1000  # load filament inside the gears force move needs to be enabled    
    TEMPERATURE_WAIT SENSOR=extruder2 MINIMUM={LOAD_TEMP} # wait for reaching set temperature    
    TEMPERATURE_WAIT SENSOR=extruder2 MINIMUM={USER_TEMP} # wait for reaching set temperature    
    G1 E{sensor.t2_purge_length} F{sensor.t2_purge_speed} # extrude preconfigured purge length
    M400 # wait to complete nozzle purge
    {% if (printer.extruder2.target > 0) %} # checking if a temperature was previous set
      SET_HEATER_TEMPERATURE HEATER=extruder2 TARGET={USER_TEMP} # restore user temp if it was set before loading                     
    {% else %}
      M104 S185 T2 # the hotend will remain warm         
      M118 Tool2 remains warm
    {% endif %} 
    M118 Tool2 load complete!   
    UPDATE_DELAYED_GCODE ID=clear_loadt2busy DURATION=2   
 

#############################################END filament auto load macro section END***********************************************************
#############################################filament auto unload and Tangle macro section*****************************************************************
[gcode_macro unload_tangle_t2]
variable_loadt2busy: 0
gcode:
    {% set sensor = printer['gcode_macro _SENSOR_t2_VARIABLES'] %}
  {% if (printer.print_stats.state == "printing") %} # filament tangle detection during printing  
    {% if(sensor.t2_disable_tangle|lower == 'false') %} # run tangle detection macro if enabled
      filament_tangle_t2   
    {% else %} #filament tangle disabled send message to console
      M118 Filament tangle detected on Tool2, action disabled!
    {% endif %} 
  {% else %} #filament unload button pressed
      #{% if (printer.print_stats.state != "paused" and loadt2busy == 0) %} #enable unload if not printing and not paused
      {% if (loadt2busy == 0) %} #enable unload if not printing 
        {% if(sensor.t2_disable_autounload|lower == 'false') %} # run unload macro if enabled
          unload_Tool2
        {% endif %}
      {% endif %}
  {% endif %}

[gcode_macro unload_Tool2] 
#variable_filamentpresent: 0
gcode:
    ACTIVATE_EXTRUDER EXTRUDER=extruder2
    {% set sensor = printer['gcode_macro _SENSOR_t2_VARIABLES'] %}
      {% if (sensor.t2_enable_beep|lower == 'true') %} 
        M300 # beep sound
      {% endif %}
      M118 Tool2 unloading!    
      M83
      G92 E0     
      {% if (printer.extruder2.can_extrude|lower != 'true')%} # checing for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder2 config (to about 185)
        M118 Tool2 heating!          
        SET_HEATER_TEMPERATURE HEATER=extruder2 TARGET={sensor.t2_unload_temp} # restore user temp if it was set before loading
        TEMPERATURE_WAIT SENSOR=extruder2 MINIMUM={sensor.t2_unload_temp} # wait for reaching configured unload temperature
      {% endif %}
      {% if(printer.extruder2.target == 0) %} # checing for set temperature if is zero than set to 185 / hotend hot but cooling due to set target temp 0
        TEMPERATURE_WAIT SENSOR=extruder2 MINIMUM={sensor.t2_unload_temp} # wait for reaching configured unload temperature
      {% endif %}
      G0 E10 F500 # extruder2 20mm of filament before extracting 
      G0 E-5 F3600 	#extract filament to cold end
      G4 P2000 # wait for two seconds
      G0 E6 F3600 # push the filament back 
      G0 E-10 F3600 	#extract filament to cold end
      G0 E-{sensor.t2_unload_distance} F300	# continue extraction slow allow filament to be cooled enough before reaches the gears  
      #M104 S0 T2 # the hotend will remain warm
      M400 # wait to complete unload
      M118 Tool2 unload complete!    

[gcode_macro filament_tangle_t2] 
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t2_VARIABLES'] %}
  M118 Filament tangle detected on Tool2, print paused!
  M600
  {% if (sensor.t2_enable_beep|lower == 'true') %} 
    M300 # beep sound
  {% endif %}
  M600
    

#############################################END filament auto unload macro section END***********************************************************

[delayed_gcode clear_unloadt2busy]
gcode:
  SET_GCODE_VARIABLE MACRO=unload_Tool2 VARIABLE=unloadt2busy VALUE=0
  #M118 Clear Unload busy! 

[delayed_gcode clear_changet2busy]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_change_state12 VARIABLE=changet2busy VALUE=0
  #M118 Clear Load busy!  

[delayed_gcode clear_loadt2busy]
gcode:
  SET_GCODE_VARIABLE MACRO=unload_tangle_t2 VARIABLE=loadt2busy VALUE=0
  #M118 Clear Load busy!


################################################################################
### SMART SENSORS - T3
################################################################################

#################################################################################################################
################################# Orbiter Sensor CONFIGURATION ##################################################
#################################################################################################################


#### CONFIG BASED ON THE OFICIAL ORBITER Smart SENSOR Config ( Klipper Config/Orbiter2_SmartSensor.cfg // #config file version v3.0.02 // #release date: 22.12.2023 ). https://www.orbiterprojects.com/smart-sensor-for-orbiter-v2/  ####
                          #### Many Thanks to Dr. Róbert Lőrincz for this great project !!! ###

#########Setting Up For More Tools##################

# 'n' is the tool number begining with 0

#1. Copy the Confing and change the name of the config: 'Tn_OrbiterSensor.cfg'
#2. Overall in the config: replace 'T3' with 'Tn'
#3. Overall in the config: replace 't3' with 'tn'
#4. Overall in the config: replace 'Tool3' with 'Tooln'
#5. Overall in the config: replace 'filament_change_state13' with 'filament_change_state13n'
#6. Overall in the config: replace 'filament_change_state23' with 'filament_change_state23n'
#7. Overall in the config: replace  'extruder3' with 'extruder3n' 
#8. Give the corresponding pin for 'filament_switch_sensor' and 'gcode_button unload_Tool3'
#9. Insert the config in 'printer.cfg': [include Tn_OrbiterSensor.cfg]


#################################################################################################################
################################# CHANGE HERE MACRO CONFIGURABLES################################################
#################################################################################################################




#///////////////////////////filament sensor button macros/////////////////////////////////////////////////

[filament_switch_sensor T3_sensor]
switch_pin: Tool3: PB3
pause_on_runout: False
runout_gcode: 
  runnout_init_t3
insert_gcode: startload_Tool3
event_delay: 1.0
pause_delay: 0.1

#********************************************************************************************************

#////////////////////////////////////////Filament Unload macros/////////////////////////////////////////////////
[gcode_button unload_Tool3]
pin: Tool3: PB4 # remove the negation "!" for sensor v1 - use just PA9 as example
press_gcode:  # filament unload procedure
    unload_tangle_t3
release_gcode: # do not add any macro call here

#################################################################################################################################
####################################### DO NOT CHANGE ANYTHING BELOW THIS LINE!!! ###############################################
#################################################################################################################################
####################################### UNLESS YOU KNOW WHAT YOU ARE DOING OR YOU ARE BORED AND NEED TO DO SOMETHING OR YOU ARE ALONE AND NEED SOMETHING TO MESS UP YOUR LIFE OR YOU CAN DO IT BETTER THAN ME OR YOU ARE A REAL SMARTASS OR JUST BECAUSE YOU CAN OR YOU RUN OUT OF BEAR OR HAS NOTHING BETTER TO DO OR ANY UNREASONABLE REASON
#################################################################################################################################

[respond]
default_type: echo

[force_move]
enable_force_move: True

[gcode_macro runnout_init_t3]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% if svv.ttovr == 1 %}
     TTOVER0
    {% elif svv.ttovr == 2 %}
     TTOVER1
    {% elif svv.ttovr == 3 %}
     TTOVER2    
    {% else %}
  ACTIVATE_EXTRUDER EXTRUDER=extruder3
  {% set sensor = printer['gcode_macro _SENSOR_t3_VARIABLES'] %}  
  {% if(sensor.t3_disable_runnout|lower == 'false') %}
      filament_change_state13
  {% else %}
    M118 Filament Tool3 runnout is disabled in the sensor config file!   
  {% endif %}
  {% endif %}

[gcode_macro filament_change_state13]
variable_changet3busy: 0
variable_temp_target: 0
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t3_VARIABLES'] %}  
  {% if changet3busy == 0 %}
    M600 # call printer pause macro          
    M118 Filament Tool3 runnout!       
    {% if (sensor.t3_disable_autochange|lower == 'false') %}
      SET_GCODE_VARIABLE MACRO=filament_change_state13 VARIABLE=changet3busy VALUE=1       
      filament_change_state23   # comment this line if you do not want to automatically unload filament in case there is a runnout detected.
    {% endif %}  
  {% endif %}

[gcode_macro filament_change_state23]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t3_VARIABLES'] %}  
  SET_GCODE_VARIABLE MACRO=unload_tangle_t3 VARIABLE=loadt3busy VALUE=1  
  {% if (sensor.t3_enable_beep|lower == 'true') %} 
    M300 # beep sound
  {% endif %}
  M118 Unloading Tool3 ...   
  M83
  G92 E0   
  # {% if printer[printer.toolhead.extruder3].temperature < 185 %} # hardcoded threshold
  {% if (printer.extruder3.can_extrude|lower != 'true')%} # checing for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder3 config (to about 185)
      M118 Tool3 heating!        
      SET_HEATER_TEMPERATURE HEATER=extruder3 TARGET={sensor.t3_unload_temp} # restore user temp if it was set before loading
      TEMPERATURE_WAIT SENSOR=extruder3 MINIMUM={sensor.t3_unload_temp} #wait for reaching filament unload temp
      {% endif %}     
  {% if(printer.extruder3.target == 0) %} # checing for set temperature if is zero than set to 200 / hotend hot but cooling due to set target temp 0
      SET_HEATER_TEMPERATURE HEATER=extruder3 TARGET={sensor.t3_unload_temp} # restore user temp if it was set before loading
      TEMPERATURE_WAIT SENSOR=extruder3 MINIMUM={sensor.t3_unload_temp} #wait for reaching filament unload temp
  {% endif %} 
  G0 E-5 F3600 	#extract filament to cold end
  G4 P2000 # wait for two seconds
  G0 E5 F3600 # push the filament back 
  G0 E-5 F3600 	#extract filament to cold end
  G0 E-{sensor.t3_unload_distance} F300	# continue extraction slow allow filament to be cooled enough before reaches the gears  
  M400   
  M118 Load new filament in Tool3! Wait until is loaded, then resume printing.  
  SET_HEATER_TEMPERATURE HEATER=extruder3 TARGET=0 # swicth off heater
  UPDATE_DELAYED_GCODE ID=clear_loadt3busy DURATION=0.5
  UPDATE_DELAYED_GCODE ID=clear_changet3busy DURATION=0.5

[gcode_macro startload_Tool3]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t3_VARIABLES'] %}
  {% if (printer.print_stats.state != "printing") %}
    {% if(sensor.t3_disable_autoload|lower == 'false') %}
      SET_GCODE_VARIABLE MACRO=unload_tangle_t3 VARIABLE=loadt3busy VALUE=1
      load_Tool3
    {% else %}
    M118 Filament auto-load is disabled in the sensor config file!   
    {% endif %} 
  {% else %}    
    M118 Printing! Can't load filament right now!    
  {% endif %} 
 # SET_GCODE_VARIABLE MACRO=unload_Tool3 VARIABLE=filamentpresent VALUE=1
  #UPDATE_DELAYED_GCODE ID=clear_changet3busy DURATION=2  

[gcode_macro load_Tool3]
variable_USER_TEMP: 0
variable_LOAD_TEMP: 0
gcode:
    ACTIVATE_EXTRUDER EXTRUDER=extruder3    
    {% set sensor = printer['gcode_macro _SENSOR_t3_VARIABLES'] %}
      {% set USER_TEMP = printer.extruder3.target %} # save user set temperature before loading
      {% set LOAD_TEMP = 0 %} 
      #M118 USER TEMP {USER_TEMP}      # echo back for debug only      
        {% if (printer.extruder3.can_extrude|lower != 'true') or (printer.extruder3.target < sensor.t3_load_min_temp) %} # checking for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder3 config (to about 185)                        
          SET_HEATER_TEMPERATURE HEATER=extruder3 TARGET={sensor.t3_load_temp} # set user defined load temperature
          {% set LOAD_TEMP = sensor.t3_load_temp %} # save user set temperature before loading           
         M118 Tool3 heating! 
        {% endif %}     
    {% if (sensor.t3_enable_beep|lower == 'true') %} 
      M300 # beep sound
    {% endif %}
    M118 Tool3 loading!  
    M82           #set extruder3 to absolute mode
    G92 E0
    G4 P1500        # wait for 1.5 seconds
    FORCE_MOVE STEPPER=extruder3 DISTANCE=15 VELOCITY=10 ACCEL=1000  # load filament inside the gears force move needs to be enabled    
    TEMPERATURE_WAIT SENSOR=extruder3 MINIMUM={LOAD_TEMP} # wait for reaching set temperature    
    TEMPERATURE_WAIT SENSOR=extruder3 MINIMUM={USER_TEMP} # wait for reaching set temperature    
    G1 E{sensor.t3_purge_length} F{sensor.t3_purge_speed} # extrude preconfigured purge length
    M400 # wait to complete nozzle purge
    {% if (printer.extruder3.target > 0) %} # checking if a temperature was previous set
      SET_HEATER_TEMPERATURE HEATER=extruder3 TARGET={USER_TEMP} # restore user temp if it was set before loading                     
    {% else %}
      M104 S185 T3 # the hotend will remain warm         
      M118 Tool3 remains warm
    {% endif %} 
    M118 Tool3 load complete!   
    UPDATE_DELAYED_GCODE ID=clear_loadt3busy DURATION=2   
 

#############################################END filament auto load macro section END***********************************************************
#############################################filament auto unload and Tangle macro section*****************************************************************
[gcode_macro unload_tangle_t3]
variable_loadt3busy: 0
gcode:
    {% set sensor = printer['gcode_macro _SENSOR_t3_VARIABLES'] %}
  {% if (printer.print_stats.state == "printing") %} # filament tangle detection during printing  
    {% if(sensor.t3_disable_tangle|lower == 'false') %} # run tangle detection macro if enabled
      filament_tangle_t3   
    {% else %} #filament tangle disabled send message to console
      M118 Filament tangle detected on Tool3, action disabled!
    {% endif %} 
  {% else %} #filament unload button pressed
      #{% if (printer.print_stats.state != "paused" and loadt3busy == 0) %} #enable unload if not printing and not paused
      {% if (loadt3busy == 0) %} #enable unload if not printing 
        {% if(sensor.t3_disable_autounload|lower == 'false') %} # run unload macro if enabled
          unload_Tool3
        {% endif %}
      {% endif %}
  {% endif %}

[gcode_macro unload_Tool3] 
#variable_filamentpresent: 0
gcode:
    ACTIVATE_EXTRUDER EXTRUDER=extruder3
    {% set sensor = printer['gcode_macro _SENSOR_t3_VARIABLES'] %}
      {% if (sensor.t3_enable_beep|lower == 'true') %} 
        M300 # beep sound
      {% endif %}
      M118 Tool3 unloading!    
      M83
      G92 E0     
      {% if (printer.extruder3.can_extrude|lower != 'true')%} # checing for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder3 config (to about 185)
        M118 Tool3 heating!          
        SET_HEATER_TEMPERATURE HEATER=extruder3 TARGET={sensor.t3_unload_temp} # restore user temp if it was set before loading
        TEMPERATURE_WAIT SENSOR=extruder3 MINIMUM={sensor.t3_unload_temp} # wait for reaching configured unload temperature
      {% endif %}
      {% if(printer.extruder3.target == 0) %} # checing for set temperature if is zero than set to 185 / hotend hot but cooling due to set target temp 0
        TEMPERATURE_WAIT SENSOR=extruder3 MINIMUM={sensor.t3_unload_temp} # wait for reaching configured unload temperature
      {% endif %}
      G0 E10 F500 # extruder3 20mm of filament before extracting 
      G0 E-5 F3600 	#extract filament to cold end
      G4 P2000 # wait for two seconds
      G0 E6 F3600 # push the filament back 
      G0 E-10 F3600 	#extract filament to cold end
      G0 E-{sensor.t3_unload_distance} F300	# continue extraction slow allow filament to be cooled enough before reaches the gears  
      #M104 S0 T3 # the hotend will remain warm
      M400 # wait to complete unload
      M118 Tool3 unload complete!    

[gcode_macro filament_tangle_t3] 
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t3_VARIABLES'] %}
  M118 Filament tangle detected on Tool3, print paused!
  M600
  {% if (sensor.t3_enable_beep|lower == 'true') %} 
    M300 # beep sound
  {% endif %}
  M600
    

#############################################END filament auto unload macro section END***********************************************************

[delayed_gcode clear_unloadt3busy]
gcode:
  SET_GCODE_VARIABLE MACRO=unload_Tool3 VARIABLE=unloadt3busy VALUE=0
  #M118 Clear Unload busy! 

[delayed_gcode clear_changet3busy]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_change_state13 VARIABLE=changet3busy VALUE=0
  #M118 Clear Load busy!  

[delayed_gcode clear_loadt3busy]
gcode:
  SET_GCODE_VARIABLE MACRO=unload_tangle_t3 VARIABLE=loadt3busy VALUE=0
  #M118 Clear Load busy!


################################################################################
### OFFSET CALIBRATION (XYZ Offsets for T1/T2/T3)
################################################################################

#### CONFIG BASED ON THE Klipper-Toolchanger  ( https://github.com/viesturz/klipper-toolchanger // https://github.com/viesturz/klipper-toolchanger/blob/main/examples/calibrate-offsets.cfg  ####
                                                #### Many Thanks to Viesturs Zariņš for this great Klipper Tool !!! ###
                                                
#############################

[xptools_calibrate]
pin: PF2 # BTT M8P V2.0 // PF5 #BTT M8P V1.1
travel_speed: 10  # mms to travel sideways for XY probing
spread: 10 #7  # mms to travel down from top for XY probing
lower_z: 0.3 #0.5  # The speed (in mm/sec) to move tools down onto the probe
speed: 3  # The speed (in mm/sec) to retract between probes
lift_speed: 6  # Z Lift after probing done, should be greater than any Z variance between tools
final_lift_z: 6 
sample_retract_dist: 5
samples_tolerance:0.08
samples:2
samples_result: median # median, average

##################################
# Move print head over probe
##################################

[gcode_macro CALIBRATE_MOVE_OVER_PROBE]
gcode:
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    {% set th = printer.toolhead %}
    {% set active_extruder = th.extruder if th.extruder is defined else "" %}
    BED_MESH_CLEAR
    G90
    G0 Z{xplorer.calp_z} F2000
    {% if active_extruder in ["extruder", "extruder1"] %}
        G0 X{xplorer.calp_x} Y{xplorer.calp_y} F8000
    {% else %}
        G0 X{xplorer.calp_x} Y{xplorer.calp_y - 55} F8000
    {% endif %}

[gcode_macro AUTO_CALIBRATE_tool_offsets]
description: Calibrate offsets for Tool1/2/3 relative to Tool0 using tools_calibrate
gcode:
    {% set svv = printer["save_variables"].variables %}

    M118 === Calibrating ALL tool offsets (T0 baseline) ===
    M118 The nozzles MUST BE PERFECTLY CLEAN !!!

    CHECK_HOME

    ZERO_TOOL_OFFSETS

    # Heat T0 and T1 to probe temp
    M104 T0 S{svv.tprobe}
    M104 T1 S{svv.tprobe}
    SET_HEATER_TEMPERATURE HEATER=extruder  TARGET={svv.tprobe}
    SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET={svv.tprobe}
    TEMPERATURE_WAIT SENSOR=extruder  MINIMUM={svv.tprobe} TIMEOUT=300
    TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={svv.tprobe} TIMEOUT=300

    # Now Heat T2 and T3 to probe temp
    M104 T2 S{svv.tprobe}
    M104 T3 S{svv.tprobe}
    SET_HEATER_TEMPERATURE HEATER=extruder2 TARGET={svv.tprobe}
    SET_HEATER_TEMPERATURE HEATER=extruder3 TARGET={svv.tprobe}
    TEMPERATURE_WAIT SENSOR=extruder2 MINIMUM={svv.tprobe} TIMEOUT=300
    TEMPERATURE_WAIT SENSOR=extruder3 MINIMUM={svv.tprobe} TIMEOUT=300

    # Brush all tools (your T2/T3 brush macros already do the gantry dance)
    Brush_Tool0
    Brush_Tool1
    Brush_Tool2
    Brush_Tool3

    # --- Baseline: Tool0 locate sensor (gantry0/t0) ---
    Tool0
    CALIBRATE_MOVE_OVER_PROBE
    TOOL_LOCATE_SENSOR
    M104 T0 S0

    # --- Tool1 on gantry0/t1 ---
    Tool1
    CALIBRATE_MOVE_OVER_PROBE
    TOOL_CALIBRATE_TOOL_OFFSET
    _save_offsets_t1
    M104 T1 S0
    PARK_extruder1

    # --- Tool2 on gantry1/t2 ---
    # move gantry0 to max
    # move tool1 left ~100mm
    G90
    ACTIVATE_EXTRUDER EXTRUDER=extruder1
    SET_DUAL_CARRIAGE CARRIAGE=gantry0
    SET_DUAL_CARRIAGE CARRIAGE=t1
    G1 X340 Y450 F9000
    # make tool 2 active
    ACTIVATE_EXTRUDER EXTRUDER=extruder2
    SET_DUAL_CARRIAGE CARRIAGE=gantry1
    SET_DUAL_CARRIAGE CARRIAGE=t2

    CALIBRATE_MOVE_OVER_PROBE
    TOOL_CALIBRATE_TOOL_OFFSET
    _save_offsets_t2
    M104 T2 S0
    G28 Y
    G28 X

    # --- Tool3 on gantry1/t3 ---
    # move gantry0 to max
    # move tool0 right ~100mm
    G90
    ACTIVATE_EXTRUDER EXTRUDER=extruder1
    SET_DUAL_CARRIAGE CARRIAGE=gantry0
    SET_DUAL_CARRIAGE CARRIAGE=t0
    G1 X80 Y450 F9000

    # make tool 3 active
    ACTIVATE_EXTRUDER EXTRUDER=extruder3
    SET_DUAL_CARRIAGE CARRIAGE=gantry1
    SET_DUAL_CARRIAGE CARRIAGE=t3

    CALIBRATE_MOVE_OVER_PROBE
    TOOL_CALIBRATE_TOOL_OFFSET
    _save_offsets_t3
    M104 T3 S0
    G28 Y
    G28 X

    M118 === Tool offset calibration complete ===


####################################
# Save Tool1 offsets in variables.cfg
####################################

[gcode_macro _save_offsets_t1]
description: Save the tool offsets into variables.cfg
gcode:
    {% set offsets = printer["xptools_calibrate"].last_result %}
    {% if offsets %}
        {% set x_offset = offsets[0]|round(6) %}
        {% set y_offset = offsets[1]|round(6) %}
        {% set z_offset = (offsets[2] * -1)|round(6) %}
        
        # Save offsets to variables.cfg
        SAVE_VARIABLE VARIABLE=x1offset VALUE={x_offset}
        SAVE_VARIABLE VARIABLE=y1offset VALUE={y_offset}
        SAVE_VARIABLE VARIABLE=z1offset VALUE={z_offset}
        
        # Display confirmation
        M118 Tool1 Offsets were saved: X={x_offset} Y={y_offset} Z={z_offset}
    {% else %}
        M118 Error: No offsets to save. Run TOOL_CALIBRATE_TOOL_OFFSET first.
    {% endif %}

####################################
# Save Tool2 offsets in variables.cfg
####################################

[gcode_macro _save_offsets_t2]
description: Save Tool2 offsets into variables.cfg
gcode:
    {% set offsets = printer["xptools_calibrate"].last_result %}
    {% if offsets %}
        {% set x_offset = offsets[0]|round(6) %}
        {% set y_offset = offsets[1]|round(6) %}
        {% set z_offset = (offsets[2] * -1)|round(6) %}
        SAVE_VARIABLE VARIABLE=x2offset VALUE={x_offset}
        SAVE_VARIABLE VARIABLE=y2offset VALUE={y_offset}
        SAVE_VARIABLE VARIABLE=z2offset VALUE={z_offset}
        M118 Tool2 Offsets saved: X={x_offset} Y={y_offset} Z={z_offset}
    {% else %}
        M118 Error: No offsets to save for Tool2.
    {% endif %}

####################################
# Save Tool3 offsets in variables.cfg
####################################

[gcode_macro _save_offsets_t3]
description: Save Tool3 offsets into variables.cfg
gcode:
    {% set offsets = printer["xptools_calibrate"].last_result %}
    {% if offsets %}
        {% set x_offset = offsets[0]|round(6) %}
        {% set y_offset = offsets[1]|round(6) %}
        {% set z_offset = (offsets[2] * -1)|round(6) %}
        SAVE_VARIABLE VARIABLE=x3offset VALUE={x_offset}
        SAVE_VARIABLE VARIABLE=y3offset VALUE={y_offset}
        SAVE_VARIABLE VARIABLE=z3offset VALUE={z_offset}
        M118 Tool3 Offsets saved: X={x_offset} Y={y_offset} Z={z_offset}
    {% else %}
        M118 Error: No offsets to save for Tool3.
    {% endif %}

###################################
# Calibrate probe offset
###################################
       
[gcode_macro AUTO_CALIBRATE_probe_offset]
variable_x_offset:0     #must be the same with what it is declared in [probe]
variable_y_offset:18.5 #must be the same with what it is declared in [probe]
gcode:
    {% set svv = printer.save_variables.variables %}   
    M104 T0 S{svv.tprobe}
    Tool0
    CHECK_HOME  
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={svv.tprobe}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={svv.tprobe} TIMEOUT=300
    Brush_Tool0
    CALIBRATE_MOVE_OVER_PROBE
    TOOL_LOCATE_SENSOR
    G91
    G1 X{x_offset} Y{y_offset} Z15 F5000
    G90
    BASE_PROBE
    G28 Z    
    _save_offsets_bedprobe
    M104 T0 S0

####################################
# Save bed probe offsets
####################################

[gcode_macro _save_offsets_bedprobe]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set sensor_location = printer["xptools_calibrate"].last_result %}
    {% set probe_z = printer["probe"].last_z_result %}
    {% set pzoff_o = printer.configfile.settings["probe"]["z_offset"]|float %} #current z_offset for the probe
    {% if sensor_location and probe_z is not none %}
        {% set sensor_z = sensor_location[2] %}
        {% set cz_offset = (probe_z - sensor_z + svv.bp_zoff)|round(3) %} # New calculated Z Offset
        {% set z_adjust = (-1*cz_offset + pzoff_o)|round(3) %} # how much must Gcode_offset adjusted in order to get the new z_offset for the probe
        M118 "Stored Probe Z Offset is : {pzoff_o}"
        M118 "New calculated Z Offset is: {cz_offset}"
        SET_GCODE_OFFSET Z={z_adjust}
        Z_OFFSET_APPLY_PROBE
    {% else %}
        M118 "Error: Missing sensor or probe data."
    {% endif %}

####################################
# Zero Offsets
####################################

[gcode_macro ZERO_TOOL_OFFSETS]
gcode:
    {% set svv = printer.save_variables.variables %}
    M118 Zeroing Offsets ...
    SAVE_VARIABLE VARIABLE=x1offset VALUE=0.0
    SAVE_VARIABLE VARIABLE=y1offset VALUE=0.0
    SAVE_VARIABLE VARIABLE=z1offset VALUE=0.0
    SAVE_VARIABLE VARIABLE=x2offset VALUE=0.0
    SAVE_VARIABLE VARIABLE=y2offset VALUE=0.0
    SAVE_VARIABLE VARIABLE=z2offset VALUE=0.0
    SAVE_VARIABLE VARIABLE=x3offset VALUE=0.0
    SAVE_VARIABLE VARIABLE=y3offset VALUE=0.0
    SAVE_VARIABLE VARIABLE=z3offset VALUE=0.0


################################################################################
### POWER LOSS RECOVERY (PLR) - 4 Extruders
################################################################################

#### CONFIG BASED ON https://github.com/Yumi-Lab/YUMI_PLR#

######################################################################

[gcode_macro G31]
gcode:
      RUN_SHELL_COMMAND CMD=clear_plr

[gcode_macro PRINT_LAYER_RESUME]
gcode:
      RUN_SHELL_COMMAND CMD=PRINT_LAYER_RESUME
      
######################################################################

[gcode_shell_command clear_plr]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/xpclear_plr.sh
timeout: 5.

######################################################################
  
[gcode_shell_command POWER_LOSS_RESUME]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/xpplr.sh
timeout: 420.

######################################################################
  
[gcode_shell_command PRINT_LAYER_RESUME]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/xpprint_layer.sh
timeout: 420.



######################################################################

[gcode_macro save_last_file]
gcode:

  {% set svv = printer.save_variables.variables %}

  {% set filepath=printer.virtual_sdcard.file_path %}

  {% set filename=filepath.split('/')%}

  SAVE_VARIABLE VARIABLE=last_file VALUE='"{ filename[-1] }"'
  SAVE_VARIABLE VARIABLE=filepath VALUE='"{ printer.virtual_sdcard.file_path }"'

  M118 Last File: { filename[-1] }

######################################################################

[gcode_macro clear_last_file]
gcode:
  {% set filename='' %}
  {% set filepath='' %}
  SAVE_VARIABLE VARIABLE=last_file VALUE='"{ filename }"'
  SAVE_VARIABLE VARIABLE=filepath VALUE='"{ filepath }"'

######################################################################
[gcode_macro SET_Z_RESUME]
description: Manually set z_pos and reset x_pos/y_pos to zero
gcode:
    {% if 'Z_HEIGHT' in params %}
        {% set z_pos = params.Z_HEIGHT|float %}
        SAVE_VARIABLE VARIABLE=z_pos VALUE={ z_pos }
        SAVE_VARIABLE VARIABLE=x_pos VALUE=210
        SAVE_VARIABLE VARIABLE=y_pos VALUE=240
        SAVE_VARIABLE VARIABLE=xy_resume VALUE=0
        M118 Set resume Z to { z_pos }
    {% else %}
        M118 Error: Missing parameter Z_HEIGHT
    {% endif %}

[gcode_macro RESUME_INTERRUPTED]
description: Resume print after power loss or interruption
gcode:
    G31    
    {% set svv = printer.save_variables.variables %}
    {% set z_height = svv.z_pos|float %}   
    PRINT_LAYER_RESUME
    G4 P2000
    _resume_print Z_HEIGHT={ z_height }
    UPDATE_XY_POS


    
[gcode_macro _resume_print]
description: Internal macro for handling resume logic
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set z_pos = printer.gcode_move.gcode_position.z %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    {% set z_height = params.Z_HEIGHT|float %}
    {% set last_file = params.GCODE_FILE|default(svv.last_file)|string %}

    M140 S{ svv.thb_resume }
    M104 S{ svv.th0_resume } T0
    M104 S{ svv.th1_resume } T1
    M83
    G28
    G90
    G92 E0

    M190 S{ svv.thb_resume } ; wait for bed temp
    M109 S{ svv.th0_resume } T0
    M109 S{ svv.th1_resume } T1

    {% if z_pos <= 395 %}
    G1 Z398 F5000
    apply_zmotors_offsets
    {% endif %}

    {% if svv.e_resume == 0 %}
      Tool0
      SET_FAN_SPEED FAN=Tool_0_partfan SPEED={ svv.t0fan_resume }
      G1 X{xplorer.xrest0} F5000
      G1 E15 F900
      M400
      G4 P2000
      G28 X
      G28 Y
      Tool0
    {% endif %}

    {% if svv.e_resume == 1 %}
      Tool0
      Tool1
      SET_FAN_SPEED FAN=Tool_1_partfan SPEED={ svv.t1fan_resume }
      G1 X{xplorer.xrest1} F5000
      G1 E15 F900
      M400
      G4 P2000
      G28 X
      G28 Y
      Tool1
    {% endif %}

    {% if svv.pmode_resume is not none %}
      {% if svv.pmode_resume == 1 %}
        ACTIVATE_COPY_MODE
      {% elif svv.pmode_resume == 2 %}
        ACTIVATE_MIRROR_MODE
      {% endif %}
    {% endif %}

    {% if svv.ttover_resume is not none %}
      SAVE_VARIABLE VARIABLE=ttovr VALUE={ svv.ttover_resume }
    {% endif %}

    BED_MESH_PROFILE LOAD=default
    SKEW_PROFILE LOAD=SKEW1

    printstart_audio
    M118 Resuming from height: { z_height }
    SET_GCODE_OFFSET Z={ -svv.z_resume + svv.layer_height } MOVE=0
        G90
    G1 X{svv.x_pos} Y{svv.x_pos} F10000
    G1 Z{svv.z_pos} F5000
    M400
    RUN_SHELL_COMMAND CMD=POWER_LOSS_RESUME PARAMS="{ z_height }"
    SDCARD_PRINT_FILE FILENAME=plr/"{ last_file }"

######################################################################

[gcode_macro LOG_ZRESUME]
gcode:
     G90
     G1 Z10 F5000
     G1 X210 Y220 F10000
     BASE_PROBE
     _save_z_resume
     


[gcode_macro _save_z_resume]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set z_probe = printer["probe"].last_z_result %}
    {% set p_offset = printer.configfile.settings["probe"]["z_offset"]|float %} #current z_offset for the probe
    SAVE_VARIABLE VARIABLE=z_resume VALUE={( z_probe - p_offset )|round(3)} 

######################################################################

[gcode_macro LOG_EXTR]
gcode:  
    {% if printer.toolhead.extruder == "extruder" %}
        SAVE_VARIABLE VARIABLE=e_resume VALUE=0  
    {% endif %}
    {% if printer.toolhead.extruder == "extruder1" %}
        SAVE_VARIABLE VARIABLE=e_resume VALUE=1  
    {% endif %}

######################################################################

[gcode_macro LOG_RESUME]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set z_pos = printer.gcode_move.gcode_position.z %}
    #RESPOND MSG="Current Z is { z_pos|round(2) }"
    SAVE_VARIABLE VARIABLE=z_pos VALUE={ z_pos|round(6) }

    {% set t0fan_resume = printer["fan_generic Tool_0_partfan"].speed %}     
    SAVE_VARIABLE VARIABLE=t0fan_resume VALUE={ t0fan_resume|round(2) } 
    {% set t1fan_resume = printer["fan_generic Tool_1_partfan"].speed %}     
    SAVE_VARIABLE VARIABLE=t1fan_resume VALUE={ t1fan_resume|round(2) } 

    {% set th0 = printer.extruder.temperature|round(0) %}
    {% set th1 = printer.extruder1.temperature|round(0) %}
    {% set thb = printer.heater_bed.temperature|round(0) %}
    
     {% if th0 >= 150 %}
      SAVE_VARIABLE VARIABLE=th0_resume VALUE={ th0 }
     {% else %}
      SAVE_VARIABLE VARIABLE=th0_resume VALUE=0
     {% endif %}
     {% if th1 >= 150 %}
      SAVE_VARIABLE VARIABLE=th1_resume VALUE={ th1 }
     {% else %}
      SAVE_VARIABLE VARIABLE=th1_resume VALUE=0
     {% endif %}
    
    SAVE_VARIABLE VARIABLE=thb_resume VALUE={ thb }

    {% if 'pmode' in svv %}
        SAVE_VARIABLE VARIABLE=pmode_resume VALUE={ svv.pmode }
    {% endif %}    

######################################################################

[gcode_macro UPDATE_XY_POS]
description: Save X and Y position to variables.cfg during active print
gcode:
    {% if printer.toolhead is not none and printer.save_variables is not none %}
      {% if printer.print_stats.state == "printing" %}
        {% set pos = printer.toolhead.position %}
        SAVE_VARIABLE VARIABLE=x_pos VALUE={ pos.x|round(3) }
        SAVE_VARIABLE VARIABLE=y_pos VALUE={ pos.y|round(3) }
      {% endif %}
    {% endif %}


[delayed_gcode SAVE_XY_TIMER]
initial_duration: 3
gcode:
    UPDATE_XY_POS
    UPDATE_DELAYED_GCODE ID=SAVE_XY_TIMER DURATION=3


################################################################################
### BASE MACROS
################################################################################

##################################
# Z_TILT_ADJUST
##################################

[gcode_macro Z_TILT_ADJUST]
rename_existing: BASE_Z_TILT_ADJUST
gcode:
    Tool0
    BASE_Z_TILT_ADJUST


####################################
# Save Z-Motors offsets
####################################

[gcode_macro _save_off_motorz]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set mot_z = printer["probe"].last_z_result|round(6) %}
    {% if mot_z is not none %}
    SAVE_VARIABLE VARIABLE=mot_z VALUE={mot_z}
    M118 "Stored Motor Z Offset is : {mot_z}"
    {% else %}
        M118 "Error: Missing probe data."
    {% endif %}

[gcode_macro _save_off_motorz1]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set mot_z1 = printer["probe"].last_z_result|round(6) %}
    {% if mot_z1 is not none %}
    SAVE_VARIABLE VARIABLE=mot_z1 VALUE={mot_z1}
    M118 "Stored Motor Z1 Offset is : {mot_z1}"
    {% else %}
        M118 "Error: Missing probe data."
    {% endif %}

[gcode_macro _save_off_motorz2]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set mot_z2 = printer["probe"].last_z_result|round(6) %}
    {% if mot_z2 is not none %}
    SAVE_VARIABLE VARIABLE=mot_z2 VALUE={mot_z2}
    M118 "Stored Motor Z2 Offset is : {mot_z2}"
    {% else %}
        M118 "Error: Missing probe data."
    {% endif %}    
    
####################################
# Mesh Bed Leveling
####################################

[gcode_macro BED_MESH_CALIBRATE]
rename_existing: BASE_BED_MESH_CALIBRATE
gcode:
      Tool0
      BASE_BED_MESH_CALIBRATE

[gcode_macro Mesh_Leveling]
gcode:
      {% set svv = printer.save_variables.variables %}
      SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={svv.mesh_tmp}
      G28 # Home All
      M190 S{svv.mesh_tmp} # Wait for bed to reach target temperature           
      Z_TILT_ADJUST
      BED_MESH_CALIBRATE PROFILE=default METHOD=automatic # Start probing
      G28 Z

####################################
# Check Homming status
####################################

[gcode_macro CHECK_HOME]
gcode:
    {% set homed_axes = printer.toolhead.homed_axes %}
    {% if "x" not in homed_axes %}
    M118 Home X Axis
    G28 X
    {% endif %}
    {% if "y" not in homed_axes %}
    M118 Home Y Axis
    G28 Y
    {% endif %}
    {% if "z" not in homed_axes %}
    M118 Home Z Axis
    G28 Z
    {% endif %}

##########################################
#POWER ON/OFF
##########################################

[gcode_macro Power_ON]
gcode:
  SET_PIN PIN=Power VALUE=1

[gcode_macro Power_OFF]
gcode:
  SET_PIN PIN=Power VALUE=0

##########################################
#Case Light
##########################################

[gcode_macro CASELIGHT_ON]
description: Helper: Light on
gcode: SET_PIN PIN=caselight VALUE=1
    
[gcode_macro CASELIGHT_OFF]
description: Helper: Light off
gcode:SET_PIN PIN=caselight VALUE=0

##########################################
#Chamber Fan
##########################################

[gcode_macro M141]
gcode:
    SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber_fan" target={params.S}


#######################################
# END_PRINT Power off
#######################################

[gcode_macro END_PRINT_OFF]
gcode:
    M118 Cooling down and then SHUT DOWN
    G4 P180000                                 # wait 3min
    Power_off                                  # power off

    
#####################################################################
# Calibrate Probe Offset
####################################################################

[gcode_macro Calibrate_Probe_Offset]
gcode:
      G28
      G90
      G1 X210 Y200 F5000
      PROBE_CALIBRATE

#########################################
# PID Autotune Bed
########################################

[gcode_macro PID_BED]
 gcode:
       PID_CALIBRATE HEATER=heater_bed TARGET=90

#####################################################################
# ‘Marlin’ style M808 compatibility macro for SDCard looping
#####################################################################

[gcode_macro M808]
gcode:
      {% if params.K is not defined and params.L is defined %}SDCARD_LOOP_BEGIN COUNT={params.L|int}
      {% endif %}
      {% if params.K is not defined and params.L is not defined %}SDCARD_LOOP_END
      {% endif %}
      {% if params.K is defined and params.L is not defined %}SDCARD_LOOP_DESIST
      {% endif %}

#####################################################################
# TFT Controller - Filament unload
#####################################################################

[gcode_macro UNLOAD_FILAMENT]
gcode:
      {% set xplorer = printer['gcode_macro _Xplorer_VARIABLES'] %} 
      M118 Unloading filament...
      M83
      G92 E0 
      M118 Hotend heating!
      G28 X
      G90
      SET_DUAL_CARRIAGE CARRIAGE=0                                                                                 #activate T0
      G1 X100 F5000
      SET_DUAL_CARRIAGE CARRIAGE=1                                                                                 #activate T1
      G1 X333 F5000
      M109 S{xplorer.tmp_uld}                                                                                                 #set temperature and wait      
      G0 E-5 F3600 	                                                                                               #extract filament to cold end
      G4 P2000                                                                                                     #wait for two seconds
      G0 E4.5 F3600                                                                                                #push the filament back 
      G0 E-5 F3600 	                                                                                               #extract filament to cold end
      G0 E{xplorer.fil_uld} F300	                                                                                               #continue extraction slow allow filament to be cooled enough before reaches the gears  
      M400
      M118 Filament unload complete!
      M117 Filament unload complete!
      M104 S0                                                                                                      #turn off the hotend 

#####################################################################
# TFT Controller - Filament load
#####################################################################

[gcode_macro LOAD_FILAMENT]
gcode:
      {% set xplorer = printer['gcode_macro _xplorer_VARIABLES'] %} 
      M118 Loading filament...
      M83
      G92 E0 
      M118 Hotend heating!
      G28 X
      G90
      SET_DUAL_CARRIAGE CARRIAGE=0                                                                                 #activate T0
      G1 X100 F5000
      SET_DUAL_CARRIAGE CARRIAGE=1                                                                                 #activate T1
      G1 X333 F5000
      M109 S{xplorer.tmp_ld}                                                                                                   #set temperature and wait      
      G0 E{xplorer.fil_ld} F400	                                                                                               #Load Filament 
      M400
      M118 Filament load complete!
      M117 Filament load complete!
      M104 S0                                                                                                      #turn off the hotend
      G0 E-5 F3600 	                                                                                               #extract filament to cold end


####################################################################
# SET Power Supply at print end
####################################################################

[gcode_macro SET_POWERSUPPLY_ENDPRINT]
description: Set whatever the printer turns off stays on after the print is ended (ON, OFF)

gcode:
    {% set pwr = params.PWR|default("ON;OFF") %}
    {% set svv = printer.save_variables.variables %}
    {% if pwr == "OFF" %}
    SAVE_VARIABLE VARIABLE=pwrendp VALUE=0
    M118 Printer will shut down after print end
    {% elif pwr == "ON" %}
    SAVE_VARIABLE VARIABLE=pwrendp VALUE=1
    M118 Printer will stay powered after print end
    {% else %}
    M118 Invalid input! Available options are: ON and OFF.
    {% endif %}

####################################################################
# Query Power supply behavior at print end
####################################################################

[gcode_macro QUERY_POWERSUPPLY_ENDPRINT]
gcode:
    {% set svv = printer.save_variables.variables %}
    {%if svv.pwrendp == 0%}
     M118 Printer will shut down after print end
    {%endif%}
    {%if svv.pwrendp == 1%}
     M118 Printer will stay powered after print end
    {%endif%}


################################################################################
### IQEX MACROS (Tool Change, Copy, Mirror, Quad Modes)
################################################################################

####################################
# Probe IQEX
####################################

[gcode_macro PROBE]
rename_existing: BASE_PROBE
variable_probex: 0.0
variable_probey: 0.0
gcode:        
    {% if printer.toolhead.extruder != "extruder" %}
        {% set current_x = printer.toolhead.position.x %}
        {% set current_y = printer.toolhead.position.y %}
        SET_GCODE_VARIABLE MACRO=PROBE VARIABLE=probex VALUE={current_x|float}
        SET_GCODE_VARIABLE MACRO=PROBE VARIABLE=probey VALUE={current_y|float}
        {% if current_x < 20 or current_x > 340 or current_y < 25 or current_y > 400 %}
            M118 Probe Position outside the probing area!
        {% else %}
            T0
            G1 X{current_x} Y{current_y} F10000
            BASE_PROBE
        {% endif %}
    {% else %}
        {% if printer.toolhead.position.x < 20 or printer.toolhead.position.y < 25 or printer.toolhead.position.y > 400 %}
            M118 Probe Position outside the probing area!
        {% else %}
            BASE_PROBE
        {% endif %}
    {% endif %}


###################################
# SET Z-Motors offsets
###################################
       
[gcode_macro set_zmotors_offset]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %} 
    Tool0
    CHECK_HOME  
    G90
    G1 Z10 F5000 
    G1 X{xplorer.dg_mzx} Y{xplorer.dg_mzy} F10000 # Motor Z, reference
    BASE_PROBE  
    _save_off_motorz
    G90
    G1 Z10 F5000 
    G1 X{xplorer.dg_mz1x} Y{xplorer.dg_mz1y} F10000 # Motor Z1,
    BASE_PROBE
    _save_off_motorz1
    G90
    G1 Z10 F5000 
    G1 X{xplorer.dg_mz2x} Y{xplorer.dg_mz2y} F10000 # Motor Z2,
    BASE_PROBE
    _save_off_motorz2
    G1 Z10 F5000 
    G28 X
    G28 Y

####################################
# Apply Z-Motors offsets
####################################

[gcode_macro apply_zmotors_offsets]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}

    {% set mot_z = svv.get("mot_z") %}
    {% set mot_z1 = svv.get("mot_z1") %}
    {% set mot_z2 = svv.get("mot_z2") %}

    {% if mot_z is not none and mot_z1 is not none and mot_z2 is not none %}

    # --- Probe locations ---
    {% set x_z = xplorer.dg_mzx %}
    {% set y_z = xplorer.dg_mzy %}
    {% set x_z1 = xplorer.dg_mz1x %}
    {% set y_z1 = xplorer.dg_mz1y %}
    {% set x_z2 = xplorer.dg_mz2x %}
    {% set y_z2 = xplorer.dg_mz2y %}

    # --- Motor locations ---
    {% set y_z1_motor = 537.5 %}
    {% set x_z2_motor = 481.1 %}

    # --- Calculate projected values at motor positions ---

    # For Z1: slope along Y
    {% set slope_y_z1 = (mot_z1 - mot_z) / (y_z1 - y_z) %}
    {% set projected_z1 = mot_z1 + slope_y_z1 * (y_z1_motor - y_z1) %}
    {% set delta_z1 = ((projected_z1 - mot_z) - 0.3)|round(6) %}  # Fixed 0.25mm offset added

    # For Z2: slope along X
    {% set slope_x_z2 = (mot_z2 - mot_z) / (x_z2 - x_z) %}
    {% set projected_z2 = mot_z2 + slope_x_z2 * (x_z2_motor - x_z2) %}
    {% set delta_z2 = (projected_z2 - mot_z)|round(6) %}

    FORCE_MOVE STEPPER="stepper z1" DISTANCE={delta_z1} VELOCITY=5
    FORCE_MOVE STEPPER="stepper z2" DISTANCE={delta_z2} VELOCITY=5

    M118 Z-motors leveled 

    {% else %}
    M118 Error: One or more Z probe offsets missing. Skipping alignment.
    {% endif %}


##################################
# Park Tool0 IQEX
##################################

[gcode_macro PARK_extruder]
gcode:
    SET_VELOCITY_LIMIT VELOCITY=220 ACCEL=10000
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    SET_DUAL_CARRIAGE CARRIAGE=gantry1
    G1 Y0 F{xplorer.sp_tchy}
	SET_DUAL_CARRIAGE CARRIAGE=gantry0
    SET_DUAL_CARRIAGE CARRIAGE=t0

    {% if svv.shaper_type_xt0 is defined and
          svv.shaper_freq_xt0 is defined and
          svv.shaper_type_yt0 is defined and
          svv.shaper_freq_yt0 is defined %}
        SET_INPUT_SHAPER SHAPER_TYPE_X={svv.shaper_type_xt0} SHAPER_FREQ_X={svv.shaper_freq_xt0} SHAPER_TYPE_Y={svv.shaper_type_yt0} SHAPER_FREQ_Y={svv.shaper_freq_yt0}
    {% endif %}

    SAVE_GCODE_STATE NAME=park0
    G90
	SET_GCODE_OFFSET X=0
    SET_GCODE_OFFSET Y=0
    
    G1 X0 F{xplorer.sp_tch}

    RESTORE_GCODE_STATE NAME=park0

##################################
# Park Tool1 IQEX
##################################

[gcode_macro PARK_extruder1]
gcode:
    SET_VELOCITY_LIMIT VELOCITY=220 ACCEL=10000
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    SET_DUAL_CARRIAGE CARRIAGE=gantry1
    G1 Y0 F{xplorer.sp_tchy}
	SET_DUAL_CARRIAGE CARRIAGE=gantry0
    SET_DUAL_CARRIAGE CARRIAGE=t1

    {% if svv.shaper_type_xt1 is defined and
          svv.shaper_freq_xt1 is defined and
          svv.shaper_type_yt1 is defined and
          svv.shaper_freq_yt1 is defined %}
        SET_INPUT_SHAPER SHAPER_TYPE_X={svv.shaper_type_xt1} SHAPER_FREQ_X={svv.shaper_freq_xt1} SHAPER_TYPE_Y={svv.shaper_type_yt1} SHAPER_FREQ_Y={svv.shaper_freq_yt1}
    {% endif %}

    SAVE_GCODE_STATE NAME=park1
    G90
    SET_GCODE_OFFSET X=0
    SET_GCODE_OFFSET Y=0
    G1 X419 F{xplorer.sp_tch}
    #SET_VELOCITY_LIMIT VELOCITY=220 ACCEL=5000
    #G1 Y0 F{xplorer.sp_tchy}
    RESTORE_GCODE_STATE NAME=park1


##################################
# Park Tool2 IQEX
##################################

[gcode_macro PARK_extruder2]
gcode:
    SET_VELOCITY_LIMIT VELOCITY=220 ACCEL=10000
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    SET_DUAL_CARRIAGE CARRIAGE=gantry0
    G1 Y449 F{xplorer.sp_tchy}
	SET_DUAL_CARRIAGE CARRIAGE=gantry1
    SET_DUAL_CARRIAGE CARRIAGE=t2

    {% if svv.shaper_type_xt2 is defined and
          svv.shaper_freq_xt2 is defined and
          svv.shaper_type_yt2 is defined and
          svv.shaper_freq_yt2 is defined %}
        SET_INPUT_SHAPER SHAPER_TYPE_X={svv.shaper_type_xt2} SHAPER_FREQ_X={svv.shaper_freq_xt2} SHAPER_TYPE_Y={svv.shaper_type_yt2} SHAPER_FREQ_Y={svv.shaper_freq_yt2}
    {% endif %}

    SAVE_GCODE_STATE NAME=park3
    G90
	SET_GCODE_OFFSET X=0
    SET_GCODE_OFFSET Y=0
    G1 X0 F{xplorer.sp_tch}
    #SET_VELOCITY_LIMIT VELOCITY=220 ACCEL=5000
    #G1 Y449 F{xplorer.sp_tchy}
    RESTORE_GCODE_STATE NAME=park3   


##################################
# Park Tool3 IQEX
##################################

[gcode_macro PARK_extruder3]
gcode:
     SET_VELOCITY_LIMIT VELOCITY=220 ACCEL=10000
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %} 
    SET_DUAL_CARRIAGE CARRIAGE=gantry0
    G1 Y449 F{xplorer.sp_tchy}
	SET_DUAL_CARRIAGE CARRIAGE=gantry1
    SET_DUAL_CARRIAGE CARRIAGE=t3

    {% if svv.shaper_type_xt3 is defined and
          svv.shaper_freq_xt3 is defined and
          svv.shaper_type_yt3 is defined and
          svv.shaper_freq_yt3 is defined %}
        SET_INPUT_SHAPER SHAPER_TYPE_X={svv.shaper_type_xt3} SHAPER_FREQ_X={svv.shaper_freq_xt3} SHAPER_TYPE_Y={svv.shaper_type_yt3} SHAPER_FREQ_Y={svv.shaper_freq_yt3}
    {% endif %}

    SAVE_GCODE_STATE NAME=park3
    G90
    SET_GCODE_OFFSET X=0
    SET_GCODE_OFFSET Y=0   
    G1 X419 F{xplorer.sp_tch}
    #SET_VELOCITY_LIMIT VELOCITY=220 ACCEL=5000
    #G1 Y0 F{xplorer.sp_tchy}
    RESTORE_GCODE_STATE NAME=park3
 

##################################
# Activate Tool0 
##################################

[gcode_macro Tool0]
gcode:
    SET_GCODE_OFFSET X=0 Y=0 Z=0
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    G1 F{xplorer.sp_tch}
    {% if printer.toolhead.extruder != "extruder" %}
        PARK_extruder1
        PARK_extruder2
        PARK_extruder3
    {% endif %}    
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SET_DUAL_CARRIAGE CARRIAGE=gantry0
    SET_DUAL_CARRIAGE CARRIAGE=t0
    SET_INPUT_SHAPER SHAPER_TYPE_X={svv.shaper_type_xt0} SHAPER_FREQ_X={svv.shaper_freq_xt0} SHAPER_TYPE_Y={svv.shaper_type_yt0} SHAPER_FREQ_Y={svv.shaper_freq_yt0}
    SET_GCODE_OFFSET X=0 Y=0 Z=0

[gcode_macro T0]
gcode:

##################################
# Activate Tool1
##################################

[gcode_macro Tool1]
gcode:
     SET_GCODE_OFFSET X=0 Y=0 Z=0
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}    
    G1 F{xplorer.sp_tch}
    {% if printer.toolhead.extruder != "extruder1" %}
        PARK_extruder
        PARK_extruder2
        PARK_extruder3
    {% endif %}
    ACTIVATE_EXTRUDER EXTRUDER=extruder1
    SET_DUAL_CARRIAGE CARRIAGE=gantry0
    SET_DUAL_CARRIAGE CARRIAGE=t1
    
    {% if svv.shaper_type_xt1 is defined and
          svv.shaper_freq_xt1 is defined and
          svv.shaper_type_yt1 is defined and
          svv.shaper_freq_yt1 is defined %}
        SET_INPUT_SHAPER SHAPER_TYPE_X={svv.shaper_type_xt1} SHAPER_FREQ_X={svv.shaper_freq_xt1} SHAPER_TYPE_Y={svv.shaper_type_yt1} SHAPER_FREQ_Y={svv.shaper_freq_yt1}
    {% endif %}
    
    SET_GCODE_OFFSET X={svv.x1offset} Y={svv.y1offset} Z={svv.z1offset}

    
[gcode_macro T1]
gcode:

##################################
# Activate Tool2
##################################

[gcode_macro Tool2]
gcode:
     SET_GCODE_OFFSET X=0 Y=0 Z=0
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}    
    G1 F{xplorer.sp_tch}
    {% if printer.toolhead.extruder != "extruder2" %}
        PARK_extruder
        PARK_extruder1
        PARK_extruder3
    {% endif %}
    ACTIVATE_EXTRUDER EXTRUDER=extruder2
    SET_DUAL_CARRIAGE CARRIAGE=gantry1
    SET_DUAL_CARRIAGE CARRIAGE=t2
    
    {% if svv.shaper_type_xt2 is defined and
          svv.shaper_freq_xt2 is defined and
          svv.shaper_type_yt2 is defined and
          svv.shaper_freq_yt2 is defined %}
        SET_INPUT_SHAPER SHAPER_TYPE_X={svv.shaper_type_xt2} SHAPER_FREQ_X={svv.shaper_freq_xt2} SHAPER_TYPE_Y={svv.shaper_type_yt2} SHAPER_FREQ_Y={svv.shaper_freq_yt2}
    {% endif %}
    
    #SET_GCODE_OFFSET X={svv.x2offset} Y={svv.y2offset - xplorer.y_off_dg} Z={svv.z2offset}
    SET_GCODE_OFFSET X={svv.x2offset} Y={svv.y2offset} Z={svv.z2offset}

    
[gcode_macro T2]
gcode:

##################################
# Activate Tool3
##################################

[gcode_macro Tool3]
gcode:
    SET_GCODE_OFFSET X=0 Y=0 Z=0
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}    
    G1 F{xplorer.sp_tch}
    {% if printer.toolhead.extruder != "extruder3" %}
        PARK_extruder
        PARK_extruder1
        PARK_extruder2
    {% endif %}
    ACTIVATE_EXTRUDER EXTRUDER=extruder3
    SET_DUAL_CARRIAGE CARRIAGE=gantry1
    SET_DUAL_CARRIAGE CARRIAGE=t3
    
    {% if svv.shaper_type_xt3 is defined and
          svv.shaper_freq_xt3 is defined and
          svv.shaper_type_yt3 is defined and
          svv.shaper_freq_yt3 is defined %}
        SET_INPUT_SHAPER SHAPER_TYPE_X={svv.shaper_type_xt3} SHAPER_FREQ_X={svv.shaper_freq_xt3} SHAPER_TYPE_Y={svv.shaper_type_yt3} SHAPER_FREQ_Y={svv.shaper_freq_yt3}
    {% endif %}
    
    #SET_GCODE_OFFSET X={svv.x3offset} Y={svv.y3offset - xplorer.y_off_dg} Z={svv.z3offset}
    SET_GCODE_OFFSET X={svv.x3offset} Y={svv.y3offset} Z={svv.z3offset}

    
[gcode_macro T3]
gcode:

####################################################################
# Copy Mode IQEX T0/T1
####################################################################

[gcode_macro ACTIVATE_COPY_MODE01]
gcode:
    M118 Activating COPY mode T0 / T1
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %} 
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=gantry0 MODE=PRIMARY
    G1 X0 F{xplorer.sp_pmode}   
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=PRIMARY
    G1 X{xplorer.x_cop_idex}
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=COPY    
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder
    SAVE_VARIABLE VARIABLE=pmode VALUE=1
    
    {% if svv.shaper_type_xidexcp is defined and
          svv.shaper_freq_xidexcp is defined and
          svv.shaper_type_yidexcp is defined and
          svv.shaper_freq_yidexcp is defined %}
        SET_INPUT_SHAPER SHAPER_TYPE_X={svv.shaper_type_xidexcp} SHAPER_FREQ_X={svv.shaper_freq_xidexcp} SHAPER_TYPE_Y={svv.shaper_type_yidexcp} SHAPER_FREQ_Y={svv.shaper_freq_yidexcp}
    {% endif %}

####################################################################
# MIRROR Mode IQEX T0/T1
####################################################################

[gcode_macro ACTIVATE_MIRROR_MODE01]
gcode:
    M118 Activating MIRROR mode T0 / T1
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %} 
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=gantry0 MODE=PRIMARY
    G1 X0 F{xplorer.sp_pmode}   
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=PRIMARY
    G1 X{xplorer.x_mir_idex}
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=MIRROR    
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder
    SAVE_VARIABLE VARIABLE=pmode VALUE=2
    
    {% if svv.shaper_type_xidexmr is defined and
          svv.shaper_freq_xidexmr is defined and
          svv.shaper_type_yidexmr is defined and
          svv.shaper_freq_yidexmr is defined %}
        SET_INPUT_SHAPER SHAPER_TYPE_X={svv.shaper_type_xidexmr} SHAPER_FREQ_X={svv.shaper_freq_xidexmr} SHAPER_TYPE_Y={svv.shaper_type_yidexmr} SHAPER_FREQ_Y={svv.shaper_freq_yidexmr}
    {% endif %}




####################################################################
# Copy Mode IQEX T0/T1 T2 T3
####################################################################

[gcode_macro ACTIVATE_COPY_MODE0123]
gcode:
    M118 Activating COPY mode T0 / T1 T2 T3
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=gantry0 MODE=PRIMARY
    G1 X0 F{xplorer.sp_pmode}
    G1 Y400 F{xplorer.sp_tchy}    
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=PRIMARY   
    G1 X{xplorer.x_cop_idex}
    SET_DUAL_CARRIAGE CARRIAGE=t3 MODE=PRIMARY   
    G1 X{xplorer.x_cop_idex}
    SET_DUAL_CARRIAGE CARRIAGE=gantry1 MODE=PRIMARY 
    G1 Y{xplorer.y_cop_dg} F{xplorer.sp_tchy}

    SET_DUAL_CARRIAGE CARRIAGE=gantry0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=gantry1 MODE=COPY 
    
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=COPY 
    SET_DUAL_CARRIAGE CARRIAGE=t2 MODE=COPY    
    SET_DUAL_CARRIAGE CARRIAGE=t3 MODE=COPY 

    
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder2 MOTION_QUEUE=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder3 MOTION_QUEUE=extruder
    
    SAVE_VARIABLE VARIABLE=pmode VALUE=3
    
    {% if svv.shaper_type_xiqexcp is defined and
          svv.shaper_freq_xiqexcp is defined and
          svv.shaper_type_yiqexcp is defined and
          svv.shaper_freq_yiqexcp is defined %}
        SET_INPUT_SHAPER SHAPER_TYPE_X={svv.shaper_type_xiqexcp} SHAPER_FREQ_X={svv.shaper_freq_xiqexcp} SHAPER_TYPE_Y={svv.shaper_type_yiqexcp} SHAPER_FREQ_Y={svv.shaper_freq_yiqexcp}
    {% endif %}

####################################################################
# Copy Mode IQEX T0/T1 T2 T3
####################################################################

[gcode_macro ACTIVATE_COPY_MODE012]
gcode:
    M118 Activating COPY mode T0 / T1 T2 
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=gantry0 MODE=PRIMARY
    G1 X0 F{xplorer.sp_pmode}
    G1 Y400 F{xplorer.sp_tchy}    
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=PRIMARY   
    G1 X{xplorer.x_cop_idex}
    SET_DUAL_CARRIAGE CARRIAGE=t2 MODE=PRIMARY   
    G1 X210
    SET_DUAL_CARRIAGE CARRIAGE=gantry1 MODE=PRIMARY 
    G1 Y{xplorer.y_cop_dg} F{xplorer.sp_tchy}

    SET_DUAL_CARRIAGE CARRIAGE=gantry0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=gantry1 MODE=COPY 
    
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=COPY 
    SET_DUAL_CARRIAGE CARRIAGE=t2 MODE=COPY    
    #SET_DUAL_CARRIAGE CARRIAGE=t3 MODE=COPY 

    
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder2 MOTION_QUEUE=extruder
    #SYNC_EXTRUDER_MOTION EXTRUDER=extruder3 MOTION_QUEUE=extruder
    
    SAVE_VARIABLE VARIABLE=pmode VALUE=3
    
    {% if svv.shaper_type_xiqexcp is defined and
          svv.shaper_freq_xiqexcp is defined and
          svv.shaper_type_yiqexcp is defined and
          svv.shaper_freq_yiqexcp is defined %}
        SET_INPUT_SHAPER SHAPER_TYPE_X={svv.shaper_type_xiqexcp} SHAPER_FREQ_X={svv.shaper_freq_xiqexcp} SHAPER_TYPE_Y={svv.shaper_type_yiqexcp} SHAPER_FREQ_Y={svv.shaper_freq_yiqexcp}
    {% endif %}


####################################################################
# Mirror Mode IQEX T0 T1 / T2 T3
####################################################################

[gcode_macro ACTIVATE_MIRROR_MODE0123]
gcode:
    M118 Activating COPY mode T0 T1 / T2 T3
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=gantry0 MODE=PRIMARY
    G1 X0 F{xplorer.sp_pmode}
    G1 Y400 F{xplorer.sp_tchy}    
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=PRIMARY   
    G1 X{xplorer.x_cop_idex}
    SET_DUAL_CARRIAGE CARRIAGE=t3 MODE=PRIMARY   
    G1 X{xplorer.x_cop_idex}
    SET_DUAL_CARRIAGE CARRIAGE=gantry1 MODE=PRIMARY 
    G1 Y{xplorer.y_mir_dg} F{xplorer.sp_tchy}

    SET_DUAL_CARRIAGE CARRIAGE=gantry0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=gantry1 MODE=MIRROR 
    
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=COPY 
    SET_DUAL_CARRIAGE CARRIAGE=t2 MODE=COPY    
    SET_DUAL_CARRIAGE CARRIAGE=t3 MODE=COPY 
    
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder2 MOTION_QUEUE=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder3 MOTION_QUEUE=extruder
    
    SAVE_VARIABLE VARIABLE=pmode VALUE=4
    
    {% if svv.shaper_type_xidexmr is defined and
          svv.shaper_freq_xidexmr is defined and
          svv.shaper_type_yidexmr is defined and
          svv.shaper_freq_yidexmr is defined %}
        SET_INPUT_SHAPER SHAPER_TYPE_X={svv.shaper_type_xidexmr} SHAPER_FREQ_X={svv.shaper_freq_xidexmr} SHAPER_TYPE_Y={svv.shaper_type_yidexmr} SHAPER_FREQ_Y={svv.shaper_freq_yidexmr}
    {% endif %}
    
####################################################################
# Normal Mode IQEX
####################################################################

[gcode_macro ACTIVATE_PRIMARY_MODE]
gcode:
    M118 Activating PRIMARY Printing Mode !
    {% set svv = printer.save_variables.variables %}

    SYNC_EXTRUDER_MOTION EXTRUDER=extruder  MOTION_QUEUE=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder2 MOTION_QUEUE=extruder2
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder3 MOTION_QUEUE=extruder3

    # Set all carriages to PRIMARY mode so any tool can be used next
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t2 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t3 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=gantry0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=gantry1 MODE=PRIMARY
    SAVE_VARIABLE VARIABLE=pmode VALUE=0
    
    PARK_extruder1
    PARK_extruder2
    PARK_extruder3
    Tool0

####################################################################
# Set variables at startup
####################################################################

[delayed_gcode var_startup]
initial_duration: 1
gcode:    
    _SET_TIMELAPSE_SETUP PARK_ENABLE=True PARK_POS=custom CUSTOM_POS_Y=120
    SAVE_VARIABLE VARIABLE=pmode VALUE=0
    SAVE_VARIABLE VARIABLE=ttovr VALUE=0
    SAVE_VARIABLE VARIABLE=xy_resume VALUE=1
    SKEW_PROFILE LOAD=SKEW0

####################################################################
# Query wich printing mode is active
####################################################################

[gcode_macro QUERY_PRINTING_MODE]
gcode:
    {% set svv = printer.save_variables.variables %}
    {%if svv.pmode == 0%}
     M118 PRIMARY Printing Mode is activated for the next print!
    {%endif%}
    {%if svv.pmode == 1%}
     M118 T1 COPY T0 Printing Mode is activated for the next print!
   {%endif%}
    {%if svv.pmode == 2%}
     M118 T1 MIRROR T0 Printing Mode is activated for the next print!
   {%endif%}
   {%if svv.pmode == 3%}
     M118 T1,T2, T3 COPY T0 Printing Mode is activated for the next print!
   {%endif%}
   {%if svv.pmode == 4%}
     M118 T2,T3 MIRROR T0 T1 Printing Mode is activated for the next print!
   {%endif%}

####################################################################
# Start print mode
####################################################################

[gcode_macro START_PRINTING_MODE]
gcode:
    {% set svv = printer.save_variables.variables %}
    {%if svv.pmode == 0%}
     M118 PRIMARY Printing Mode is active
     #ACTIVATE_PRIMARY_MODE
    {%endif%}
    {%if svv.pmode == 1%}
     ACTIVATE_COPY_MODE01
   {%endif%}
    {%if svv.pmode == 2%}
     ACTIVATE_MIRROR_MODE01
   {%endif%}
   {%if svv.pmode == 3%}
     ACTIVATE_COPY_MODE0123
   {%endif%}
    {%if svv.pmode == 4%}
     ACTIVATE_MIRROR_MODE0123
   {%endif%}
   
####################################################################
# SET print mode
####################################################################

[gcode_macro SET_PRINT_MODE]
description: Set the printing mode (PRIMARY, COPY01, MIRROR01, COPY0123, MIRROR0123)

gcode:
    {% set mode = params.MODE|default("PRIMARY; COPY01; MIRROR01; COPY0123; MIRROR0123") %}
    {% set svv = printer.save_variables.variables %}
    {% if mode == "PRIMARY" %}
    SAVE_VARIABLE VARIABLE=pmode VALUE=0
    M118 Print Mode: PRIMARY
    {% elif mode == "COPY01" %}
    {% if svv.ttovr == 1 or svv.ttovr == 2 or svv.ttovr == 3 or svv.ttovr == 3   %}
    M118 COPY Mode is not compatible with Toolhead take over strategy !!!
    {% else %}
    SAVE_VARIABLE VARIABLE=pmode VALUE=1
    M118 Print Mode: T1 COPY T0
    {% endif %}
    {% elif mode == "MIRROR01" %}
    {% if svv.ttovr == 1 or svv.ttovr == 2 or svv.ttovr == 3 or svv.ttovr == 3   %}
    M118 MIRROR Mode is not compatible with Toolhead take over strategy !!!
    {% else %}
    SAVE_VARIABLE VARIABLE=pmode VALUE=2
    M118 Print Mode: T1 MIRROR T0
    {% elif mode == "COPY0123" %}
    {% if svv.ttovr == 1 or svv.ttovr == 2 or svv.ttovr == 3 or svv.ttovr == 3   %}
    M118 COPY Mode is not compatible with Toolhead take over strategy !!!
    {% else %}
    SAVE_VARIABLE VARIABLE=pmode VALUE=3
    M118 Print Mode: T1, T2, T3 COPY T0
    {% endif %}
    {% elif mode == "MIRROR0123" %}
    {% if svv.ttovr == 1 or svv.ttovr == 2 or svv.ttovr == 3 or svv.ttovr == 3   %}
    M118 MIRROR Mode is not compatible with Toolhead take over strategy !!!
    {% else %}
    SAVE_VARIABLE VARIABLE=pmode VALUE=4
    M118 Print Mode: T1, T2, T3 MIRROR T0
    
    {% endif %}
    {% else %}
    M118 Invalid Print Mode! Available printing modes are: PRIMARY (default), COPY01, MIRROR01, COPY0123 and MIRROR0123.
    {% endif %}

####################################################################
# SET Toolhead Takeover
####################################################################

[gcode_macro SET_PRINT_MODE]
description: Set the printing mode (PRIMARY, COPY01, MIRROR01, COPY0123, MIRROR0123)
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set ttovr = svv.ttovr|default(0)|int %}
    {% set mode = (params.MODE|default("PRIMARY"))|upper %}
    {% set allowed = ["PRIMARY","COPY01","MIRROR01","COPY0123","MIRROR0123"] %}

    {% if mode not in allowed %}
        M118 Invalid Print Mode! Available modes: PRIMARY (default), COPY01, MIRROR01, COPY0123, MIRROR0123.
    {% elif mode == "PRIMARY" %}
        SAVE_VARIABLE VARIABLE=pmode VALUE=0
        M118 Print Mode: PRIMARY

    {% elif mode == "COPY01" %}
        {% if ttovr in [1,2,3] %}
            M118 COPY Mode is not compatible with Toolhead take over strategy !!!
        {% else %}
            SAVE_VARIABLE VARIABLE=pmode VALUE=1
            M118 Print Mode: T1 COPY T0
        {% endif %}

    {% elif mode == "MIRROR01" %}
        {% if ttovr in [1,2,3] %}
            M118 MIRROR Mode is not compatible with Toolhead take over strategy !!!
        {% else %}
            SAVE_VARIABLE VARIABLE=pmode VALUE=2
            M118 Print Mode: T1 MIRROR T0
        {% endif %}

    {% elif mode == "COPY0123" %}
        {% if ttovr in [1,2,3] %}
            M118 COPY Mode is not compatible with Toolhead take over strategy !!!
        {% else %}
            SAVE_VARIABLE VARIABLE=pmode VALUE=3
            M118 Print Mode: T1, T2, T3 COPY T0
        {% endif %}

    {% elif mode == "MIRROR0123" %}
        {% if ttovr in [1,2,3] %}
            M118 MIRROR Mode is not compatible with Toolhead take over strategy !!!
        {% else %}
            SAVE_VARIABLE VARIABLE=pmode VALUE=4
            M118 Print Mode:  T2, T3 MIRROR T0, T1
        {% endif %}
    {% endif %}

####################################################################
# SET Toolhead Takeover
####################################################################

[gcode_macro SET_TOOLHEAD_TAKEOVER]
description: Set the Toolhead takeover strategy when filament runs out

gcode:
    {% set toolhead = params.TOOLHEAD|default("None;Tool0;Tool1;Tool2;Tool3") %}
    {% set svv = printer.save_variables.variables %}

    {% if toolhead == "None" %}
        SAVE_VARIABLE VARIABLE=ttovr VALUE=0
        SAVE_VARIABLE VARIABLE=ttover_resume VALUE=0
        M118 When filament runs out, no toolhead will take over.

    {% elif toolhead == "Tool0" %}
        {% if svv.pmode == 1 or svv.pmode == 2 %}
            M118 Toolhead takeover is not compatible with COPY and MIRROR mode!
        {% else %}
            SAVE_VARIABLE VARIABLE=ttovr VALUE=1
            SAVE_VARIABLE VARIABLE=ttover_resume VALUE=1
            M118 When filament runs out on Tool1/Tool2/Tool3, Tool0 will take over.
        {% endif %}

    {% elif toolhead == "Tool1" %}
        {% if svv.pmode == 1 or svv.pmode == 2 %}
            M118 Toolhead takeover is not compatible with COPY and MIRROR mode!
        {% else %}
            SAVE_VARIABLE VARIABLE=ttovr VALUE=2
            SAVE_VARIABLE VARIABLE=ttover_resume VALUE=2
            M118 When filament runs out on Tool0/Tool2/Tool3, Tool1 will take over.
        {% endif %}

    {% elif toolhead == "Tool2" %}
        {% if svv.pmode == 1 or svv.pmode == 2 %}
            M118 Toolhead takeover is not compatible with COPY and MIRROR mode!
        {% else %}
            SAVE_VARIABLE VARIABLE=ttovr VALUE=3
            SAVE_VARIABLE VARIABLE=ttover_resume VALUE=3
            M118 When filament runs out on Tool0/Tool1/Tool3, Tool2 will take over.
        {% endif %}

    {% elif toolhead == "Tool3" %}
        {% if svv.pmode == 1 or svv.pmode == 2 %}
            M118 Toolhead takeover is not compatible with COPY and MIRROR mode!
        {% else %}
            SAVE_VARIABLE VARIABLE=ttovr VALUE=4
            SAVE_VARIABLE VARIABLE=ttover_resume VALUE=4
            M118 When filament runs out on Tool0/Tool1/Tool2, Tool3 will take over.
        {% endif %}

    {% else %}
        M118 Invalid input! Available options: None, Tool0, Tool1, Tool2, Tool3.
    {% endif %}


####################################################################
# Query Toolhead Takeover
####################################################################

[gcode_macro QUERY_TOOLHEAD_TAKEOVER]
gcode:
    {% set svv = printer.save_variables.variables %}
    {%if svv.ttovr == 0%}
    M118 NO Toolhead take over strategy is activated!
    {%endif%}
    {%if svv.ttovr == 1%}
    M118 IF  filament run out, then Tool0 will take over and continue the print
   {%endif%}
    {%if svv.ttovr == 2%}
    M118 IF  filament run out, then Tool1 will take over and continue the print
   {%endif%}
    {%if svv.ttovr == 3%}
    M118 IF  filament run out, then Tool2 will take over and continue the print
   {%endif%}
    {%if svv.ttovr == 4%}
    M118 IF  filament run out, then Tool3 will take over and continue the print
   {%endif%}

######################################################################
# Toolhead 0 Takeover
######################################################################

[gcode_macro TTOVER0]
variable_zhop: 0
variable_e1temp: 0
variable_e2temp: 0
variable_e3temp: 0

gcode:
    M118 Tool0 is taking over and continues the print...

    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    {% set s1 = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}
    {% set s2 = printer['gcode_macro _SENSOR_t2_VARIABLES'] %}
    {% set s3 = printer['gcode_macro _SENSOR_t3_VARIABLES'] %}

    {% set zhop = params.Z|default(10)|float %}
    {% set zmax = printer.toolhead.axis_maximum.z %}
    {% set current_z = printer.gcode_move.position.z %}
    {% set paused = printer['pause_resume'].is_paused %}

    {% if printer['extruder1'] is defined %}
        {% set e1temp = printer['extruder1'].target|int %}
    {% else %}
        {% set e1temp = 0 %}
    {% endif %}
    {% if printer['extruder2'] is defined %}
        {% set e2temp = printer['extruder2'].target|int %}
    {% else %}
        {% set e2temp = 0 %}
    {% endif %}
    {% if printer['extruder3'] is defined %}
        {% set e3temp = printer['extruder3'].target|int %}
    {% else %}
        {% set e3temp = 0 %}
    {% endif %}

    {% set active = printer.toolhead.extruder %}

    {% if not paused %}
        SAVE_GCODE_STATE NAME=TTOVER0

        SET_GCODE_VARIABLE MACRO=TTOVER0 VARIABLE=zhop VALUE={zhop}
        SET_GCODE_VARIABLE MACRO=TTOVER0 VARIABLE=e1temp VALUE={e1temp}
        SET_GCODE_VARIABLE MACRO=TTOVER0 VARIABLE=e2temp VALUE={e2temp}
        SET_GCODE_VARIABLE MACRO=TTOVER0 VARIABLE=e3temp VALUE={e3temp}

        {% if active == 'extruder1' %}
            {% set takeover_temp = e1temp %}
        {% elif active == 'extruder2' %}
            {% set takeover_temp = e2temp %}
        {% elif active == 'extruder3' %}
            {% set takeover_temp = e3temp %}
        {% else %}
            {% set takeover_temp = 0 %}
        {% endif %}

        {% if current_z + zhop < zmax %}
            G91
            G1 Z{zhop} F900
            G90
        {% else %}
            M118 Z-hop too high — skipping Z lift
            SET_GCODE_VARIABLE MACRO=TTOVER0 VARIABLE=zhop VALUE=0
        {% endif %}

        {% if active == 'extruder1' %}
            PARK_extruder1
            G91
            G0 E-{s1.t1_unload_distance} F300
            M400
            SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET=0
            G90
        {% elif active == 'extruder2' %}
            PARK_extruder2
            G91
            G0 E-{s2.t2_unload_distance} F300
            M400
            SET_HEATER_TEMPERATURE HEATER=extruder2 TARGET=0
            G90
        {% elif active == 'extruder3' %}
            PARK_extruder3
            G91
            G0 E-{s3.t3_unload_distance} F300
            M400
            SET_HEATER_TEMPERATURE HEATER=extruder3 TARGET=0
            G90
        {% endif %}

        Tool0

        {% if takeover_temp > 0 %}
            SET_HEATER_TEMPERATURE HEATER=extruder TARGET={takeover_temp}
            M118 Heating Tool0 to {takeover_temp}°C
            M109 T0 S{takeover_temp}
        {% else %}
            M118 No takeover temperature found; skipping Tool0 heat
        {% endif %}

        {% if xplorer is defined and xplorer.xrest0 is defined %}
            G1 X{xplorer.xrest0} F5000
        {% endif %}

        M83
        G1 E30 F900
        M400
        PARK_extruder
        RESTORE_GCODE_STATE NAME=TTOVER0 MOVE=1 MOVE_SPEED=100
        Tool0
    {% else %}
        M118 Cannot make the takeover while paused!
    {% endif %}


######################################################################
# Toolhead 1 Takeover
######################################################################

[gcode_macro TTOVER1]
variable_zhop: 0
variable_e0temp: 0
variable_e1temp: 0
variable_e2temp: 0
variable_e3temp: 0

gcode:
    M118 Tool1 is taking over and continues the print...

    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    {% set s0 = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}
    {% set s1 = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}
    {% set s2 = printer['gcode_macro _SENSOR_t2_VARIABLES'] %}
    {% set s3 = printer['gcode_macro _SENSOR_t3_VARIABLES'] %}

    {% set zhop = params.Z|default(10)|float %}
    {% set zmax = printer.toolhead.axis_maximum.z %}
    {% set current_z = printer.gcode_move.position.z %}
    {% set paused = printer['pause_resume'].is_paused %}

    {% if printer['extruder'] is defined %}
        {% set e0temp = printer['extruder'].target|int %}
    {% else %}
        {% set e0temp = 0 %}
    {% endif %}
    {% if printer['extruder1'] is defined %}
        {% set e1temp = printer['extruder1'].target|int %}
    {% else %}
        {% set e1temp = 0 %}
    {% endif %}
    {% if printer['extruder2'] is defined %}
        {% set e2temp = printer['extruder2'].target|int %}
    {% else %}
        {% set e2temp = 0 %}
    {% endif %}
    {% if printer['extruder3'] is defined %}
        {% set e3temp = printer['extruder3'].target|int %}
    {% else %}
        {% set e3temp = 0 %}
    {% endif %}

    {% set active = printer.toolhead.extruder %}

    {% if not paused %}
        SAVE_GCODE_STATE NAME=TTOVER1

        SET_GCODE_VARIABLE MACRO=TTOVER1 VARIABLE=zhop VALUE={zhop}
        SET_GCODE_VARIABLE MACRO=TTOVER1 VARIABLE=e0temp VALUE={e0temp}
        SET_GCODE_VARIABLE MACRO=TTOVER1 VARIABLE=e1temp VALUE={e1temp}
        SET_GCODE_VARIABLE MACRO=TTOVER1 VARIABLE=e2temp VALUE={e2temp}
        SET_GCODE_VARIABLE MACRO=TTOVER1 VARIABLE=e3temp VALUE={e3temp}

        {% if active == 'extruder' %}
            {% set takeover_temp = e0temp %}
        {% elif active == 'extruder1' %}
            {% set takeover_temp = e1temp %}
        {% elif active == 'extruder2' %}
            {% set takeover_temp = e2temp %}
        {% elif active == 'extruder3' %}
            {% set takeover_temp = e3temp %}
        {% else %}
            {% set takeover_temp = 0 %}
        {% endif %}

        {% if current_z + zhop < zmax %}
            G91
            G1 Z{zhop} F900
            G90
        {% else %}
            M118 Z-hop too high — skipping Z lift
            SET_GCODE_VARIABLE MACRO=TTOVER1 VARIABLE=zhop VALUE=0
        {% endif %}

        {% if active == 'extruder' %}
            PARK_extruder
            G91
            G0 E-{s0.t0_unload_distance} F300
            M400
            SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
            G90
        {% elif active == 'extruder1' %}
            PARK_extruder1
            G91
            G0 E-{s1.t1_unload_distance} F300
            M400
            SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET=0
            G90
        {% elif active == 'extruder2' %}
            PARK_extruder2
            G91
            G0 E-{s2.t2_unload_distance} F300
            M400
            SET_HEATER_TEMPERATURE HEATER=extruder2 TARGET=0
            G90
        {% elif active == 'extruder3' %}
            PARK_extruder3
            G91
            G0 E-{s3.t3_unload_distance} F300
            M400
            SET_HEATER_TEMPERATURE HEATER=extruder3 TARGET=0
            G90
        {% endif %}

        Tool1

        {% if takeover_temp > 0 %}
            SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET={takeover_temp}
            M118 Heating Tool1 to {takeover_temp}°C
            M109 T1 S{takeover_temp}
        {% else %}
            M118 No takeover temperature found; skipping Tool1 heat
        {% endif %}

        {% if xplorer is defined and xplorer.xrest1 is defined %}
            G1 X{xplorer.xrest1} F5000
        {% endif %}

        M83
        G1 E30 F900
        M400
        PARK_extruder1
        RESTORE_GCODE_STATE NAME=TTOVER1 MOVE=1 MOVE_SPEED=100
        Tool1
    {% else %}
        M118 Cannot make the takeover while paused!
    {% endif %}


######################################################################
# Toolhead 2 Takeover
######################################################################

[gcode_macro TTOVER2]
variable_zhop: 0
variable_e0temp: 0
variable_e1temp: 0
variable_e2temp: 0
variable_e3temp: 0

gcode:
    M118 Tool2 is taking over and continues the print...

    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    {% set s0 = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}
    {% set s1 = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}
    {% set s2 = printer['gcode_macro _SENSOR_t2_VARIABLES'] %}
    {% set s3 = printer['gcode_macro _SENSOR_t3_VARIABLES'] %}

    {% set zhop = params.Z|default(10)|float %}
    {% set zmax = printer.toolhead.axis_maximum.z %}
    {% set current_z = printer.gcode_move.position.z %}
    {% set paused = printer['pause_resume'].is_paused %}

    {% if printer['extruder'] is defined %}
        {% set e0temp = printer['extruder'].target|int %}
    {% else %}
        {% set e0temp = 0 %}
    {% endif %}
    {% if printer['extruder1'] is defined %}
        {% set e1temp = printer['extruder1'].target|int %}
    {% else %}
        {% set e1temp = 0 %}
    {% endif %}
    {% if printer['extruder2'] is defined %}
        {% set e2temp = printer['extruder2'].target|int %}
    {% else %}
        {% set e2temp = 0 %}
    {% endif %}
    {% if printer['extruder3'] is defined %}
        {% set e3temp = printer['extruder3'].target|int %}
    {% else %}
        {% set e3temp = 0 %}
    {% endif %}

    {% set active = printer.toolhead.extruder %}

    {% if not paused %}
        SAVE_GCODE_STATE NAME=TTOVER2

        SET_GCODE_VARIABLE MACRO=TTOVER2 VARIABLE=zhop VALUE={zhop}
        SET_GCODE_VARIABLE MACRO=TTOVER2 VARIABLE=e0temp VALUE={e0temp}
        SET_GCODE_VARIABLE MACRO=TTOVER2 VARIABLE=e1temp VALUE={e1temp}
        SET_GCODE_VARIABLE MACRO=TTOVER2 VARIABLE=e2temp VALUE={e2temp}
        SET_GCODE_VARIABLE MACRO=TTOVER2 VARIABLE=e3temp VALUE={e3temp}

        {% if active == 'extruder' %}
            {% set takeover_temp = e0temp %}
        {% elif active == 'extruder1' %}
            {% set takeover_temp = e1temp %}
        {% elif active == 'extruder2' %}
            {% set takeover_temp = e2temp %}
        {% elif active == 'extruder3' %}
            {% set takeover_temp = e3temp %}
        {% else %}
            {% set takeover_temp = 0 %}
        {% endif %}

        {% if current_z + zhop < zmax %}
            G91
            G1 Z{zhop} F900
            G90
        {% else %}
            M118 Z-hop too high — skipping Z lift
            SET_GCODE_VARIABLE MACRO=TTOVER2 VARIABLE=zhop VALUE=0
        {% endif %}

        {% if active == 'extruder' %}
            PARK_extruder
            G91
            G0 E-{s0.t0_unload_distance} F300
            M400
            SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
            G90
        {% elif active == 'extruder1' %}
            PARK_extruder1
            G91
            G0 E-{s1.t1_unload_distance} F300
            M400
            SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET=0
            G90
        {% elif active == 'extruder2' %}
            PARK_extruder2
            G91
            G0 E-{s2.t2_unload_distance} F300
            M400
            SET_HEATER_TEMPERATURE HEATER=extruder2 TARGET=0
            G90
        {% elif active == 'extruder3' %}
            PARK_extruder3
            G91
            G0 E-{s3.t3_unload_distance} F300
            M400
            SET_HEATER_TEMPERATURE HEATER=extruder3 TARGET=0
            G90
        {% endif %}

        Tool2

        {% if takeover_temp > 0 %}
            SET_HEATER_TEMPERATURE HEATER=extruder2 TARGET={takeover_temp}
            M118 Heating Tool2 to {takeover_temp}°C
            M109 T2 S{takeover_temp}
        {% else %}
            M118 No takeover temperature found; skipping Tool2 heat
        {% endif %}

        {% if xplorer is defined and xplorer.xrest2 is defined %}
            G1 X{xplorer.xrest2} F5000
        {% endif %}

        M83
        G1 E30 F900
        M400
        PARK_extruder2
        RESTORE_GCODE_STATE NAME=TTOVER2 MOVE=1 MOVE_SPEED=100
        Tool2
    {% else %}
        M118 Cannot make the takeover while paused!
    {% endif %}


######################################################################
# Toolhead 3 Takeover
######################################################################

[gcode_macro TTOVER3]
variable_zhop: 0
variable_e0temp: 0
variable_e1temp: 0
variable_e2temp: 0
variable_e3temp: 0

gcode:
    M118 Tool3 is taking over and continues the print...

    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    {% set s0 = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}
    {% set s1 = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}
    {% set s2 = printer['gcode_macro _SENSOR_t2_VARIABLES'] %}
    {% set s3 = printer['gcode_macro _SENSOR_t3_VARIABLES'] %}

    {% set zhop = params.Z|default(10)|float %}
    {% set zmax = printer.toolhead.axis_maximum.z %}
    {% set current_z = printer.gcode_move.position.z %}
    {% set paused = printer['pause_resume'].is_paused %}

    {% if printer['extruder'] is defined %}
        {% set e0temp = printer['extruder'].target|int %}
    {% else %}
        {% set e0temp = 0 %}
    {% endif %}
    {% if printer['extruder1'] is defined %}
        {% set e1temp = printer['extruder1'].target|int %}
    {% else %}
        {% set e1temp = 0 %}
    {% endif %}
    {% if printer['extruder2'] is defined %}
        {% set e2temp = printer['extruder2'].target|int %}
    {% else %}
        {% set e2temp = 0 %}
    {% endif %}
    {% if printer['extruder3'] is defined %}
        {% set e3temp = printer['extruder3'].target|int %}
    {% else %}
        {% set e3temp = 0 %}
    {% endif %}

    {% set active = printer.toolhead.extruder %}

    {% if not paused %}
        SAVE_GCODE_STATE NAME=TTOVER3

        SET_GCODE_VARIABLE MACRO=TTOVER3 VARIABLE=zhop VALUE={zhop}
        SET_GCODE_VARIABLE MACRO=TTOVER3 VARIABLE=e0temp VALUE={e0temp}
        SET_GCODE_VARIABLE MACRO=TTOVER3 VARIABLE=e1temp VALUE={e1temp}
        SET_GCODE_VARIABLE MACRO=TTOVER3 VARIABLE=e2temp VALUE={e2temp}
        SET_GCODE_VARIABLE MACRO=TTOVER3 VARIABLE=e3temp VALUE={e3temp}

        {% if active == 'extruder' %}
            {% set takeover_temp = e0temp %}
        {% elif active == 'extruder1' %}
            {% set takeover_temp = e1temp %}
        {% elif active == 'extruder2' %}
            {% set takeover_temp = e2temp %}
        {% elif active == 'extruder3' %}
            {% set takeover_temp = e3temp %}
        {% else %}
            {% set takeover_temp = 0 %}
        {% endif %}

        {% if current_z + zhop < zmax %}
            G91
            G1 Z{zhop} F900
            G90
        {% else %}
            M118 Z-hop too high — skipping Z lift
            SET_GCODE_VARIABLE MACRO=TTOVER3 VARIABLE=zhop VALUE=0
        {% endif %}

        {% if active == 'extruder' %}
            PARK_extruder
            G91
            G0 E-{s0.t0_unload_distance} F300
            M400
            SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
            G90
        {% elif active == 'extruder1' %}
            PARK_extruder1
            G91
            G0 E-{s1.t1_unload_distance} F300
            M400
            SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET=0
            G90
        {% elif active == 'extruder2' %}
            PARK_extruder2
            G91
            G0 E-{s2.t2_unload_distance} F300
            M400
            SET_HEATER_TEMPERATURE HEATER=extruder2 TARGET=0
            G90
        {% elif active == 'extruder3' %}
            PARK_extruder3
            G91
            G0 E-{s3.t3_unload_distance} F300
            M400
            SET_HEATER_TEMPERATURE HEATER=extruder3 TARGET=0
            G90
        {% endif %}

        Tool3

        {% if takeover_temp > 0 %}
            SET_HEATER_TEMPERATURE HEATER=extruder3 TARGET={takeover_temp}
            M118 Heating Tool3 to {takeover_temp}°C
            M109 T3 S{takeover_temp}
        {% else %}
            M118 No takeover temperature found; skipping Tool3 heat
        {% endif %}

        {% if xplorer is defined and xplorer.xrest3 is defined %}
            G1 X{xplorer.xrest3} F5000
        {% endif %}

        M83
        G1 E30 F900
        M400
        PARK_extruder3
        RESTORE_GCODE_STATE NAME=TTOVER3 MOVE=1 MOVE_SPEED=100
        Tool3
    {% else %}
        M118 Cannot make the takeover while paused!
    {% endif %}

    
#######################################
# START_PRINT
#######################################

[gcode_macro START_PRINT]
gcode: 
      M118 Start printing...
      printstart_audio
      G28 X 
      CHECK_HOME                                               # Home the printer 
      G90
      G1 Z50 F5000
      apply_zmotors_offsets
      Z_TILT_ADJUST
      LOG_ZRESUME
      G92 E0                                        # Reset extruder       
      BED_MESH_PROFILE LOAD=default
     # Move to wait position 
      G28 X 
      G28 Y
      SET_VELOCITY_LIMIT VELOCITY=350 ACCEL=10000
      #SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=Electronics_fan TARGET=45
      SET_GCODE_VARIABLE MACRO=filament_change_state1 VARIABLE=changet0busy VALUE=0
      SET_GCODE_VARIABLE MACRO=filament_change_state11 VARIABLE=changet1busy VALUE=0
      SET_GCODE_VARIABLE MACRO=unload_tangle_t0 VARIABLE=loadt0busy VALUE=0
      SET_GCODE_VARIABLE MACRO=unload_tangle_t1 VARIABLE=loadt1busy VALUE=0
      SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
      G31
      save_last_file
      SAVE_VARIABLE VARIABLE=was_interrupted VALUE=True
      SAVE_VARIABLE VARIABLE=xy_resume VALUE=1
      SAVE_VARIABLE VARIABLE=ttover_resume VALUE=0
      SET_GCODE_OFFSET Z=0 MOVE=0
      UPDATE_XY_POS   

#######################################
# END_PRINT IQEX
#######################################

[gcode_macro END_PRINT]
description: End of print routine – shuts down heaters, disables COPY/MIRROR, resets toolheads

gcode:
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}

    SET_SKEW CLEAR=1
    M104 T0 S0
    M104 T1 S0
    M104 T2 S0
    M104 T3 S0
    M140 S0

    SET_FAN_SPEED FAN=Tool_0_partfan SPEED=0.0
    SET_FAN_SPEED FAN=Tool_1_partfan SPEED=0.0
    SET_FAN_SPEED FAN=Tool_2_partfan SPEED=0.0
    SET_FAN_SPEED FAN=Tool_3_partfan SPEED=0.0

    G91
    G1 E-3 F300
    M117 RETRACT
    G1 Z+0.5 E-3 F9000
    G1 E-10
    M117 WIPE OUT
    G90

    {% set axismax = printer.toolhead.axis_maximum %}
    {% set pos = printer.toolhead.position %}

    # Move toolhead away from the finished print
    {% if pos.z <= (axismax.z - 10) %}
        G1 Z{ pos.z + 5 }
        G28 X
        G28 Y
    {% else %}
        G28 X
        G28 Y
    {% endif %}

    M117 PRESENT ITEM
    BED_MESH_CLEAR
    M141 S40                       ; chamber fan target 40°C

    # ---- Disable COPY/MIRROR and any takeover ----
    SAVE_VARIABLE VARIABLE=pmode VALUE=0
    SAVE_VARIABLE VARIABLE=ttovr VALUE=0
    SAVE_VARIABLE VARIABLE=ttover_resume VALUE=0
    M118 Copy/Mirror modes disabled – all toolheads independent.

    # Reset motion sync so each extruder is independent
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder  MOTION_QUEUE=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder2 MOTION_QUEUE=extruder2
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder3 MOTION_QUEUE=extruder3

    # Set all carriages to PRIMARY mode so any tool can be used next
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t2 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t3 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=gantry0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=gantry1 MODE=PRIMARY

    SET_VELOCITY_LIMIT VELOCITY=300 ACCEL=5000
    G28 Z
    M400

    SET_GCODE_OFFSET X=0 Y=0 Z=0

    # Return all tools to their defined rest positions
    SET_DUAL_CARRIAGE CARRIAGE=gantry1
    G90
    G1 Y{ xplorer.yrest2 } F5000

    SET_DUAL_CARRIAGE CARRIAGE=t0
    G90
    G1 X{ xplorer.xrest0 } F5000

    SET_DUAL_CARRIAGE CARRIAGE=t1
    G90
    G1 X{ xplorer.xrest1 } F5000

    SET_DUAL_CARRIAGE CARRIAGE=t2
    G90
    G1 X{ xplorer.xrest0 } F5000

    SET_DUAL_CARRIAGE CARRIAGE=t3
    G90
    G1 X{ xplorer.xrest1 } F5000

    SKEW_PROFILE LOAD=SKEW0
    #SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=Electronics_fan TARGET=50
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}

    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    SAVE_VARIABLE VARIABLE=xy_resume VALUE=1
    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
    SAVE_VARIABLE VARIABLE=ttover_resume VALUE=0

    G31
    UPDATE_DELAYED_GCODE ID=SAVE_XY_TIMER DURATION=0
    printend_audio

    {% if svv.pwrendp == 0 %}
        END_PRINT_OFF
    {% endif %}

########################################
# Part cooling Fan IQEX
########################################
[gcode_macro M106]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% if params.S is defined %}
        {% set realspeed = (params.S|int / 255)|float %}
        {% if printer.toolhead.extruder == "extruder" %}
            SET_FAN_SPEED FAN=Tool_0_partfan Speed={realspeed}            
            {% if svv.pmode in [1, 2] %}
                SET_FAN_SPEED FAN=Tool_1_partfan Speed={realspeed}  
            {% elif svv.pmode in [3, 4] %} 
                SET_FAN_SPEED FAN=Tool_1_partfan Speed={realspeed}  
                SET_FAN_SPEED FAN=Tool_2_partfan Speed={realspeed}
                SET_FAN_SPEED FAN=Tool_3_partfan Speed={realspeed}  
            {% endif %}
        {% elif printer.toolhead.extruder == "extruder1" %}
            SET_FAN_SPEED FAN=Tool_1_partfan Speed={realspeed}  
        {% elif printer.toolhead.extruder == "extruder2" %}
            SET_FAN_SPEED FAN=Tool_2_partfan Speed={realspeed}
        {% elif printer.toolhead.extruder == "extruder3" %}
            SET_FAN_SPEED FAN=Tool_3_partfan Speed={realspeed}  
        {% else %}
            # Default behavior if no specific extruder is active
            SET_FAN_SPEED FAN=Tool_0_partfan Speed={realspeed}            
            SET_FAN_SPEED FAN=Tool_1_partfan Speed={realspeed}
            SET_FAN_SPEED FAN=Tool_2_partfan Speed={realspeed}            
            SET_FAN_SPEED FAN=Tool_3_partfan Speed={realspeed} 
        {% endif %}
    {% else %}
        # Default to full speed if no S parameter is provided
        {% if printer.toolhead.extruder == "extruder" %}
            SET_FAN_SPEED FAN=Tool_0_partfan Speed=1.0            
            {% if svv.pmode in [1, 2] %}
                SET_FAN_SPEED FAN=Tool_1_partfan Speed=1.0   
            {% elif svv.pmode in [3, 4] %} 
                SET_FAN_SPEED FAN=Tool_1_partfan Speed=1.0   
                SET_FAN_SPEED FAN=Tool_2_partfan Speed=1.0 
                SET_FAN_SPEED FAN=Tool_3_partfan Speed=1.0   
            {% endif %}
        {% elif printer.toolhead.extruder == "extruder1" %}
            SET_FAN_SPEED FAN=Tool_1_partfan Speed=1.0    
        {% elif printer.toolhead.extruder == "extruder2" %}
            SET_FAN_SPEED FAN=Tool_2_partfan Speed=1.0  
        {% elif printer.toolhead.extruder == "extruder3" %}
            SET_FAN_SPEED FAN=Tool_3_partfan Speed=1.0  
        {% else %}
            SET_FAN_SPEED FAN=Tool_0_partfan Speed=1.0
            SET_FAN_SPEED FAN=Tool_1_partfan Speed=1.0
            SET_FAN_SPEED FAN=Tool_2_partfan Speed=1.0
            SET_FAN_SPEED FAN=Tool_3_partfan Speed=1.0 
        {% endif %}
    {% endif %}



########################################
# Brush_T0 IQEX
########################################
[gcode_macro Brush_Tool0]
gcode:
     {% set svv = printer.save_variables.variables %}
     M118 Brushing Tool0
     G90
     Tool0
     G1 Z10
   
; Set initial position
    G0 X94 Y405 Z{svv.h_brush} F9000        ; Move to the starting point at X94 Y405 Z1.5

; Clockwise Spiral - Movement Loop
    G1 F15000               ; Set feedrate to 12000 mm/min

   G1 X97 Y405
   G1 X100 Y408
   G1 X103 Y409
   G1 X106 Y406
   G1 X109 Y403
   G1 X112 Y401
   G1 X115 Y402
   G1 X118 Y405
   G1 X121 Y408
   G1 X124 Y409
   G1 X127 Y406
   G1 X129 Y403

   G1 X127 Y406
   G1 X124 Y409
   G1 X121 Y408
   G1 X118 Y405
   G1 X115 Y402
   G1 X112 Y401
   G1 X109 Y403
   G1 X106 Y406
   G1 X103 Y409
   G1 X100 Y408
   G1 X97 Y405
   G1 X94 Y405

   G1 X97 Y405
   G1 X100 Y408
   G1 X103 Y409
   G1 X106 Y406
   G1 X109 Y403
   G1 X112 Y401
   G1 X115 Y402
   G1 X118 Y405
   G1 X121 Y408
   G1 X124 Y409
   G1 X127 Y406
   G1 X129 Y403

   G1 X127 Y406
   G1 X124 Y409
   G1 X121 Y408
   G1 X118 Y405
   G1 X115 Y402
   G1 X112 Y401
   G1 X109 Y403
   G1 X106 Y406
   G1 X103 Y409
   G1 X100 Y408
   G1 X97 Y405
   G1 X94 Y405

   G1 X97 Y405
   G1 X100 Y408
   G1 X103 Y409
   G1 X106 Y406
   G1 X109 Y403
   G1 X112 Y401
   G1 X115 Y402
   G1 X118 Y405
   G1 X121 Y408
   G1 X124 Y409
   G1 X127 Y406
   G1 X129 Y403

   G1 X127 Y406
   G1 X124 Y409
   G1 X121 Y408
   G1 X118 Y405
   G1 X115 Y402
   G1 X112 Y401
   G1 X109 Y403
   G1 X106 Y406
   G1 X103 Y409
   G1 X100 Y408
   G1 X97 Y405
   G1 X94 Y405   


   G0 Z10                  ; Lift up to avoid collisions
########################################
# Brush_T1 IQEX
########################################
[gcode_macro Brush_Tool1]
gcode:
     {% set svv = printer.save_variables.variables %}
     M118 Brushing Tool1
     G90
     G1 Z10 F2000
     Tool1
     
; Set initial position
    G0 X294 Y405 Z{svv.h_brush} F9000        ; Move to the starting point at X94 Y405 Z1.5

; Clockwise Spiral - Movement Loop
    G1 F15000               ; Set feedrate to 12000 mm/min

   G1 X297 Y405
   G1 X300 Y408
   G1 X303 Y409
   G1 X306 Y406
   G1 X309 Y403
   G1 X312 Y401
   G1 X315 Y402
   G1 X318 Y405
   G1 X321 Y408
   G1 X324 Y409
   G1 X327 Y406
   G1 X329 Y403

   G1 X327 Y406
   G1 X324 Y409
   G1 X321 Y408
   G1 X318 Y405
   G1 X315 Y402
   G1 X312 Y401
   G1 X309 Y403
   G1 X306 Y406
   G1 X303 Y409
   G1 X300 Y408
   G1 X297 Y405
   G1 X294 Y405

   G1 X297 Y405
   G1 X300 Y408
   G1 X303 Y409
   G1 X306 Y406
   G1 X309 Y403
   G1 X312 Y401
   G1 X315 Y402
   G1 X318 Y405
   G1 X321 Y408
   G1 X324 Y409
   G1 X327 Y406
   G1 X329 Y403

   G1 X327 Y406
   G1 X324 Y409
   G1 X321 Y408
   G1 X318 Y405
   G1 X315 Y402
   G1 X312 Y401
   G1 X309 Y403
   G1 X306 Y406
   G1 X303 Y409
   G1 X300 Y408
   G1 X297 Y405
   G1 X294 Y405
 
   G1 X297 Y405
   G1 X300 Y408
   G1 X303 Y409
   G1 X306 Y406
   G1 X309 Y403
   G1 X312 Y401
   G1 X315 Y402
   G1 X318 Y405
   G1 X321 Y408
   G1 X324 Y409
   G1 X327 Y406
   G1 X329 Y403
 
   G1 X327 Y406
   G1 X324 Y409
   G1 X321 Y408
   G1 X318 Y405
   G1 X315 Y402
   G1 X312 Y401
   G1 X309 Y403
   G1 X306 Y406
   G1 X303 Y409
   G1 X300 Y408
   G1 X297 Y405
   G1 X294 Y405  


   G0 Z10                  ; Lift up to avoid collisions

########################################
# Brush_T3 IQEX
########################################
[gcode_macro Brush_Tool3]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    M118 Brushing Tool3
    G90
    G1 Z10 F2000
    Tool3

	SET_DUAL_CARRIAGE CARRIAGE=gantry0
    SET_DUAL_CARRIAGE CARRIAGE=t0
    G1 X210 F{xplorer.sp_tch}

    SET_DUAL_CARRIAGE CARRIAGE=gantry1
    SET_DUAL_CARRIAGE CARRIAGE=t3
    SET_GCODE_OFFSET X={svv.x2offset} Y={svv.y2offset} Z={svv.z2offset}
    
; Set initial position
    G0 X294 Y405 Z{svv.h_brush} F9000        ; Move to the starting point at X94 Y405 Z1.5

; Clockwise Spiral - Movement Loop
    G1 F15000               ; Set feedrate to 12000 mm/min

   G1 X297 Y405
   G1 X300 Y408
   G1 X303 Y409
   G1 X306 Y406
   G1 X309 Y403
   G1 X312 Y401
   G1 X315 Y402
   G1 X318 Y405
   G1 X321 Y408
   G1 X324 Y409
   G1 X327 Y406
   G1 X329 Y403

   G1 X327 Y406
   G1 X324 Y409
   G1 X321 Y408
   G1 X318 Y405
   G1 X315 Y402
   G1 X312 Y401
   G1 X309 Y403
   G1 X306 Y406
   G1 X303 Y409
   G1 X300 Y408
   G1 X297 Y405
   G1 X294 Y405

   G1 X297 Y405
   G1 X300 Y408
   G1 X303 Y409
   G1 X306 Y406
   G1 X309 Y403
   G1 X312 Y401
   G1 X315 Y402
   G1 X318 Y405
   G1 X321 Y408
   G1 X324 Y409
   G1 X327 Y406
   G1 X329 Y403

   G1 X327 Y406
   G1 X324 Y409
   G1 X321 Y408
   G1 X318 Y405
   G1 X315 Y402
   G1 X312 Y401
   G1 X309 Y403
   G1 X306 Y406
   G1 X303 Y409
   G1 X300 Y408
   G1 X297 Y405
   G1 X294 Y405
 
   G1 X297 Y405
   G1 X300 Y408
   G1 X303 Y409
   G1 X306 Y406
   G1 X309 Y403
   G1 X312 Y401
   G1 X315 Y402
   G1 X318 Y405
   G1 X321 Y408
   G1 X324 Y409
   G1 X327 Y406
   G1 X329 Y403
 
   G1 X327 Y406
   G1 X324 Y409
   G1 X321 Y408
   G1 X318 Y405
   G1 X315 Y402
   G1 X312 Y401
   G1 X309 Y403
   G1 X306 Y406
   G1 X303 Y409
   G1 X300 Y408
   G1 X297 Y405
   G1 X294 Y405  


   G0 Z10                  ; Lift up to avoid collisions

   G28 Y
   G28 X
   Tool3
          
########################################
# Brush_T2 IQEX
########################################
[gcode_macro Brush_Tool2]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    M118 Brushing Tool2
    G90
    G1 Z10
    Tool2

	SET_DUAL_CARRIAGE CARRIAGE=gantry0
    SET_DUAL_CARRIAGE CARRIAGE=t1
    G1 X210 F{xplorer.sp_tch}

    SET_DUAL_CARRIAGE CARRIAGE=gantry1
    SET_DUAL_CARRIAGE CARRIAGE=t2
    SET_GCODE_OFFSET X={svv.x3offset} Y={svv.y3offset} Z={svv.z3offset}
   
; Set initial position
    G0 X94 Y405 Z{svv.h_brush} F9000        ; Move to the starting point at X94 Y405 Z1.5

; Clockwise Spiral - Movement Loop
    G1 F15000               ; Set feedrate to 12000 mm/min

   G1 X97 Y405
   G1 X100 Y408
   G1 X103 Y409
   G1 X106 Y406
   G1 X109 Y403
   G1 X112 Y401
   G1 X115 Y402
   G1 X118 Y405
   G1 X121 Y408
   G1 X124 Y409
   G1 X127 Y406
   G1 X129 Y403

   G1 X127 Y406
   G1 X124 Y409
   G1 X121 Y408
   G1 X118 Y405
   G1 X115 Y402
   G1 X112 Y401
   G1 X109 Y403
   G1 X106 Y406
   G1 X103 Y409
   G1 X100 Y408
   G1 X97 Y405
   G1 X94 Y405

   G1 X97 Y405
   G1 X100 Y408
   G1 X103 Y409
   G1 X106 Y406
   G1 X109 Y403
   G1 X112 Y401
   G1 X115 Y402
   G1 X118 Y405
   G1 X121 Y408
   G1 X124 Y409
   G1 X127 Y406
   G1 X129 Y403

   G1 X127 Y406
   G1 X124 Y409
   G1 X121 Y408
   G1 X118 Y405
   G1 X115 Y402
   G1 X112 Y401
   G1 X109 Y403
   G1 X106 Y406
   G1 X103 Y409
   G1 X100 Y408
   G1 X97 Y405
   G1 X94 Y405

   G1 X97 Y405
   G1 X100 Y408
   G1 X103 Y409
   G1 X106 Y406
   G1 X109 Y403
   G1 X112 Y401
   G1 X115 Y402
   G1 X118 Y405
   G1 X121 Y408
   G1 X124 Y409
   G1 X127 Y406
   G1 X129 Y403

   G1 X127 Y406
   G1 X124 Y409
   G1 X121 Y408
   G1 X118 Y405
   G1 X115 Y402
   G1 X112 Y401
   G1 X109 Y403
   G1 X106 Y406
   G1 X103 Y409
   G1 X100 Y408
   G1 X97 Y405
   G1 X94 Y405   


   G0 Z10                  ; Lift up to avoid collisio

   G28 Y
   G28 X
   Tool2

######################################################################
# Filament Change M600 IQEX
######################################################################
# After filament has # been changed, the print can be resumed from its previous position
# with the "RESUME" gcode.

[gcode_macro M600]
description: Filament change for any of 4 toolheads (pmode-safe)
gcode:
    M118 Filament change requested (M600)...

    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    {% set z = params.Z|default(10)|int %}
    {% set svv = printer.save_variables.variables %}
    {% set pmode = svv.pmode|default(0)|int %}

    {% if printer['pause_resume'].is_paused|int == 0 %}
        # Save resume parameters
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp  VALUE={printer['extruder'].target}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=e1temp VALUE={printer['extruder1'].target}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=e2temp VALUE={printer['extruder2'].target}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=e3temp VALUE={printer['extruder3'].target}

        # Save current print position and pause
        SAVE_GCODE_STATE NAME=PAUSE
        BASE_PAUSE

        # Apply safe Z-hop
        {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}
            G91
            G1 Z{z} F900
        {% else %}
            { action_respond_info("Pause Z-hop exceeds maximum Z height — skipping lift.") }
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
        {% endif %}
        G90

        # Move to front only if pmode == 0 (primary mode)
        {% if pmode == 0 %}
            G1 X210 Y130 F6000
        {% else %}
            M118 Filament change: skipping front move (COPY/MIRROR active)
        {% endif %}

        # Save parked position for safe resume
        SAVE_GCODE_STATE NAME=PAUSEPARK

        # Cool all tools to 150°C if above 100°C
        {% if printer.extruder.temperature > 100 %}
            M104 T0 S150
        {% endif %}
        {% if printer.extruder1.temperature > 100 %}
            M104 T1 S150
        {% endif %}
        {% if printer.extruder2.temperature > 100 %}
            M104 T2 S150
        {% endif %}
        {% if printer.extruder3.temperature > 100 %}
            M104 T3 S150
        {% endif %}

        # Prevent idle timeout during manual filament change
        SET_IDLE_TIMEOUT TIMEOUT={xplorer.tmpout}

    {% endif %}

    printpause_audio

                
######################################################################
# Pause IQEX
######################################################################

[gcode_macro PAUSE]
description: Pause print safely, store temperatures and position
rename_existing: BASE_PAUSE

gcode:
    M118 Pause print...

    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    {% set z = params.Z|default(10)|int %}

    {% if printer['pause_resume'].is_paused|int == 0 %}
        # Save print state
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=e1temp VALUE={printer['extruder1'].target}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=e2temp VALUE={printer['extruder2'].target}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=e3temp VALUE={printer['extruder3'].target}

        SAVE_GCODE_STATE NAME=PAUSE
        BASE_PAUSE

        {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}
            G91
            G1 Z{z} F900
        {% else %}
            { action_respond_info("Pause z-hop exceeds maximum Z height — skipping.") }
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
        {% endif %}

        G90
        G28 Y
        SAVE_GCODE_STATE NAME=PAUSEPARK

        # Cool down each tool to safe standby temp
        {% if printer.extruder.temperature > 100 %}
            M104 T0 S150
        {% endif %}
        {% if printer.extruder1.temperature > 100 %}
            M104 T1 S150
        {% endif %}
        {% if printer.extruder2.temperature > 100 %}
            M104 T2 S150
        {% endif %}
        {% if printer.extruder3.temperature > 100 %}
            M104 T3 S150
        {% endif %}

        SET_IDLE_TIMEOUT TIMEOUT={xplorer.tmpout}  ; usually long pause timeout (e.g., 12 h)
    {% endif %}

    # Reset filament-change busy states
    SET_GCODE_VARIABLE MACRO=filament_change_state1  VARIABLE=changet0busy VALUE=0
    SET_GCODE_VARIABLE MACRO=filament_change_state11 VARIABLE=changet1busy VALUE=0
    SET_GCODE_VARIABLE MACRO=filament_change_state12 VARIABLE=changet2busy VALUE=0
    SET_GCODE_VARIABLE MACRO=filament_change_state13 VARIABLE=changet3busy VALUE=0

    printpause_audio


######################################################################
# Resume IQEX
######################################################################
[gcode_macro RESUME]
description: Resume paused print safely for all tools
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
variable_e1temp: 0
variable_e2temp: 0
variable_e3temp: 0

gcode:
    M118 Resuming printing...

    {% set e = params.E|default(2.5)|float %}

    {% if printer['pause_resume'].is_paused|int == 1 %}
        SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}

        # Reheat all tools that were cooled down
        {% if etemp > 0 %}
            M109 T0 S{etemp|int}
        {% endif %}
        {% if e1temp > 0 %}
            M109 T1 S{e1temp|int}
        {% endif %}
        {% if e2temp > 0 %}
            M109 T2 S{e2temp|int}
        {% endif %}
        {% if e3temp > 0 %}
            M109 T3 S{e3temp|int}
        {% endif %}

        # Restore to parked Z-hop position (safe recovery)
        RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=100
        G91
        M83

        {% if printer[printer.toolhead.extruder].temperature >= printer.configfile.settings.extruder.min_extrude_temp %}
            G1 Z{zhop * -1} E{e} F900
        {% else %}
            G1 Z{zhop * -1} F900
        {% endif %}

        RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=60
        BASE_RESUME
    {% endif %}

    printstart_audio

    
########################################################################################
# Cancel IQEX
########################################################################################

[gcode_macro CANCEL_PRINT]
description: Cancel the current print safely, reset modes and prepare for next job
rename_existing: BASE_CANCEL_PRINT

gcode:
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    M118 CANCEL PRINT !

    SET_SKEW CLEAR=1
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}

    # Turn off heaters
    M104 T0 S0
    M104 T1 S0
    M104 T2 S0
    M104 T3 S0
    M140 S0

    # Turn off part cooling fans
    SET_FAN_SPEED FAN=Tool_0_partfan SPEED=0.0
    SET_FAN_SPEED FAN=Tool_1_partfan SPEED=0.0
    SET_FAN_SPEED FAN=Tool_2_partfan SPEED=0.0
    SET_FAN_SPEED FAN=Tool_3_partfan SPEED=0.0

    # Retract filament and lift nozzle slightly
    G91
    G1 E-3 F300
    M117 RETRACT
    G1 Z+0.5 E-3 F9000
    G1 E-10
    M117 WIPE OUT
    G90

    {% set axismax = printer.toolhead.axis_maximum %}
    {% set pos = printer.toolhead.position %}

    # Move toolhead away from print
    {% if pos.z <= (axismax.z - 10) %}
        G1 Z{ pos.z + 5 }
        G28 X
        G28 Y
    {% else %}
        G28 X
        G28 Y
    {% endif %}

    M117 PRESENT ITEM
    BED_MESH_CLEAR
    M141 S40                      ; chamber fan 40°C

    # ---- Disable COPY/MIRROR and takeover modes ----
    SAVE_VARIABLE VARIABLE=pmode VALUE=0
    SAVE_VARIABLE VARIABLE=ttovr VALUE=0
    SAVE_VARIABLE VARIABLE=ttover_resume VALUE=0
    M118 Copy/Mirror modes disabled – all toolheads reset to PRIMARY.

    # Unsync all extruders (restore independent motion)
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder  MOTION_QUEUE=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder2 MOTION_QUEUE=extruder2
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder3 MOTION_QUEUE=extruder3

    # Reset velocity limits and offsets
    SET_VELOCITY_LIMIT VELOCITY=300 ACCEL=5000
    G28 Z
    M400
    SET_GCODE_OFFSET X=0 Y=0 Z=0

    # Return all gantries and tools to rest positions
    SET_DUAL_CARRIAGE CARRIAGE=gantry1
    G90
    G1 Y{ xplorer.yrest2 } F5000

    SET_DUAL_CARRIAGE CARRIAGE=t0
    G90
    G1 X{ xplorer.xrest0 } F5000

    SET_DUAL_CARRIAGE CARRIAGE=t1
    G90
    G1 X{ xplorer.xrest1 } F5000

    SET_DUAL_CARRIAGE CARRIAGE=t2
    G90
    G1 X{ xplorer.xrest0 } F5000

    SET_DUAL_CARRIAGE CARRIAGE=t3
    G90
    G1 X{ xplorer.xrest1 } F5000

    # Make sure all carriages and gantries are in PRIMARY mode (ready for next print)
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t2 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t3 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=gantry0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=gantry1 MODE=PRIMARY

    # Restore base settings and status
    SKEW_PROFILE LOAD=SKEW0
    #SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=Electronics_fan TARGET=50
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    SAVE_VARIABLE VARIABLE=xy_resume VALUE=1
    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
    G31
    UPDATE_DELAYED_GCODE ID=SAVE_XY_TIMER DURATION=0

    printcancel_audio

#########################################
# Resonance Calibration IQEX
########################################


[gcode_macro RESONANCE_CALIBRATION_IDEX_Mirror]
gcode:
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    M118 This will measure the resonaces on X and Y-Axis for Tool0.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME
    #G28
    ACTIVATE_MIRROR_MODE01    
    G1 Z{xplorer.res_z} F2000
    TEST_RESONANCES AXIS=X POINT={xplorer.res_xmicp},{xplorer.res_ymicp2e},{xplorer.res_z} ACCELEROMETER=Tool0
    RUN_SHELL_COMMAND CMD=resonaces_x_idexmr
    TEST_RESONANCES AXIS=Y POINT={xplorer.res_xmicp},{xplorer.res_ymicp2e},{xplorer.res_z} ACCELEROMETER=Tool0
    RUN_SHELL_COMMAND CMD=resonaces_y_idexmr
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=PRIMARY
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1
    M118 Resonace test is complete. Check the PNG files for details
     
[gcode_macro RESONANCE_CALIBRATION_IDEX_Copy]
gcode:
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    M118 This will measure the resonaces on X and Y-Axis for Tool0.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME
    #G28
    ACTIVATE_COPY_MODE01  
    G1 Z{xplorer.res_z} F2000
    TEST_RESONANCES AXIS=X POINT={xplorer.res_xmicp},{xplorer.res_ymicp2e},{xplorer.res_z} ACCELEROMETER=Tool0
    RUN_SHELL_COMMAND CMD=resonaces_x_idexcp
    TEST_RESONANCES AXIS=Y POINT={xplorer.res_xmicp},{xplorer.res_ymicp2e},{xplorer.res_z} ACCELEROMETER=Tool0
    RUN_SHELL_COMMAND CMD=resonaces_y_idexcp
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=PRIMARY
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1
    M118 Resonace test is complete. Check the PNG files for details

[gcode_macro RESONANCE_CALIBRATION_IQEX_Mirror]
gcode:
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    M118 This will measure the resonaces on X and Y-Axis for Tool0.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME  
    ACTIVATE_MIRROR_MODE0123    
    G1 Z{xplorer.res_z} F2000
    TEST_RESONANCES AXIS=X POINT={xplorer.res_xmicp},{xplorer.res_y2micp4e},{xplorer.res_z} ACCELEROMETER=Tool0
    RUN_SHELL_COMMAND CMD=resonaces_x_iqexmr
    TEST_RESONANCES AXIS=Y POINT={xplorer.res_xmicp},{xplorer.res_y2micp4e},{xplorer.res_z} ACCELEROMETER=Tool0
    RUN_SHELL_COMMAND CMD=resonaces_y_iqexmr
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t2 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t3 MODE=PRIMARY
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder2 MOTION_QUEUE=extruder2
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder3 MOTION_QUEUE=extruder3
    G28 X
    G28 Y
    M118 Resonace test is complete. Check the PNG files for details
     
[gcode_macro RESONANCE_CALIBRATION_IQEX_Copy]
gcode:
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    M118 This will measure the resonaces on X and Y-Axis for Tool0.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME  
    ACTIVATE_COPY_MODE0123  
    G1 Z{xplorer.res_z} F2000
    TEST_RESONANCES AXIS=X POINT={xplorer.res_xmicp},{xplorer.res_y1micp4e},{xplorer.res_z} ACCELEROMETER=Tool0
    RUN_SHELL_COMMAND CMD=resonaces_x_iqexcp
    TEST_RESONANCES AXIS=Y POINT={xplorer.res_xmicp},{xplorer.res_y1micp4e},{xplorer.res_z} ACCELEROMETER=Tool0
    RUN_SHELL_COMMAND CMD=resonaces_y_iqexcp
    SET_DUAL_CARRIAGE CARRIAGE=t0 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t1 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t2 MODE=PRIMARY
    SET_DUAL_CARRIAGE CARRIAGE=t3 MODE=PRIMARY
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder2 MOTION_QUEUE=extruder2
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder3 MOTION_QUEUE=extruder3
    G28 X
    G28 Y
    M118 Resonace test is complete. Check the PNG files for details
    
[gcode_macro RESONANCE_CALIBRATION_IQEX]
gcode:
     RESONANCE_CALIBRATION_IDEX_Copy
     RESONANCE_CALIBRATION_IDEX_Mirror
     G28
     RESONANCE_CALIBRATION_IQEX_Copy
     RESONANCE_CALIBRATION_IQEX_Mirror
     M118 Resonace tests for IQEX printing modes are complete.  

#########################################
# Printer Auto Calibrate IQEX
########################################

[gcode_macro Printer_Calibrate]
gcode:       
    printstart_audio
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    {% set svv = printer["save_variables"].variables %}
    M118 Starting printer calibration...
    M118 The calibration process takes up to 45 minutes ! Be patient !!! You can grab a coffe :)
    M104 T0 S{svv.tprobe}
    M104 T1 S{svv.tprobe}
    M104 T2 S{svv.tprobe}
    M104 T3 S{svv.tprobe}
    M140 S{svv.mesh_tmp}    
    M118 Calibration Bed Probe offset
    AUTO_CALIBRATE_probe_offset
    M118 Calibration Tools offsets
    AUTO_CALIBRATE_tool_offsets
    Tool0
    G1 X210 Y200 F10000
    G1 Z100 F2000
    M118 PID Calibration for Tool0
    PID_Tool0
    M104 T1 S{svv.tprobe}
    Tool1
    G1 X210 Y200 F10000
    M118 PID Calibration for Tool1
    PID_Tool1
    M104 T1 S{svv.tprobe}
    PARK_extruder1
    Tool2
    G1 X210 Y200 F10000
    M118 PID Calibration for Tool2
    PID_Tool2
    M104 T2 S{svv.tprobe}    
    PARK_extruder2
    Tool3
    G1 X210 Y200 F10000
    M118 PID Calibration for Tool3
    PID_Tool3
    M104 T3 S{svv.tprobe}
    PARK_extruder3
    M118 PID Calibration for Print Bed
    PID_BED
    M118 Mesh leveling
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={svv.tprobe}
    Brush_Tool0
    Tool0    
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={svv.mesh_tmp}
    set_zmotors_offset
    Z_TILT_ADJUST
    BED_MESH_CALIBRATE PROFILE=default METHOD=automatic # Start probing
    M104 T0 S0
    M104 T1 S0
    M104 T2 S0
    M104 T3 S0
    M118 Resonance Calibration
    RESONACE_CALIBRATION_Tool0
    RESONACE_CALIBRATION_Tool1
    RESONACE_CALIBRATION_Tool2
    RESONACE_CALIBRATION_Tool3
    RESONANCE_CALIBRATION_IQEX
    G28
    printend_audio
    SAVE_CONFIG


################################################################################
### T0 MACROS
################################################################################

#########################################
# PID Autotune Tool 0
########################################

[gcode_macro PID_Tool0]
 gcode:
      SET_FAN_SPEED FAN=Tool_0_partfan SPEED=1
      PID_CALIBRATE HEATER=extruder TARGET=230
      SET_FAN_SPEED FAN=Tool_0_partfan SPEED=0

#########################################
# Shaper Calibrate Tool0
########################################

[gcode_macro RESONACE_CALIBRATION_Tool0]
gcode:    
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    M118 This will measure the resonaces on X and Y-Axis for Tool0.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME
    #G28
    Tool0
    G1 X{xplorer.res_x} Y{xplorer.res_y} F10000
    G1 Z{xplorer.res_z} F2000
    TEST_RESONANCES AXIS=X ACCELEROMETER=Tool0
    RUN_SHELL_COMMAND CMD=resonaces_x_t0
    TEST_RESONANCES AXIS=Y ACCELEROMETER=Tool0
    RUN_SHELL_COMMAND CMD=resonaces_y_t0
    M118 Resonace test is complete. Check the PNG files for details


################################################################################
### T1 MACROS
################################################################################

#########################################
# PID Autotune Tool 1
########################################

[gcode_macro PID_Tool1]
 gcode:
      SET_FAN_SPEED FAN=Tool_1_partfan SPEED=1
      PID_CALIBRATE HEATER=extruder1 TARGET=230
      SET_FAN_SPEED FAN=Tool_1_partfan SPEED=0
      

#########################################
# Shaper Calibrate Tool1
########################################

[gcode_macro RESONACE_CALIBRATION_Tool1]
gcode:
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    M118 This will measure the resonaces on X and Y-Axis for Tool1.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME
    #G28
    Tool1
    G1 X{xplorer.res_x} Y{xplorer.res_y} F10000
    G1 Z{xplorer.res_z} F2000
    TEST_RESONANCES AXIS=X ACCELEROMETER=Tool1
    RUN_SHELL_COMMAND CMD=resonaces_x_t1
    TEST_RESONANCES AXIS=Y ACCELEROMETER=Tool1
    RUN_SHELL_COMMAND CMD=resonaces_y_t1
    M118 Resonace test is complete. Check the PNG files for details


################################################################################
### T2 MACROS
################################################################################

#########################################
# PID Autotune Tool 2
########################################

[gcode_macro PID_Tool2]
 gcode:
      SET_FAN_SPEED FAN=Tool_2_partfan SPEED=1
      PID_CALIBRATE HEATER=extruder2 TARGET=230
      SET_FAN_SPEED FAN=Tool_2_partfan SPEED=0
      

#########################################
# Shaper Calibrate Tool2
########################################

[gcode_macro RESONANCE_CALIBRATION_Tool2]
gcode:
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    M118 This will measure the resonaces on X and Y-Axis for Tool2.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME
    #G28
    Tool2
    G1 X{xplorer.res_x} Y{xplorer.res_y} F10000
    G1 Z{xplorer.res_z} F2000
    TEST_RESONANCES AXIS=X ACCELEROMETER=Tool2
    RUN_SHELL_COMMAND CMD=resonaces_x_t2
    TEST_RESONANCES AXIS=Y ACCELEROMETER=Tool2
    RUN_SHELL_COMMAND CMD=resonaces_y_t2
    M118 Resonace test is complete. Check the PNG files for details


################################################################################
### T3 MACROS
################################################################################

#########################################
# PID Autotune Tool 3
########################################

[gcode_macro PID_Tool3]
 gcode:
      SET_FAN_SPEED FAN=Tool_3_partfan SPEED=1
      PID_CALIBRATE HEATER=extruder3 TARGET=230
      SET_FAN_SPEED FAN=Tool_3_partfan SPEED=0
      

#########################################
# Shaper Calibrate Tool3
########################################

[gcode_macro RESONANCE_CALIBRATION_Tool3]
gcode:
    {% set xplorer = printer['gcode_macro _XPLORER_VARIABLES'] %}
    M118 This will measure the resonaces on X and Y-Axis for Tool3.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME
    #G28
    Tool3
    G1 X{xplorer.res_x} Y{xplorer.res_y} F10000
    G1 Z{xplorer.res_z} F2000
    TEST_RESONANCES AXIS=X ACCELEROMETER=Tool3
    RUN_SHELL_COMMAND CMD=resonaces_x_t3
    TEST_RESONANCES AXIS=Y ACCELEROMETER=Tool3
    RUN_SHELL_COMMAND CMD=resonaces_y_t3
    M118 Resonace test is complete. Check the PNG files for details


################################################################################
### SHELL COMMANDS - BASE
################################################################################

##################################
# Shell Commands
##################################


#######################################################
# Store the curent system password in a local file to be automativally used when flashing MCUs
#######################################################

[gcode_shell_command write_password]
command: sh /home/biqu/printer_data/config/0_Xplorer/.9_MCU_Flash/scripts/.store_syspass.sh 
timeout: 10.

[gcode_macro System_Password]
description: Stores the system password for flashing the MCUs.The execution of this macro is only need if you've changed the system password lately.
gcode:
      RESPOND MSG="Please note: the password may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. The password cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
     
      RUN_SHELL_COMMAND CMD=write_password PARAMS={params.PASSWORD}

      M118 You only need to redo this step when you change the system password again!


#######################################################
# Wifi Setup
#######################################################

[gcode_shell_command setup_wifi]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/setup_wifi.sh
timeout: 20

[gcode_macro Setup_WiFi]
description: Setup WiFi by providing SSID and Password
gcode:
    RESPOND MSG="Starting WiFi setup with SSID: {params.SSID}"
    RUN_SHELL_COMMAND CMD=setup_wifi PARAMS="WIFI_SSID={params.SSID} WIFI_PASSWD={params.PASSWORD}"
    M118 WiFi setup initiated. Please wait a moment and then check the connection.

#######################################################
# Time zone settings
#######################################################

[gcode_shell_command set_time_zone]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/setup_timezone.sh
timeout: 20

[gcode_macro Setup_Time_Zone]
description: Setup Time Zone by providing Continent and City 
gcode:
    RESPOND MSG="Starting WiFi setup with SSID: {params.CONTINENT} {params.CITY} "
    RUN_SHELL_COMMAND CMD=set_time_zone PARAMS="CONTINENT={params.CONTINENT} CITY={params.CITY}"
    M118 Time zone setup done.
    M118 System needs to reboot in order for the changes to take effect!


#######################################################
# Flash xplorer MCU Mainboard BTT Manta M8P V1.1
#######################################################

#[gcode_shell_command flash_mcu_mb]
#command: sh /home/biqu/printer_data/config/0_Xplorer/.9_MCU_Flash/scripts/flash_M1_BTTM8PV11.sh
#timeout: 80

#######################################################
# Flash xplorer MCU Mainboard BTT Manta M8P V2.0
#######################################################

[gcode_shell_command flash_mcu_mb]
command: sh /home/biqu/printer_data/config/0_Xplorer/.9_MCU_Flash/scripts/flash_M1_BTTM8PV20.sh
timeout: 80

[gcode_macro Flash_Mainboard]
description: This macro flashes the Mainboard with the latest Klipper version from your system
gcode:
    M118 This will flash the mainboard with the latest Klipper firmware.
    M118 The process may take a few minutes, so be patient.
    RUN_SHELL_COMMAND CMD=flash_mcu_mb
    M118 Flash is COMPLETE

#######################################################
# Play Sounds
#######################################################

[gcode_shell_command printstart_audio]
command: /bin/bash -c "mplayer -quiet -ao alsa -nolirc /home/biqu/printer_data/config/.10__Audio/start_print.mp3 > /dev/null 2>&1"
timeout: 80

[gcode_macro printstart_audio]
gcode:
    RUN_SHELL_COMMAND CMD=printstart_audio


####################    

[gcode_shell_command printend_audio]
command: /bin/bash -c "mplayer -quiet -ao alsa -nolirc /home/biqu/printer_data/config/.10__Audio/end_print.mp3 > /dev/null 2>&1"
timeout: 80

[gcode_macro printend_audio]
gcode:
    RUN_SHELL_COMMAND CMD=printend_audio

####################    

[gcode_shell_command printpause_audio]
command: /bin/bash -c "mplayer -quiet -ao alsa -nolirc /home/biqu/printer_data/config/.10__Audio/pause_print.mp3 > /dev/null 2>&1"
timeout: 80

[gcode_macro printpause_audio]
gcode:
    RUN_SHELL_COMMAND CMD=printpause_audio

####################    

[gcode_shell_command printcancel_audio]
command: /bin/bash -c "mplayer -quiet -ao alsa -nolirc /home/biqu/printer_data/config/.10__Audio/cancel_print.mp3 > /dev/null 2>&1"
timeout: 80

[gcode_macro printcancel_audio]
gcode:
    RUN_SHELL_COMMAND CMD=printcancel_audio

####################    

[gcode_shell_command ACDC_thunderstruck]
command: /bin/bash -c "mplayer -quiet -ao alsa -nolirc /home/biqu/printer_data/config/.10__Audio/ACDC_Thunderstruck.mp3 > /dev/null 2>&1"
timeout: 400

[gcode_macro ACDC_thunderstruck]
gcode:
    RUN_SHELL_COMMAND CMD=ACDC_thunderstruck

####################    

[gcode_shell_command Metalica_EnterSandman]
command: /bin/bash -c "mplayer -quiet -ao alsa -nolirc /home/biqu/printer_data/config/.10__Audio/Metalica_EnterSandman.mp3 > /dev/null 2>&1"
timeout: 400

[gcode_macro Metalica_EnterSandman]
gcode:
    RUN_SHELL_COMMAND CMD=Metalica_EnterSandman


################################################################################
### SHELL COMMANDS - T0
################################################################################

##################################
# Shell Commands
##################################
#######################################################
# Flash xplorer Tool0 EBB36
#######################################################

[gcode_shell_command flash_mcu_t0]
command: sh /home/biqu/printer_data/config/0_Xplorer/.9_MCU_Flash/scripts/flash_EBB36T0.sh
timeout: 80

[gcode_macro Flash_Tool0]
description: This macro flashes the Tool0 board with the latest Klipper version from your system
gcode:
    M118 This will flash the Tool0 boars with the latest Klipper firmware.
    M118 The process may take a few minutes, so be patient.
    RUN_SHELL_COMMAND CMD=flash_mcu_t0
    M118 Flash is COMPLETE

#######################################################
# Measure Resonaces on X-Axis
#######################################################

[gcode_shell_command resonaces_x_t0]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_X_t0.sh
timeout: 80

[gcode_macro Measure_Resonances_X_T0]
description: This macro mesures the resonaces on the X-Axis and save a graphical representation as PNG-file
gcode:
    T0
    M118 This will measure the resonaces on X-Axis for Tool0.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME
    #G28
    G1 X210 Y200 F10000
    G1 Z50 F2000
    TEST_RESONANCES AXIS=X ACCELEROMETER=Tool0
    RUN_SHELL_COMMAND CMD=resonaces_x_t0
    M118 Resonace test is complete. Check the PNG file for details

#######################################################
# Measure Resonaces on Y-Axis
#######################################################

[gcode_shell_command resonaces_y_t0]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_Y_t0.sh
timeout: 80

[gcode_macro Measure_Resonances_Y_T0]
description: This macro mesures the resonaces on the Y-Axis and save a graphical representation as PNG-file
gcode:
    M118 This will measure the resonaces on Y-Axis for Tool0.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME
    #G28
    G1 X210 Y200 F10000
    G1 Z50 F2000
    TEST_RESONANCES AXIS=Y ACCELEROMETER=Tool0
    RUN_SHELL_COMMAND CMD=resonaces_y_t0
    M118 Resonace test is complete. Check the PNG file for details


################################################################################
### SHELL COMMANDS - T1
################################################################################

##################################
# Shell Commands
##################################



#######################################################
# Copy XY-Calibration Print to Gcode folder
#######################################################

#[gcode_shell_command copy_calibration_gcode]
#command: sh /home/biqu/printer_data/config/0__xplorer/.8__Formbot__Scripts/copy_calibr_gcode.sh
#timeout: 20

#[gcode_macro Calibration_print_dual_extrusion]
#description: Printing a calibration model for T1 xy-offsets
#gcode:
 #    M118 Start printing the calibration model
  #   RUN_SHELL_COMMAND CMD=copy_calibration_gcode
   #  SDCARD_PRINT_FILE FILENAME=.Offset_XY_dual_extruder.gcode

#######################################################
# Flash xplorer Tool1 EBB36
#######################################################

[gcode_shell_command flash_mcu_t1]
command: sh /home/biqu/printer_data/config/0_Xplorer/.9_MCU_Flash/scripts/flash_EBB36T1.sh
timeout: 80

[gcode_macro Flash_Tool1]
description: This macro flashes the Tool1 board with the latest Klipper version from your system
gcode:
    M118 This will flash the Tool1 boars with the latest Klipper firmware.
    M118 The process may take a few minutes, so be patient.
    RUN_SHELL_COMMAND CMD=flash_mcu_t1
    M118 Flash is COMPLETE
#######################################################
# Measure Resonaces on X-Axis
#######################################################

[gcode_shell_command resonaces_x_t1]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_X_t1.sh
timeout: 80

[gcode_macro Measure_Resonances_X_T1]
description: This macro mesures the resonaces on the X-Axis and save a graphical representation as PNG-file
gcode:
    T1
    M118 This will measure the resonaces on X-Axis for Tool1.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME
    #G28
    G1 X210 Y200 F10000
    G1 Z50 F2000
    TEST_RESONANCES AXIS=X ACCELEROMETER=Tool1
    RUN_SHELL_COMMAND CMD=resonaces_x_t1
    M118 Resonace test is complete. Check the PNG file for details

#######################################################
# Measure Resonaces on Y-Axis
#######################################################

[gcode_shell_command resonaces_y_t1]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_Y_t1.sh
timeout: 80

[gcode_macro Measure_Resonances_Y_T1]
description: This macro mesures the resonaces on the Y-Axis and save a graphical representation as PNG-file
gcode:
    M118 This will measure the resonaces on Y-Axis for Tool1.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME
    #G28
    G1 X210 Y200 F10000
    G1 Z50 F2000
    TEST_RESONANCES AXIS=Y ACCELEROMETER=Tool1
    RUN_SHELL_COMMAND CMD=resonaces_y_t1
    M118 Resonace test is complete. Check the PNG file for details


################################################################################
### SHELL COMMANDS - T2
################################################################################

##################################
# Shell Commands
##################################



#######################################################
# Copy XY-Calibration Print to Gcode folder
#######################################################

#[gcode_shell_command copy_calibration_gcode]
#command: sh /home/biqu/printer_data/config/0__xplorer/.8__Formbot__Scripts/copy_calibr_gcode.sh
#timeout: 20

#[gcode_macro Calibration_print_dual_extrusion]
#description: Printing a calibration model for T1 xy-offsets
#gcode:
 #    M118 Start printing the calibration model
  #   RUN_SHELL_COMMAND CMD=copy_calibration_gcode
   #  SDCARD_PRINT_FILE FILENAME=.Offset_XY_dual_extruder.gcode

#######################################################
# Flash xplorer Tool2 EBB36
#######################################################

[gcode_shell_command flash_mcu_t2]
command: sh /home/biqu/printer_data/config/0_Xplorer/.9_MCU_Flash/scripts/flash_EBB36T2.sh
timeout: 80

[gcode_macro Flash_Tool2]
description: This macro flashes the Tool2 board with the latest Klipper version from your system
gcode:
    M118 This will flash the Tool2 boars with the latest Klipper firmware.
    M118 The process may take a few minutes, so be patient.
    RUN_SHELL_COMMAND CMD=flash_mcu_t2
    M118 Flash is COMPLETE
#######################################################
# Measure Resonaces on X-Axis
#######################################################

[gcode_shell_command resonaces_x_t2]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_X_t2.sh
timeout: 80

[gcode_macro Measure_Resonances_X_T2]
description: This macro mesures the resonaces on the X-Axis and save a graphical representation as PNG-file
gcode:
    T1
    M118 This will measure the resonaces on X-Axis for Tool2.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME
    #G28
    G1 X210 Y200 F10000
    G1 Z50 F2000
    TEST_RESONANCES AXIS=X ACCELEROMETER=Tool2
    RUN_SHELL_COMMAND CMD=resonaces_x_t2
    M118 Resonace test is complete. Check the PNG file for details

#######################################################
# Measure Resonaces on Y-Axis
#######################################################

[gcode_shell_command resonaces_y_t2]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_Y_t2.sh
timeout: 80

[gcode_macro Measure_Resonances_Y_T2]
description: This macro mesures the resonaces on the Y-Axis and save a graphical representation as PNG-file
gcode:
    M118 This will measure the resonaces on Y-Axis for Tool2.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME
    #G28
    G1 X210 Y200 F10000
    G1 Z50 F2000
    TEST_RESONANCES AXIS=Y ACCELEROMETER=Tool2
    RUN_SHELL_COMMAND CMD=resonaces_y_t2
    M118 Resonace test is complete. Check the PNG file for details


################################################################################
### SHELL COMMANDS - T3
################################################################################

##################################
# Shell Commands
##################################



#######################################################
# Copy XY-Calibration Print to Gcode folder
#######################################################

#[gcode_shell_command copy_calibration_gcode]
#command: sh /home/biqu/printer_data/config/0__xplorer/.8__Formbot__Scripts/copy_calibr_gcode.sh
#timeout: 20

#[gcode_macro Calibration_print_dual_extrusion]
#description: Printing a calibration model for T3 xy-offsets
#gcode:
 #    M118 Start printing the calibration model
  #   RUN_SHELL_COMMAND CMD=copy_calibration_gcode
   #  SDCARD_PRINT_FILE FILENAME=.Offset_XY_dual_extruder.gcode

#######################################################
# Flash xplorer Tool3 EBB36
#######################################################

[gcode_shell_command flash_mcu_t3]
command: sh /home/biqu/printer_data/config/0_Xplorer/.9_MCU_Flash/scripts/flash_EBB36T3.sh
timeout: 80

[gcode_macro Flash_Tool3]
description: This macro flashes the Tool3 board with the latest Klipper version from your system
gcode:
    M118 This will flash the Tool3 boars with the latest Klipper firmware.
    M118 The process may take a few minutes, so be patient.
    RUN_SHELL_COMMAND CMD=flash_mcu_t3
    M118 Flash is COMPLETE
#######################################################
# Measure Resonaces on X-Axis
#######################################################

[gcode_shell_command resonaces_x_t3]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_X_t3.sh
timeout: 80

[gcode_macro Measure_Resonances_X_T3]
description: This macro mesures the resonaces on the X-Axis and save a graphical representation as PNG-file
gcode:
    T3
    M118 This will measure the resonaces on X-Axis for Tool3.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME
    #G28
    G1 X210 Y200 F10000
    G1 Z50 F2000
    TEST_RESONANCES AXIS=X ACCELEROMETER=Tool3
    RUN_SHELL_COMMAND CMD=resonaces_x_t3
    M118 Resonace test is complete. Check the PNG file for details

#######################################################
# Measure Resonaces on Y-Axis
#######################################################

[gcode_shell_command resonaces_y_t3]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_Y_t3.sh
timeout: 80

[gcode_macro Measure_Resonances_Y_T3]
description: This macro mesures the resonaces on the Y-Axis and save a graphical representation as PNG-file
gcode:
    M118 This will measure the resonaces on Y-Axis for Tool3.
    M118 The process may take a few minutes, so be patient.
    CHECK_HOME
    #G28
    G1 X210 Y200 F10000
    G1 Z50 F2000
    TEST_RESONANCES AXIS=Y ACCELEROMETER=Tool3
    RUN_SHELL_COMMAND CMD=resonaces_y_t3
    M118 Resonace test is complete. Check the PNG file for details


################################################################################
### SHELL COMMANDS - IQEX
################################################################################

##################################
# Shell Commands
##################################
#######################################################
# Measure Resonaces on X-Axis Copy Mode
#######################################################

[gcode_shell_command resonaces_x_iqexcp]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_X_iqexcp.sh
timeout: 80

#######################################################
# Measure Resonaces on Y-Axis Copy Mode
#######################################################

[gcode_shell_command resonaces_y_iqexcp]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_Y_iqexcp.sh
timeout: 80

#######################################################
# Measure Resonaces on X-Axis Mirror Mode
#######################################################

[gcode_shell_command resonaces_x_iqexmr]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_X_iqexmr.sh
timeout: 80

#######################################################
# Measure Resonaces on Y-Axis Mirror Mode
#######################################################

[gcode_shell_command resonaces_y_iqexmr]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_Y_iqexmr.sh
timeout: 80

#######################################################
# Measure Resonaces on X-Axis Copy Mode
#######################################################

[gcode_shell_command resonaces_x_idexcp]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_X_idexcp.sh
timeout: 80

#######################################################
# Measure Resonaces on Y-Axis Copy Mode
#######################################################

[gcode_shell_command resonaces_y_idexcp]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_Y_idexcp.sh
timeout: 80

#######################################################
# Measure Resonaces on X-Axis Mirror Mode
#######################################################

[gcode_shell_command resonaces_x_idexmr]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_X_idexmr.sh
timeout: 80

#######################################################
# Measure Resonaces on Y-Axis Mirror Mode
#######################################################

[gcode_shell_command resonaces_y_idexmr]
command: sh /home/biqu/printer_data/config/0_Xplorer/.8_Scripts/resonances_Y_idexmr.sh
timeout: 80

#######################################################
# Flash xplorer MCU Ext BTT Pico
#######################################################

[gcode_shell_command flash_mcu_ext]
command: sh /home/biqu/printer_data/config/0_Xplorer/.9_MCU_Flash/scripts/flash_ext_BTTpico.sh
timeout: 80

[gcode_macro Flash_Extension]
description: This macro flashes the Extension Board with the latest Klipper version from your system
gcode:
    M118 This will flash the Extension Board with the latest Klipper firmware.
    M118 The process may take a few minutes, so be patient.
    RUN_SHELL_COMMAND CMD=flash_mcu_ext
    M118 Flash is COMPLETE
