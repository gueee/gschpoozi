#######################################
# Calibration and stepper identification macros
# Generated by gschpoozi v2.0
# 2025-12-20 08:24:39
#
# DO NOT EDIT - Changes will be overwritten
# Use user-overrides.cfg for customizations
#######################################

# ═════════════════════════════════════════════════════════════════════════════
# STEPPER IDENTIFICATION & CALIBRATION MACROS
# Generated by gschpoozi
# ═════════════════════════════════════════════════════════════════════════════
#
# These macros help you:
# 1. Identify which physical motor is connected to which driver
# 2. Verify motor directions are correct
# 3. For CoreXY AWD: Test motor pairs safely without risk of fighting
#
# Reference: https://www.klipper3d.org/Config_checks.html
#            https://mpx.wiki/Troubleshooting/corexy-direction
# ═════════════════════════════════════════════════════════════════════════════

[force_move]
enable_force_move: True
# Required for STEPPER_BUZZ and FORCE_MOVE commands

# ─────────────────────────────────────────────────────────────────────────────
# TMC DRIVER STATUS
# ─────────────────────────────────────────────────────────────────────────────

[gcode_macro QUERY_TMC_STATUS]
description: Query TMC driver status for all configured steppers
gcode:
    {% set steppers = printer.motion_report.steppers|default([]) %}
    M118 === TMC Driver Status ===
    {% for stepper in steppers %}
        {% set tmc_name = "tmc2209_" ~ stepper %}
        {% if printer[tmc_name] is defined %}
            M118 {stepper}: TMC2209 detected
            DUMP_TMC STEPPER={stepper}
        {% else %}
            {% set tmc_name = "tmc2240_" ~ stepper %}
            {% if printer[tmc_name] is defined %}
                M118 {stepper}: TMC2240 detected
                DUMP_TMC STEPPER={stepper}
            {% else %}
                {% set tmc_name = "tmc5160_" ~ stepper %}
                {% if printer[tmc_name] is defined %}
                    M118 {stepper}: TMC5160 detected
                    DUMP_TMC STEPPER={stepper}
                {% endif %}
            {% endif %}
        {% endif %}
    {% endfor %}
    M118 === End TMC Status ===

[gcode_macro CHECK_MOTOR_CONNECTED]
description: Check if a motor appears connected via TMC driver status
gcode:
    {% set stepper = params.STEPPER|default("stepper_x") %}
    M118 Checking {stepper}...
    DUMP_TMC STEPPER={stepper}
    M118 Look for 'ola' or 'olb' flags - if set, motor may be disconnected

# ─────────────────────────────────────────────────────────────────────────────
# INDIVIDUAL STEPPER IDENTIFICATION
# ─────────────────────────────────────────────────────────────────────────────

[gcode_macro IDENTIFY_STEPPER]
description: Buzz a single stepper to identify which physical motor it is
gcode:
    {% set stepper = params.STEPPER|default("stepper_x") %}
    M118 === Identifying {stepper} ===
    M118 Watch which motor moves (10 short buzzes)
    STEPPER_BUZZ STEPPER={stepper}
    M118 === Done identifying {stepper} ===

[gcode_macro IDENTIFY_ALL_STEPPERS]
description: Buzz each stepper one by one with pauses for identification
gcode:
    M118 === STEPPER IDENTIFICATION SEQUENCE ===
    M118 Each stepper will buzz 10 times. Watch and note which motor moves.
    M118
    M118 Starting in 3 seconds...
    G4 P3000

    M118 >>> STEPPER_X - Watch now...
    STEPPER_BUZZ STEPPER=stepper_x
    G4 P2000

    M118 >>> STEPPER_Y - Watch now...
    STEPPER_BUZZ STEPPER=stepper_y
    G4 P2000

    {% if printer.configfile.config.stepper_x1 is defined %}
    M118 >>> STEPPER_X1 - Watch now...
    STEPPER_BUZZ STEPPER=stepper_x1
    G4 P2000
    {% endif %}

    {% if printer.configfile.config.stepper_y1 is defined %}
    M118 >>> STEPPER_Y1 - Watch now...
    STEPPER_BUZZ STEPPER=stepper_y1
    G4 P2000
    {% endif %}

    M118 >>> STEPPER_Z - Watch now...
    STEPPER_BUZZ STEPPER=stepper_z
    G4 P2000

    {% if printer.configfile.config.stepper_z1 is defined %}
    M118 >>> STEPPER_Z1 - Watch now...
    STEPPER_BUZZ STEPPER=stepper_z1
    G4 P2000
    {% endif %}

    {% if printer.configfile.config.stepper_z2 is defined %}
    M118 >>> STEPPER_Z2 - Watch now...
    STEPPER_BUZZ STEPPER=stepper_z2
    G4 P2000
    {% endif %}

    {% if printer.configfile.config.stepper_z3 is defined %}
    M118 >>> STEPPER_Z3 - Watch now...
    STEPPER_BUZZ STEPPER=stepper_z3
    G4 P2000
    {% endif %}

    M118 >>> EXTRUDER - Watch now...
    STEPPER_BUZZ STEPPER=extruder

    M118 === IDENTIFICATION COMPLETE ===
    M118 Make note of which physical motor corresponds to each stepper name.

# ─────────────────────────────────────────────────────────────────────────────
# COREXY AWD SAFE PAIR TESTING
# Test one motor pair at a time to prevent motors from fighting
# ─────────────────────────────────────────────────────────────────────────────

[gcode_macro AWD_TEST_PAIR_A]
description: Test first motor pair (X+Y) with second pair (X1+Y1) disabled
gcode:
    {% set distance = params.DISTANCE|default(20)|float %}
    {% set speed = params.SPEED|default(50)|float %}

    M118 ════════════════════════════════════════════════════════════
    M118 AWD PAIR A TEST (stepper_x + stepper_y)
    M118 ════════════════════════════════════════════════════════════
    M118 This test moves ONLY stepper_x and stepper_y.
    M118 stepper_x1 and stepper_y1 are DISABLED.
    M118 The toolhead should move in a square pattern.

    # Disable second pair
    {% if printer.configfile.config.stepper_x1 is defined %}
        SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=0
    {% endif %}
    {% if printer.configfile.config.stepper_y1 is defined %}
        SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=0
    {% endif %}

    # Enable first pair
    SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
    SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1

    M118 Moving +X...
    FORCE_MOVE STEPPER=stepper_x DISTANCE={distance} VELOCITY={speed}
    FORCE_MOVE STEPPER=stepper_y DISTANCE={distance} VELOCITY={speed}
    G4 P500

    M118 Moving +Y...
    FORCE_MOVE STEPPER=stepper_x DISTANCE={distance} VELOCITY={speed}
    FORCE_MOVE STEPPER=stepper_y DISTANCE={-distance} VELOCITY={speed}
    G4 P500

    M118 Moving -X...
    FORCE_MOVE STEPPER=stepper_x DISTANCE={-distance} VELOCITY={speed}
    FORCE_MOVE STEPPER=stepper_y DISTANCE={-distance} VELOCITY={speed}
    G4 P500

    M118 Moving -Y (back to start)...
    FORCE_MOVE STEPPER=stepper_x DISTANCE={-distance} VELOCITY={speed}
    FORCE_MOVE STEPPER=stepper_y DISTANCE={distance} VELOCITY={speed}

    M118 PAIR A TEST COMPLETE
    M118 Did the toolhead move in a correct square pattern?

[gcode_macro AWD_TEST_PAIR_B]
description: Test second motor pair (X1+Y1) with first pair (X+Y) disabled
gcode:
    {% set distance = params.DISTANCE|default(20)|float %}
    {% set speed = params.SPEED|default(50)|float %}

    {% if printer.configfile.config.stepper_x1 is not defined or printer.configfile.config.stepper_y1 is not defined %}
        M118 ERROR: AWD_TEST_PAIR_B requires AWD configuration (stepper_x1 and stepper_y1)
        M118 This macro is only for All Wheel Drive printers.
    {% else %}
        M118 ════════════════════════════════════════════════════════════
        M118 AWD PAIR B TEST (stepper_x1 + stepper_y1)
        M118 ════════════════════════════════════════════════════════════
        M118 This test moves ONLY stepper_x1 and stepper_y1.
        M118 stepper_x and stepper_y are DISABLED.
        M118 Should move in the SAME pattern as Pair A.

        # Disable first pair
        SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0
        SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0

        # Enable second pair
        SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
        SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1

        M118 Moving +X...
        FORCE_MOVE STEPPER=stepper_x1 DISTANCE={distance} VELOCITY={speed}
        FORCE_MOVE STEPPER=stepper_y1 DISTANCE={distance} VELOCITY={speed}
        G4 P500

        M118 Moving +Y...
        FORCE_MOVE STEPPER=stepper_x1 DISTANCE={distance} VELOCITY={speed}
        FORCE_MOVE STEPPER=stepper_y1 DISTANCE={-distance} VELOCITY={speed}
        G4 P500

        M118 Moving -X...
        FORCE_MOVE STEPPER=stepper_x1 DISTANCE={-distance} VELOCITY={speed}
        FORCE_MOVE STEPPER=stepper_y1 DISTANCE={-distance} VELOCITY={speed}
        G4 P500

        M118 Moving -Y (back to start)...
        FORCE_MOVE STEPPER=stepper_x1 DISTANCE={-distance} VELOCITY={speed}
        FORCE_MOVE STEPPER=stepper_y1 DISTANCE={distance} VELOCITY={speed}

        M118 PAIR B TEST COMPLETE
        M118 Did it move the SAME as Pair A?
    {% endif %}

[gcode_macro AWD_ENABLE_ALL]
description: Re-enable all AWD motors after testing
gcode:
    M118 Re-enabling all motors...
    SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
    SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
    {% if printer.configfile.config.stepper_x1 is defined %}
        SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
    {% endif %}
    {% if printer.configfile.config.stepper_y1 is defined %}
        SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1
    {% endif %}
    M118 All motors enabled.

[gcode_macro AWD_FULL_TEST]
description: Run complete AWD motor pair verification sequence
gcode:
    {% set distance = params.DISTANCE|default(20)|float %}

    M118 ════════════════════════════════════════════════════════════════════
    M118 COREXY AWD FULL CALIBRATION SEQUENCE
    M118 ════════════════════════════════════════════════════════════════════
    M118 Testing each motor pair separately for safety.
    M118 If anything looks wrong, use EMERGENCY STOP (M112)!
    M118 Starting Pair A test in 5 seconds...
    G4 P5000

    AWD_TEST_PAIR_A DISTANCE={distance}

    M118 Pausing 5 seconds before Pair B test...
    G4 P5000

    AWD_TEST_PAIR_B DISTANCE={distance}

    AWD_ENABLE_ALL

    M118 ════════════════════════════════════════════════════════════════════
    M118 AWD CALIBRATION COMPLETE
    M118 ════════════════════════════════════════════════════════════════════
    M118 If both pairs moved identically: AWD is correctly configured!
    M118 If not, see: https://mpx.wiki/Troubleshooting/corexy-direction

# ─────────────────────────────────────────────────────────────────────────────
# CALIBRATION WIZARD
# ─────────────────────────────────────────────────────────────────────────────

[gcode_macro STEPPER_CALIBRATION_WIZARD]
description: Display stepper calibration instructions
gcode:
    M118 ════════════════════════════════════════════════════════════════════
    M118 STEPPER CALIBRATION WIZARD
    M118 ════════════════════════════════════════════════════════════════════
    M118
    M118 STEP 1: MOTOR IDENTIFICATION
    M118 Run: IDENTIFY_ALL_STEPPERS
    M118 Watch each motor and note which one corresponds to each name.
    M118
    M118 STEP 2: TMC STATUS CHECK
    M118 Run: QUERY_TMC_STATUS
    M118 Verify all drivers communicate properly.
    M118
    M118 STEP 3: DIRECTION VERIFICATION
    M118 Run: AWD_FULL_TEST
    M118 Tests each motor pair separately for safety.
    M118
    M118 ════════════════════════════════════════════════════════════════════
    M118 References:
    M118   https://www.klipper3d.org/Config_checks.html
    M118   https://mpx.wiki/Troubleshooting/corexy-direction
    M118 ════════════════════════════════════════════════════════════════════
