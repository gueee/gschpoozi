# config-sections.yaml
# Jinja2 templates for generating Klipper configuration from wizard state
# Version: 2.0

# Template syntax:
#   {{ variable }} - Insert value from wizard state
#   {% if condition %} - Conditional block
#   {# comment #} - Template comment
#   Filters: | default(value), | int, | float, | lower

# -----------------------------------------------------------------------------
# MCU Configuration
# -----------------------------------------------------------------------------
mcu:
  main:
    template: |
      [mcu]
      serial: {{ mcu.main.serial }}
      {% if mcu.main.restart_method is defined and mcu.main.restart_method and mcu.main.restart_method != 'command' %}
      restart_method: {{ mcu.main.restart_method }}
      {% endif %}

  toolboard:
    condition: "mcu.toolboard.enabled"
    template: |
      [mcu toolboard]
      {% if mcu.toolboard.connection_type == 'CAN' %}
      canbus_uuid: {{ mcu.toolboard.canbus_uuid }}
      {% else %}
      serial: {{ mcu.toolboard.serial }}
      {% endif %}

  host:
    condition: "mcu.host.enabled"
    template: |
      [mcu rpi]
      serial: {{ mcu.host.serial | default('/tmp/klipper_host_mcu', true) }}


# -----------------------------------------------------------------------------
# Printer Settings
# -----------------------------------------------------------------------------
printer:
  template: |
    [printer]
    kinematics: {{ printer.kinematics }}
    max_velocity: {{ printer.max_velocity | default(300) }}
    max_accel: {{ printer.max_accel | default(3000) }}
    max_z_velocity: {{ printer.max_z_velocity | default(15) }}
    max_z_accel: {{ printer.max_z_accel | default(350) }}
    {% if printer.square_corner_velocity %}
    square_corner_velocity: {{ printer.square_corner_velocity }}
    {% endif %}
    {% if printer.minimum_cruise_ratio %}
    minimum_cruise_ratio: {{ printer.minimum_cruise_ratio }}
    {% endif %}

# -----------------------------------------------------------------------------
# Steppers
# -----------------------------------------------------------------------------
stepper_x:
  template: |
    [stepper_x]
    step_pin: {{ pins.stepper_x.step }}
    dir_pin: {{ pins.stepper_x.dir }}
    enable_pin: {{ pins.stepper_x.enable }}
    rotation_distance: {{ stepper_x.belt_pitch * stepper_x.pulley_teeth }}
    microsteps: {{ stepper_x.microsteps | default(16) }}
    full_steps_per_rotation: {{ stepper_x.full_steps_per_rotation | default(200) }}
    endstop_pin: {{ pins.stepper_x.endstop }}
    position_endstop: {{ stepper_x.position_endstop }}
    # Klipper requires position_endstop to be between position_min and position_max.
    # When position_min is missing, only default it to position_endstop if the endstop is negative
    # (common for wipe zones). Otherwise default to 0 to avoid unintentionally shrinking travel.
    {% if stepper_x.position_min is defined %}
    position_min: {{ stepper_x.position_min }}
    {% else %}
    {% set _xe = (stepper_x.position_endstop | default(0) | float) %}
    position_min: {{ _xe if _xe < 0 else 0 }}
    {% endif %}
    position_max: {{ stepper_x.position_max | default(printer.bed_size_x) }}
    homing_speed: {{ stepper_x.homing_speed | default(50) }}
    {% if stepper_x.endstop_type != 'sensorless' %}
    # Allow explicit 0 (required for some probe/virtual-endstop homing behaviors)
    homing_retract_dist: {{ stepper_x.homing_retract_dist if (stepper_x.homing_retract_dist is defined) else 5 }}
    {% else %}
    homing_retract_dist: {{ stepper_x.homing_retract_dist | default(0) }}
    {% endif %}
    {% if stepper_x.second_homing_speed %}
    second_homing_speed: {{ stepper_x.second_homing_speed }}
    {% endif %}

stepper_y:
  template: |
    [stepper_y]
    step_pin: {{ pins.stepper_y.step }}
    dir_pin: {{ pins.stepper_y.dir }}
    enable_pin: {{ pins.stepper_y.enable }}
    rotation_distance: {{ stepper_y.belt_pitch * stepper_y.pulley_teeth }}
    microsteps: {{ stepper_y.microsteps | default(16) }}
    full_steps_per_rotation: {{ stepper_y.full_steps_per_rotation | default(200) }}
    endstop_pin: {{ pins.stepper_y.endstop }}
    position_endstop: {{ stepper_y.position_endstop }}
    # Klipper requires position_endstop to be between position_min and position_max.
    # When position_min is missing, only default it to position_endstop if the endstop is negative
    # (common for wipe zones). Otherwise default to 0 to avoid unintentionally shrinking travel.
    {% if stepper_y.position_min is defined %}
    position_min: {{ stepper_y.position_min }}
    {% else %}
    {% set _ye = (stepper_y.position_endstop | default(0) | float) %}
    position_min: {{ _ye if _ye < 0 else 0 }}
    {% endif %}
    position_max: {{ stepper_y.position_max | default(printer.bed_size_y) }}
    homing_speed: {{ stepper_y.homing_speed | default(50) }}
    {% if stepper_y.endstop_type != 'sensorless' %}
    # Allow explicit 0 (required for some probe/virtual-endstop homing behaviors)
    homing_retract_dist: {{ stepper_y.homing_retract_dist if (stepper_y.homing_retract_dist is defined) else 5 }}
    {% else %}
    homing_retract_dist: {{ stepper_y.homing_retract_dist | default(0) }}
    {% endif %}

stepper_z:
  template: |
    [stepper_z]
    step_pin: {{ pins.stepper_z.step }}
    dir_pin: {{ pins.stepper_z.dir }}
    enable_pin: {{ pins.stepper_z.enable }}
    {% if stepper_z.drive_type == 'leadscrew' %}
    rotation_distance: {{ stepper_z.leadscrew_pitch }}
    {% else %}
    rotation_distance: {{ (stepper_z.belt_pitch | default(2)) * (stepper_z.pulley_teeth | default(20)) }}
    {% endif %}
    {% if stepper_z.gear_ratio %}
    gear_ratio: {{ stepper_z.gear_ratio }}
    {% endif %}
    microsteps: {{ stepper_z.microsteps | default(32) }}
    full_steps_per_rotation: {{ stepper_z.full_steps_per_rotation | default(200) }}
    endstop_pin: {{ pins.stepper_z.endstop }}
    position_min: {{ stepper_z.position_min | default(-5) }}
    position_max: {{ stepper_z.position_max | default(printer.bed_size_z) }}
    homing_speed: {{ stepper_z.homing_speed | default(10) }}
    homing_retract_dist: {{ stepper_z.homing_retract_dist | default(0) }}

# Multi-Z Steppers (for Z Tilt / QGL)
stepper_z1:
  condition: "stepper_z.z_motor_count >= 2"
  template: |
    [stepper_z1]
    step_pin: {{ pins.stepper_z1.step }}
    dir_pin: {{ pins.stepper_z1.dir }}
    enable_pin: {{ pins.stepper_z1.enable }}
    {% if stepper_z.drive_type == 'leadscrew' %}
    rotation_distance: {{ stepper_z.leadscrew_pitch }}
    {% else %}
    rotation_distance: {{ (stepper_z.belt_pitch | default(2)) * (stepper_z.pulley_teeth | default(20)) }}
    {% endif %}
    {% if stepper_z.gear_ratio %}
    gear_ratio: {{ stepper_z.gear_ratio }}
    {% endif %}
    microsteps: {{ stepper_z.microsteps | default(32) }}
    full_steps_per_rotation: {{ stepper_z.full_steps_per_rotation | default(200) }}

stepper_z2:
  condition: "stepper_z.z_motor_count >= 3"
  template: |
    [stepper_z2]
    step_pin: {{ pins.stepper_z2.step }}
    dir_pin: {{ pins.stepper_z2.dir }}
    enable_pin: {{ pins.stepper_z2.enable }}
    {% if stepper_z.drive_type == 'leadscrew' %}
    rotation_distance: {{ stepper_z.leadscrew_pitch }}
    {% else %}
    rotation_distance: {{ (stepper_z.belt_pitch | default(2)) * (stepper_z.pulley_teeth | default(20)) }}
    {% endif %}
    {% if stepper_z.gear_ratio %}
    gear_ratio: {{ stepper_z.gear_ratio }}
    {% endif %}
    microsteps: {{ stepper_z.microsteps | default(32) }}
    full_steps_per_rotation: {{ stepper_z.full_steps_per_rotation | default(200) }}

stepper_z3:
  condition: "stepper_z.z_motor_count >= 4"
  template: |
    [stepper_z3]
    step_pin: {{ pins.stepper_z3.step }}
    dir_pin: {{ pins.stepper_z3.dir }}
    enable_pin: {{ pins.stepper_z3.enable }}
    {% if stepper_z.drive_type == 'leadscrew' %}
    rotation_distance: {{ stepper_z.leadscrew_pitch }}
    {% else %}
    rotation_distance: {{ (stepper_z.belt_pitch | default(2)) * (stepper_z.pulley_teeth | default(20)) }}
    {% endif %}
    {% if stepper_z.gear_ratio %}
    gear_ratio: {{ stepper_z.gear_ratio }}
    {% endif %}
    microsteps: {{ stepper_z.microsteps | default(32) }}
    full_steps_per_rotation: {{ stepper_z.full_steps_per_rotation | default(200) }}

# AWD (All Wheel Drive) Secondary Steppers
stepper_x1:
  condition: "printer.awd_enabled"
  template: |
    [stepper_x1]
    step_pin: {{ pins.stepper_x1.step }}
    dir_pin: {{ pins.stepper_x1.dir }}
    enable_pin: {{ pins.stepper_x1.enable }}
    rotation_distance: {{ (stepper_x1.belt_pitch | default(stepper_x.belt_pitch)) * (stepper_x1.pulley_teeth | default(stepper_x.pulley_teeth)) }}
    microsteps: {{ stepper_x1.microsteps | default(stepper_x.microsteps) | default(32) }}
    full_steps_per_rotation: {{ stepper_x1.full_steps_per_rotation | default(stepper_x.full_steps_per_rotation) | default(200) }}

stepper_y1:
  condition: "printer.awd_enabled"
  template: |
    [stepper_y1]
    step_pin: {{ pins.stepper_y1.step }}
    dir_pin: {{ pins.stepper_y1.dir }}
    enable_pin: {{ pins.stepper_y1.enable }}
    rotation_distance: {{ (stepper_y1.belt_pitch | default(stepper_y.belt_pitch)) * (stepper_y1.pulley_teeth | default(stepper_y.pulley_teeth)) }}
    microsteps: {{ stepper_y1.microsteps | default(stepper_y.microsteps) | default(32) }}
    full_steps_per_rotation: {{ stepper_y1.full_steps_per_rotation | default(stepper_y.full_steps_per_rotation) | default(200) }}

# -----------------------------------------------------------------------------
# TMC Drivers
# -----------------------------------------------------------------------------
tmc_stepper_x:
  template: |
    [{{ stepper_x.driver_type | lower }} stepper_x]
    {% if stepper_x.driver_protocol == 'spi' %}
    cs_pin: {{ pins.stepper_x.cs }}
    spi_software_miso_pin: {{ board.spi.miso }}
    spi_software_mosi_pin: {{ board.spi.mosi }}
    spi_software_sclk_pin: {{ board.spi.sclk }}
    {% else %}
    uart_pin: {{ pins.stepper_x.uart }}
    {% endif %}
    run_current: {{ stepper_x.run_current }}
    interpolate: {{ stepper_x.interpolate | default(false) | lower }}
    {% if stepper_x.driver_protocol == 'spi' %}
    sense_resistor: {{ stepper_x.sense_resistor | default(0.075) }}
    {% else %}
    sense_resistor: {{ stepper_x.sense_resistor | default(0.110) }}
    {% endif %}
    {% if stepper_x.driver_type == 'TMC5160' %}
    driver_tbl: {{ stepper_x.driver_tbl | default(1) }}
    driver_toff: {{ stepper_x.driver_toff | default(3) }}
    driver_diss2g: {{ stepper_x.driver_diss2g | default(1) }}
    driver_diss2vs: {{ stepper_x.driver_diss2vs | default(1) }}
    {% endif %}
    {% if stepper_x.endstop_type == 'sensorless' %}
    diag_pin: {{ pins.stepper_x.diag }}
    driver_SGTHRS: {{ stepper_x.driver_SGTHRS | default(70) }}
    {% endif %}

tmc_stepper_y:
  template: |
    [{{ stepper_y.driver_type | lower }} stepper_y]
    {% if stepper_y.driver_protocol == 'spi' %}
    cs_pin: {{ pins.stepper_y.cs }}
    spi_software_miso_pin: {{ board.spi.miso }}
    spi_software_mosi_pin: {{ board.spi.mosi }}
    spi_software_sclk_pin: {{ board.spi.sclk }}
    {% else %}
    uart_pin: {{ pins.stepper_y.uart }}
    {% endif %}
    run_current: {{ stepper_y.run_current }}
    interpolate: {{ stepper_y.interpolate | default(false) | lower }}
    {% if stepper_y.driver_protocol == 'spi' %}
    sense_resistor: {{ stepper_y.sense_resistor | default(0.075) }}
    {% else %}
    sense_resistor: {{ stepper_y.sense_resistor | default(0.110) }}
    {% endif %}
    {% if stepper_y.driver_type == 'TMC5160' %}
    driver_tbl: {{ stepper_y.driver_tbl | default(1) }}
    driver_toff: {{ stepper_y.driver_toff | default(3) }}
    driver_diss2g: {{ stepper_y.driver_diss2g | default(1) }}
    driver_diss2vs: {{ stepper_y.driver_diss2vs | default(1) }}
    {% endif %}
    {% if stepper_y.endstop_type == 'sensorless' %}
    diag_pin: {{ pins.stepper_y.diag }}
    driver_SGTHRS: {{ stepper_y.driver_SGTHRS | default(70) }}
    {% endif %}

tmc_stepper_z:
  template: |
    [{{ stepper_z.driver_type | default('TMC2209') | lower }} stepper_z]
    {% if stepper_z.driver_protocol == 'spi' %}
    cs_pin: {{ pins.stepper_z.cs }}
    spi_software_miso_pin: {{ board.spi.miso }}
    spi_software_mosi_pin: {{ board.spi.mosi }}
    spi_software_sclk_pin: {{ board.spi.sclk }}
    {% else %}
    uart_pin: {{ pins.stepper_z.uart }}
    {% endif %}
    run_current: {{ stepper_z.run_current | default(0.8) }}
    interpolate: {{ stepper_z.interpolate | default(false) | lower }}
    sense_resistor: {{ stepper_z.sense_resistor | default(0.110) }}
    {% if stepper_z.driver_type == 'TMC5160' %}
    driver_tbl: {{ stepper_z.driver_tbl | default(1) }}
    driver_toff: {{ stepper_z.driver_toff | default(3) }}
    driver_diss2g: {{ stepper_z.driver_diss2g | default(1) }}
    driver_diss2vs: {{ stepper_z.driver_diss2vs | default(1) }}
    {% endif %}

# Multi-Z TMC Drivers
tmc_stepper_z1:
  condition: "stepper_z.z_motor_count >= 2"
  template: |
    [{{ stepper_z.driver_type | default('TMC2209') | lower }} stepper_z1]
    {% if stepper_z.driver_protocol == 'spi' %}
    cs_pin: {{ pins.stepper_z1.cs }}
    spi_software_miso_pin: {{ board.spi.miso }}
    spi_software_mosi_pin: {{ board.spi.mosi }}
    spi_software_sclk_pin: {{ board.spi.sclk }}
    {% else %}
    uart_pin: {{ pins.stepper_z1.uart }}
    {% endif %}
    run_current: {{ stepper_z.run_current | default(0.8) }}
    interpolate: {{ stepper_z.interpolate | default(false) | lower }}
    sense_resistor: {{ stepper_z.sense_resistor | default(0.110) }}
    {% if stepper_z.driver_type == 'TMC5160' %}
    driver_tbl: {{ stepper_z.driver_tbl | default(1) }}
    driver_toff: {{ stepper_z.driver_toff | default(3) }}
    driver_diss2g: {{ stepper_z.driver_diss2g | default(1) }}
    driver_diss2vs: {{ stepper_z.driver_diss2vs | default(1) }}
    {% endif %}

tmc_stepper_z2:
  condition: "stepper_z.z_motor_count >= 3"
  template: |
    [{{ stepper_z.driver_type | default('TMC2209') | lower }} stepper_z2]
    {% if stepper_z.driver_protocol == 'spi' %}
    cs_pin: {{ pins.stepper_z2.cs }}
    spi_software_miso_pin: {{ board.spi.miso }}
    spi_software_mosi_pin: {{ board.spi.mosi }}
    spi_software_sclk_pin: {{ board.spi.sclk }}
    {% else %}
    uart_pin: {{ pins.stepper_z2.uart }}
    {% endif %}
    run_current: {{ stepper_z.run_current | default(0.8) }}
    interpolate: {{ stepper_z.interpolate | default(false) | lower }}
    sense_resistor: {{ stepper_z.sense_resistor | default(0.110) }}
    {% if stepper_z.driver_type == 'TMC5160' %}
    driver_tbl: {{ stepper_z.driver_tbl | default(1) }}
    driver_toff: {{ stepper_z.driver_toff | default(3) }}
    driver_diss2g: {{ stepper_z.driver_diss2g | default(1) }}
    driver_diss2vs: {{ stepper_z.driver_diss2vs | default(1) }}
    {% endif %}

tmc_stepper_z3:
  condition: "stepper_z.z_motor_count >= 4"
  template: |
    [{{ stepper_z.driver_type | default('TMC2209') | lower }} stepper_z3]
    {% if stepper_z.driver_protocol == 'spi' %}
    cs_pin: {{ pins.stepper_z3.cs }}
    spi_software_miso_pin: {{ board.spi.miso }}
    spi_software_mosi_pin: {{ board.spi.mosi }}
    spi_software_sclk_pin: {{ board.spi.sclk }}
    {% else %}
    uart_pin: {{ pins.stepper_z3.uart }}
    {% endif %}
    run_current: {{ stepper_z.run_current | default(0.8) }}
    interpolate: {{ stepper_z.interpolate | default(false) | lower }}
    sense_resistor: {{ stepper_z.sense_resistor | default(0.110) }}
    {% if stepper_z.driver_type == 'TMC5160' %}
    driver_tbl: {{ stepper_z.driver_tbl | default(1) }}
    driver_toff: {{ stepper_z.driver_toff | default(3) }}
    driver_diss2g: {{ stepper_z.driver_diss2g | default(1) }}
    driver_diss2vs: {{ stepper_z.driver_diss2vs | default(1) }}
    {% endif %}

# AWD TMC Drivers
tmc_stepper_x1:
  condition: "printer.awd_enabled"
  template: |
    [{{ stepper_x1.driver_type | lower }} stepper_x1]
    {% if stepper_x1.driver_protocol == 'spi' %}
    cs_pin: {{ pins.stepper_x1.cs }}
    spi_software_miso_pin: {{ board.spi.miso }}
    spi_software_mosi_pin: {{ board.spi.mosi }}
    spi_software_sclk_pin: {{ board.spi.sclk }}
    {% else %}
    uart_pin: {{ pins.stepper_x1.uart }}
    {% endif %}
    run_current: {{ stepper_x1.run_current }}
    interpolate: {{ stepper_x1.interpolate | default(false) | lower }}
    {% if stepper_x1.driver_protocol == 'spi' %}
    sense_resistor: {{ stepper_x1.sense_resistor | default(0.075) }}
    {% else %}
    sense_resistor: {{ stepper_x1.sense_resistor | default(0.110) }}
    {% endif %}
    {% if stepper_x1.driver_type == 'TMC5160' %}
    driver_tbl: {{ stepper_x1.driver_tbl | default(1) }}
    driver_toff: {{ stepper_x1.driver_toff | default(3) }}
    driver_diss2g: {{ stepper_x1.driver_diss2g | default(1) }}
    driver_diss2vs: {{ stepper_x1.driver_diss2vs | default(1) }}
    {% endif %}

tmc_stepper_y1:
  condition: "printer.awd_enabled"
  template: |
    [{{ stepper_y1.driver_type | lower }} stepper_y1]
    {% if stepper_y1.driver_protocol == 'spi' %}
    cs_pin: {{ pins.stepper_y1.cs }}
    spi_software_miso_pin: {{ board.spi.miso }}
    spi_software_mosi_pin: {{ board.spi.mosi }}
    spi_software_sclk_pin: {{ board.spi.sclk }}
    {% else %}
    uart_pin: {{ pins.stepper_y1.uart }}
    {% endif %}
    run_current: {{ stepper_y1.run_current }}
    interpolate: {{ stepper_y1.interpolate | default(false) | lower }}
    {% if stepper_y1.driver_protocol == 'spi' %}
    sense_resistor: {{ stepper_y1.sense_resistor | default(0.075) }}
    {% else %}
    sense_resistor: {{ stepper_y1.sense_resistor | default(0.110) }}
    {% endif %}
    {% if stepper_y1.driver_type == 'TMC5160' %}
    driver_tbl: {{ stepper_y1.driver_tbl | default(1) }}
    driver_toff: {{ stepper_y1.driver_toff | default(3) }}
    driver_diss2g: {{ stepper_y1.driver_diss2g | default(1) }}
    driver_diss2vs: {{ stepper_y1.driver_diss2vs | default(1) }}
    {% endif %}

# -----------------------------------------------------------------------------
# Extruder
# -----------------------------------------------------------------------------
extruder:
  template: |
    [extruder]
    step_pin: {{ pins.extruder.step }}
    dir_pin: {{ pins.extruder.dir }}
    enable_pin: {{ pins.extruder.enable }}
    rotation_distance: {{ extruder_presets[extruder.extruder_type].rotation_distance }}
    gear_ratio: {{ extruder_presets[extruder.extruder_type].gear_ratio }}
    microsteps: {{ extruder.microsteps | default(16) }}
    full_steps_per_rotation: {{ extruder.full_steps_per_rotation | default(200) }}
    nozzle_diameter: {{ extruder.nozzle_diameter | default(0.4) }}
    filament_diameter: {{ extruder.filament_diameter | default(1.75) }}
    heater_pin: {{ pins.extruder.heater }}
    max_power: {{ extruder.max_power | default(1.0) }}
    sensor_pin: {{ pins.extruder.sensor }}
    sensor_type: {{ extruder.sensor_type | default('Generic 3950', true) }}
    {% if extruder.pullup_resistor is defined and extruder.pullup_resistor %}
    pullup_resistor: {{ extruder.pullup_resistor }}
    {% endif %}
    min_temp: {{ extruder.min_temp | default(0) }}
    max_temp: {{ extruder.max_temp | default(300) }}
    min_extrude_temp: {{ extruder.min_extrude_temp | default(170) }}
    max_extrude_only_distance: {{ extruder.max_extrude_only_distance | default(150) }}
    max_extrude_cross_section: {{ extruder.max_extrude_cross_section | default(5) }}
    pressure_advance: {{ extruder_presets[extruder.extruder_type].default_pa | default(0.04) }}
    pressure_advance_smooth_time: 0.040
    {% set _klipper_variant = (klipper.variant if klipper is defined and klipper.variant is defined else 'standard') %}
    {% if _klipper_variant == 'kalico' and extruder.control == 'mpc' %}
    # MPC (Model Predictive Control) - Kalico feature
    control: mpc
    {% else %}
    # PID control and PID values are in printer.cfg override sections (not here to avoid SAVE_CONFIG conflicts)
    # Run PID_CALIBRATE HEATER=extruder TARGET=240, then SAVE_CONFIG
    # SAVE_CONFIG will save control: pid and PID values to the [extruder] override section in printer.cfg
    {% endif %}

tmc_extruder:
  template: |
    [{{ extruder.driver_type | default('tmc2209') | lower }} extruder]
    uart_pin: {{ pins.extruder.uart }}
    run_current: {{ extruder.run_current | default(0.6) }}
    interpolate: {{ extruder.interpolate | default(false) | lower }}
    sense_resistor: {{ extruder.sense_resistor | default(0.110) }}

# -----------------------------------------------------------------------------
# Heater Bed
# -----------------------------------------------------------------------------
heater_bed:
  template: |
    [heater_bed]
    heater_pin: {{ pins.heater_bed.heater }}
    sensor_pin: {{ pins.heater_bed.sensor }}
    sensor_type: {{ heater_bed.sensor_type | default('Generic 3950', true) }}
    {% if heater_bed.pullup_resistor -%}
    pullup_resistor: {{ heater_bed.pullup_resistor }}
    {% endif -%}
    max_power: {{ heater_bed.max_power | default(1.0) }}
    {% if heater_bed.pwm_cycle_time is defined and heater_bed.pwm_cycle_time and heater_bed.pwm_cycle_time != 0.0166 -%}
    pwm_cycle_time: {{ heater_bed.pwm_cycle_time }}
    {% endif -%}
    min_temp: {{ heater_bed.min_temp | default(0) }}
    max_temp: {{ heater_bed.max_temp | default(120) }}
    # PID control and PID values are in printer.cfg override sections (not here to avoid SAVE_CONFIG conflicts)
    # Run PID_CALIBRATE HEATER=heater_bed TARGET=60, then SAVE_CONFIG
    # SAVE_CONFIG will save control: pid and PID values to the [heater_bed] override section in printer.cfg

# -----------------------------------------------------------------------------
# Fans
# -----------------------------------------------------------------------------
fan:
  template: |
    [fan]
    pin: {{ pins.fans.part_cooling }}
    max_power: {{ fans.part_cooling.max_power | default(1.0) }}
    cycle_time: {{ fans.part_cooling.cycle_time | default(0.002) }}
    hardware_pwm: {{ fans.part_cooling.hardware_pwm | default(false) | lower }}
    shutdown_speed: {{ fans.part_cooling.shutdown_speed | default(0) }}

heater_fan:
  template: |
    [heater_fan hotend_fan]
    pin: {{ pins.fans.hotend }}
    heater: {{ fans.hotend.heater | default('extruder') }}
    heater_temp: {{ fans.hotend.heater_temp | default(50) }}
    fan_speed: {{ fans.hotend.fan_speed | default(1.0) }}

    # Additional heater-controlled fans (Radiator, hotend_pump, etc.)
    {% if fans.additional_fans and pins.fans.additional %}
    {% for i in range(fans.additional_fans | length) %}
    {% set fan = fans.additional_fans[i] %}
    {% set fan_pin = pins.fans.additional[i] %}
    {% if fan.control_mode | default('manual') == 'heater' %}
    [heater_fan {{ fan.name }}]
    pin: {{ fan_pin.pin }}
    heater: {{ fan.heater | default('extruder') }}
    heater_temp: {{ fan.heater_temp | default(50) }}
    fan_speed: {{ fan.fan_speed | default(1.0) }}

    {% endif %}
    {% endfor %}
    {% endif %}

controller_fan:
  condition: "fans.controller.enabled"
  template: |
    [controller_fan controller_fan]
    pin: {{ pins.fans.controller }}
    kick_start_time: {{ fans.controller.kick_start_time | default(0.5) }}
    stepper: {{ fans.controller.stepper | default('stepper_x') }}
    idle_timeout: {{ fans.controller.idle_timeout | default(60) }}
    idle_speed: {{ fans.controller.idle_speed | default(0.5) }}

# Generic fans (RSCS, Nevermore, exhaust, etc.)
fan_generic:
  condition: "fans.additional_fans"
  type: "list"
  template: |
    {% if pins.fans.additional %}
    {% for i in range(fans.additional_fans | length) %}
    {% set fan = fans.additional_fans[i] %}
    {% set fan_pin = pins.fans.additional[i] %}
    {% if fan.control_mode | default('manual') != 'heater' %}
    [fan_generic {{ fan.name }}]
    pin: {{ fan_pin.pin }}
    max_power: {{ fan.max_power | default(1.0) }}
    shutdown_speed: {{ fan.shutdown_speed | default(0) }}
    kick_start_time: {{ fan.kick_start_time | default(0.1) }}
    off_below: {{ fan.off_below | default(0.1) }}

    {% endif %}
    {% endfor %}
    {% endif %}

# -----------------------------------------------------------------------------
# Probe
# -----------------------------------------------------------------------------
probe:
  condition: "probe.probe_type in ['inductive', 'klicky', 'tap']"
  template: |
    [probe]
    pin: {{ pins.probe.pin }}
    x_offset: {{ probe.x_offset | default(0) }}
    y_offset: {{ probe.y_offset | default(0) }}
    z_offset: 0  # Calibrate with PROBE_CALIBRATE, stored in SAVE_CONFIG
    speed: {{ probe.speed | default(5) }}
    samples: {{ probe.samples | default(3) }}
    sample_retract_dist: {{ probe.sample_retract_dist | default(2) }}
    samples_result: {{ probe.samples_result | default('median') }}
    samples_tolerance: {{ probe.samples_tolerance | default(0.006) }}
    samples_tolerance_retries: {{ probe.samples_tolerance_retries | default(3) }}

bltouch:
  condition: "probe.probe_type == 'bltouch'"
  template: |
    [bltouch]
    sensor_pin: {{ pins.probe.sensor }}
    control_pin: {{ pins.probe.control }}
    x_offset: {{ probe.x_offset | default(0) }}
    y_offset: {{ probe.y_offset | default(0) }}
    z_offset: 0  # Calibrate with PROBE_CALIBRATE, stored in SAVE_CONFIG
    speed: {{ probe.speed | default(5) }}
    samples: {{ probe.samples | default(3) }}
    sample_retract_dist: {{ probe.sample_retract_dist | default(3) }}

# Eddy Current Probes
beacon:
  condition: "probe.probe_type == 'beacon'"
  template: |
    [beacon]
    serial: {{ probe.serial }}
    x_offset: {{ probe.x_offset | default(0) }}
    y_offset: {{ probe.y_offset | default(0) }}
    {% if probe.homing_mode == 'contact' %}
    contact_max_hotend_temperature: {{ probe.contact_max_hotend_temperature | default(180) }}
    {% endif %}
    home_xy_position: {{ homing.home_xy_position | default(printer.bed_size_x / 2 ~ ', ' ~ printer.bed_size_y / 2) }}
    home_z_hop: {{ probe.home_z_hop | default(5) }}
    home_z_hop_speed: {{ probe.home_z_hop_speed | default(30) }}
    home_xy_move_speed: {{ probe.home_xy_move_speed | default(300) }}
    home_method: {{ probe.homing_mode | default('contact') }}
    home_method_when_homed: proximity
    home_autocalibrate: {{ probe.home_autocalibrate | default('unhomed') }}
    mesh_main_direction: {{ probe.bed_mesh.mesh_main_direction | default('x') if probe.bed_mesh else 'x' }}
    mesh_runs: {{ probe.bed_mesh.mesh_runs | default(2) if probe.bed_mesh else 2 }}

cartographer:
  condition: "probe.probe_type == 'cartographer'"
  template: |
    [scanner]
    serial: {{ probe.serial }}
    x_offset: {{ probe.x_offset | default(0) }}
    y_offset: {{ probe.y_offset | default(0) }}
    calibration_method: {{ probe.homing_mode | default('touch') }}
    {% if probe.homing_mode == 'touch' %}
    scanner_touch_z_offset: {{ probe.scanner_touch_z_offset | default(0.05) }}
    {% endif %}
    backlash_comp: {{ probe.backlash_comp | default(0.5) }}

btt_eddy:
  condition: "probe.probe_type == 'btt_eddy'"
  template: |
    [probe_eddy_current btt_eddy]
    sensor_type: {{ probe.sensor_type | default('ldc1612') }}
    {% if probe.i2c_mcu == 'toolboard' %}
    i2c_mcu: toolboard
    {% endif %}
    {% if probe.i2c_bus %}
    i2c_bus: {{ probe.i2c_bus }}
    {% endif %}
    x_offset: {{ probe.x_offset | default(0) }}
    y_offset: {{ probe.y_offset | default(0) }}

# -----------------------------------------------------------------------------
# Homing
# -----------------------------------------------------------------------------
safe_z_home:
  # CRITICAL: Do NOT generate safe_z_home when eddy probes use contact/touch mode
  # Beacon/Cartographer handle homing internally via home_xy_position in their sections
  condition: "homing.homing_method == 'safe_z_home' and not (probe.probe_type == 'beacon' and probe.homing_mode == 'contact') and not (probe.probe_type == 'cartographer' and probe.homing_mode == 'touch')"
  template: |
    [safe_z_home]
    {% if homing.home_xy_position is not defined or not homing.home_xy_position or homing.home_xy_position == 'bed_center' %}
    home_xy_position: {{ (printer.bed_size_x / 2) | int }}, {{ (printer.bed_size_y / 2) | int }}
    {% else %}
    home_xy_position: {{ homing.home_xy_position }}
    {% endif %}
    speed: {{ homing.speed | default(100) }}
    z_hop: {{ homing.z_hop | default(10) }}
    z_hop_speed: {{ homing.z_hop_speed | default(15) }}

# -----------------------------------------------------------------------------
# Bed Mesh (in Probe section - mesh is probe-dependent)
# -----------------------------------------------------------------------------
bed_mesh:
  condition: "probe.bed_mesh and probe.bed_mesh.enabled"
  template: |
    [bed_mesh]
    {% if probe.probe_type in ['beacon', 'btt_eddy'] %}
    # Eddy probes: faster speed, lower horizontal_move_z (must be ≤2mm for valid readings)
    speed: {{ probe.bed_mesh.speed | default(300) if probe.bed_mesh else 300 }}
    horizontal_move_z: {{ probe.bed_mesh.horizontal_move_z | default(2) if probe.bed_mesh else 2 }}
    {% elif probe.probe_type == 'cartographer' %}
    # Cartographer: fast scanning with zero reference at bed center
    speed: {{ probe.bed_mesh.speed | default(300) if probe.bed_mesh else 300 }}
    horizontal_move_z: {{ probe.bed_mesh.horizontal_move_z | default(2) if probe.bed_mesh else 2 }}
    zero_reference_position: {{ (printer.bed_size_x / 2) | int }}, {{ (printer.bed_size_y / 2) | int }}
    {% else %}
    speed: {{ probe.bed_mesh.speed | default(200) if probe.bed_mesh else 200 }}
    horizontal_move_z: {{ probe.bed_mesh.horizontal_move_z | default(5) if probe.bed_mesh else 5 }}
    {% endif %}
    {% if probe.bed_mesh and probe.bed_mesh.mesh_min == 'auto' %}
    mesh_min: {{ (probe.x_offset | abs + 10) | int }}, {{ (probe.y_offset | abs + 10) | int }}
    {% elif probe.bed_mesh and probe.bed_mesh.mesh_min %}
    mesh_min: {{ probe.bed_mesh.mesh_min }}
    {% else %}
    mesh_min: {{ (probe.x_offset | abs + 10) | int }}, {{ (probe.y_offset | abs + 10) | int }}
    {% endif %}
    {% if probe.bed_mesh and probe.bed_mesh.mesh_max == 'auto' %}
    mesh_max: {{ (printer.bed_size_x - probe.x_offset | abs - 10) | int }}, {{ (printer.bed_size_y - probe.y_offset | abs - 10) | int }}
    {% elif probe.bed_mesh and probe.bed_mesh.mesh_max %}
    mesh_max: {{ probe.bed_mesh.mesh_max }}
    {% else %}
    mesh_max: {{ (printer.bed_size_x - probe.x_offset | abs - 10) | int }}, {{ (printer.bed_size_y - probe.y_offset | abs - 10) | int }}
    {% endif %}
    # Probe count: eddy probes are fast, use higher density for better mesh
    {% if probe.probe_type == 'cartographer' %}
    probe_count: {{ probe.bed_mesh.probe_count | default('20, 20', true) if probe.bed_mesh else '20, 20' }}
    {% elif probe.probe_type in ['beacon', 'btt_eddy'] %}
    probe_count: {{ probe.bed_mesh.probe_count | default('9, 9', true) if probe.bed_mesh else '9, 9' }}
    {% else %}
    probe_count: {{ probe.bed_mesh.probe_count | default('5, 5', true) if probe.bed_mesh else '5, 5' }}
    {% endif %}
    algorithm: bicubic
    {% if probe.probe_type in ['beacon', 'cartographer', 'btt_eddy']
          and probe.bed_mesh
          and probe.bed_mesh.supports_scan_overshoot is defined
          and probe.bed_mesh.supports_scan_overshoot %}
    # scan_overshoot: only emitted when the installed Klipper/Kalico supports it
    scan_overshoot: {{ probe.bed_mesh.scan_overshoot | default(8) if probe.bed_mesh else 8 }}
    {% endif %}
    {% if probe.probe_type == 'cartographer' %}
    # mesh_pps: disable interpolation for scan mode (Cartographer recommendation)
    mesh_pps: 0, 0
    {% endif %}
    fade_start: {{ probe.bed_mesh.fade_start | default(0.6) if probe.bed_mesh else 0.6 }}
    fade_end: {{ probe.bed_mesh.fade_end | default(10.0) if probe.bed_mesh else 10.0 }}

# -----------------------------------------------------------------------------
# Bed Leveling (Z Tilt / QGL)
# -----------------------------------------------------------------------------

z_tilt:
  condition: "bed_leveling.leveling_type == 'z_tilt'"
  template: |
    [z_tilt]
    # Z motor positions (outside bed, where steppers are located)
    # Auto-generated defaults based on Z motor count - adjust to match your hardware!
    {% if bed_leveling.z_tilt and bed_leveling.z_tilt.z_positions %}
    z_positions: {{ bed_leveling.z_tilt.z_positions }}
    {% elif stepper_z.z_motor_count == 2 %}
    # 2 Z motors: Left-right pattern (common for dual-Z bed leveling)
    z_positions:
        -50, {{ (printer.bed_size_y / 2) | int }}                                    # Left (stepper)
        {{ printer.bed_size_x | int + 50 }}, {{ (printer.bed_size_y / 2) | int }}    # Right (stepper)
    {% else %}
    # 3 Z motors: Triangle pattern (Voron Trident style)
    z_positions:
        {{ (printer.bed_size_x / 2) | int }}, {{ printer.bed_size_y | int + 50 }}    # Front center (stepper)
        -50, -50                                                                      # Back left (stepper)
        {{ printer.bed_size_x | int + 50 }}, -50                                     # Back right (stepper)
    {% endif %}
    # Probe points (inside bed, where nozzle/probe can reach)
    {% if bed_leveling.z_tilt and bed_leveling.z_tilt.points %}
    points: {{ bed_leveling.z_tilt.points }}
    {% elif stepper_z.z_motor_count == 2 %}
    # 2 probe points for 2 Z motors
    points:
        30, {{ (printer.bed_size_y / 2) | int }}                                     # Left
        {{ (printer.bed_size_x - 30) | int }}, {{ (printer.bed_size_y / 2) | int }}  # Right
    {% else %}
    # 3 probe points for 3 Z motors
    points:
        {{ (printer.bed_size_x / 2) | int }}, {{ (printer.bed_size_y - 30) | int }}  # Front center
        30, 30                                                                        # Back left
        {{ (printer.bed_size_x - 30) | int }}, 30                                    # Back right
    {% endif %}
    speed: {{ bed_leveling.z_tilt.speed | default(200) if bed_leveling.z_tilt else 200 }}
    horizontal_move_z: {{ bed_leveling.z_tilt.horizontal_move_z | default(10) if bed_leveling.z_tilt else 10 }}
    retries: {{ bed_leveling.z_tilt.retries | default(5) if bed_leveling.z_tilt else 5 }}
    retry_tolerance: {{ bed_leveling.z_tilt.retry_tolerance | default(0.0075) if bed_leveling.z_tilt else 0.0075 }}

quad_gantry_level:
  condition: "bed_leveling.leveling_type == 'qgl'"
  template: |
    [quad_gantry_level]
    # Gantry corners (outside bed, where gantry pivots are located)
    # Auto-generated defaults for Voron-style QGL - adjust to match your hardware!
    {% if bed_leveling.qgl and bed_leveling.qgl.gantry_corners %}
    gantry_corners: {{ bed_leveling.qgl.gantry_corners }}
    {% else %}
    gantry_corners:
        -60, -10                                                                      # Front left
        {{ printer.bed_size_x | int + 60 }}, -10                                     # Front right
        {{ printer.bed_size_x | int + 60 }}, {{ printer.bed_size_y | int + 60 }}     # Back right
        -60, {{ printer.bed_size_y | int + 60 }}                                     # Back left
    {% endif %}
    # Probe points (inside bed corners)
    {% if bed_leveling.qgl and bed_leveling.qgl.points %}
    points: {{ bed_leveling.qgl.points }}
    {% else %}
    points:
        50, 25                                                                        # Front left
        50, {{ (printer.bed_size_y - 25) | int }}                                    # Back left
        {{ (printer.bed_size_x - 50) | int }}, {{ (printer.bed_size_y - 25) | int }} # Back right
        {{ (printer.bed_size_x - 50) | int }}, 25                                    # Front right
    {% endif %}
    speed: {{ bed_leveling.qgl.speed | default(200) if bed_leveling.qgl else 200 }}
    horizontal_move_z: {{ bed_leveling.qgl.horizontal_move_z | default(10) if bed_leveling.qgl else 10 }}
    retries: {{ bed_leveling.qgl.retries | default(5) if bed_leveling.qgl else 5 }}
    retry_tolerance: {{ bed_leveling.qgl.retry_tolerance | default(0.0075) if bed_leveling.qgl else 0.0075 }}
    max_adjust: {{ bed_leveling.qgl.max_adjust | default(10) if bed_leveling.qgl else 10 }}

# -----------------------------------------------------------------------------
# Common Sections (always included)
# -----------------------------------------------------------------------------
common:
  virtual_sdcard:
    template: |
      [virtual_sdcard]
      path: {{ tuning.virtual_sdcard.path | default('~/printer_data/gcodes') }}
      on_error_gcode: {{ tuning.virtual_sdcard.on_error_gcode | default('CANCEL_PRINT') }}

  idle_timeout:
    template: |
      [idle_timeout]
      timeout: {{ tuning.idle_timeout.timeout | default(600) }}
      gcode:
          {{ tuning.idle_timeout.gcode | default('TURN_OFF_HEATERS') | indent(4) }}

  pause_resume:
    template: |
      [pause_resume]
      recover_velocity: {{ tuning.pause_resume.recover_velocity | default(50) }}

  exclude_object:
    condition: "tuning.exclude_object.enabled"
    template: |
      [exclude_object]

  # TMC Autotune (optional extension)
  # This requires the external klipper_tmc_autotune module.
  # We intentionally generate a commented example by default to avoid breaking
  # Klipper on systems that don't have the plugin installed.
  tmc_autotune:
    condition: "tuning.tmc_autotune.enabled"
    template: |
      # ─────────────────────────────────────────────────────────────────────────────
      # TMC AUTOTUNE (optional)
      # Requires: klipper_tmc_autotune
      # Repo: https://github.com/andrewmcgr/klipper_tmc_autotune
      #
      # If you have the plugin installed and want this section active, set:
      #   tuning.tmc_autotune.emit_config = true
      # in the wizard.
      # ─────────────────────────────────────────────────────────────────────────────
      {% if tuning.tmc_autotune.emit_config | default(false) %}
      # One section per tuned stepper/extruder.
      # See: https://github.com/andrewmcgr/klipper_tmc_autotune#autotune-configuration
      {% for s in (tuning.tmc_autotune.steppers | default([])) %}
      [autotune_tmc {{ s.stepper }}]
      {% if s.motor -%}
      motor: {{ s.motor }}
      {% endif -%}
      {% if s.voltage -%}
      voltage: {{ s.voltage }}
      {% elif tuning.tmc_autotune.voltage -%}
      voltage: {{ tuning.tmc_autotune.voltage }}
      {% endif -%}
      {% if s.tuning_goal -%}
      tuning_goal: {{ s.tuning_goal }}
      {% elif tuning.tmc_autotune.tuning_goal -%}
      tuning_goal: {{ tuning.tmc_autotune.tuning_goal }}
      {% endif %}

      {% endfor %}
      {% else %}
      # [autotune_tmc stepper_x]
      # motor: <select in wizard>
      # [autotune_tmc stepper_y]
      # motor: <select in wizard>
      # voltage: 24
      # tuning_goal: auto
      {% endif %}

  input_shaper:
    condition: "tuning.input_shaper.enabled"
    template: |
      [input_shaper]
      shaper_type_x: {{ tuning.input_shaper.shaper_type_x | default('mzv') }}
      shaper_freq_x: {{ tuning.input_shaper.shaper_freq_x | default(0) }}
      damping_ratio_x: {{ tuning.input_shaper.damping_ratio_x | default(0.1) }}
      {% if tuning.input_shaper.enable_y | default(false) %}
      shaper_type_y: {{ tuning.input_shaper.shaper_type_y | default('mzv') }}
      shaper_freq_y: {{ tuning.input_shaper.shaper_freq_y | default(0) }}
      damping_ratio_y: {{ tuning.input_shaper.damping_ratio_y | default(0.1) }}
      {% endif %}

  # ─────────────────────────────────────────────────────────────────────────────
  # Accelerometer Configuration
  # Source: toolboard accelerometer or probe with built-in accelerometer
  # Note: Probes with built-in accelerometers (beacon, cartographer) provide their own
  # accelerometer sections via klipper_config, so we only generate toolboard sections here.
  # ─────────────────────────────────────────────────────────────────────────────
  accelerometer:
    condition: "tuning.accelerometer.enabled and tuning.accelerometer.source == 'toolboard'"
    template: |
      {% if tuning.accelerometer.type == 'ADXL345' %}
      [adxl345]
      {% if tuning.accelerometer.spi_bus %}
      cs_pin: {{ tuning.accelerometer.mcu_prefix }}{{ tuning.accelerometer.cs_pin }}
      spi_bus: {{ tuning.accelerometer.spi_bus }}
      {% else %}
      cs_pin: {{ tuning.accelerometer.mcu_prefix }}{{ tuning.accelerometer.cs_pin }}
      spi_software_sclk_pin: {{ tuning.accelerometer.mcu_prefix }}{{ tuning.accelerometer.spi_software_sclk_pin }}
      spi_software_mosi_pin: {{ tuning.accelerometer.mcu_prefix }}{{ tuning.accelerometer.spi_software_mosi_pin }}
      spi_software_miso_pin: {{ tuning.accelerometer.mcu_prefix }}{{ tuning.accelerometer.spi_software_miso_pin }}
      {% endif %}
      {% elif tuning.accelerometer.type == 'LIS2DW12' %}
      [lis2dw]
      cs_pin: {{ tuning.accelerometer.mcu_prefix }}{{ tuning.accelerometer.cs_pin }}
      {% if tuning.accelerometer.spi_bus %}
      spi_bus: {{ tuning.accelerometer.spi_bus }}
      {% endif %}
      {% endif %}

  resonance_tester:
    condition: "tuning.accelerometer.enabled"
    template: |
      [resonance_tester]
      {% if tuning.accelerometer.source == 'beacon' %}
      accel_chip: beacon
      {% elif tuning.accelerometer.source == 'cartographer' %}
      accel_chip: adxl345
      {% elif tuning.accelerometer.type == 'ADXL345' %}
      accel_chip: adxl345
      {% elif tuning.accelerometer.type == 'LIS2DW12' %}
      accel_chip: lis2dw
      {% endif %}
      probe_points: {{ (printer.bed_size_x / 2) | int }}, {{ (printer.bed_size_y / 2) | int }}, 20

  # ─────────────────────────────────────────────────────────────────────────────
  # Input Shaper Calibration Shell Commands
  # Requires gcode_shell_command extension to be installed in Klipper
  #
  # To install the extension:
  # 1. Download gcode_shell_command.py to ~/klipper/klippy/extras/
  # 2. Recompile and flash Klipper firmware
  #
  # Or use KIAUH: Extensions menu -> G-Code Shell Command
  # ─────────────────────────────────────────────────────────────────────────────
  shaper_shell_commands:
    condition: "tuning.accelerometer.enabled"
    template: |
      [gcode_shell_command shaper_graph_x]
      command: python3 $HOME/printer_data/config/gschpoozi/scripts/tools/shaper_graphs.py axis x
      timeout: 120
      verbose: True

      [gcode_shell_command shaper_graph_y]
      command: python3 $HOME/printer_data/config/gschpoozi/scripts/tools/shaper_graphs.py axis y
      timeout: 120
      verbose: True

      [gcode_shell_command shaper_graph_belts]
      command: python3 $HOME/printer_data/config/gschpoozi/scripts/tools/shaper_graphs.py belts
      timeout: 120
      verbose: True

  # ─────────────────────────────────────────────────────────────────────────────
  # TMC Chopper Tuning
  # Finds optimal chopper parameters (TPFD, TBL, TOFF, HSTRT, HEND) for TMC5160/TMC2240
  # to reduce mid-range resonance and improve print quality.
  #
  # Requires: gcode_shell_command extension (same as input shaper)
  # See: docs/TMC_CHOPPER_TUNING_IMPLEMENTATION.md for usage
  # ─────────────────────────────────────────────────────────────────────────────

  # Shell command to run the Python chopper analyzer
  chopper_shell_command:
    render: raw
    template: |
      [gcode_shell_command chopper_analyze]
      command: python3 $HOME/printer_data/config/gschpoozi/scripts/tools/chopper_analyze.py
      timeout: 300
      verbose: True

  # Hardware stall detection using DIAG pins (TMC5160/TMC2240 only)
  # Monitors for motor stalls during chopper tuning to prevent damage
  # ONLY enabled when:
  #   - Using sensorless homing (diag pin not used for physical endstop)
  #   - Driver supports advanced chopper tuning (TMC5160, TMC2240, TMC2130)
  #   - TMC2209 excluded (limited chopper tuning, diag used for sensorless only)
  chopper_stall_monitor_x:
    condition: "pins.stepper_x.diag and stepper_x.endstop_type == 'sensorless' and stepper_x.driver_type in ['tmc5160', 'tmc2240', 'tmc2130']"
    template: |
      [gcode_button stall_monitor_x]
      pin: {{ pins.stepper_x.diag }}
      press_gcode:
          _CHOPPER_STALL_DETECTED AXIS=X

  chopper_stall_monitor_y:
    condition: "pins.stepper_y.diag and stepper_y.endstop_type == 'sensorless' and stepper_y.driver_type in ['tmc5160', 'tmc2240', 'tmc2130']"
    template: |
      [gcode_button stall_monitor_y]
      pin: {{ pins.stepper_y.diag }}
      press_gcode:
          _CHOPPER_STALL_DETECTED AXIS=Y

  # Chopper tuning state and macros
  chopper_tuning_macros:
    render: raw
    template: |
      # ═══════════════════════════════════════════════════════════════════════════════
      # TMC CHOPPER TUNING STATE
      # Stores tuning state, original parameters, and test results
      # ═══════════════════════════════════════════════════════════════════════════════
      [gcode_macro _CHOPPER_TUNE_STATE]
      description: Internal state for chopper tuning process
      # Tuning state
      variable_tuning_active: False
      variable_current_axis: "x"
      variable_current_phase: "idle"
      variable_test_count: 0
      variable_abort_requested: False
      # Safety tracking
      variable_last_driver_temp: 0
      variable_stall_detected: False
      variable_stall_axis: ""
      # Original parameters for X axis (stored before tuning)
      variable_x_original_tpfd: 0
      variable_x_original_tbl: 0
      variable_x_original_toff: 0
      variable_x_original_hstrt: 0
      variable_x_original_hend: 0
      # Original parameters for Y axis
      variable_y_original_tpfd: 0
      variable_y_original_tbl: 0
      variable_y_original_toff: 0
      variable_y_original_hstrt: 0
      variable_y_original_hend: 0
      # Best results found
      variable_x_best_tpfd: 0
      variable_x_best_tbl: 0
      variable_x_best_toff: 0
      variable_x_best_hstrt: 0
      variable_x_best_hend: 0
      variable_x_best_score: 999999
      variable_y_best_tpfd: 0
      variable_y_best_tbl: 0
      variable_y_best_toff: 0
      variable_y_best_hstrt: 0
      variable_y_best_hend: 0
      variable_y_best_score: 999999
      gcode:
          # State holder - no gcode needed

      # ═══════════════════════════════════════════════════════════════════════════════
      # STALL DETECTION HANDLER
      # Called by gcode_button when DIAG pin triggers
      # ═══════════════════════════════════════════════════════════════════════════════
      [gcode_macro _CHOPPER_STALL_DETECTED]
      description: Handle motor stall during chopper tuning
      gcode:
          {% set axis = params.AXIS | default("?") | upper %}
          {% set state = printer["gcode_macro _CHOPPER_TUNE_STATE"] %}

          {% if state.tuning_active %}
              # Only respond to stalls during active tuning
              SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=stall_detected VALUE=True
              SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=stall_axis VALUE="'{axis}'"
              RESPOND TYPE=error MSG="STALL DETECTED on {axis} axis during chopper tuning!"
              _CHOPPER_ABORT REASON="stall"
          {% endif %}

      # ═══════════════════════════════════════════════════════════════════════════════
      # STORE ORIGINAL PARAMETERS
      # Saves current chopper settings before tuning begins
      # ═══════════════════════════════════════════════════════════════════════════════
      [gcode_macro _CHOPPER_STORE_ORIGINALS]
      description: Store original TMC chopper parameters before tuning
      gcode:
          {% set axis = params.AXIS | default("x") | lower %}
          {% set stepper = "stepper_" ~ axis %}

          # Determine TMC driver type (TMC5160/TMC2240 have TPFD, TMC2209 does not)
          {% if printer.configfile.config["tmc5160 " ~ stepper] is defined %}
              {% set tmc = "tmc5160 " ~ stepper %}
              {% set has_tpfd = true %}
          {% elif printer.configfile.config["tmc2240 " ~ stepper] is defined %}
              {% set tmc = "tmc2240 " ~ stepper %}
              {% set has_tpfd = true %}
          {% elif printer.configfile.config["tmc2209 " ~ stepper] is defined %}
              {% set tmc = "tmc2209 " ~ stepper %}
              {% set has_tpfd = false %}
          {% else %}
              { action_raise_error("No TMC5160, TMC2240, or TMC2209 found for " ~ stepper) }
          {% endif %}

          # Store original values
          {% if axis == "x" %}
              {% if has_tpfd %}
              SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=x_original_tpfd VALUE={printer[tmc].driver_tpfd | default(0)}
              {% endif %}
              SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=x_original_tbl VALUE={printer[tmc].driver_tbl | default(1)}
              SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=x_original_toff VALUE={printer[tmc].driver_toff | default(3)}
              SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=x_original_hstrt VALUE={printer[tmc].driver_hstrt | default(0)}
              SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=x_original_hend VALUE={printer[tmc].driver_hend | default(0)}
          {% else %}
              {% if has_tpfd %}
              SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=y_original_tpfd VALUE={printer[tmc].driver_tpfd | default(0)}
              {% endif %}
              SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=y_original_tbl VALUE={printer[tmc].driver_tbl | default(1)}
              SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=y_original_toff VALUE={printer[tmc].driver_toff | default(3)}
              SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=y_original_hstrt VALUE={printer[tmc].driver_hstrt | default(0)}
              SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=y_original_hend VALUE={printer[tmc].driver_hend | default(0)}
          {% endif %}

          RESPOND MSG="Stored original chopper parameters for {axis | upper} axis"

      # ═══════════════════════════════════════════════════════════════════════════════
      # RESTORE ORIGINAL PARAMETERS
      # Restores saved chopper settings (used on abort or after tuning)
      # ═══════════════════════════════════════════════════════════════════════════════
      [gcode_macro _CHOPPER_RESTORE_ORIGINALS]
      description: Restore original TMC chopper parameters
      gcode:
          {% set axis = params.AXIS | default("x") | lower %}
          {% set stepper = "stepper_" ~ axis %}
          {% set state = printer["gcode_macro _CHOPPER_TUNE_STATE"] %}

          # Determine TMC driver type (TMC5160/TMC2240 have TPFD, TMC2209 does not)
          {% if printer.configfile.config["tmc5160 " ~ stepper] is defined %}
              {% set tmc = "tmc5160" %}
              {% set has_tpfd = true %}
          {% elif printer.configfile.config["tmc2240 " ~ stepper] is defined %}
              {% set tmc = "tmc2240" %}
              {% set has_tpfd = true %}
          {% elif printer.configfile.config["tmc2209 " ~ stepper] is defined %}
              {% set tmc = "tmc2209" %}
              {% set has_tpfd = false %}
          {% else %}
              { action_raise_error("No TMC5160, TMC2240, or TMC2209 found for " ~ stepper) }
          {% endif %}

          # Restore original values
          {% if axis == "x" %}
              {% if has_tpfd %}
              SET_TMC_FIELD STEPPER={stepper} FIELD=tpfd VALUE={state.x_original_tpfd}
              {% endif %}
              SET_TMC_FIELD STEPPER={stepper} FIELD=tbl VALUE={state.x_original_tbl}
              SET_TMC_FIELD STEPPER={stepper} FIELD=toff VALUE={state.x_original_toff}
              SET_TMC_FIELD STEPPER={stepper} FIELD=hstrt VALUE={state.x_original_hstrt}
              SET_TMC_FIELD STEPPER={stepper} FIELD=hend VALUE={state.x_original_hend}
          {% else %}
              {% if has_tpfd %}
              SET_TMC_FIELD STEPPER={stepper} FIELD=tpfd VALUE={state.y_original_tpfd}
              {% endif %}
              SET_TMC_FIELD STEPPER={stepper} FIELD=tbl VALUE={state.y_original_tbl}
              SET_TMC_FIELD STEPPER={stepper} FIELD=toff VALUE={state.y_original_toff}
              SET_TMC_FIELD STEPPER={stepper} FIELD=hstrt VALUE={state.y_original_hstrt}
              SET_TMC_FIELD STEPPER={stepper} FIELD=hend VALUE={state.y_original_hend}
          {% endif %}

          RESPOND MSG="Restored original chopper parameters for {axis | upper} axis"

      # ═══════════════════════════════════════════════════════════════════════════════
      # SAFETY CHECK
      # Checks driver temperature and status before/during tuning
      # ═══════════════════════════════════════════════════════════════════════════════
      [gcode_macro _CHOPPER_SAFETY_CHECK]
      description: Check TMC driver safety status
      gcode:
          {% set axis = params.AXIS | default("x") | lower %}
          {% set stepper = "stepper_" ~ axis %}
          {% set max_driver_temp = params.MAX_DRIVER_TEMP | default(100) | int %}
          {% set state = printer["gcode_macro _CHOPPER_TUNE_STATE"] %}

          # Determine TMC driver type
          {% if printer.configfile.config["tmc5160 " ~ stepper] is defined %}
              {% set tmc = "tmc5160 " ~ stepper %}
          {% elif printer.configfile.config["tmc2240 " ~ stepper] is defined %}
              {% set tmc = "tmc2240 " ~ stepper %}
          {% elif printer.configfile.config["tmc2209 " ~ stepper] is defined %}
              {% set tmc = "tmc2209 " ~ stepper %}
          {% else %}
              { action_raise_error("No TMC5160, TMC2240, or TMC2209 found for " ~ stepper) }
          {% endif %}

          # Check driver status
          {% set drv = printer[tmc] %}

          # Check for over-temperature
          {% if drv.drv_status is defined %}
              {% if drv.drv_status.ot is defined and drv.drv_status.ot %}
                  RESPOND TYPE=error MSG="TMC driver {stepper} OVER-TEMPERATURE!"
                  _CHOPPER_ABORT REASON="overtemp"
              {% endif %}

              # Check for open load (disconnected motor)
              {% if (drv.drv_status.ola is defined and drv.drv_status.ola) or
                    (drv.drv_status.olb is defined and drv.drv_status.olb) %}
                  RESPOND TYPE=error MSG="TMC driver {stepper} reports OPEN LOAD - check motor connection!"
                  _CHOPPER_ABORT REASON="open_load"
              {% endif %}

              # Check for short to ground
              {% if (drv.drv_status.s2ga is defined and drv.drv_status.s2ga) or
                    (drv.drv_status.s2gb is defined and drv.drv_status.s2gb) %}
                  RESPOND TYPE=error MSG="TMC driver {stepper} reports SHORT TO GROUND!"
                  _CHOPPER_ABORT REASON="short_gnd"
              {% endif %}
          {% endif %}

          # All checks passed
          {% if not state.abort_requested %}
              RESPOND MSG="Safety check passed for {axis | upper} axis"
          {% endif %}

      # ═══════════════════════════════════════════════════════════════════════════════
      # ABORT TUNING
      # Emergency stop for chopper tuning with parameter restoration
      # ═══════════════════════════════════════════════════════════════════════════════
      [gcode_macro _CHOPPER_ABORT]
      description: Abort chopper tuning and restore original parameters
      gcode:
          {% set reason = params.REASON | default("user_request") %}
          {% set state = printer["gcode_macro _CHOPPER_TUNE_STATE"] %}

          # Mark abort requested
          SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=abort_requested VALUE=True
          SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=tuning_active VALUE=False

          # Stop any movement
          M400

          RESPOND TYPE=error MSG="Chopper tuning ABORTED: {reason}"

          # Restore original parameters for whichever axis was being tuned
          {% if state.current_axis == "x" or state.current_axis == "both" %}
              _CHOPPER_RESTORE_ORIGINALS AXIS=X
          {% endif %}
          {% if state.current_axis == "y" or state.current_axis == "both" %}
              _CHOPPER_RESTORE_ORIGINALS AXIS=Y
          {% endif %}

          # Reset state
          SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=current_phase VALUE="'aborted'"
          SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=stall_detected VALUE=False

          {% if reason == "stall" %}
              RESPOND TYPE=error MSG="Motor stall detected - check for mechanical issues or reduce test speed"
          {% elif reason == "overtemp" %}
              RESPOND TYPE=error MSG="Driver overtemperature - allow to cool before retrying"
          {% endif %}

      # ═══════════════════════════════════════════════════════════════════════════════
      # SAFE POSITION
      # Move to safe position for tuning movements
      # ═══════════════════════════════════════════════════════════════════════════════
      [gcode_macro _CHOPPER_SAFE_POSITION]
      description: Move to safe center position for chopper tuning
      gcode:
          {% set axis = params.AXIS | default("x") | lower %}
          {% set speed = params.SPEED | default(100) | float %}

          {% set max_x = printer.toolhead.axis_maximum.x %}
          {% set min_x = printer.toolhead.axis_minimum.x %}
          {% set max_y = printer.toolhead.axis_maximum.y %}
          {% set min_y = printer.toolhead.axis_minimum.y %}

          # Calculate center position
          {% set center_x = (max_x + min_x) / 2 %}
          {% set center_y = (max_y + min_y) / 2 %}

          # Ensure homed
          {% if "xyz" not in printer.toolhead.homed_axes %}
              G28
          {% endif %}

          # Move to center
          G90
          {% if axis == "x" or axis == "both" %}
              G1 X{center_x} F{speed * 60}
          {% endif %}
          {% if axis == "y" or axis == "both" %}
              G1 Y{center_y} F{speed * 60}
          {% endif %}
          G4 P500  ; Brief pause to settle

      # ═══════════════════════════════════════════════════════════════════════════════
      # MAIN ENTRY POINT
      # User-callable macro to start chopper tuning
      # ═══════════════════════════════════════════════════════════════════════════════
      [gcode_macro TMC_CHOPPER_TUNE]
      description: Auto-tune TMC chopper settings to reduce vibration (TMC5160/TMC2240/TMC2209)
      gcode:
          {% set axis = params.AXIS | default("x") | lower %}
          {% set mode = params.MODE | default("full") | lower %}
          {% set min_speed = params.MIN_SPEED | default(30) | int %}
          {% set max_speed = params.MAX_SPEED | default(150) | int %}
          {% set step = params.STEP | default(10) | int %}
          {% set state = printer["gcode_macro _CHOPPER_TUNE_STATE"] %}
          {% set stepper = "stepper_" ~ axis %}

          # Validate stepper has compatible driver
          {% if not (printer.configfile.config["tmc5160 " ~ stepper] is defined or
                     printer.configfile.config["tmc2240 " ~ stepper] is defined or
                     printer.configfile.config["tmc2209 " ~ stepper] is defined) %}
              { action_raise_error("TMC_CHOPPER_TUNE requires TMC5160, TMC2240, or TMC2209 driver on " ~ stepper) }
          {% endif %}

          # Check if driver has TPFD support (TMC2209 does not)
          {% set has_tpfd = printer.configfile.config["tmc5160 " ~ stepper] is defined or
                            printer.configfile.config["tmc2240 " ~ stepper] is defined %}
          {% if not has_tpfd %}
              RESPOND MSG="Note: TMC2209 detected - TPFD optimization not available"
          {% endif %}

          # Validate accelerometer is available
          {% if not (printer.configfile.config["adxl345"] is defined or
                     printer.configfile.config["lis2dw"] is defined or
                     printer.configfile.config["beacon"] is defined) %}
              { action_raise_error("TMC_CHOPPER_TUNE requires an accelerometer") }
          {% endif %}

          # Initialize state
          SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=tuning_active VALUE=True
          SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=current_axis VALUE="'{axis}'"
          SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=current_phase VALUE="'init'"
          SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=abort_requested VALUE=False
          SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=test_count VALUE=0

          RESPOND MSG="═══════════════════════════════════════════════════════"
          RESPOND MSG="     TMC CHOPPER TUNING - {axis | upper} AXIS"
          RESPOND MSG="═══════════════════════════════════════════════════════"
          RESPOND MSG="Mode: {mode} | Speeds: {min_speed}-{max_speed} mm/s"

          # Store original parameters
          _CHOPPER_STORE_ORIGINALS AXIS={axis}

          # Run safety check
          _CHOPPER_SAFETY_CHECK AXIS={axis}

          {% if state.abort_requested %}
              RESPOND TYPE=error MSG="Tuning aborted during safety check"
          {% else %}
              # Move to safe position
              _CHOPPER_SAFE_POSITION AXIS={axis}

              {% if mode == "find_resonance" or mode == "full" %}
                  RESPOND MSG="═══ Phase 1: Finding Resonant Speeds ═══"
                  SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=current_phase VALUE="'find_resonance'"
                  _CHOPPER_FIND_RESONANCE AXIS={axis} MIN_SPEED={min_speed} MAX_SPEED={max_speed} STEP={step}
              {% endif %}

              {% if mode == "optimize" or mode == "full" %}
                  RESPOND MSG="═══ Phase 2: Optimizing Parameters ═══"
                  SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=current_phase VALUE="'optimize'"
                  _CHOPPER_OPTIMIZE AXIS={axis} MIN_SPEED={min_speed} MAX_SPEED={max_speed}
              {% endif %}

              # Finalize
              SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=tuning_active VALUE=False
              SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=current_phase VALUE="'complete'"

              RESPOND MSG="═══════════════════════════════════════════════════════"
              RESPOND MSG="     TUNING COMPLETE"
              RESPOND MSG="═══════════════════════════════════════════════════════"
              RESPOND MSG="Results saved to ~/printer_data/config/chopper_results/"
              RESPOND MSG="Run CHOPPER_ANALYZE to generate recommendations"
          {% endif %}

      # ═══════════════════════════════════════════════════════════════════════════════
      # FIND RESONANCE PHASE
      # Sweep speeds to identify problematic vibration frequencies
      # ═══════════════════════════════════════════════════════════════════════════════
      [gcode_macro _CHOPPER_FIND_RESONANCE]
      description: Sweep speeds to find resonant frequencies
      gcode:
          {% set axis = params.AXIS | default("x") | lower %}
          {% set min_speed = params.MIN_SPEED | default(30) | int %}
          {% set max_speed = params.MAX_SPEED | default(150) | int %}
          {% set step = params.STEP | default(10) | int %}
          {% set state = printer["gcode_macro _CHOPPER_TUNE_STATE"] %}

          {% set max_pos = printer.toolhead.axis_maximum[axis] %}
          {% set min_pos = printer.toolhead.axis_minimum[axis] %}
          {% set travel = max_pos - min_pos %}
          {% set safe_distance = ([travel / 4, 40] | min) | int %}
          {% set center = (max_pos + min_pos) / 2 %}

          # Determine accelerometer chip
          {% if printer.configfile.config["beacon"] is defined %}
              {% set accel_chip = "beacon" %}
          {% elif printer.configfile.config["lis2dw"] is defined %}
              {% set accel_chip = "lis2dw" %}
          {% else %}
              {% set accel_chip = "adxl345" %}
          {% endif %}

          RESPOND MSG="Sweeping {min_speed} to {max_speed} mm/s in {step} mm/s increments"
          RESPOND MSG="Using accelerometer: {accel_chip}"

          # Start recording
          ACCELEROMETER_MEASURE CHIP={accel_chip}

          {% for speed in range(min_speed, max_speed + 1, step) %}
              {% if not state.abort_requested %}
                  RESPOND MSG="Testing {speed} mm/s..."

                  # Move back and forth at test speed
                  G90
                  G1 {axis | upper}{center + safe_distance} F{speed * 60}
                  G1 {axis | upper}{center - safe_distance} F{speed * 60}
                  G1 {axis | upper}{center} F{speed * 60}
                  G4 P300  ; Pause between tests
              {% endif %}
          {% endfor %}

          # Stop recording
          ACCELEROMETER_MEASURE CHIP={accel_chip} NAME=resonance_sweep_{axis}

          RESPOND MSG="Resonance sweep complete for {axis | upper} axis"

      # ═══════════════════════════════════════════════════════════════════════════════
      # OPTIMIZE PHASE
      # Test chopper parameter combinations at problematic speeds
      # ═══════════════════════════════════════════════════════════════════════════════
      [gcode_macro _CHOPPER_OPTIMIZE]
      description: Test chopper parameter combinations
      gcode:
          {% set axis = params.AXIS | default("x") | lower %}
          {% set min_speed = params.MIN_SPEED | default(50) | int %}
          {% set max_speed = params.MAX_SPEED | default(100) | int %}
          {% set stepper = "stepper_" ~ axis %}
          {% set state = printer["gcode_macro _CHOPPER_TUNE_STATE"] %}

          # Check if driver has TPFD support (TMC2209 does not)
          {% set has_tpfd = printer.configfile.config["tmc5160 " ~ stepper] is defined or
                            printer.configfile.config["tmc2240 " ~ stepper] is defined %}

          # Test speeds (mid-range where resonance typically occurs)
          {% set test_speed = ((min_speed + max_speed) / 2) | int %}

          {% if has_tpfd %}
              # TMC5160/TMC2240: Test TPFD values (primary parameter for mid-range resonance)
              {% set tpfd_list = "0,4,8,12,15".split(",") %}

              RESPOND MSG="Testing TPFD values at {test_speed} mm/s"
              RESPOND MSG="TPFD values: {tpfd_list | join(', ')}"

              {% for tpfd in tpfd_list %}
                  {% if not state.abort_requested %}
                      _CHOPPER_TEST_COMBO AXIS={axis} SPEED={test_speed} TPFD={tpfd | int}
                      SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=test_count VALUE={state.test_count + 1}
                  {% endif %}
              {% endfor %}
          {% else %}
              # TMC2209: Test TBL/TOFF combinations (no TPFD available)
              {% set tbl_list = "0,1,2".split(",") %}
              {% set toff_list = "1,2,3,4".split(",") %}

              RESPOND MSG="TMC2209 mode: Testing TBL/TOFF combinations at {test_speed} mm/s"

              {% for tbl in tbl_list %}
                  {% for toff in toff_list %}
                      {% if not state.abort_requested %}
                          _CHOPPER_TEST_COMBO AXIS={axis} SPEED={test_speed} TBL={tbl | int} TOFF={toff | int}
                          SET_GCODE_VARIABLE MACRO=_CHOPPER_TUNE_STATE VARIABLE=test_count VALUE={state.test_count + 1}
                      {% endif %}
                  {% endfor %}
              {% endfor %}
          {% endif %}

          # Restore original parameters after testing
          _CHOPPER_RESTORE_ORIGINALS AXIS={axis}

          RESPOND MSG="Parameter optimization complete"
          RESPOND MSG="Total tests: {state.test_count}"

      # ═══════════════════════════════════════════════════════════════════════════════
      # TEST COMBO
      # Test a single parameter combination and record accelerometer data
      # ═══════════════════════════════════════════════════════════════════════════════
      [gcode_macro _CHOPPER_TEST_COMBO]
      description: Test a single chopper parameter combination
      gcode:
          {% set axis = params.AXIS | default("x") | lower %}
          {% set speed = params.SPEED | default(75) | int %}
          {% set tpfd = params.TPFD | default(0) | int %}
          {% set tbl = params.TBL | default(2) | int %}
          {% set toff = params.TOFF | default(3) | int %}
          {% set hstrt = params.HSTRT | default(5) | int %}
          {% set hend = params.HEND | default(3) | int %}
          {% set stepper = "stepper_" ~ axis %}
          {% set state = printer["gcode_macro _CHOPPER_TUNE_STATE"] %}

          # Check if driver has TPFD support (TMC2209 does not)
          {% set has_tpfd = printer.configfile.config["tmc5160 " ~ stepper] is defined or
                            printer.configfile.config["tmc2240 " ~ stepper] is defined %}

          {% set max_pos = printer.toolhead.axis_maximum[axis] %}
          {% set min_pos = printer.toolhead.axis_minimum[axis] %}
          {% set travel = max_pos - min_pos %}
          {% set safe_distance = ([travel / 4, 40] | min) | int %}
          {% set center = (max_pos + min_pos) / 2 %}

          # Determine accelerometer chip
          {% if printer.configfile.config["beacon"] is defined %}
              {% set accel_chip = "beacon" %}
          {% elif printer.configfile.config["lis2dw"] is defined %}
              {% set accel_chip = "lis2dw" %}
          {% else %}
              {% set accel_chip = "adxl345" %}
          {% endif %}

          {% if has_tpfd %}
              RESPOND MSG="Testing TPFD={tpfd} TBL={tbl} TOFF={toff} HSTRT={hstrt} HEND={hend}"
          {% else %}
              RESPOND MSG="Testing TBL={tbl} TOFF={toff} HSTRT={hstrt} HEND={hend} (TMC2209)"
          {% endif %}

          # Apply chopper parameters
          {% if has_tpfd %}
          SET_TMC_FIELD STEPPER={stepper} FIELD=tpfd VALUE={tpfd}
          {% endif %}
          SET_TMC_FIELD STEPPER={stepper} FIELD=tbl VALUE={tbl}
          SET_TMC_FIELD STEPPER={stepper} FIELD=toff VALUE={toff}
          SET_TMC_FIELD STEPPER={stepper} FIELD=hstrt VALUE={hstrt}
          SET_TMC_FIELD STEPPER={stepper} FIELD=hend VALUE={hend}

          G4 P200  ; Wait for settings to stabilize

          # Check driver status
          _CHOPPER_SAFETY_CHECK AXIS={axis}

          {% if not state.abort_requested %}
              # Test filename encodes parameters
              {% if has_tpfd %}
              {% set test_name = "chopper_" ~ axis ~ "_tpfd" ~ tpfd ~ "_tbl" ~ tbl ~ "_toff" ~ toff ~ "_s" ~ speed %}
              {% else %}
              {% set test_name = "chopper_" ~ axis ~ "_tbl" ~ tbl ~ "_toff" ~ toff ~ "_s" ~ speed %}
              {% endif %}

              # Start recording
              ACCELEROMETER_MEASURE CHIP={accel_chip}

              # Execute test movement
              G90
              G1 {axis | upper}{center + safe_distance} F{speed * 60}
              G1 {axis | upper}{center - safe_distance} F{speed * 60}
              G1 {axis | upper}{center} F{speed * 60}

              # Stop recording
              ACCELEROMETER_MEASURE CHIP={accel_chip} NAME={test_name}

              RESPOND MSG="  Recorded: {test_name}"
          {% endif %}

      # ═══════════════════════════════════════════════════════════════════════════════
      # CHOPPER ANALYZE
      # Trigger the Python analysis script
      # ═══════════════════════════════════════════════════════════════════════════════
      [gcode_macro CHOPPER_ANALYZE]
      description: Run analysis on chopper tuning data and generate recommendations
      gcode:
          {% set mode = params.MODE | default("report") %}
          RESPOND MSG="Running chopper analysis ({mode} mode)..."
          RUN_SHELL_COMMAND CMD=chopper_analyze
          RESPOND MSG="Analysis complete. Check ~/printer_data/config/chopper_results/"

  # AWD (All Wheel Drive) Chopper Tuning
  # Additional macros for printers with stepper_x1 and stepper_y1
  chopper_tuning_awd:
    condition: "printer.awd_enabled"
    render: raw
    template: |
      # ═══════════════════════════════════════════════════════════════════════════════
      # AWD CHOPPER TUNING SUPPORT
      # For printers with dual X/Y motors (stepper_x1, stepper_y1)
      # ═══════════════════════════════════════════════════════════════════════════════

      [gcode_macro TMC_CHOPPER_TUNE_AWD]
      description: Auto-tune chopper settings for AWD printers (front + rear motors)
      gcode:
          {% set axis = params.AXIS | default("x") | lower %}
          {% set mode = params.MODE | default("full") | lower %}
          {% set tune_method = params.METHOD | default("paired") | lower %}

          RESPOND MSG="═══════════════════════════════════════════════════════"
          RESPOND MSG="     TMC CHOPPER TUNING - AWD {axis | upper} AXIS"
          RESPOND MSG="═══════════════════════════════════════════════════════"
          RESPOND MSG="Method: {tune_method}"

          {% if tune_method == "paired" %}
              # Tune front and rear motors together (recommended)
              RESPOND MSG="Tuning front + rear motors together..."
              TMC_CHOPPER_TUNE AXIS={axis} MODE={mode}
              RESPOND MSG="Applying same settings to rear motor..."
              _AWD_SYNC_CHOPPER AXIS={axis}

          {% elif tune_method == "separate" %}
              # Tune front motor, then rear separately
              RESPOND MSG="Step 1: Tuning front motor (stepper_{axis})..."
              TMC_CHOPPER_TUNE AXIS={axis} MODE={mode}

              RESPOND MSG="Step 2: Tuning rear motor (stepper_{axis}1)..."
              # Disable front motor, enable rear only
              SET_STEPPER_ENABLE STEPPER=stepper_{axis} ENABLE=0
              G4 P500
              _AWD_TUNE_REAR AXIS={axis} MODE={mode}
              SET_STEPPER_ENABLE STEPPER=stepper_{axis} ENABLE=1

          {% elif tune_method == "front_only" %}
              # Only tune front motor
              RESPOND MSG="Tuning front motor only..."
              TMC_CHOPPER_TUNE AXIS={axis} MODE={mode}
              RESPOND MSG="Run _AWD_SYNC_CHOPPER AXIS={axis} to apply to rear motor"

          {% endif %}

          RESPOND MSG="AWD chopper tuning complete for {axis | upper} axis"

      # ─────────────────────────────────────────────────────────────────────────────
      # Sync chopper settings from front to rear motor
      # ─────────────────────────────────────────────────────────────────────────────
      [gcode_macro _AWD_SYNC_CHOPPER]
      description: Copy chopper settings from stepper_x/y to stepper_x1/y1
      gcode:
          {% set axis = params.AXIS | default("x") | lower %}
          {% set front_stepper = "stepper_" ~ axis %}
          {% set rear_stepper = "stepper_" ~ axis ~ "1" %}

          # Determine TMC driver type for front
          {% if printer.configfile.config["tmc5160 " ~ front_stepper] is defined %}
              {% set tmc_front = "tmc5160 " ~ front_stepper %}
          {% elif printer.configfile.config["tmc2240 " ~ front_stepper] is defined %}
              {% set tmc_front = "tmc2240 " ~ front_stepper %}
          {% else %}
              { action_raise_error("No TMC5160 or TMC2240 found for " ~ front_stepper) }
          {% endif %}

          # Get current front motor values
          {% set tpfd = printer[tmc_front].driver_tpfd | default(0) %}
          {% set tbl = printer[tmc_front].driver_tbl | default(2) %}
          {% set toff = printer[tmc_front].driver_toff | default(3) %}
          {% set hstrt = printer[tmc_front].driver_hstrt | default(5) %}
          {% set hend = printer[tmc_front].driver_hend | default(3) %}

          # Apply to rear motor
          SET_TMC_FIELD STEPPER={rear_stepper} FIELD=tpfd VALUE={tpfd}
          SET_TMC_FIELD STEPPER={rear_stepper} FIELD=tbl VALUE={tbl}
          SET_TMC_FIELD STEPPER={rear_stepper} FIELD=toff VALUE={toff}
          SET_TMC_FIELD STEPPER={rear_stepper} FIELD=hstrt VALUE={hstrt}
          SET_TMC_FIELD STEPPER={rear_stepper} FIELD=hend VALUE={hend}

          RESPOND MSG="Synced chopper settings from {front_stepper} to {rear_stepper}"
          RESPOND MSG="  TPFD={tpfd} TBL={tbl} TOFF={toff} HSTRT={hstrt} HEND={hend}"

      # ─────────────────────────────────────────────────────────────────────────────
      # Tune rear motor separately (front disabled)
      # ─────────────────────────────────────────────────────────────────────────────
      [gcode_macro _AWD_TUNE_REAR]
      description: Tune rear motor (stepper_x1/y1) with front motor disabled
      gcode:
          {% set axis = params.AXIS | default("x") | lower %}
          {% set mode = params.MODE | default("full") | lower %}
          {% set rear_stepper = "stepper_" ~ axis ~ "1" %}
          {% set state = printer["gcode_macro _CHOPPER_TUNE_STATE"] %}

          # Store original parameters for rear motor
          _CHOPPER_STORE_ORIGINALS_REAR AXIS={axis}

          # Run parameter sweep on rear motor
          _CHOPPER_OPTIMIZE_REAR AXIS={axis}

          RESPOND MSG="Rear motor tuning complete"

      [gcode_macro _CHOPPER_STORE_ORIGINALS_REAR]
      description: Store original TMC chopper parameters for rear motor
      gcode:
          {% set axis = params.AXIS | default("x") | lower %}
          {% set stepper = "stepper_" ~ axis ~ "1" %}

          # Determine TMC driver type
          {% if printer.configfile.config["tmc5160 " ~ stepper] is defined %}
              {% set tmc = "tmc5160 " ~ stepper %}
          {% elif printer.configfile.config["tmc2240 " ~ stepper] is defined %}
              {% set tmc = "tmc2240 " ~ stepper %}
          {% else %}
              RESPOND TYPE=error MSG="No TMC5160 or TMC2240 found for {stepper}"
          {% endif %}

          RESPOND MSG="Stored original chopper parameters for {stepper}"

      [gcode_macro _CHOPPER_OPTIMIZE_REAR]
      description: Test chopper parameters on rear motor
      gcode:
          {% set axis = params.AXIS | default("x") | lower %}
          {% set stepper = "stepper_" ~ axis ~ "1" %}
          {% set state = printer["gcode_macro _CHOPPER_TUNE_STATE"] %}

          # TPFD values to test
          {% set tpfd_list = "0,4,8,12,15".split(",") %}

          {% set max_pos = printer.toolhead.axis_maximum[axis] %}
          {% set min_pos = printer.toolhead.axis_minimum[axis] %}
          {% set center = (max_pos + min_pos) / 2 %}
          {% set safe_distance = [((max_pos - min_pos) / 4) | int, 40] | min %}

          # Determine accelerometer chip
          {% if printer.configfile.config["beacon"] is defined %}
              {% set accel_chip = "beacon" %}
          {% elif printer.configfile.config["lis2dw"] is defined %}
              {% set accel_chip = "lis2dw" %}
          {% else %}
              {% set accel_chip = "adxl345" %}
          {% endif %}

          RESPOND MSG="Testing rear motor ({stepper}) TPFD values..."

          {% for tpfd in tpfd_list %}
              {% if not state.abort_requested %}
                  SET_TMC_FIELD STEPPER={stepper} FIELD=tpfd VALUE={tpfd | int}
                  G4 P200

                  {% set test_name = "chopper_" ~ axis ~ "1_tpfd" ~ tpfd %}
                  ACCELEROMETER_MEASURE CHIP={accel_chip}

                  G90
                  G1 {axis | upper}{center + safe_distance} F{75 * 60}
                  G1 {axis | upper}{center - safe_distance} F{75 * 60}
                  G1 {axis | upper}{center} F{75 * 60}

                  ACCELEROMETER_MEASURE CHIP={accel_chip} NAME={test_name}
                  RESPOND MSG="  Tested rear TPFD={tpfd}"
              {% endif %}
          {% endfor %}

  gcode_arcs:
    # Arc (G2/G3) support
    # Default: enabled (the wizard sets tuning.arc_support.enabled; generator also defaults it on)
    condition: "tuning.arc_support.enabled"
    template: |
      [gcode_arcs]
      resolution: {{ tuning.arc_support.resolution | default(0.1) }}

  respond:
    condition: "tuning.respond.enabled"
    template: |
      [respond]
      default_type: {{ tuning.respond.default_type | default('echo') }}
      default_prefix: {{ tuning.respond.default_prefix | default('echo: ') }}

  save_variables:
    condition: "tuning.save_variables.enabled"
    template: |
      [save_variables]
      filename: {{ tuning.save_variables.filename | default('~/printer_data/config/variables.cfg') }}

  force_move:
    condition: "advanced.force_move.enable_force_move"
    template: |
      [force_move]
      enable_force_move: True

  firmware_retraction:
    condition: "advanced.firmware_retraction.enabled"
    template: |
      [firmware_retraction]
      retract_length: {{ advanced.firmware_retraction.retract_length | default(0.5) }}
      retract_speed: {{ advanced.firmware_retraction.retract_speed | default(35) }}
      unretract_extra_length: {{ advanced.firmware_retraction.unretract_extra_length | default(0) }}
      unretract_speed: {{ advanced.firmware_retraction.unretract_speed | default(35) }}

  # Macro configuration variables
  macro_config:
    template: |
      [gcode_macro _MACRO_CONFIG]
      description: Configuration variables for START_PRINT, END_PRINT, PAUSE, and utility macros

      # ═══════════════════════════════════════════════════════════════════════════════
      # PRINTER DIMENSIONS (from wizard)
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_bed_size_x: {{ printer.bed_size_x }}
      variable_bed_size_y: {{ printer.bed_size_y }}
      variable_bed_size_z: {{ printer.bed_size_z }}
      variable_bed_center_x: {{ (printer.bed_size_x / 2) | int }}
      variable_bed_center_y: {{ (printer.bed_size_y / 2) | int }}

      # ═══════════════════════════════════════════════════════════════════════════════
      # PROBE AND LEVELING
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_probe_type: "{{ probe.probe_type | default('none') }}"
      {% if probe.probe_type == 'beacon' %}
      # Beacon only supports METHOD=beacon - hardcoded
      variable_eddy_mesh_method: "beacon"
      {% elif probe.probe_type == 'cartographer' %}
      # Cartographer: scan method (touch mode uses scan for mesh)
      variable_eddy_mesh_method: "{{ probe.bed_mesh.mesh_method | default('scan') if probe.bed_mesh else 'scan' }}"
      {% elif probe.probe_type == 'btt_eddy' %}
      # BTT Eddy: rapid_scan by default for fastest scanning
      variable_eddy_mesh_method: "{{ probe.bed_mesh.mesh_method | default('rapid_scan') if probe.bed_mesh else 'rapid_scan' }}"
      {% else %}
      variable_eddy_mesh_method: "none"
      {% endif %}
      {% if bed_leveling.leveling_type == 'qgl' %}
      variable_leveling_method: "quad_gantry_level"
      {% elif bed_leveling.leveling_type == 'z_tilt' %}
      variable_leveling_method: "z_tilt"
      {% else %}
      variable_leveling_method: "none"
      {% endif %}
      # Klipper parses gcode_macro variables with Python literal_eval, so booleans must be True/False (not true/false).
      variable_leveling_enabled: {{ 'True' if ((bed_leveling.leveling_type | default('none') | lower) != 'none') else 'False' }}
      variable_z_calibration_enabled: {{ 'True' if (macros.z_calibration_enabled | default(true)) else 'False' }}
      variable_z_calibration_command: "{{ macros.z_calibration_command | default('') }}"
      variable_always_home_z: {{ 'True' if (macros.always_home_z | default(true)) else 'False' }}
      variable_level_bed_at_temp: {{ 'True' if (macros.level_bed_at_temp | default(true)) else 'False' }}

      # ═══════════════════════════════════════════════════════════════════════════════
      # HEATING
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_extruder_preheat_temp: {{ macros.extruder_preheat_temp | default(150) }}
      variable_preheat_scale: {{ macros.preheat_scale | default(0.75) }}
      # Park position before final extruder heating (front/back/center/front_left/front_right/back_left/back_right/none)
      # Park position before final extruder heating:
      # front/back/left/right/center/front_left/front_right/back_left/back_right/none or manual "X,Y"
      variable_heating_park_position: "{{ macros.heating_park_position | default('center') }}"

      # ═══════════════════════════════════════════════════════════════════════════════
      # BED HEATING BEHAVIOR
      # ═══════════════════════════════════════════════════════════════════════════════
      # Temperature source for probing/meshing: "print", "initial_layer", or "fixed"
      variable_probe_temp_source: "{{ macros.probe_temp_source | default('print') }}"
      # Fixed temperature for probing (only used if probe_temp_source="fixed")
      variable_probe_bed_temp: {{ macros.probe_bed_temp | default(60) }}
      # Wait for bed to stabilize before probing
      variable_bed_stabilize_before_probe: {{ 'True' if (macros.bed_stabilize_before_probe | default(true)) else 'False' }}
      # Stabilization threshold - how close to target before stable (°C)
      variable_bed_stabilize_threshold: {{ macros.bed_stabilize_threshold | default(2.0) }}
      # Optional dwell time after reaching temp for thermal equilibrium (seconds)
      variable_bed_stabilize_dwell: {{ macros.bed_stabilize_dwell | default(0) }}
      # Turn off bed heater during probing/meshing
      variable_bed_off_during_probe: {{ 'True' if (macros.bed_off_during_probe | default(false)) else 'False' }}
      # Reheat bed after probing if it was turned off
      variable_bed_reheat_after_probe: {{ 'True' if (macros.bed_reheat_after_probe | default(true)) else 'False' }}

      # ═══════════════════════════════════════════════════════════════════════════════
      # HEAT SOAK
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_heat_soak_enabled: {{ 'True' if (macros.heat_soak_enabled | default(false)) else 'False' }}
      variable_heat_soak_time: {{ macros.heat_soak_time | default(0) }}
      variable_heat_soak_interruptible: {{ 'True' if (macros.heat_soak_interruptible | default(true)) else 'False' }}
      variable_heat_soak_threshold: {{ macros.heat_soak_threshold | default(0.5) }}

      # ═══════════════════════════════════════════════════════════════════════════════
      # CHAMBER
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_chamber_temp_default: {{ macros.chamber_temp_default | default(0) }}
      variable_chamber_timeout: {{ macros.chamber_timeout | default(30) }}
      variable_chamber_wait: {{ 'True' if (macros.chamber_wait | default(true)) else 'False' }}

      # ═══════════════════════════════════════════════════════════════════════════════
      # BED MESH
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_bed_mesh_mode: "{{ macros.bed_mesh_mode | default('adaptive') }}"

      # ═══════════════════════════════════════════════════════════════════════════════
      # NOZZLE CLEANING (BRUSH)
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_brush_enabled: {{ 'True' if (macros.brush_enabled | default(false)) else 'False' }}
      variable_brush_x: {{ macros.brush_x | default(50.0) }}
      variable_brush_y: {{ macros.brush_y | default(317.0) }}
      variable_brush_z: {{ macros.brush_z | default(1.0) }}
      variable_brush_width: {{ macros.brush_width | default(30.0) }}
      variable_wipe_count: {{ macros.wipe_count | default(3) }}
      variable_wipe_speed: {{ macros.wipe_speed | default(100) }}

      # ═══════════════════════════════════════════════════════════════════════════════
      # PURGE SETTINGS
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_purge_style: "{{ macros.purge_style | default('line') }}"
      variable_purge_amount: {{ macros.purge_amount | default(30.0) }}
      variable_purge_speed: {{ macros.purge_speed | default(3.0) }}
      variable_purge_x: {{ macros.purge_x | default(5) }}
      variable_purge_y: {{ macros.purge_y | default(5) }}
      variable_purge_clearance: {{ macros.purge_clearance | default(10.0) }}
      # Bucket (for blob/voron purge)
      variable_bucket_x: {{ macros.bucket_x | default((printer.bed_size_x / 2) | int) }}
      variable_bucket_y: {{ macros.bucket_y | default(printer.bed_size_y - 5) }}
      variable_bucket_z: {{ macros.bucket_z | default(5.0) }}
      variable_bucket_dwell: {{ macros.bucket_dwell | default(1000) }}

      # ═══════════════════════════════════════════════════════════════════════════════
      # MOVEMENT SPEEDS (mm/s unless noted)
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_travel_speed: {{ macros.travel_speed | default(300) }}
      variable_z_travel_speed: {{ macros.z_travel_speed | default(15) }}
      variable_homing_speed: {{ macros.homing_speed | default(50) }}

      # ═══════════════════════════════════════════════════════════════════════════════
      # END PRINT - RETRACTION
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_end_retract_length: {{ macros.end_retract_length | default(10.0) }}
      variable_end_retract_speed: {{ macros.end_retract_speed | default(30.0) }}

      # ═══════════════════════════════════════════════════════════════════════════════
      # END PRINT - PARKING
      # ═══════════════════════════════════════════════════════════════════════════════
      # Park position:
      # front/back/left/right/center/front_left/front_right/back_left/back_right or manual "X,Y"
      variable_park_position: "{{ macros.park_position | default('front') }}"
      variable_park_z_hop: {{ macros.park_z_hop | default(10.0) }}
      # Default park_z_max should scale with printer Z travel (z_max - 5 safety margin)
      variable_park_z_max: {{ (macros.park_z_max | default(printer.bed_size_z - 5)) | float }}
      variable_park_speed: {{ macros.park_speed | default(150) }}

      # ═══════════════════════════════════════════════════════════════════════════════
      # END PRINT - COOLDOWN
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_turn_off_extruder: {{ 'True' if (macros.turn_off_extruder | default(true)) else 'False' }}
      variable_turn_off_bed: {{ 'True' if (macros.turn_off_bed | default(true)) else 'False' }}
      variable_turn_off_fans: {{ 'True' if (macros.turn_off_fans | default(true)) else 'False' }}
      variable_fan_off_delay: {{ macros.fan_off_delay | default(0) }}
      variable_motor_off_delay: {{ macros.motor_off_delay | default(300) }}

      # ═══════════════════════════════════════════════════════════════════════════════
      # PAUSE / RESUME
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_pause_retract: {{ macros.pause_retract | default(1.0) }}
      variable_pause_z_hop: {{ macros.pause_z_hop | default(10.0) }}
      # Pause park position:
      # front/back/left/right/center/front_left/front_right/back_left/back_right or manual "X,Y"
      variable_pause_position: "{{ macros.pause_position | default('front') }}"
      variable_pause_heater_off: {{ 'True' if (macros.pause_heater_off | default(false)) else 'False' }}
      variable_pause_timeout: {{ macros.pause_timeout | default(43200) }}
      variable_resume_prime: {{ macros.resume_prime | default(1.0) }}
      variable_resume_speed: {{ macros.resume_speed | default(100) }}

      # ═══════════════════════════════════════════════════════════════════════════════
      # FILAMENT LOAD
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_load_temp: {{ macros.load_temp | default(220) }}
      variable_load_length: {{ macros.load_length | default(100) }}
      # Speeds are stored as mm/s (wizard UI). Macros convert to G-code feedrate (F) internally.
      # Backwards compatible: if a legacy value looks like a feedrate (>100), it is converted.
      variable_load_speed: {{ macros.load_speed | default(5.0) }}
      variable_load_prime: {{ macros.load_prime | default(50) }}
      variable_load_prime_speed: {{ macros.load_prime_speed | default(2.5) }}

      # ═══════════════════════════════════════════════════════════════════════════════
      # FILAMENT UNLOAD
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_unload_temp: {{ macros.unload_temp | default(220) }}
      variable_unload_length: {{ macros.unload_length | default(100) }}
      variable_unload_speed: {{ macros.unload_speed | default(30.0) }}
      variable_unload_tip_shape: {{ 'True' if (macros.unload_tip_shape | default(true)) else 'False' }}
      # Tip shaping tuning (units: mm and mm/s; converted to G-code feedrate (F) in macros)
      variable_unload_tip_prime_length: {{ macros.unload_tip_prime_length | default(10.0) }}
      variable_unload_tip_prime_speed: {{ macros.unload_tip_prime_speed | default(5.0) }}
      variable_unload_tip_quick_retract_length: {{ macros.unload_tip_quick_retract_length | default(10.0) }}
      variable_unload_tip_quick_retract_speed: {{ macros.unload_tip_quick_retract_speed | default(60.0) }}
      variable_unload_tip_ram_length: {{ macros.unload_tip_ram_length | default(5.0) }}
      variable_unload_tip_ram_speed: {{ macros.unload_tip_ram_speed | default(5.0) }}
      variable_unload_tip_short_retract_length: {{ macros.unload_tip_short_retract_length | default(15.0) }}
      variable_unload_tip_short_retract_speed: {{ macros.unload_tip_short_retract_speed | default(60.0) }}

      # ═══════════════════════════════════════════════════════════════════════════════
      # FILAMENT SENSOR
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_filament_sensor_enabled: {{ 'True' if (macros.filament_sensor_enabled | default(false)) else 'False' }}
      variable_runout_pause: {{ 'True' if (macros.runout_pause | default(true)) else 'False' }}
      variable_runout_gcode: "{{ macros.runout_gcode | default('M600') }}"
      variable_insert_delay: {{ macros.insert_delay | default(0) }}

      # ═══════════════════════════════════════════════════════════════════════════════
      # LED STATUS
      # ═══════════════════════════════════════════════════════════════════════════════
      variable_led_enabled: {{ 'True' if (macros.led_enabled | default(false)) else 'False' }}
      variable_led_name: "{{ macros.led_name | default('status_led') }}"
      variable_led_heating: "{{ macros.led_heating | default('1.0, 0.2, 0.0') }}"
      variable_led_printing: "{{ macros.led_printing | default('0.0, 1.0, 0.0') }}"
      variable_led_paused: "{{ macros.led_paused | default('1.0, 1.0, 0.0') }}"
      variable_led_error: "{{ macros.led_error | default('1.0, 0.0, 0.0') }}"
      variable_led_complete: "{{ macros.led_complete | default('0.0, 0.5, 1.0') }}"

      gcode:
          # Configuration only - no gcode

  # _BED_MESH macro with probe-aware method selection
  bed_mesh_macro:
    render: raw
    template: |
      [gcode_macro _BED_MESH]
      description: Run bed mesh with appropriate method for probe type
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
          {% set MODE = params.MODE|default("adaptive")|lower %}

          {% if MODE == "none" %}
              M117 Skipping mesh
          {% elif MODE == "saved" %}
              BED_MESH_PROFILE LOAD=default
          {% elif MODE == "adaptive" %}
              # Adaptive mesh - only mesh print area
              {% if cfg.probe_type in ['beacon', 'cartographer', 'btt_eddy'] %}
                  BED_MESH_CALIBRATE METHOD={cfg.eddy_mesh_method} ADAPTIVE=1
              {% else %}
                  BED_MESH_CALIBRATE ADAPTIVE=1
              {% endif %}
          {% else %}
              # Full mesh
              {% if cfg.probe_type in ['beacon', 'cartographer', 'btt_eddy'] %}
                  BED_MESH_CALIBRATE METHOD={cfg.eddy_mesh_method}
              {% else %}
                  BED_MESH_CALIBRATE
              {% endif %}
          {% endif %}

  # START_PRINT macro
  start_print_macro:
    render: raw
    template: |
      # ═══════════════════════════════════════════════════════════════════════════════
      # START_PRINT MACRO
      # Generated by gschpoozi
      # ═══════════════════════════════════════════════════════════════════════════════
      #
      # Usage in slicer start G-code:
      #   START_PRINT BED={bed_temp} EXTRUDER={extruder_temp} [BED_INITIAL={first_layer_bed_temp}] [CHAMBER={chamber_temp}] [MATERIAL={material}] [MESH={mesh_mode}]
      #
      # Parameters:
      #   BED        - Bed temperature for printing (required)
      #   EXTRUDER   - Extruder temperature (required)
      #   BED_INITIAL - Bed temp for probing/meshing (optional, defaults to BED)
      #   CHAMBER    - Chamber temperature (optional, 0 = skip)
      #   MATERIAL   - Filament type: PLA/PETG/ABS/ASA/TPU (optional, for tuning)
      #   MESH       - Bed mesh mode: adaptive/full/saved/none (optional)
      #   PURGE      - Purge style: line/blob/adaptive/none (optional)
      #
      # ═══════════════════════════════════════════════════════════════════════════════

      [gcode_macro START_PRINT]
      description: Complete print start sequence with heating, leveling, meshing, and purging
      gcode:
          # ───────────────────────────────────────────────────────────────────────────
          # Parse parameters (with defaults from config)
          # ───────────────────────────────────────────────────────────────────────────
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

          {% set BED_TEMP = params.BED|default(60)|int %}
          {% set BED_INITIAL = params.BED_INITIAL|default(BED_TEMP)|int %}
          {% set EXTRUDER_TEMP = params.EXTRUDER|default(200)|int %}
          {% set MATERIAL = params.MATERIAL|default("PLA")|upper %}
          {% set MESH_MODE = params.MESH|default(cfg.bed_mesh_mode)|lower %}
          {% set PURGE_STYLE = params.PURGE|default(cfg.purge_style)|lower %}

          # Calculate probe temperature based on probe_temp_source setting
          # Options: "print" = BED_TEMP, "initial_layer" = BED_INITIAL, "fixed" = probe_bed_temp
          {% if cfg.probe_temp_source == "fixed" %}
              {% set PROBE_TEMP = cfg.probe_bed_temp %}
          {% elif cfg.probe_temp_source == "initial_layer" %}
              {% set PROBE_TEMP = BED_INITIAL %}
          {% else %}
              {% set PROBE_TEMP = BED_TEMP %}
          {% endif %}

          # ───────────────────────────────────────────────────────────────────────────
          # Material profile lookup (chamber temp, heat soak time)
          # Slicer provides BED/EXTRUDER temps; material sets behavior
          # ───────────────────────────────────────────────────────────────────────────
          {% set material_profiles = {
              "PLA":   {"chamber": 0,  "soak": 0},
              "PETG":  {"chamber": 0,  "soak": 0},
              "ABS":   {"chamber": 45, "soak": 15},
              "ASA":   {"chamber": 50, "soak": 15},
              "TPU":   {"chamber": 0,  "soak": 0},
              "PC":    {"chamber": 55, "soak": 20},
              "NYLON": {"chamber": 40, "soak": 10},
              "HIPS":  {"chamber": 40, "soak": 10}
          } %}
          {% set mat = material_profiles.get(MATERIAL, {"chamber": 0, "soak": 0}) %}

          # Chamber temp: Use CHAMBER param if provided, else material default, else config default
          {% if params.CHAMBER is defined %}
              {% set CHAMBER_TEMP = params.CHAMBER|int %}
          {% elif mat.chamber > 0 %}
              {% set CHAMBER_TEMP = mat.chamber %}
          {% else %}
              {% set CHAMBER_TEMP = cfg.chamber_temp_default %}
          {% endif %}

          # Heat soak: Use material profile if heat_soak_enabled, else config setting
          {% if cfg.heat_soak_enabled %}
              {% set SOAK_TIME = [mat.soak, cfg.heat_soak_time]|max %}
          {% else %}
              {% set SOAK_TIME = cfg.heat_soak_time %}
          {% endif %}

          # Calculate preheat temperature using scale factor or fixed temp
          # preheat_scale: 0.0 = no preheat, 0.5 = half temp, 1.0 = full temp
          {% if cfg.preheat_scale > 0 %}
              {% set EXTRUDER_PREHEAT = [(EXTRUDER_TEMP * cfg.preheat_scale)|int, cfg.extruder_preheat_temp]|min %}
          {% else %}
              {% set EXTRUDER_PREHEAT = 0 %}
          {% endif %}

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 1: Start heating and home
          # ───────────────────────────────────────────────────────────────────────────
          M117 Heating bed...
          {% if cfg.led_enabled %}
          _STATUS_LED STATUS=heating
          {% endif %}

          # Start bed heating to probe temperature (don't wait yet)
          # PROBE_TEMP may differ from BED_TEMP based on probe_temp_source setting
          M140 S{PROBE_TEMP}

          # Preheat extruder to prevent cold ooze during probing (don't wait)
          {% if EXTRUDER_PREHEAT > 0 %}
          M104 S{EXTRUDER_PREHEAT}
          {% endif %}

          # Home if needed
          _HOME_IF_NEEDED

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 2: Wait for bed and optional heat soak
          # ───────────────────────────────────────────────────────────────────────────
          {% if cfg.level_bed_at_temp %}
              # Wait for bed to reach probe temperature before leveling
              M117 Waiting for bed...
              M190 S{PROBE_TEMP}

              {% if cfg.bed_stabilize_before_probe and cfg.bed_stabilize_dwell > 0 %}
              # Optional dwell time for thermal equilibrium
              M117 Stabilizing bed temp...
              G4 P{cfg.bed_stabilize_dwell * 1000}
              {% endif %}
          {% endif %}

          {% if SOAK_TIME > 0 %}
          _HEAT_SOAK MINUTES={SOAK_TIME}
          {% endif %}

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 3: Chamber heating (if configured)
          # ───────────────────────────────────────────────────────────────────────────
          {% if CHAMBER_TEMP > 0 and cfg.chamber_wait %}
          _CHAMBER_WAIT TEMP={CHAMBER_TEMP} TIMEOUT={cfg.chamber_timeout}
          {% endif %}

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 4: Bed leveling
          # ───────────────────────────────────────────────────────────────────────────
          {% if cfg.led_enabled %}
          _STATUS_LED STATUS=leveling
          {% endif %}

          # Optional: Turn off bed heater during probing (reduces PWM noise for some probes)
          {% if cfg.bed_off_during_probe %}
          M117 Heater off for probing...
          M140 S0
          G4 P3000  ; Wait 3s for heater to stabilize
          {% endif %}

          {% if cfg.leveling_enabled %}
          M117 Leveling bed...
          _LEVEL_BED
          {% endif %}

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 5: Z calibration (probe-specific)
          # ───────────────────────────────────────────────────────────────────────────
          {% if cfg.z_calibration_enabled and cfg.z_calibration_command != "" %}
          M117 Z calibration...
          {cfg.z_calibration_command}
          {% endif %}

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 6: Bed mesh
          # ───────────────────────────────────────────────────────────────────────────
          {% if cfg.led_enabled %}
          _STATUS_LED STATUS=meshing
          {% endif %}

          {% if MESH_MODE != "none" %}
          M117 Bed mesh...
          _BED_MESH MODE={MESH_MODE}
          {% endif %}

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 7: Heat bed to print temperature (and reheat if needed)
          # ───────────────────────────────────────────────────────────────────────────
          {% if cfg.led_enabled %}
          _STATUS_LED STATUS=heating
          {% endif %}

          # Reheat bed if it was turned off during probing
          {% if cfg.bed_off_during_probe and cfg.bed_reheat_after_probe %}
          M117 Reheating bed...
          M140 S{BED_TEMP}
          {% endif %}

          # Heat bed to final print temp if PROBE_TEMP was different
          {% if PROBE_TEMP != BED_TEMP %}
          M117 Heating bed to print temp...
          M140 S{BED_TEMP}
          M190 S{BED_TEMP}
          {% elif not cfg.level_bed_at_temp %}
          # Wait for bed if we skipped earlier
          M117 Waiting for bed...
          M190 S{BED_TEMP}
          {% elif cfg.bed_off_during_probe and cfg.bed_reheat_after_probe %}
          # Wait for reheat to complete
          M190 S{BED_TEMP}
          {% endif %}

          # Park for heating if configured
          {% if cfg.heating_park_position != "none" %}
          _PARK POSITION={cfg.heating_park_position}
          {% endif %}

          M117 Heating extruder...
          M109 S{EXTRUDER_TEMP}

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 8: Nozzle cleaning (if enabled)
          # ───────────────────────────────────────────────────────────────────────────
          {% if cfg.brush_enabled %}
          M117 Cleaning nozzle...
          _CLEAN_NOZZLE
          {% endif %}

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 9: Purge
          # ───────────────────────────────────────────────────────────────────────────
          {% if PURGE_STYLE != "none" %}
          M117 Purging...
          _PURGE STYLE={PURGE_STYLE}
          {% endif %}

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 10: Ready to print
          # ───────────────────────────────────────────────────────────────────────────
          {% if cfg.led_enabled %}
          _STATUS_LED STATUS=printing
          {% endif %}

          M117 Printing...
          G92 E0  ; Reset extruder
          G90     ; Absolute positioning

      # ═══════════════════════════════════════════════════════════════════════════════
      # BUILDING BLOCK MACROS
      # ═══════════════════════════════════════════════════════════════════════════════

      # ───────────────────────────────────────────────────────────────────────────────
      # Conditional Homing
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro _HOME_IF_NEEDED]
      description: Home axes only if not already homed
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

          {% if cfg.led_enabled %}
          _STATUS_LED STATUS=homing
          {% endif %}

          M117 Homing...

          {% if "xyz" not in printer.toolhead.homed_axes %}
              G28
          {% else %}
              # Already homed - optionally re-home Z for accuracy
              {% if cfg.always_home_z %}
              G28 Z
              {% endif %}
          {% endif %}

      # ───────────────────────────────────────────────────────────────────────────────
      # Heat Soak
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro _HEAT_SOAK]
      description: Wait for bed temperature to stabilize
      gcode:
          {% set MINUTES = params.MINUTES|default(0)|int %}

          {% if MINUTES > 0 %}
              M117 Heat soak {MINUTES}min...
              # Move to center during soak
              {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
              G0 X{cfg.bed_center_x} Y{cfg.bed_center_y} Z30 F6000

              # Wait for soak time
              {% for i in range(MINUTES) %}
                  M117 Heat soak {MINUTES - i}min remaining...
                  G4 P60000  ; Wait 1 minute
              {% endfor %}
          {% endif %}

      # ───────────────────────────────────────────────────────────────────────────────
      # Chamber Wait
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro _CHAMBER_WAIT]
      description: Wait for chamber to reach target temperature
      gcode:
          {% set TEMP = params.TEMP|default(0)|int %}
          {% set TIMEOUT = params.TIMEOUT|default(30)|int %}

          {% if TEMP > 0 %}
              M117 Chamber heating to {TEMP}C...

              # Check if chamber sensor exists
              {% if printer["temperature_sensor chamber"] is defined %}
                  TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={TEMP}
              {% elif printer["temperature_fan chamber"] is defined %}
                  # Chamber has temperature-controlled fan
                  SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET={TEMP}
                  TEMPERATURE_WAIT SENSOR="temperature_fan chamber" MINIMUM={TEMP}
              {% else %}
                  M117 No chamber sensor found
              {% endif %}
          {% endif %}

      # ───────────────────────────────────────────────────────────────────────────────
      # Bed Leveling (auto-selects QGL or Z_TILT)
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro _LEVEL_BED]
      description: Level bed using QGL or Z_TILT based on configuration
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

          {% if cfg.leveling_method == "quad_gantry_level" %}
              # Quad Gantry Level (4 Z motors)
              {% if printer.quad_gantry_level.applied|lower == 'false' %}
                  QUAD_GANTRY_LEVEL
              {% endif %}
          {% elif cfg.leveling_method == "z_tilt" %}
              # Z Tilt Adjust (2-3 Z motors)
              {% if printer.z_tilt.applied|lower == 'false' %}
                  Z_TILT_ADJUST
              {% endif %}
          {% endif %}

          # Re-home Z after leveling for accuracy
          G28 Z

      # ───────────────────────────────────────────────────────────────────────────────
      # Z Calibration (probe-specific)
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro _CALIBRATE_Z]
      description: Probe-specific Z calibration
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

          # Move to calibration position
          G0 X{cfg.bed_center_x} Y{cfg.bed_center_y} F6000

          # Probe-specific calibration
          # Note: Specific probe calibration commands should be added here based on probe type

      # ───────────────────────────────────────────────────────────────────────────────
      # Nozzle Cleaning
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro _CLEAN_NOZZLE]
      description: Clean nozzle at brush station
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
          {% set WIPES = params.WIPES|default(cfg.wipe_count)|int %}

          {% if cfg.brush_enabled %}
              # Save current position
              {% set start_x = printer.toolhead.position.x %}
              {% set start_y = printer.toolhead.position.y %}

              # Move to brush position
              G0 Z{cfg.brush_z + 5} F3000
              G0 X{cfg.brush_x} Y{cfg.brush_y} F6000
              G0 Z{cfg.brush_z} F1000

              # Wipe back and forth
              {% for i in range(WIPES) %}
                  G0 X{cfg.brush_x + cfg.brush_width} F3000
                  G0 X{cfg.brush_x} F3000
              {% endfor %}

              # Lift and return
              G0 Z{cfg.brush_z + 5} F3000
          {% endif %}

      # ───────────────────────────────────────────────────────────────────────────────
      # Purge
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro _PURGE]
      description: Purge filament before printing
      gcode:
          {% set STYLE = params.STYLE|default("line")|lower %}
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
          {% set AMOUNT = params.AMOUNT|default(cfg.purge_amount)|float %}

          {% if STYLE == "none" %}
              # Skip purge
          {% elif STYLE == "blob" %}
              _PURGE_BLOB AMOUNT={AMOUNT}
          {% elif STYLE == "adaptive" %}
              _PURGE_ADAPTIVE AMOUNT={AMOUNT}
          {% else %}
              # Default: line purge
              _PURGE_LINE AMOUNT={AMOUNT}
          {% endif %}

      [gcode_macro _PURGE_LINE]
      description: Simple line purge along bed edge
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
          {% set AMOUNT = params.AMOUNT|default(cfg.purge_amount)|float %}

          # Calculate purge line length based on amount
          {% set LINE_LENGTH = AMOUNT * 3 %}  ; ~3mm per mm of filament
          {% set LINE_LENGTH = [LINE_LENGTH, cfg.bed_size_y - 20]|min %}  ; Cap at bed size

          # Start position (front left corner)
          {% set START_X = cfg.purge_x %}
          {% set START_Y = cfg.purge_y %}

          G92 E0
          G0 Z5 F3000
          G0 X{START_X} Y{START_Y} F6000
          G0 Z0.3 F1000

          # Purge line
          G1 Y{START_Y + LINE_LENGTH} E{AMOUNT} F1500

          # Small wipe
          G1 E-0.5 F3000
          G0 Z2 F3000
          G0 X{START_X + 5} F6000

          G92 E0

      [gcode_macro _PURGE_BLOB]
      description: Purge blob into bucket
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
          {% set AMOUNT = params.AMOUNT|default(cfg.purge_amount)|float %}

          # Move to bucket position
          G0 Z10 F3000
          G0 X{cfg.bucket_x} Y{cfg.bucket_y} F6000
          G0 Z{cfg.bucket_z} F1000

          G92 E0

          # Slow purge to form blob
          G1 E{AMOUNT} F150

          # Quick retract
          G1 E-2 F3000
          G4 P1000  ; Wait for blob to detach

          # Lift
          G0 Z{cfg.bucket_z + 10} F3000

          G92 E0

      [gcode_macro _PURGE_ADAPTIVE]
      description: Adaptive purge near print area
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
          {% set AMOUNT = params.AMOUNT|default(cfg.purge_amount)|float %}

          # If print bounds are provided, purge near the print
          # Otherwise fall back to line purge
          {% if params.PRINT_MIN is defined %}
              {% set print_min = params.PRINT_MIN.split(",")|map('float')|list %}
              {% set START_X = print_min[0] - 10 %}
              {% set START_Y = print_min[1] %}

              # Ensure we're on the bed
              {% set START_X = [START_X, 5]|max %}
              {% set START_Y = [START_Y, 5]|max %}

              G92 E0
              G0 Z5 F3000
              G0 X{START_X} Y{START_Y} F6000
              G0 Z0.3 F1000

              # Short purge line
              G1 Y{START_Y + 30} E{AMOUNT} F1500
              G1 E-0.5 F3000
              G0 Z2 F3000

              G92 E0
          {% else %}
              _PURGE_LINE AMOUNT={AMOUNT}
          {% endif %}

      # ───────────────────────────────────────────────────────────────────────────────
      # LED Status
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro _STATUS_LED]
      description: Update LED status color
      gcode:
          {% set STATUS = params.STATUS|default("ready")|lower %}
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

          {% if cfg.led_enabled %}
              {% set colors = {
                  "heating":  {"r": 1.0, "g": 0.2, "b": 0.0},
                  "homing":   {"r": 0.0, "g": 0.5, "b": 1.0},
                  "leveling": {"r": 0.5, "g": 0.0, "b": 1.0},
                  "meshing":  {"r": 0.0, "g": 1.0, "b": 0.5},
                  "printing": {"r": 1.0, "g": 1.0, "b": 1.0},
                  "complete": {"r": 0.0, "g": 1.0, "b": 0.0},
                  "error":    {"r": 1.0, "g": 0.0, "b": 0.0},
                  "ready":    {"r": 0.2, "g": 0.2, "b": 0.2}
              } %}

              {% set c = colors[STATUS] if STATUS in colors else colors["ready"] %}

              SET_LED LED={cfg.led_name} RED={c.r} GREEN={c.g} BLUE={c.b}
          {% endif %}

  # END_PRINT macro
  end_print_macro:
    render: raw
    template: |
      # ═══════════════════════════════════════════════════════════════════════════════
      # END_PRINT MACRO
      # Generated by gschpoozi
      # ═══════════════════════════════════════════════════════════════════════════════
      #
      # Usage in slicer end G-code:
      #   END_PRINT
      #
      # Optional parameters:
      #   PARK     - Park position: front/back/center (default from config)
      #   RETRACT  - Retract length in mm (default from config)
      #
      # ═══════════════════════════════════════════════════════════════════════════════

      [gcode_macro END_PRINT]
      description: End print (PARK=front|back|center|front_left|front_right|back_left|back_right)
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
          {% set PARK_POS = params.PARK|default(cfg.park_position)|lower %}

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 1: Turn off heaters first (they take longest to cool)
          # ───────────────────────────────────────────────────────────────────────────
          {% if cfg.turn_off_extruder %}
          M104 S0  ; Turn off extruder
          {% endif %}

          {% if cfg.turn_off_bed %}
          M140 S0  ; Turn off bed
          {% endif %}

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 2: Retract filament
          # ───────────────────────────────────────────────────────────────────────────
          _END_RETRACT

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 3: Park toolhead
          # ───────────────────────────────────────────────────────────────────────────
          _PARK POSITION={PARK_POS}

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 4: Fan management
          # ───────────────────────────────────────────────────────────────────────────
          {% if cfg.turn_off_fans %}
              {% if cfg.fan_off_delay > 0 %}
                  # Delayed fan off (let part cool a bit)
                  UPDATE_DELAYED_GCODE ID=_DELAYED_FAN_OFF DURATION={cfg.fan_off_delay}
              {% else %}
                  M106 S0  ; Turn off part cooling fan
              {% endif %}
          {% endif %}

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 5: Status LED
          # ───────────────────────────────────────────────────────────────────────────
          {% if cfg.led_enabled %}
          _STATUS_LED STATUS=complete
          {% endif %}

          # ───────────────────────────────────────────────────────────────────────────
          # Phase 6: Disable motors (delayed if configured)
          # ───────────────────────────────────────────────────────────────────────────
          {% if cfg.motor_off_delay > 0 %}
              UPDATE_DELAYED_GCODE ID=_DELAYED_MOTOR_OFF DURATION={cfg.motor_off_delay}
          {% else %}
              M84  ; Disable motors
          {% endif %}

          M117 Print complete!

      # ═══════════════════════════════════════════════════════════════════════════════
      # END_PRINT BUILDING BLOCKS
      # ═══════════════════════════════════════════════════════════════════════════════

      # ───────────────────────────────────────────────────────────────────────────────
      # Retract Filament
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro _END_RETRACT]
      description: Retract filament at end of print
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

          # Relative extrusion
          M83

          # Retract
          G1 E-{cfg.end_retract_length} F{cfg.end_retract_speed * 60}

          # Back to absolute extrusion
          M82
          G92 E0

      # ───────────────────────────────────────────────────────────────────────────────
      # Park Toolhead
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro _PARK]
      description: Park toolhead (POSITION=front|back|left|right|center|front_left|front_right|back_left|back_right|X,Y)
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
          {% set POSITION = (params.POSITION|default(cfg.park_position)|string)|lower %}
          {% set POSITION = POSITION.replace(" ", "") %}

          # Get current Z and calculate safe Z
          {% set current_z = printer.toolhead.position.z %}
          {% set z_hop = cfg.park_z_hop %}
          {% set z_max = printer.toolhead.axis_maximum.z %}
          {% set park_z = [current_z + z_hop, cfg.park_z_max, z_max - 5]|min %}

          # Calculate park X/Y based on position
          {% set bed_x = cfg.bed_size_x %}
          {% set bed_y = cfg.bed_size_y %}

          {% if POSITION == "front" %}
              {% set park_x = bed_x / 2 %}
              {% set park_y = 10 %}
          {% elif POSITION == "back" %}
              {% set park_x = bed_x / 2 %}
              {% set park_y = bed_y - 10 %}
          {% elif POSITION == "center" %}
              {% set park_x = bed_x / 2 %}
              {% set park_y = bed_y / 2 %}
          {% elif POSITION == "left" %}
              {% set park_x = 10 %}
              {% set park_y = bed_y / 2 %}
          {% elif POSITION == "right" %}
              {% set park_x = bed_x - 10 %}
              {% set park_y = bed_y / 2 %}
          {% elif POSITION == "front_left" %}
              {% set park_x = 10 %}
              {% set park_y = 10 %}
          {% elif POSITION == "front_right" %}
              {% set park_x = bed_x - 10 %}
              {% set park_y = 10 %}
          {% elif POSITION == "back_left" %}
              {% set park_x = 10 %}
              {% set park_y = bed_y - 10 %}
          {% elif POSITION == "back_right" %}
              {% set park_x = bed_x - 10 %}
              {% set park_y = bed_y - 10 %}
          {% elif "," in POSITION %}
              {% set _p = POSITION.split(",") %}
              {% if _p|length >= 2 %}
                  {% set park_x = _p[0]|float %}
                  {% set park_y = _p[1]|float %}
                  # Clamp inside bed with a 10mm margin
                  {% set park_x = ([10, park_x, bed_x - 10]|sort)[1] %}
                  {% set park_y = ([10, park_y, bed_y - 10]|sort)[1] %}
              {% else %}
                  # Default to front center
                  {% set park_x = bed_x / 2 %}
                  {% set park_y = 10 %}
              {% endif %}
          {% else %}
              # Default to front center
              {% set park_x = bed_x / 2 %}
              {% set park_y = 10 %}
          {% endif %}

          # Move to park position
          G90  ; Absolute positioning
          G0 Z{park_z} F3000
          G0 X{park_x} Y{park_y} F6000

      # ───────────────────────────────────────────────────────────────────────────────
      # Delayed Fan Off
      # ───────────────────────────────────────────────────────────────────────────────
      [delayed_gcode _DELAYED_FAN_OFF]
      gcode:
          M106 S0  ; Turn off part cooling fan

      # ───────────────────────────────────────────────────────────────────────────────
      # Delayed Motor Off
      # ───────────────────────────────────────────────────────────────────────────────
      [delayed_gcode _DELAYED_MOTOR_OFF]
      gcode:
          M84  ; Disable all motors

      # ═══════════════════════════════════════════════════════════════════════════════
      # UTILITY MACROS
      # ═══════════════════════════════════════════════════════════════════════════════

      # ───────────────────────────────────────────────────────────────────────────────
      # Cancel Print
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro CANCEL_PRINT]
      description: Cancel the running print
      rename_existing: CANCEL_PRINT_BASE
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

          # Turn off heaters
          M104 S0
          M140 S0

          # Retract
          _END_RETRACT

          # Park
          _PARK POSITION={cfg.park_position}

          # Turn off fans
          M106 S0

          # Set LED to error
          {% if cfg.led_enabled %}
          _STATUS_LED STATUS=error
          {% endif %}

          # Clear print state
          CANCEL_PRINT_BASE

          M117 Print cancelled

      # ───────────────────────────────────────────────────────────────────────────────
      # Pause Print
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro PAUSE]
      description: Pause the running print
      rename_existing: PAUSE_BASE
      variable_saved_extruder_temp: 0
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
          {% set RETRACT = cfg.pause_retract %}
          {% set Z_HOP = cfg.pause_z_hop %}

          # Save current position
          SAVE_GCODE_STATE NAME=PAUSE_state

          # Save extruder temp for resume (if heater_off enabled)
          {% if cfg.pause_heater_off %}
              SET_GCODE_VARIABLE MACRO=PAUSE VARIABLE=saved_extruder_temp VALUE={printer.extruder.target}
          {% endif %}

          # Retract
          M83
          G1 E-{RETRACT} F2100

          # Z hop
          {% set current_z = printer.toolhead.position.z %}
          {% set max_z = printer.toolhead.axis_maximum.z %}
          {% set target_z = [current_z + Z_HOP, max_z - 5]|min %}
          G90
          G0 Z{target_z} F{cfg.z_travel_speed * 60}

          # Park at configured position
          _PARK POSITION={cfg.pause_position}

          # Set idle timeout (Ellis safety pattern)
          SET_IDLE_TIMEOUT TIMEOUT={cfg.pause_timeout}

          # Turn off heater if configured (safety feature)
          {% if cfg.pause_heater_off %}
              M104 S0
              M117 Paused (heater off)
          {% else %}
              M117 Print paused
          {% endif %}

          # LED status
          {% if cfg.led_enabled %}
              _STATUS_LED STATUS=paused
          {% endif %}

          # Base pause
          PAUSE_BASE

      # ───────────────────────────────────────────────────────────────────────────────
      # Resume Print
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro RESUME]
      description: Resume the paused print
      rename_existing: RESUME_BASE
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
          {% set PRIME = cfg.resume_prime %}
          {% set SPEED = cfg.resume_speed %}
          {% set saved_temp = printer["gcode_macro PAUSE"].saved_extruder_temp %}

          # Restore idle timeout to default
          SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout|int}

          # Reheat if heater was turned off
          {% if cfg.pause_heater_off and saved_temp > 0 %}
              M117 Reheating...
              M109 S{saved_temp}
          {% endif %}

          # LED status
          {% if cfg.led_enabled %}
              _STATUS_LED STATUS=printing
          {% endif %}

          # Prime nozzle
          M83
          G1 E{PRIME} F{SPEED * 60}

          # Restore position
          RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={SPEED}

          # Base resume
          RESUME_BASE

          M117 Printing...

      # ───────────────────────────────────────────────────────────────────────────────
      # Filament Load
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro LOAD_FILAMENT]
      description: Load filament into the extruder
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
          {% set TEMP = params.TEMP|default(cfg.load_temp)|float %}
          {% set LENGTH = params.LENGTH|default(cfg.load_length)|float %}
          {% set SPEED_MM_S = params.SPEED|default(cfg.load_speed)|float %}
          {% set PRIME = params.PRIME|default(cfg.load_prime)|float %}
          {% set PRIME_SPEED_MM_S = params.PRIME_SPEED|default(cfg.load_prime_speed)|float %}

          # Backwards compatibility: legacy configs stored filament speeds as raw feedrates.
          {% if SPEED_MM_S > 100 %}
              {% set SPEED_MM_S = SPEED_MM_S / 60.0 %}
          {% endif %}
          {% if PRIME_SPEED_MM_S > 100 %}
              {% set PRIME_SPEED_MM_S = PRIME_SPEED_MM_S / 60.0 %}
          {% endif %}

          # Save state
          SAVE_GCODE_STATE NAME=LOAD_FILAMENT_state

          # Heat if needed
          {% if printer.extruder.temperature < (TEMP - 10) %}
              M117 Heating for filament load...
              M109 S{TEMP}
          {% endif %}

          M117 Loading filament...
          M83  ; Relative extrusion

          # Fast load (bowden section if applicable)
          G1 E{LENGTH} F{(SPEED_MM_S * 60.0)|int}

          # Slow prime (hotend section)
          G1 E{PRIME} F{(PRIME_SPEED_MM_S * 60.0)|int}

          # Small retract to prevent ooze
          G1 E-5 F1800

          M82  ; Absolute extrusion
          G92 E0

          RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_state
          M117 Filament loaded

      # ───────────────────────────────────────────────────────────────────────────────
      # Filament Unload
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro UNLOAD_FILAMENT]
      description: Unload filament from the extruder
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
          {% set TEMP = params.TEMP|default(cfg.unload_temp)|float %}
          {% set LENGTH = params.LENGTH|default(cfg.unload_length)|float %}
          {% set SPEED_MM_S = params.SPEED|default(cfg.unload_speed)|float %}

          # Backwards compatibility: legacy configs stored filament speeds as raw feedrates.
          {% if SPEED_MM_S > 100 %}
              {% set SPEED_MM_S = SPEED_MM_S / 60.0 %}
          {% endif %}

          SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_state

          # Heat if needed
          {% if printer.extruder.temperature < (TEMP - 10) %}
              M117 Heating for filament unload...
              M109 S{TEMP}
          {% endif %}

          M117 Unloading filament...
          M83  ; Relative extrusion

          {% if cfg.unload_tip_shape %}
              # Tip-shaping sequence (reduces stringing on reload)
              {% set TIP_PRIME_MM_S = cfg.unload_tip_prime_speed|float %}
              {% set TIP_QR_MM_S = cfg.unload_tip_quick_retract_speed|float %}
              {% set TIP_RAM_MM_S = cfg.unload_tip_ram_speed|float %}
              {% set TIP_SR_MM_S = cfg.unload_tip_short_retract_speed|float %}

              # Backwards compatibility for legacy feedrate values
              {% if TIP_PRIME_MM_S > 100 %}{% set TIP_PRIME_MM_S = TIP_PRIME_MM_S / 60.0 %}{% endif %}
              {% if TIP_QR_MM_S > 100 %}{% set TIP_QR_MM_S = TIP_QR_MM_S / 60.0 %}{% endif %}
              {% if TIP_RAM_MM_S > 100 %}{% set TIP_RAM_MM_S = TIP_RAM_MM_S / 60.0 %}{% endif %}
              {% if TIP_SR_MM_S > 100 %}{% set TIP_SR_MM_S = TIP_SR_MM_S / 60.0 %}{% endif %}

              G1 E{cfg.unload_tip_prime_length} F{(TIP_PRIME_MM_S * 60.0)|int}      ; Prime
              G1 E-{cfg.unload_tip_quick_retract_length} F{(TIP_QR_MM_S * 60.0)|int}    ; Quick retract
              G1 E{cfg.unload_tip_ram_length} F{(TIP_RAM_MM_S * 60.0)|int}       ; Small push (ram)
              G1 E-{cfg.unload_tip_short_retract_length} F{(TIP_SR_MM_S * 60.0)|int}    ; Short retract
          {% else %}
              # Simple prime only (still tunable)
              {% set TIP_PRIME_MM_S = cfg.unload_tip_prime_speed|float %}
              {% if TIP_PRIME_MM_S > 100 %}
                  {% set TIP_PRIME_MM_S = TIP_PRIME_MM_S / 60.0 %}
              {% endif %}
              G1 E{cfg.unload_tip_prime_length} F{(TIP_PRIME_MM_S * 60.0)|int}
          {% endif %}

          # Main retract
          G1 E-{LENGTH} F{(SPEED_MM_S * 60.0)|int}

          M82  ; Absolute extrusion
          G92 E0

          RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
          M117 Filament unloaded

      # ───────────────────────────────────────────────────────────────────────────────
      # Filament Change (M600)
      # ───────────────────────────────────────────────────────────────────────────────
      [gcode_macro M600]
      description: Filament change (pause print and unload filament)
      gcode:
          {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

          M117 Filament change...

          # Pause print
          PAUSE

          # Set LED to indicate waiting
          {% if cfg.led_enabled %}
          _STATUS_LED STATUS=error
          {% endif %}

          # Unload filament using configured settings
          UNLOAD_FILAMENT

          M117 Load new filament and RESUME

  # Heater calibration helper macros (PID)
  heater_calibration_pid:
    render: raw
    template: |
      [gcode_macro PID_CALIBRATE_EXTRUDER]
      description: Run PID calibration for extruder (TARGET=240 default)
      gcode:
          {% set TARGET = params.TARGET|default(240)|int %}
          M117 PID calibrating extruder...
          ; Ensure fan is on for realistic conditions
          M106 S255
          ; Run PID calibration
          PID_CALIBRATE HEATER=extruder TARGET={TARGET}
          M117 PID calibration complete!
          M118 Run SAVE_CONFIG to save PID values to printer.cfg
          ; Turn off fan
          M106 S0

      [gcode_macro PID_CALIBRATE_BED]
      description: Run PID calibration for heated bed (TARGET=60 default)
      gcode:
          {% set TARGET = params.TARGET|default(60)|int %}
          M117 PID calibrating bed...
          ; Run PID calibration
          PID_CALIBRATE HEATER=heater_bed TARGET={TARGET}
          M117 PID calibration complete!
          M118 Run SAVE_CONFIG to save PID values to printer.cfg

  # MPC calibration (Kalico only)
  heater_calibration_mpc:
    condition: "extruder.control == 'mpc'"
    render: raw
    template: |
      [gcode_macro MPC_CALIBRATE_EXTRUDER]
      description: Run MPC calibration for extruder (Kalico only, TARGET=240 default)
      gcode:
          {% set TARGET = params.TARGET|default(240)|int %}
          M117 MPC calibrating extruder...
          ; Ensure fan is on for realistic conditions
          M106 S255
          ; Run MPC calibration
          MPC_CALIBRATE HEATER=extruder TARGET={TARGET}
          M117 MPC calibration complete!
          M118 Run SAVE_CONFIG to save MPC parameters to printer.cfg
          ; Turn off fan
          M106 S0

  # Stepper identification & calibration macros (kept separate for readability/continuity)
  calibration:
    render: raw
    template: |
      # ═════════════════════════════════════════════════════════════════════════════
      # STEPPER IDENTIFICATION & CALIBRATION MACROS
      # Generated by gschpoozi
      # ═════════════════════════════════════════════════════════════════════════════
      #
      # These macros help you:
      # 1. Identify which physical motor is connected to which driver
      # 2. Verify motor directions are correct
      # 3. For CoreXY AWD: Test motor pairs safely without risk of fighting
      #
      # Reference: https://www.klipper3d.org/Config_checks.html
      #            https://mpx.wiki/Troubleshooting/corexy-direction
      # ═════════════════════════════════════════════════════════════════════════════

      [force_move]
      enable_force_move: True
      # Required for STEPPER_BUZZ and FORCE_MOVE commands

      # ─────────────────────────────────────────────────────────────────────────────
      # TMC DRIVER STATUS
      # ─────────────────────────────────────────────────────────────────────────────

      [gcode_macro QUERY_TMC_STATUS]
      description: Query TMC driver status for all configured steppers
      gcode:
          {% set steppers = printer.motion_report.steppers|default([]) %}
          M118 === TMC Driver Status ===
          {% for stepper in steppers %}
              {% set tmc_name = "tmc2209_" ~ stepper %}
              {% if printer[tmc_name] is defined %}
                  M118 {stepper}: TMC2209 detected
                  DUMP_TMC STEPPER={stepper}
              {% else %}
                  {% set tmc_name = "tmc2240_" ~ stepper %}
                  {% if printer[tmc_name] is defined %}
                      M118 {stepper}: TMC2240 detected
                      DUMP_TMC STEPPER={stepper}
                  {% else %}
                      {% set tmc_name = "tmc5160_" ~ stepper %}
                      {% if printer[tmc_name] is defined %}
                          M118 {stepper}: TMC5160 detected
                          DUMP_TMC STEPPER={stepper}
                      {% endif %}
                  {% endif %}
              {% endif %}
          {% endfor %}
          M118 === End TMC Status ===

      [gcode_macro CHECK_MOTOR_CONNECTED]
      description: Check if a motor appears connected via TMC driver status
      gcode:
          {% set stepper = params.STEPPER|default("stepper_x") %}
          M118 Checking {stepper}...
          DUMP_TMC STEPPER={stepper}
          M118 Look for 'ola' or 'olb' flags - if set, motor may be disconnected

      # ─────────────────────────────────────────────────────────────────────────────
      # INDIVIDUAL STEPPER IDENTIFICATION
      # ─────────────────────────────────────────────────────────────────────────────

      [gcode_macro IDENTIFY_STEPPER]
      description: Buzz a single stepper to identify which physical motor it is
      gcode:
          {% set stepper = params.STEPPER|default("stepper_x") %}
          M118 === Identifying {stepper} ===
          M118 Watch which motor moves (10 short buzzes)
          STEPPER_BUZZ STEPPER={stepper}
          M118 === Done identifying {stepper} ===

      [gcode_macro IDENTIFY_ALL_STEPPERS]
      description: Buzz each stepper one by one with pauses for identification
      gcode:
          M118 === STEPPER IDENTIFICATION SEQUENCE ===
          M118 Each stepper will buzz 10 times. Watch and note which motor moves.
          M118
          M118 Starting in 3 seconds...
          G4 P3000

          M118 >>> STEPPER_X - Watch now...
          STEPPER_BUZZ STEPPER=stepper_x
          G4 P2000

          M118 >>> STEPPER_Y - Watch now...
          STEPPER_BUZZ STEPPER=stepper_y
          G4 P2000

          {% if printer.configfile.config.stepper_x1 is defined %}
          M118 >>> STEPPER_X1 - Watch now...
          STEPPER_BUZZ STEPPER=stepper_x1
          G4 P2000
          {% endif %}

          {% if printer.configfile.config.stepper_y1 is defined %}
          M118 >>> STEPPER_Y1 - Watch now...
          STEPPER_BUZZ STEPPER=stepper_y1
          G4 P2000
          {% endif %}

          M118 >>> STEPPER_Z - Watch now...
          STEPPER_BUZZ STEPPER=stepper_z
          G4 P2000

          {% if printer.configfile.config.stepper_z1 is defined %}
          M118 >>> STEPPER_Z1 - Watch now...
          STEPPER_BUZZ STEPPER=stepper_z1
          G4 P2000
          {% endif %}

          {% if printer.configfile.config.stepper_z2 is defined %}
          M118 >>> STEPPER_Z2 - Watch now...
          STEPPER_BUZZ STEPPER=stepper_z2
          G4 P2000
          {% endif %}

          {% if printer.configfile.config.stepper_z3 is defined %}
          M118 >>> STEPPER_Z3 - Watch now...
          STEPPER_BUZZ STEPPER=stepper_z3
          G4 P2000
          {% endif %}

          M118 >>> EXTRUDER - Watch now...
          STEPPER_BUZZ STEPPER=extruder

          M118 === IDENTIFICATION COMPLETE ===
          M118 Make note of which physical motor corresponds to each stepper name.

      # ─────────────────────────────────────────────────────────────────────────────
      # COREXY AWD SAFE PAIR TESTING
      # Test one motor pair at a time to prevent motors from fighting
      # ─────────────────────────────────────────────────────────────────────────────

      [gcode_macro AWD_TEST_PAIR_A]
      description: Test first motor pair (X+Y) with second pair (X1+Y1) disabled
      gcode:
          {% set distance = params.DISTANCE|default(20)|float %}
          {% set speed = params.SPEED|default(50)|float %}

          M118 ════════════════════════════════════════════════════════════
          M118 AWD PAIR A TEST (stepper_x + stepper_y)
          M118 ════════════════════════════════════════════════════════════
          M118 This test moves ONLY stepper_x and stepper_y.
          M118 stepper_x1 and stepper_y1 are DISABLED.
          M118 The toolhead should move in a square pattern.

          # Disable second pair
          {% if printer.configfile.config.stepper_x1 is defined %}
              SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=0
          {% endif %}
          {% if printer.configfile.config.stepper_y1 is defined %}
              SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=0
          {% endif %}

          # Enable first pair
          SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
          SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1

          M118 Moving +X...
          FORCE_MOVE STEPPER=stepper_x DISTANCE={distance} VELOCITY={speed}
          FORCE_MOVE STEPPER=stepper_y DISTANCE={distance} VELOCITY={speed}
          G4 P500

          M118 Moving +Y...
          FORCE_MOVE STEPPER=stepper_x DISTANCE={distance} VELOCITY={speed}
          FORCE_MOVE STEPPER=stepper_y DISTANCE={-distance} VELOCITY={speed}
          G4 P500

          M118 Moving -X...
          FORCE_MOVE STEPPER=stepper_x DISTANCE={-distance} VELOCITY={speed}
          FORCE_MOVE STEPPER=stepper_y DISTANCE={-distance} VELOCITY={speed}
          G4 P500

          M118 Moving -Y (back to start)...
          FORCE_MOVE STEPPER=stepper_x DISTANCE={-distance} VELOCITY={speed}
          FORCE_MOVE STEPPER=stepper_y DISTANCE={distance} VELOCITY={speed}

          M118 PAIR A TEST COMPLETE
          M118 Did the toolhead move in a correct square pattern?

      [gcode_macro AWD_TEST_PAIR_B]
      description: Test second motor pair (X1+Y1) with first pair (X+Y) disabled
      gcode:
          {% set distance = params.DISTANCE|default(20)|float %}
          {% set speed = params.SPEED|default(50)|float %}

          {% if printer.configfile.config.stepper_x1 is not defined or printer.configfile.config.stepper_y1 is not defined %}
              M118 ERROR: AWD_TEST_PAIR_B requires AWD configuration (stepper_x1 and stepper_y1)
              M118 This macro is only for All Wheel Drive printers.
          {% else %}
              M118 ════════════════════════════════════════════════════════════
              M118 AWD PAIR B TEST (stepper_x1 + stepper_y1)
              M118 ════════════════════════════════════════════════════════════
              M118 This test moves ONLY stepper_x1 and stepper_y1.
              M118 stepper_x and stepper_y are DISABLED.
              M118 Should move in the SAME pattern as Pair A.

              # Disable first pair
              SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0
              SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0

              # Enable second pair
              SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
              SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1

              M118 Moving +X...
              FORCE_MOVE STEPPER=stepper_x1 DISTANCE={distance} VELOCITY={speed}
              FORCE_MOVE STEPPER=stepper_y1 DISTANCE={distance} VELOCITY={speed}
              G4 P500

              M118 Moving +Y...
              FORCE_MOVE STEPPER=stepper_x1 DISTANCE={distance} VELOCITY={speed}
              FORCE_MOVE STEPPER=stepper_y1 DISTANCE={-distance} VELOCITY={speed}
              G4 P500

              M118 Moving -X...
              FORCE_MOVE STEPPER=stepper_x1 DISTANCE={-distance} VELOCITY={speed}
              FORCE_MOVE STEPPER=stepper_y1 DISTANCE={-distance} VELOCITY={speed}
              G4 P500

              M118 Moving -Y (back to start)...
              FORCE_MOVE STEPPER=stepper_x1 DISTANCE={-distance} VELOCITY={speed}
              FORCE_MOVE STEPPER=stepper_y1 DISTANCE={distance} VELOCITY={speed}

              M118 PAIR B TEST COMPLETE
              M118 Did it move the SAME as Pair A?
          {% endif %}

      [gcode_macro AWD_ENABLE_ALL]
      description: Re-enable all AWD motors after testing
      gcode:
          M118 Re-enabling all motors...
          SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
          SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
          {% if printer.configfile.config.stepper_x1 is defined %}
              SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
          {% endif %}
          {% if printer.configfile.config.stepper_y1 is defined %}
              SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1
          {% endif %}
          M118 All motors enabled.

      [gcode_macro AWD_FULL_TEST]
      description: Run complete AWD motor pair verification sequence
      gcode:
          {% set distance = params.DISTANCE|default(20)|float %}

          M118 ════════════════════════════════════════════════════════════════════
          M118 COREXY AWD FULL CALIBRATION SEQUENCE
          M118 ════════════════════════════════════════════════════════════════════
          M118 Testing each motor pair separately for safety.
          M118 If anything looks wrong, use EMERGENCY STOP (M112)!
          M118 Starting Pair A test in 5 seconds...
          G4 P5000

          AWD_TEST_PAIR_A DISTANCE={distance}

          M118 Pausing 5 seconds before Pair B test...
          G4 P5000

          AWD_TEST_PAIR_B DISTANCE={distance}

          AWD_ENABLE_ALL

          M118 ════════════════════════════════════════════════════════════════════
          M118 AWD CALIBRATION COMPLETE
          M118 ════════════════════════════════════════════════════════════════════
          M118 If both pairs moved identically: AWD is correctly configured!
          M118 If not, see: https://mpx.wiki/Troubleshooting/corexy-direction

      # ─────────────────────────────────────────────────────────────────────────────
      # CALIBRATION WIZARD
      # ─────────────────────────────────────────────────────────────────────────────

      [gcode_macro STEPPER_CALIBRATION_WIZARD]
      description: Display stepper calibration instructions
      gcode:
          M118 ════════════════════════════════════════════════════════════════════
          M118 STEPPER CALIBRATION WIZARD
          M118 ════════════════════════════════════════════════════════════════════
          M118
          M118 STEP 1: MOTOR IDENTIFICATION
          M118 Run: IDENTIFY_ALL_STEPPERS
          M118 Watch each motor and note which one corresponds to each name.
          M118
          M118 STEP 2: TMC STATUS CHECK
          M118 Run: QUERY_TMC_STATUS
          M118 Verify all drivers communicate properly.
          M118
          M118 STEP 3: DIRECTION VERIFICATION
          M118 Run: AWD_FULL_TEST
          M118 Tests each motor pair separately for safety.
          M118
          M118 ════════════════════════════════════════════════════════════════════
          M118 References:
          M118   https://www.klipper3d.org/Config_checks.html
          M118   https://mpx.wiki/Troubleshooting/corexy-direction
          M118 ════════════════════════════════════════════════════════════════════

      # ─────────────────────────────────────────────────────────────────────────────
      # INPUT SHAPER CALIBRATION MACROS
      # Lightweight alternative to Shake&Tune
      # ─────────────────────────────────────────────────────────────────────────────

      [gcode_macro CALIBRATE_SHAPER]
      description: Run input shaper calibration for X, Y, or both axes
      gcode:
          {% set axis = params.AXIS|default('both')|lower %}
          {% set accel = params.ACCEL|default(5000)|int %}

          M118 ════════════════════════════════════════════════════════════════════
          M118 INPUT SHAPER CALIBRATION
          M118 ════════════════════════════════════════════════════════════════════

          # Home if not already homed
          {% if "xyz" not in printer.toolhead.homed_axes %}
              M118 Homing first...
              G28
          {% endif %}

          {% if axis == 'x' or axis == 'both' %}
              M118 Testing X axis resonances...
              TEST_RESONANCES AXIS=X
              M118 Generating X axis graph...
              RUN_SHELL_COMMAND CMD=shaper_graph_x
          {% endif %}

          {% if axis == 'y' or axis == 'both' %}
              M118 Testing Y axis resonances...
              TEST_RESONANCES AXIS=Y
              M118 Generating Y axis graph...
              RUN_SHELL_COMMAND CMD=shaper_graph_y
          {% endif %}

          M118 ════════════════════════════════════════════════════════════════════
          M118 CALIBRATION COMPLETE
          M118 ════════════════════════════════════════════════════════════════════
          M118 View graphs in Mainsail/Fluidd: config/plots/
          M118 To apply recommendations, run: APPLY_SHAPER

      [gcode_macro COMPARE_BELTS]
      description: Compare belt tensions (CoreXY). Run resonance tests and generate comparison graph.
      gcode:
          M118 ════════════════════════════════════════════════════════════════════
          M118 BELT TENSION COMPARISON (CoreXY)
          M118 ════════════════════════════════════════════════════════════════════

          # Home if not already homed
          {% if "xyz" not in printer.toolhead.homed_axes %}
              M118 Homing first...
              G28
          {% endif %}

          M118 Testing X axis (Belt A+B)...
          TEST_RESONANCES AXIS=X

          M118 Testing Y axis (Belt A-B)...
          TEST_RESONANCES AXIS=Y

          M118 Generating belt comparison graph...
          RUN_SHELL_COMMAND CMD=shaper_graph_belts

          M118 ════════════════════════════════════════════════════════════════════
          M118 BELT COMPARISON COMPLETE
          M118 ════════════════════════════════════════════════════════════════════
          M118 View graph in Mainsail/Fluidd: config/plots/belt_comparison.png
          M118
          M118 For CoreXY with uneven belt tension:
          M118 - Tighten the belt on the axis with LOWER frequency
          M118 - Target: < 3 Hz difference between X and Y peaks

      [gcode_macro APPLY_SHAPER]
      description: Apply input shaper recommendations from last calibration
      gcode:
          {% set axis = params.AXIS|default('both')|lower %}

          M118 ════════════════════════════════════════════════════════════════════
          M118 APPLY INPUT SHAPER SETTINGS
          M118 ════════════════════════════════════════════════════════════════════
          M118
          M118 NOTE: This macro shows recommended settings.
          M118 To permanently apply them, use Mainsail/Fluidd console:
          M118
          M118   SAVE_CONFIG
          M118
          M118 Or manually edit printer.cfg [input_shaper] section.
          M118
          M118 View recommendations: config/plots/shaper_recommendations.json
          M118 ════════════════════════════════════════════════════════════════════

      [gcode_macro SHAPER_CALIBRATION_WIZARD]
      description: Display input shaper calibration instructions
      gcode:
          M118 ════════════════════════════════════════════════════════════════════
          M118 INPUT SHAPER CALIBRATION WIZARD
          M118 ════════════════════════════════════════════════════════════════════
          M118
          M118 STEP 1: RUN CALIBRATION
          M118 Run: CALIBRATE_SHAPER
          M118 This tests both X and Y axes and generates graphs.
          M118
          M118 STEP 2: VIEW GRAPHS
          M118 In Mainsail/Fluidd, browse to: config/plots/
          M118 Open shaper_x.png and shaper_y.png
          M118
          M118 STEP 3: CHECK BELT TENSION (CoreXY only)
          M118 Run: COMPARE_BELTS
          M118 Peaks should be within 3 Hz of each other.
          M118
          M118 STEP 4: APPLY SETTINGS
          M118 Edit [input_shaper] in printer.cfg with recommended values.
          M118 Or use: SET_INPUT_SHAPER SHAPER_TYPE_X=... SHAPER_FREQ_X=...
          M118 Then: SAVE_CONFIG
          M118
          M118 ════════════════════════════════════════════════════════════════════

# Multi-pin groups (for fans with multiple pins)
multi_pin:
  condition: "advanced.multi_pins"
  type: "list"
  template: |
    {% for pin_group in advanced.multi_pins %}
    [multi_pin {{ pin_group.name }}]
    pins: {{ pin_group.pins }}

    {% endfor %}

# -----------------------------------------------------------------------------
# Temperature Sensors
# -----------------------------------------------------------------------------
temperature_sensor:
  condition: "temperature_sensors"
  type: "list"
  template: |
    {% for sensor in temperature_sensors %}
    {% if sensor.type == 'temperature_mcu' %}
    [temperature_sensor {{ sensor.name }}]
    sensor_type: temperature_mcu
    sensor_mcu: {{ sensor.mcu | default('mcu') }}
    {% elif sensor.type == 'temperature_host' %}
    [temperature_sensor {{ sensor.name }}]
    sensor_type: temperature_host
    {% elif sensor.type == 'temperature_sensor' %}
    [temperature_sensor {{ sensor.name }}]
    sensor_type: {{ sensor.sensor_type }}
    sensor_pin: {{ sensor.sensor_pin }}
    {% endif %}

    {% endfor %}

# -----------------------------------------------------------------------------
# LEDs
# -----------------------------------------------------------------------------
neopixel:
  condition: "leds"
  type: "list"
  template: |
    {% for led in leds %}
    [neopixel {{ led.name }}]
    {% if led.location == 'toolboard' %}
    pin: toolboard:{{ led.pin }}
    {% else %}
    pin: {{ led.pin }}
    {% endif %}
    chain_count: {{ led.chain_count | default(1) }}
    color_order: {{ led.color_order | default('GRB') }}
    initial_RED: 0.2
    initial_GREEN: 0.2
    initial_BLUE: 0.2

    {% endfor %}

# -----------------------------------------------------------------------------
# Filament Sensors
# -----------------------------------------------------------------------------
filament_switch_sensor:
  condition: "filament_sensors"
  type: "list"
  template: |
    {% for sensor in filament_sensors %}
    {% set _pullup = sensor.pin_pullup | default(true) %}
    {% set _pulldown = sensor.pin_pulldown | default(false) %}
    {% set _invert = sensor.pin_invert | default(false) %}
    {% set _mods = ('^' if _pullup else ('~' if _pulldown else '')) ~ ('!' if _invert else '') %}
    {% if sensor.type == 'switch' %}
    [filament_switch_sensor {{ sensor.name }}]
    {% if sensor.location == 'toolboard' %}
    switch_pin: {{ _mods }}toolboard:{{ sensor.pin }}
    {% else %}
    switch_pin: {{ _mods }}{{ sensor.pin }}
    {% endif %}
    pause_on_runout: {{ sensor.pause_on_runout | default(true) | lower }}
    runout_gcode:
        M117 Filament runout detected!
        PAUSE
    {% elif sensor.type == 'motion' %}
    [filament_motion_sensor {{ sensor.name }}]
    {% if sensor.location == 'toolboard' %}
    switch_pin: {{ _mods }}toolboard:{{ sensor.pin }}
    {% else %}
    switch_pin: {{ _mods }}{{ sensor.pin }}
    {% endif %}
    detection_length: {{ sensor.detection_length | default(7.0) }}
    extruder: extruder
    pause_on_runout: {{ sensor.pause_on_runout | default(true) | lower }}
    runout_gcode:
        M117 Filament runout detected!
        PAUSE
    {% endif %}

    {% endfor %}

# -----------------------------------------------------------------------------
# Pin Configuration Mappings (DEPRECATED - now handled in Python by _resolve_pins())
# Kept for backward compatibility with custom templates
# -----------------------------------------------------------------------------
pin_config:
  nc_gnd: "^"      # NC switch to GND (pull-up)
  no_gnd: "^!"     # NO switch to GND (pull-up + invert)
  nc_vcc: "!"      # NC switch to VCC (invert)
  no_vcc: ""       # NO switch to VCC (no modifiers)
