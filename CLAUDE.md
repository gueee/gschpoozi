# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**gschpoozi** is a wizard-based Klipper configuration generator for 3D printers. It generates clean, modular config files without requiring manual editing - a simpler alternative to Klippain.

**Stack:** Bash (main wizard), Python (hardware setup/config generation), JSON (templates), Klipper INI-style configs

## Key Commands

```bash
# Run the interactive wizard
~/gschpoozi/scripts/configure.sh

# Hardware port assignment
~/gschpoozi/scripts/setup-hardware.py [--board|--toolboard|--list-boards]

# Generate config files
~/gschpoozi/scripts/generate-config.py --output-dir ~/printer_data/config/gschpoozi

# Validation (run before commits affecting .cfg files)
bash .cursor/scripts/validate-config.sh path/to/config.cfg
python3 .cursor/scripts/validate-thermal.py path/to/config.cfg
python3 .cursor/scripts/validate-movement.py path/to/config.cfg
bash .cursor/scripts/validate-pins.sh path/to/config.cfg
```

## Architecture

```
User → [configure.sh] → [setup-hardware.py] → [generate-config.py] → Output configs
           ↓                    ↓                      ↓
    .wizard-state      .hardware-state.json      templates/*.json
```

- **configure.sh** - KIAUH-style interactive menu, stores selections in state files
- **setup-hardware.py** - Port/pin assignment with conflict detection
- **generate-config.py** - Merges templates to produce Klipper configs
- **templates/** - JSON definitions for boards (28), toolboards (17), probes (9), extruders, kinematics

**Output structure:**
```
~/printer_data/config/
├── printer.cfg           # User's file (includes + overrides)
└── gschpoozi/            # Generated by wizard
    ├── hardware.cfg
    ├── macros.cfg
    └── homing.cfg
```

## Critical Klipper Syntax Rules

**COLON not EQUALS** - Klipper uses `:` for all parameters:
```ini
# CORRECT
step_pin: PE9
microsteps: 16

# WRONG - will break Klipper
step_pin = PE9
```

**Pin modifiers:** `^` for pullup, `!` for invert (e.g., `^!PA4`)

**Gcode macros use Jinja2** (not Python):
```ini
gcode:
    {% set temp = params.TEMP|default(200)|float %}
    {% if printer.toolhead.homed_axes != "xyz" %}
        G28
    {% endif %}
```

**Section names are lowercase** with underscores: `[stepper_x]`, `[filament_switch_sensor e0_sensor]`

**Multi-line gcode must be indented** (4 spaces or tab)

## Safety-Critical Rules

This is hardware-critical code - bad configs can damage printers or cause fires.

### Never:
- Set `max_temp` above hardware specifications
- Set `min_temp` below 0 (disables sensor failure detection)
- Set `position_max` beyond physical travel limits
- Create duplicate pin assignments
- Modify working configs without explicit permission
- Skip validation before committing config changes

### Temperature limits (typical safe values):
- Extruder max_temp: 300 (all-metal) / 260 (PTFE)
- Bed max_temp: 120-130

### Always:
- Run validation scripts before committing .cfg changes
- Test on dev printer before production deployment
- Include rollback plan for config changes
- Verify parameters exist in [Klipper Config Reference](https://www.klipper3d.org/Config_Reference.html)

## Development Guidelines

1. **Working code is sacred** - never modify without explicit permission
2. **No redundant functions** - check for existing implementations first
3. **User configs are user data** - never overwrite without backup
4. **Ask, don't assume** - clarify requirements before coding
5. **All changes must be reversible** - document rollback procedures

When proposing changes, include: affected files, specific changes with reasoning, testing plan, rollback plan, and assumptions.

## DIY Flexibility Principle

**3D printing is driven by a DIY community - always maximize user flexibility.**

- **Port assignments are suggestions, not rules** - Users can connect anything to any port. Manufacturer "default" assignments are guidelines only.
- **Never force hardware location** - When a toolboard exists, don't assume hotend/thermistor/endstops MUST be on the toolboard. Always offer BOTH mainboard AND toolboard options.
- **No artificial restrictions** - If hardware physically supports a configuration, the wizard should allow it.
- **Trust the user** - They know their printer better than we do. Provide warnings for unusual configs, but don't block them.
