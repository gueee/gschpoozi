# ═════════════════════════════════════════════════════════════════════════════
# MACROS
# Generated by gschpoozi - 2025-12-13 06:05
# ═════════════════════════════════════════════════════════════════════════════
#
# These macros use variables from macros-config.cfg
# Edit macros-config.cfg to customize behavior.
#
# Slicer start G-code:
#   START_PRINT BED=60 EXTRUDER=200
#   START_PRINT BED=110 EXTRUDER=250 CHAMBER=50 MATERIAL=ABS
#
# Slicer end G-code:
#   END_PRINT
# ═════════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────
# MAINSAIL / FLUIDD REQUIRED SECTIONS
# ─────────────────────────────────────────────────────────────────────────────
[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[display_status]
# Required for M117 messages and print status

[pause_resume]
# Required for PAUSE/RESUME functionality

[exclude_object]
# Required for object cancellation in Mainsail/Fluidd

[respond]
# Required for M118 messages

# ═══════════════════════════════════════════════════════════════════════════════
# START_PRINT
# ═══════════════════════════════════════════════════════════════════════════════

[gcode_macro START_PRINT]
description: Complete print start sequence with heating, leveling, meshing, and purging
gcode:
    # ───────────────────────────────────────────────────────────────────────────
    # Parse parameters (with defaults from config)
    # ───────────────────────────────────────────────────────────────────────────
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

    {% set BED_TEMP = params.BED|default(60)|int %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(200)|int %}
    {% set CHAMBER_TEMP = params.CHAMBER|default(cfg.chamber_temp_default)|int %}
    {% set MATERIAL = params.MATERIAL|default("PLA")|upper %}
    {% set MESH_MODE = params.MESH|default(cfg.bed_mesh_mode)|lower %}
    {% set PURGE_STYLE = params.PURGE|default(cfg.purge_style)|lower %}

    # Preheat extruder to safe probing temp (prevents ooze during mesh)
    {% set EXTRUDER_PREHEAT = 150 %}

    # ───────────────────────────────────────────────────────────────────────────
    # Phase 1: Start heating and home
    # ───────────────────────────────────────────────────────────────────────────
    M117 Heating bed...
    {% if cfg.led_enabled %}
    _STATUS_LED STATUS=heating
    {% endif %}

    # Start bed heating (don't wait yet)
    M140 S{BED_TEMP}

    # Preheat extruder to prevent cold ooze (don't wait)
    M104 S{EXTRUDER_PREHEAT}

    # Home if needed
    _HOME_IF_NEEDED

    # ───────────────────────────────────────────────────────────────────────────
    # Phase 2: Wait for bed and optional heat soak
    # ───────────────────────────────────────────────────────────────────────────
    M117 Waiting for bed...
    M190 S{BED_TEMP}

    {% if cfg.heat_soak_time > 0 %}
    _HEAT_SOAK MINUTES={cfg.heat_soak_time}
    {% endif %}

    # ───────────────────────────────────────────────────────────────────────────
    # Phase 3: Chamber heating (if configured)
    # ───────────────────────────────────────────────────────────────────────────
    {% if CHAMBER_TEMP > 0 %}
    _CHAMBER_WAIT TEMP={CHAMBER_TEMP}
    {% endif %}

    # ───────────────────────────────────────────────────────────────────────────
    # Phase 4: Bed leveling
    # ───────────────────────────────────────────────────────────────────────────
    {% if cfg.led_enabled %}
    _STATUS_LED STATUS=leveling
    {% endif %}

    {% if cfg.leveling_enabled %}
    M117 Leveling bed...
    _LEVEL_BED
    {% endif %}

    # ───────────────────────────────────────────────────────────────────────────
    # Phase 5: Bed mesh
    # ───────────────────────────────────────────────────────────────────────────
    {% if cfg.led_enabled %}
    _STATUS_LED STATUS=meshing
    {% endif %}

    {% if MESH_MODE != "none" %}
    M117 Bed mesh...
    _BED_MESH MODE={MESH_MODE}
    {% endif %}

    # ───────────────────────────────────────────────────────────────────────────
    # Phase 6: Heat extruder to print temperature
    # ───────────────────────────────────────────────────────────────────────────
    {% if cfg.led_enabled %}
    _STATUS_LED STATUS=heating
    {% endif %}

    M117 Heating extruder...
    M109 S{EXTRUDER_TEMP}

    # ───────────────────────────────────────────────────────────────────────────
    # Phase 7: Nozzle cleaning (if enabled)
    # ───────────────────────────────────────────────────────────────────────────
    {% if cfg.brush_enabled %}
    M117 Cleaning nozzle...
    _CLEAN_NOZZLE
    {% endif %}

    # ───────────────────────────────────────────────────────────────────────────
    # Phase 8: Purge
    # ───────────────────────────────────────────────────────────────────────────
    {% if PURGE_STYLE != "none" %}
    M117 Purging...
    _PURGE STYLE={PURGE_STYLE}
    {% endif %}

    # ───────────────────────────────────────────────────────────────────────────
    # Phase 9: Ready to print
    # ───────────────────────────────────────────────────────────────────────────
    {% if cfg.led_enabled %}
    _STATUS_LED STATUS=printing
    {% endif %}

    M117 Printing...
    G92 E0  ; Reset extruder
    G90     ; Absolute positioning

# ═══════════════════════════════════════════════════════════════════════════════
# END_PRINT
# ═══════════════════════════════════════════════════════════════════════════════

[gcode_macro END_PRINT]
description: Complete print end sequence with retraction, parking, and cooldown
gcode:
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
    {% set PARK_POS = params.PARK|default(cfg.park_position)|lower %}

    # Turn off heaters first (they take longest to cool)
    {% if cfg.turn_off_extruder %}
    M104 S0
    {% endif %}

    {% if cfg.turn_off_bed %}
    M140 S0
    {% endif %}

    # Retract filament
    _END_RETRACT

    # Park toolhead
    _PARK POSITION={PARK_POS}

    # Fan management
    {% if cfg.turn_off_fans %}
        {% if cfg.fan_off_delay > 0 %}
        UPDATE_DELAYED_GCODE ID=_DELAYED_FAN_OFF DURATION={cfg.fan_off_delay}
        {% else %}
        M106 S0
        {% endif %}
    {% endif %}

    # Status LED
    {% if cfg.led_enabled %}
    _STATUS_LED STATUS=complete
    {% endif %}

    # Disable motors (delayed if configured)
    {% if cfg.motor_off_delay > 0 %}
    UPDATE_DELAYED_GCODE ID=_DELAYED_MOTOR_OFF DURATION={cfg.motor_off_delay}
    {% else %}
    M84
    {% endif %}

    M117 Print complete!

# ═══════════════════════════════════════════════════════════════════════════════
# BUILDING BLOCK MACROS
# ═══════════════════════════════════════════════════════════════════════════════

[gcode_macro _HOME_IF_NEEDED]
description: Home axes only if not already homed
gcode:
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

    {% if cfg.led_enabled %}
    _STATUS_LED STATUS=homing
    {% endif %}

    M117 Homing...

    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% else %}
        {% if cfg.always_home_z %}
        G28 Z
        {% endif %}
    {% endif %}

[gcode_macro _HEAT_SOAK]
description: Wait for bed temperature to stabilize
gcode:
    {% set MINUTES = params.MINUTES|default(0)|int %}
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

    {% if MINUTES > 0 %}
        M117 Heat soak {MINUTES}min...
        G0 X{cfg.bed_center_x} Y{cfg.bed_center_y} Z30 F6000

        {% for i in range(MINUTES) %}
            M117 Heat soak {MINUTES - i}min remaining...
            G4 P60000
        {% endfor %}
    {% endif %}

[gcode_macro _CHAMBER_WAIT]
description: Wait for chamber to reach target temperature
gcode:
    {% set TEMP = params.TEMP|default(0)|int %}

    {% if TEMP > 0 %}
        M117 Chamber heating to {TEMP}C...

        {% if printer["temperature_sensor chamber"] is defined %}
            TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={TEMP}
        {% elif printer["temperature_fan chamber"] is defined %}
            SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET={TEMP}
            TEMPERATURE_WAIT SENSOR="temperature_fan chamber" MINIMUM={TEMP}
        {% else %}
            M117 No chamber sensor found
        {% endif %}
    {% endif %}

[gcode_macro _LEVEL_BED]
description: Level bed using QGL or Z_TILT based on configuration
gcode:
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

    {% if cfg.leveling_method == "quad_gantry_level" %}
        {% if printer.quad_gantry_level.applied|lower == 'false' %}
            QUAD_GANTRY_LEVEL
        {% endif %}
    {% elif cfg.leveling_method == "z_tilt" %}
        {% if printer.z_tilt.applied|lower == 'false' %}
            Z_TILT_ADJUST
        {% endif %}
    {% endif %}

    G28 Z

[gcode_macro _BED_MESH]
description: Generate or load bed mesh
gcode:
    {% set MODE = params.MODE|default("adaptive")|lower %}
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

    {% if MODE == "none" %}
        # Skip mesh
        M117 Skipping mesh
    {% elif MODE == "saved" %}
        # Load saved profile
        BED_MESH_PROFILE LOAD=default
    {% elif MODE == "adaptive" %}
        # Adaptive mesh - mesh only print area
        # Requires PRINT_MIN/PRINT_MAX from slicer or uses full bed
        {% if params.PRINT_MIN is defined and params.PRINT_MAX is defined %}
            BED_MESH_CALIBRATE MESH_MIN={params.PRINT_MIN} MESH_MAX={params.PRINT_MAX}
        {% else %}
            # Fall back to rapid scan for eddy probes or standard adaptive mesh
            {% if cfg.probe_type in ["beacon", "cartographer", "btt_eddy"] %}
                # Eddy probes: use METHOD=rapid_scan (cannot combine with ADAPTIVE=1)
                BED_MESH_CALIBRATE METHOD=rapid_scan
            {% else %}
                # Non-eddy probes: use ADAPTIVE=1
                BED_MESH_CALIBRATE ADAPTIVE=1
            {% endif %}
        {% endif %}
    {% else %}
        # Full mesh
        {% if cfg.probe_type in ["beacon", "cartographer", "btt_eddy"] %}
            BED_MESH_CALIBRATE METHOD=rapid_scan
        {% else %}
            BED_MESH_CALIBRATE
        {% endif %}
    {% endif %}

[gcode_macro _CLEAN_NOZZLE]
description: Clean nozzle at brush station
gcode:
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
    {% set WIPES = params.WIPES|default(cfg.wipe_count)|int %}

    {% if cfg.brush_enabled %}
        G0 Z{cfg.brush_z + 5} F3000
        G0 X{cfg.brush_x} Y{cfg.brush_y} F6000
        G0 Z{cfg.brush_z} F1000

        {% for i in range(WIPES) %}
            G0 X{cfg.brush_x + cfg.brush_width} F3000
            G0 X{cfg.brush_x} F3000
        {% endfor %}

        G0 Z{cfg.brush_z + 5} F3000
    {% endif %}

[gcode_macro _PURGE]
description: Purge filament before printing
gcode:
    {% set STYLE = params.STYLE|default("line")|lower %}
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
    {% set AMOUNT = params.AMOUNT|default(cfg.purge_amount)|float %}

    {% if STYLE == "none" %}
        # Skip purge
    {% elif STYLE == "blob" %}
        _PURGE_BLOB AMOUNT={AMOUNT}
    {% elif STYLE == "adaptive" %}
        _PURGE_ADAPTIVE AMOUNT={AMOUNT}
    {% else %}
        _PURGE_LINE AMOUNT={AMOUNT}
    {% endif %}

[gcode_macro _PURGE_LINE]
description: Simple line purge along bed edge
gcode:
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
    {% set AMOUNT = params.AMOUNT|default(cfg.purge_amount)|float %}
    {% set LINE_LENGTH = [AMOUNT * 3, 292]|min %}
    {% set START_X = cfg.purge_x %}
    {% set START_Y = cfg.purge_y %}

    G92 E0
    G0 Z5 F3000
    G0 X{START_X} Y{START_Y} F6000
    G0 Z0.3 F1000
    G1 Y{START_Y + LINE_LENGTH} E{AMOUNT} F1500
    G1 E-0.5 F3000
    G0 Z2 F3000
    G0 X{START_X + 5} F6000
    G92 E0

[gcode_macro _PURGE_BLOB]
description: Purge blob into bucket
gcode:
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
    {% set AMOUNT = params.AMOUNT|default(cfg.purge_amount)|float %}

    G0 Z10 F3000
    G0 X{cfg.bucket_x} Y{cfg.bucket_y} F6000
    G0 Z{cfg.bucket_z} F1000
    G92 E0
    G1 E{AMOUNT} F150
    G1 E-2 F3000
    G4 P1000
    G0 Z{cfg.bucket_z + 10} F3000
    G92 E0

[gcode_macro _PURGE_ADAPTIVE]
description: Adaptive purge near print area
gcode:
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
    {% set AMOUNT = params.AMOUNT|default(cfg.purge_amount)|float %}

    # Fall back to line purge (adaptive requires slicer print bounds)
    _PURGE_LINE AMOUNT={AMOUNT}

[gcode_macro _END_RETRACT]
description: Retract filament at end of print
gcode:
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

    M83
    G1 E-{cfg.end_retract_length} F{cfg.end_retract_speed * 60}
    M82
    G92 E0

[gcode_macro _PARK]
description: Park toolhead at specified position
gcode:
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
    {% set POSITION = params.POSITION|default(cfg.park_position)|lower %}

    {% set current_z = printer.toolhead.position.z %}
    {% set z_max = printer.toolhead.axis_maximum.z %}
    # Park Z logic:
    # - Always Z-hop up from current position
    # - Never move Z downward while parking
    # - Respect park_z_max as an upper cap (also capped to z_max-5)
    {% set target_z = current_z + cfg.park_z_hop %}
    {% set cap_z = z_max - 5 %}
    {% if cfg.park_z_max is defined and (cfg.park_z_max|float) > 0 %}
        {% set cap_z = [cap_z, cfg.park_z_max]|min %}
    {% endif %}
    {% set park_z = [target_z, cap_z]|min %}
    {% set park_z = [park_z, current_z]|max %}

    {% set bed_x = cfg.bed_size_x %}
    {% set bed_y = cfg.bed_size_y %}

    {% if POSITION == "front" %}
        {% set park_x = bed_x / 2 %}
        {% set park_y = 10 %}
    {% elif POSITION == "back" %}
        {% set park_x = bed_x / 2 %}
        {% set park_y = bed_y - 10 %}
    {% elif POSITION == "center" %}
        {% set park_x = bed_x / 2 %}
        {% set park_y = bed_y / 2 %}
    {% elif POSITION == "front_left" %}
        {% set park_x = 10 %}
        {% set park_y = 10 %}
    {% elif POSITION == "front_right" %}
        {% set park_x = bed_x - 10 %}
        {% set park_y = 10 %}
    {% elif POSITION == "back_left" %}
        {% set park_x = 10 %}
        {% set park_y = bed_y - 10 %}
    {% elif POSITION == "back_right" %}
        {% set park_x = bed_x - 10 %}
        {% set park_y = bed_y - 10 %}
    {% else %}
        {% set park_x = bed_x / 2 %}
        {% set park_y = 10 %}
    {% endif %}

    G90
    G0 Z{park_z} F3000
    G0 X{park_x} Y{park_y} F6000

[gcode_macro _STATUS_LED]
description: Update LED status color
gcode:
    {% set STATUS = params.STATUS|default("ready")|lower %}
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

    {% if cfg.led_enabled %}
        {% set colors = {
            "heating":  {"r": 1.0, "g": 0.2, "b": 0.0},
            "homing":   {"r": 0.0, "g": 0.5, "b": 1.0},
            "leveling": {"r": 0.5, "g": 0.0, "b": 1.0},
            "meshing":  {"r": 0.0, "g": 1.0, "b": 0.5},
            "printing": {"r": 1.0, "g": 1.0, "b": 1.0},
            "complete": {"r": 0.0, "g": 1.0, "b": 0.0},
            "error":    {"r": 1.0, "g": 0.0, "b": 0.0},
            "ready":    {"r": 0.2, "g": 0.2, "b": 0.2}
        } %}

        {% set c = colors[STATUS] if STATUS in colors else colors["ready"] %}
        SET_LED LED={cfg.led_name} RED={c.r} GREEN={c.g} BLUE={c.b}
    {% endif %}

[delayed_gcode _DELAYED_FAN_OFF]
gcode:
    M106 S0

[delayed_gcode _DELAYED_MOTOR_OFF]
gcode:
    M84

# ═══════════════════════════════════════════════════════════════════════════════
# UTILITY MACROS
# ═══════════════════════════════════════════════════════════════════════════════

[gcode_macro CANCEL_PRINT]
description: Cancel the running print
rename_existing: CANCEL_PRINT_BASE
gcode:
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

    M104 S0
    M140 S0
    _END_RETRACT
    _PARK POSITION={cfg.park_position}
    M106 S0

    {% if cfg.led_enabled %}
    _STATUS_LED STATUS=error
    {% endif %}

    CANCEL_PRINT_BASE
    M117 Print cancelled

[gcode_macro PAUSE]
description: Pause the running print
rename_existing: PAUSE_BASE
variable_extrude: 1.0
gcode:
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}

    SAVE_GCODE_STATE NAME=PAUSE_state
    M83
    G1 E-{E} F2100
    _PARK POSITION={cfg.park_position}
    PAUSE_BASE
    M117 Print paused

[gcode_macro RESUME]
description: Resume the paused print
rename_existing: RESUME_BASE
gcode:
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}

    M83
    G1 E{E} F2100
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED=100
    RESUME_BASE
    M117 Printing...

[gcode_macro M600]
description: Filament change
gcode:
    {% set cfg = printer["gcode_macro _MACRO_CONFIG"] %}

    M117 Filament change...
    PAUSE

    {% if cfg.led_enabled %}
    _STATUS_LED STATUS=error
    {% endif %}

    M83
    G1 E-50 F1800
    M117 Load new filament and RESUME

[gcode_macro LOAD_FILAMENT]
description: Load filament into the extruder
gcode:
    {% set TEMP = params.TEMP|default(220)|float %}
    {% set LENGTH = params.LENGTH|default(100)|float %}

    M109 S{TEMP}
    M83
    G1 E{LENGTH} F300
    M82
    M104 S0

[gcode_macro UNLOAD_FILAMENT]
description: Unload filament from the extruder
gcode:
    {% set TEMP = params.TEMP|default(220)|float %}
    {% set LENGTH = params.LENGTH|default(100)|float %}

    M109 S{TEMP}
    M83
    G1 E10 F300
    G1 E-{LENGTH} F1800
    M82
    M104 S0
