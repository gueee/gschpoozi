{
  "$schema": "./skeleton.schema.json",
  "version": "3.0.0",
  "metadata": {
    "name": "gschpoozi",
    "description": "Klipper Configuration Wizard",
    "author": "gschpoozi team"
  },

  "field_types": {
    "text": {
      "description": "Free text input",
      "ui_widget": "inputbox"
    },
    "int": {
      "description": "Integer value",
      "ui_widget": "inputbox",
      "validation": "integer"
    },
    "float": {
      "description": "Decimal value",
      "ui_widget": "inputbox",
      "validation": "number"
    },
    "bool": {
      "description": "Yes/No toggle",
      "ui_widget": "yesno"
    },
    "choice": {
      "description": "Single selection from options list",
      "ui_widget": "radiolist"
    },
    "exclusive_choice": {
      "description": "Single selection from exclusive group",
      "ui_widget": "radiolist"
    },
    "multi_select": {
      "description": "Multiple selections",
      "ui_widget": "checklist"
    },
    "serial_select": {
      "description": "Serial device with auto-detection",
      "ui_widget": "serial_picker"
    },
    "port_select": {
      "description": "Board port selection with conflict detection",
      "ui_widget": "port_picker"
    },
    "board_select": {
      "description": "Board selection from templates",
      "ui_widget": "board_picker"
    }
  },

  "exclusive_groups": {
    "probe_types": {
      "description": "Probe technology - only one can be active",
      "state_key": "probe.probe_type",
      "options": [
        {
          "value": "none",
          "label": "No Probe",
          "klipper_section": null,
          "homing_modes": null,
          "bed_mesh_method": null,
          "requires_serial": false,
          "requires_homing_retract_dist_0": false,
          "safe_z_home_compatible": true,
          "x_offset_fixed": null,
          "y_offset_fixed": null
        },
        {
          "value": "tap",
          "label": "Voron Tap",
          "klipper_section": "[probe]",
          "homing_modes": null,
          "bed_mesh_method": null,
          "requires_serial": false,
          "requires_homing_retract_dist_0": false,
          "safe_z_home_compatible": true,
          "x_offset_fixed": 0,
          "y_offset_fixed": 0,
          "sample_retract_dist": 0
        },
        {
          "value": "klicky",
          "label": "Klicky / Euclid (dockable)",
          "klipper_section": "[probe]",
          "homing_modes": null,
          "bed_mesh_method": null,
          "requires_serial": false,
          "requires_homing_retract_dist_0": false,
          "safe_z_home_compatible": true,
          "x_offset_fixed": null,
          "y_offset_fixed": null
        },
        {
          "value": "bltouch",
          "label": "BLTouch / 3DTouch",
          "klipper_section": "[bltouch]",
          "homing_modes": null,
          "bed_mesh_method": null,
          "requires_serial": false,
          "requires_homing_retract_dist_0": false,
          "safe_z_home_compatible": true,
          "x_offset_fixed": null,
          "y_offset_fixed": null
        },
        {
          "value": "inductive",
          "label": "Inductive Probe (PINDA, SuperPINDA)",
          "klipper_section": "[probe]",
          "homing_modes": null,
          "bed_mesh_method": null,
          "requires_serial": false,
          "requires_homing_retract_dist_0": false,
          "safe_z_home_compatible": true,
          "x_offset_fixed": null,
          "y_offset_fixed": null
        },
        {
          "value": "beacon",
          "label": "Beacon (eddy current)",
          "klipper_section": "[beacon]",
          "plugin_required": "beacon",
          "homing_modes": ["proximity", "contact"],
          "bed_mesh_method": "METHOD=beacon",
          "z_calibrate_method": "BEACON_AUTO_CALIBRATE",
          "requires_serial": true,
          "requires_homing_retract_dist_0": true,
          "safe_z_home_compatible": false,
          "x_offset_fixed": null,
          "y_offset_fixed": null,
          "mode_implications": {
            "contact": {
              "homing.homing_method": "beacon_contact"
            },
            "proximity": {
              "homing.homing_method": "safe_z_home"
            }
          }
        },
        {
          "value": "cartographer",
          "label": "Cartographer (eddy current)",
          "klipper_section": "[scanner]",
          "plugin_required": "cartographer",
          "homing_modes": ["scan", "touch"],
          "bed_mesh_method": null,
          "z_calibrate_method": "CARTOGRAPHER_CALIBRATE",
          "requires_serial": true,
          "requires_homing_retract_dist_0": true,
          "safe_z_home_compatible": false,
          "x_offset_fixed": null,
          "y_offset_fixed": null,
          "mode_implications": {
            "touch": {
              "homing.homing_method": "cartographer_touch"
            },
            "scan": {
              "homing.homing_method": "safe_z_home"
            }
          }
        },
        {
          "value": "btt_eddy",
          "label": "BTT Eddy",
          "klipper_section": "[probe_eddy_current btt_eddy]",
          "homing_modes": ["proximity"],
          "bed_mesh_method": "METHOD=scan SCAN_MODE=rapid",
          "requires_serial": true,
          "requires_homing_retract_dist_0": true,
          "safe_z_home_compatible": true,
          "x_offset_fixed": null,
          "y_offset_fixed": null
        }
      ]
    },

    "leveling_types": {
      "description": "Bed leveling method - determined by Z motor count",
      "state_key": "bed_leveling.leveling_type",
      "options": [
        {
          "value": "none",
          "label": "None (manual leveling)",
          "klipper_section": null,
          "condition": null
        },
        {
          "value": "z_tilt",
          "label": "Z Tilt Adjust",
          "klipper_section": "[z_tilt]",
          "condition": "stepper_z.z_motor_count >= 2 and stepper_z.z_motor_count <= 3"
        },
        {
          "value": "qgl",
          "label": "Quad Gantry Level",
          "klipper_section": "[quad_gantry_level]",
          "condition": "stepper_z.z_motor_count == 4"
        }
      ]
    },

    "endstop_types_xy": {
      "description": "X/Y axis endstop type",
      "options": [
        {
          "value": "physical",
          "label": "Physical switch"
        },
        {
          "value": "sensorless",
          "label": "Sensorless (StallGuard)",
          "requires_driver": ["TMC2209", "TMC2240", "TMC5160"]
        }
      ]
    },

    "endstop_types_z": {
      "description": "Z axis endstop type",
      "options": [
        {
          "value": "probe",
          "label": "Use probe as Z endstop",
          "condition": "probe.probe_type != 'none'"
        },
        {
          "value": "physical_mainboard",
          "label": "Physical switch (mainboard)"
        },
        {
          "value": "physical_toolboard",
          "label": "Physical switch (toolboard)",
          "condition": "mcu.toolboard.enabled"
        },
        {
          "value": "sensorless",
          "label": "Sensorless (StallGuard)",
          "requires_driver": ["TMC2209", "TMC2240", "TMC5160"]
        }
      ]
    },

    "homing_methods": {
      "description": "Z homing method - auto-selected based on probe",
      "state_key": "homing.homing_method",
      "options": [
        {
          "value": "safe_z_home",
          "label": "Safe Z Home (standard)",
          "klipper_section": "[safe_z_home]",
          "condition": "probe.probe_type not in ['beacon', 'cartographer'] or (probe.probe_type == 'beacon' and probe.homing_mode == 'proximity') or (probe.probe_type == 'cartographer' and probe.homing_mode == 'scan')"
        },
        {
          "value": "beacon_contact",
          "label": "Beacon Contact Homing",
          "klipper_section": null,
          "condition": "probe.probe_type == 'beacon' and probe.homing_mode == 'contact'",
          "auto_select": true
        },
        {
          "value": "cartographer_touch",
          "label": "Cartographer Touch Homing",
          "klipper_section": null,
          "condition": "probe.probe_type == 'cartographer' and probe.homing_mode == 'touch'",
          "auto_select": true
        }
      ]
    },

    "kinematics": {
      "description": "Printer kinematics type",
      "state_key": "printer.kinematics",
      "options": [
        { "value": "corexy", "label": "CoreXY" },
        { "value": "corexy-awd", "label": "CoreXY AWD (4 motors)" },
        { "value": "cartesian", "label": "Cartesian (bed-slinger)" },
        { "value": "corexz", "label": "CoreXZ" },
        { "value": "delta", "label": "Delta" }
      ]
    },

    "driver_types": {
      "description": "TMC driver type",
      "options": [
        { "value": "TMC2209", "label": "TMC2209", "protocol": "UART" },
        { "value": "TMC2226", "label": "TMC2226", "protocol": "UART" },
        { "value": "TMC5160", "label": "TMC5160", "protocol": "SPI" },
        { "value": "TMC2240", "label": "TMC2240", "protocol": "SPI" },
        { "value": "TMC2130", "label": "TMC2130", "protocol": "SPI" },
        { "value": "TMC2208", "label": "TMC2208", "protocol": "UART", "no_stallguard": true }
      ]
    },

    "connection_types": {
      "description": "MCU connection type",
      "options": [
        { "value": "USB", "label": "USB Serial" },
        { "value": "CAN", "label": "CAN Bus" }
      ]
    }
  },

  "menus": {
    "main": {
      "id": "main",
      "title": "gschpoozi - Main Menu",
      "items": [
        {
          "id": "klipper_setup",
          "label": "1. Klipper Setup",
          "description": "Installation and verification",
          "section": "klipper_setup"
        },
        {
          "id": "hardware_setup",
          "label": "2. Hardware Setup",
          "description": "Configure printer hardware",
          "section": "hardware_setup"
        },
        {
          "id": "macros",
          "label": "3. Macros",
          "description": "Configure printer macros",
          "section": "macros"
        },
        {
          "id": "tuning",
          "label": "4. Tuning & Features",
          "description": "Optional features and tuning",
          "section": "tuning"
        },
        {
          "id": "generate",
          "label": "G. Generate Config",
          "description": "Generate Klipper configuration files",
          "action": "generate_config"
        }
      ]
    },

    "hardware_setup": {
      "id": "hardware_setup",
      "title": "Hardware Setup",
      "items": [
        {
          "id": "mcu",
          "label": "2.1 MCU Setup",
          "section": "mcu",
          "status_key": "mcu.main.board_type",
          "description": "Mainboard, Host MCU, Additional MCUs"
        },
        {
          "id": "host_mcu",
          "label": "2.1.2 Host MCU",
          "section": "host_mcu",
          "status_key": "mcu.host.enabled"
        },
        {
          "id": "eddy_probe",
          "label": "2.1.3 Eddy Current Probe",
          "description": "Beacon, Cartographer, BTT Eddy",
          "section": "eddy_probe",
          "status_key": "mcu.eddy_probe.probe_type"
        },
        {
          "id": "mmu_buffers",
          "label": "2.1.4 MMUs/Smart Buffers",
          "description": "Box Turtle, TradRack, ERCF, etc.",
          "section": "mmu_buffers",
          "status_key": "mcu.mmu.type"
        },
        {
          "id": "additional_mcus",
          "label": "2.1.5 Additional MCUs",
          "description": "Other generic MCUs",
          "section": "additional_mcus"
        },
        {
          "id": "printer",
          "label": "Printer Settings",
          "section": "printer",
          "status_key": "printer.kinematics"
        },
        {
          "id": "stepper_x",
          "label": "Stepper X",
          "section": "stepper_x",
          "status_key": "stepper_x.driver_type"
        },
        {
          "id": "stepper_x1",
          "label": "Stepper X1 (AWD)",
          "section": "stepper_x1",
          "status_key": "stepper_x1.driver_type",
          "condition": "printer.awd_enabled"
        },
        {
          "id": "stepper_y",
          "label": "Stepper Y",
          "section": "stepper_y",
          "status_key": "stepper_y.driver_type"
        },
        {
          "id": "stepper_y1",
          "label": "Stepper Y1 (AWD)",
          "section": "stepper_y1",
          "status_key": "stepper_y1.driver_type",
          "condition": "printer.awd_enabled"
        },
        {
          "id": "stepper_z",
          "label": "Stepper Z",
          "section": "stepper_z",
          "status_key": "stepper_z.z_motor_count"
        },
        {
          "id": "extruder",
          "label": "Extruder",
          "section": "extruder",
          "status_key": "extruder.extruder_type"
        },
        {
          "id": "heater_bed",
          "label": "Heater Bed",
          "section": "heater_bed",
          "status_key": "heater_bed.sensor_type"
        },
        {
          "id": "probe",
          "label": "Probe",
          "section": "probe",
          "status_key": "probe.probe_type"
        },
        {
          "id": "homing",
          "label": "Homing",
          "section": "homing",
          "status_key": "homing.homing_method"
        },
        {
          "id": "bed_leveling",
          "label": "Bed Leveling",
          "section": "bed_leveling",
          "status_key": "bed_leveling.leveling_type",
          "condition": "probe.probe_type != 'none'"
        },
        {
          "id": "fans",
          "label": "Fans",
          "section": "fans",
          "status_key": "fans.part_cooling.enabled"
        },
        {
          "id": "additional_fans",
          "label": "Additional Fans",
          "description": "Nevermore, RSCS, Exhaust, etc.",
          "section": "additional_fans"
        },
        {
          "id": "leds",
          "label": "LEDs",
          "section": "leds",
          "status_key": "leds.enabled"
        },
        {
          "id": "temperature_sensors",
          "label": "Temperature Sensors",
          "section": "temperature_sensors",
          "status_key": "temperature_sensors.chamber.enabled"
        },
        {
          "id": "additional_temp_sensors",
          "label": "Additional Temperature Sensors",
          "description": "BME280, AHT10, custom thermistors",
          "section": "additional_temp_sensors"
        },
        {
          "id": "filament_sensors",
          "label": "Filament Sensors",
          "section": "filament_sensors",
          "status_key": "filament_sensors.runout.enabled"
        }
      ]
    },

    "klipper_setup": {
      "id": "klipper_setup",
      "title": "Klipper Setup",
      "items": [
        {
          "id": "manage_components",
          "label": "1. Manage Klipper Components",
          "description": "Install/update Klipper, Moonraker, frontends",
          "action": "manage_components"
        },
        {
          "id": "can_setup",
          "label": "2. CAN Interface Setup",
          "description": "Configure CAN bus interfaces",
          "action": "can_setup"
        },
        {
          "id": "katapult_setup",
          "label": "3. Katapult/Firmware Flashing",
          "description": "DFU and CAN firmware flashing",
          "action": "katapult_setup"
        },
        {
          "id": "mmu_software",
          "label": "4. MMU Software Installation",
          "description": "Happy Hare, AFC-Klipper-Add-On",
          "action": "install_mmu_software"
        },
        {
          "id": "verify_services",
          "label": "V. Verify Klipper Services",
          "description": "Check service status",
          "action": "verify_services"
        }
      ]
    },

    "tuning": {
      "id": "tuning",
      "title": "Tuning & Features",
      "items": [
        {
          "id": "tuning_config",
          "label": "General Settings",
          "section": "tuning",
          "status_key": "tuning.kalico_enabled"
        },
        {
          "id": "input_shaper",
          "label": "Input Shaper",
          "section": "input_shaper",
          "status_key": "input_shaper.enabled"
        }
      ]
    }
  },

  "sections": {
    "mcu": {
      "id": "mcu",
      "title": "MCU Setup",
      "state_prefix": "mcu",
      "subsections": [
        {
          "id": "main",
          "title": "2.1.1 Mainboard",
          "required": true,
          "klipper_section": "[mcu]",
          "fields": [
            {
              "id": "board_type",
              "type": "board_select",
              "label": "Board Type",
              "state_key": "mcu.main.board_type",
              "source": "templates/boards/",
              "required": true,
              "help": "Select your main controller board"
            },
            {
              "id": "connection_type",
              "type": "choice",
              "label": "Connection Type",
              "state_key": "mcu.main.connection_type",
              "options": [
                { "value": "USB", "label": "USB Serial" },
                { "value": "CAN", "label": "CAN Bus" }
              ],
              "default": "USB",
              "required": true,
              "help": "Choose USB Serial or CAN Bus connection"
            },
            {
              "id": "serial",
              "type": "serial_select",
              "label": "Serial Port (USB)",
              "state_key": "mcu.main.serial",
              "auto_detect_pattern": "Klipper",
              "required": true,
              "condition": "mcu.main.connection_type == 'USB'",
              "help": "Select USB serial device from /dev/serial/by-id/"
            },
            {
              "id": "canbus_uuid",
              "type": "can_select",
              "label": "CAN Bus UUID",
              "state_key": "mcu.main.canbus_uuid",
              "required": true,
              "condition": "mcu.main.connection_type == 'CAN'",
              "help": "Select CAN device UUID (query via canbus_query.py)"
            },
            {
              "id": "restart_method",
              "type": "choice",
              "label": "Restart Method",
              "state_key": "mcu.main.restart_method",
              "options": [
                { "value": "command", "label": "Command (default)" },
                { "value": "arduino", "label": "Arduino" },
                { "value": "cheetah", "label": "Cheetah" }
              ],
              "default": "command"
            }
          ]
        },
        {
          "id": "toolboard",
          "title": "Toolhead Board",
          "required": false,
          "klipper_section": "[mcu toolboard]",
          "fields": [
            {
              "id": "enabled",
              "type": "bool",
              "label": "Enable Toolhead Board",
              "state_key": "mcu.toolboard.enabled",
              "default": false
            },
            {
              "id": "board_type",
              "type": "board_select",
              "label": "Board Type",
              "state_key": "mcu.toolboard.board_type",
              "source": "templates/toolboards/",
              "condition": "mcu.toolboard.enabled"
            },
            {
              "id": "connection_type",
              "type": "choice",
              "label": "Connection Type",
              "state_key": "mcu.toolboard.connection_type",
              "options": [
                { "value": "USB", "label": "USB Serial" },
                { "value": "CAN", "label": "CAN Bus" }
              ],
              "default": "CAN",
              "condition": "mcu.toolboard.enabled"
            },
            {
              "id": "serial",
              "type": "serial_select",
              "label": "Serial Port",
              "state_key": "mcu.toolboard.serial",
              "auto_detect_pattern": "Klipper",
              "condition": "mcu.toolboard.enabled and mcu.toolboard.connection_type == 'USB'"
            },
            {
              "id": "canbus_uuid",
              "type": "text",
              "label": "CAN Bus UUID",
              "state_key": "mcu.toolboard.canbus_uuid",
              "condition": "mcu.toolboard.enabled and mcu.toolboard.connection_type == 'CAN'"
            }
          ]
        }
      ]
    },

    "host_mcu": {
      "id": "host_mcu",
      "title": "2.1.2 Host MCU",
      "state_prefix": "mcu.host",
      "klipper_section": "[mcu rpi]",
      "help": "Enables GPIO access on the Raspberry Pi for sensors, fans, and other peripherals",
      "fields": [
        {
          "id": "enabled",
          "type": "bool",
          "label": "Enable Host MCU",
          "state_key": "mcu.host.enabled",
          "default": false,
          "help": "Required for RPi GPIO sensors, DS18B20, Neopixels on GPIO, etc."
        },
        {
          "id": "setup_host_mcu",
          "type": "action",
          "label": "Setup Host MCU Firmware",
          "action": "setup_host_mcu",
          "help": "Run make menuconfig, compile, and flash Host MCU firmware",
          "condition": "mcu.host.enabled"
        },
        {
          "id": "serial",
          "type": "text",
          "label": "Serial Path",
          "state_key": "mcu.host.serial",
          "default": "/tmp/klipper_host_mcu",
          "condition": "mcu.host.enabled",
          "help": "Default Klipper linux MCU socket path"
        }
      ]
    },

    "eddy_probe": {
      "id": "eddy_probe",
      "title": "2.1.3 Eddy Current Probe",
      "state_prefix": "mcu.eddy_probe",
      "description": "Configure Beacon, Cartographer, or BTT Eddy probes",
      "fields": [
        {
          "id": "probe_type",
          "type": "choice",
          "label": "Probe Type",
          "state_key": "mcu.eddy_probe.probe_type",
          "options": [
            { "value": "none", "label": "No Eddy Probe" },
            { "value": "beacon", "label": "Beacon" },
            { "value": "cartographer", "label": "Cartographer 3D" },
            { "value": "btt_eddy", "label": "BTT Eddy" }
          ],
          "default": "none",
          "required": true
        },
        {
          "id": "device_id",
          "type": "mcu_select",
          "label": "Select Probe Device",
          "state_key": "mcu.eddy_probe.device_id",
          "help": "Query and select probe from USB/CAN devices",
          "required": true,
          "condition": "mcu.eddy_probe.probe_type != 'none'"
        },
        {
          "id": "install_module",
          "type": "action",
          "label": "Install Probe Module",
          "action": "install_eddy_module",
          "help": "Install required Klipper module for this probe",
          "condition": "mcu.eddy_probe.probe_type != 'none'"
        }
      ]
    },

    "mmu_buffers": {
      "id": "mmu_buffers",
      "title": "2.1.4 MMUs/Smart Buffers",
      "state_prefix": "mcu.mmu",
      "description": "Configure MMU systems and smart filament buffers",
      "fields": [
        {
          "id": "enabled",
          "type": "bool",
          "label": "Enable MMU/Buffer",
          "state_key": "mcu.mmu.enabled",
          "default": false
        },
        {
          "id": "type",
          "type": "choice",
          "label": "MMU/Buffer Type",
          "state_key": "mcu.mmu.type",
          "options": [
            { "value": "box_turtle", "label": "Box Turtle (AFC)" },
            { "value": "night_owl", "label": "Night Owl (AFC)" },
            { "value": "tradrack", "label": "TradRack (Happy Hare)" },
            { "value": "ercf", "label": "ERCF (Happy Hare)" },
            { "value": "3ms", "label": "3MS" },
            { "value": "prusa_mmu", "label": "Prusa MMU" },
            { "value": "other", "label": "Other" }
          ],
          "default": "box_turtle",
          "condition": "mcu.mmu.enabled"
        },
        {
          "id": "device_id",
          "type": "mcu_select",
          "label": "Select MMU Device",
          "state_key": "mcu.mmu.device_id",
          "help": "Query and select MMU controller from USB/CAN devices",
          "condition": "mcu.mmu.enabled"
        },
        {
          "id": "gate_count",
          "type": "int",
          "label": "Number of Gates/Filaments",
          "state_key": "mcu.mmu.gate_count",
          "default": 4,
          "range": [2, 16],
          "condition": "mcu.mmu.enabled"
        },
        {
          "id": "module_type",
          "type": "choice",
          "label": "Software Module",
          "state_key": "mcu.mmu.module_type",
          "options": [
            { "value": "happy_hare", "label": "Happy Hare", "condition": "mcu.mmu.type in ['tradrack', 'ercf', 'prusa_mmu', 'other']" },
            { "value": "afc", "label": "AFC-Klipper-Add-On", "condition": "mcu.mmu.type in ['box_turtle', 'night_owl', 'other']" }
          ],
          "help": "Select the software module to control your MMU",
          "condition": "mcu.mmu.enabled"
        },
        {
          "id": "install_module",
          "type": "action",
          "label": "Install MMU Module",
          "action": "install_mmu_module",
          "help": "Install the selected MMU software module",
          "condition": "mcu.mmu.enabled"
        },
        {
          "id": "klipperscreen_addon",
          "type": "bool",
          "label": "Install KlipperScreen Add-on",
          "state_key": "mcu.mmu.klipperscreen_addon",
          "default": false,
          "help": "Install KlipperScreen add-on for MMU control",
          "condition": "mcu.mmu.enabled"
        },
        {
          "id": "install_ks_addon",
          "type": "action",
          "label": "Install KlipperScreen Add-on",
          "action": "install_ks_mmu_addon",
          "help": "Install KlipperScreen MMU add-on",
          "condition": "mcu.mmu.enabled and mcu.mmu.klipperscreen_addon"
        }
      ]
    },

    "additional_mcus": {
      "id": "additional_mcus",
      "title": "2.1.5 Additional MCUs",
      "state_prefix": "mcu.additional",
      "description": "Other external MCUs (generic)",
      "is_list": true,
      "item_template": {
        "fields": [
          {
            "id": "device_id",
            "type": "mcu_select",
            "label": "Select MCU Device",
            "state_key": "device_id",
            "help": "Query and select from available USB/CAN devices",
            "required": true
          },
          {
            "id": "name",
            "type": "text",
            "label": "MCU Name",
            "state_key": "name",
            "help": "e.g., mmu, buffer, ercf (used in Klipper config as [mcu name])",
            "required": true
          },
          {
            "id": "type",
            "type": "choice",
            "label": "MCU Type",
            "state_key": "type",
            "options": [
              { "value": "mmu", "label": "MMU (Multi-Material Unit)" },
              { "value": "filament_buffer", "label": "Filament Buffer" },
              { "value": "generic", "label": "Generic MCU" }
            ],
            "default": "mmu",
            "required": true
          },
          {
            "id": "mmu_type",
            "type": "choice",
            "label": "MMU System",
            "state_key": "mmu_type",
            "options": [
              { "value": "ercf", "label": "ERCF (Enraged Rabbit)" },
              { "value": "tradrack", "label": "TradRack" },
              { "value": "box_turtle", "label": "Box Turtle" },
              { "value": "night_owl", "label": "Night Owl" },
              { "value": "3ms", "label": "3MS" },
              { "value": "afc", "label": "AFC / Armored Turtle" },
              { "value": "other", "label": "Other" }
            ],
            "default": "ercf",
            "condition": "type == 'mmu'"
          },
          {
            "id": "gate_count",
            "type": "int",
            "label": "Number of Gates/Filaments",
            "state_key": "gate_count",
            "default": 4,
            "range": [2, 16],
            "condition": "type == 'mmu'"
          },
          {
            "id": "buffer_type",
            "type": "choice",
            "label": "Buffer Type",
            "state_key": "buffer_type",
            "options": [
              { "value": "trad_rack_buffer", "label": "TradRack Buffer" },
              { "value": "ercf_buffer", "label": "ERCF Buffer (Springy)" },
              { "value": "afc_buffer", "label": "AFC Buffer" },
              { "value": "generic", "label": "Generic" }
            ],
            "default": "trad_rack_buffer",
            "condition": "type == 'filament_buffer'"
          },
          {
            "id": "board",
            "type": "choice",
            "label": "Controller Board",
            "state_key": "board",
            "options": [
              { "value": "btt_mmb", "label": "BTT MMB (MMU Board)" },
              { "value": "btt_mmb_can", "label": "BTT MMB CAN" },
              { "value": "fysetc_erb", "label": "Fysetc ERB (ERCF Board)" },
              { "value": "mellow_easy_brd", "label": "Mellow EASY-BRD" },
              { "value": "skr_pico", "label": "SKR Pico" },
              { "value": "rp2040_zero", "label": "RP2040 Zero" },
              { "value": "other", "label": "Other" }
            ],
            "default": "btt_mmb"
          },
          {
            "id": "connection_type",
            "type": "choice",
            "label": "Connection Type",
            "state_key": "connection_type",
            "options": [
              { "value": "USB", "label": "USB Serial" },
              { "value": "CAN", "label": "CAN Bus" }
            ],
            "default": "USB"
          },
          {
            "id": "serial",
            "type": "serial_select",
            "label": "Serial Port",
            "state_key": "serial",
            "auto_detect_pattern": "Klipper",
            "condition": "connection_type == 'USB'"
          },
          {
            "id": "canbus_uuid",
            "type": "can_select",
            "label": "CAN Bus UUID",
            "state_key": "canbus_uuid",
            "help": "Select CAN device UUID from queried devices",
            "condition": "connection_type == 'CAN'"
          },
          {
            "id": "module_check",
            "type": "action",
            "label": "Check Module Installation",
            "action": "check_module",
            "help": "Check if required module (Happy Hare, AFC, etc.) is installed",
            "condition": "type == 'mmu'"
          },
          {
            "id": "module_install",
            "type": "action",
            "label": "Install Module",
            "action": "install_module",
            "help": "Install required module if not present",
            "condition": "type == 'mmu'"
          },
          {
            "id": "klipperscreen_addon",
            "type": "bool",
            "label": "Install KlipperScreen Add-on",
            "state_key": "klipperscreen_addon",
            "default": false,
            "help": "Install KlipperScreen add-on if applicable",
            "condition": "type == 'mmu'"
          }
        ]
      }
    },

    "printer": {
      "id": "printer",
      "title": "Printer Settings",
      "state_prefix": "printer",
      "klipper_section": "[printer]",
      "fields": [
        {
          "id": "kinematics",
          "type": "exclusive_choice",
          "group": "kinematics",
          "label": "Kinematics",
          "state_key": "printer.kinematics",
          "required": true
        },
        {
          "id": "bed_size_x",
          "type": "int",
          "label": "Bed Size X (mm)",
          "state_key": "printer.bed_size_x",
          "required": true,
          "range": [100, 500]
        },
        {
          "id": "bed_size_y",
          "type": "int",
          "label": "Bed Size Y (mm)",
          "state_key": "printer.bed_size_y",
          "required": true,
          "range": [100, 500]
        },
        {
          "id": "max_z",
          "type": "int",
          "label": "Max Z Height (mm)",
          "state_key": "printer.max_z",
          "required": true,
          "range": [100, 500]
        },
        {
          "id": "max_velocity",
          "type": "int",
          "label": "Max Velocity (mm/s)",
          "state_key": "printer.max_velocity",
          "default": 300,
          "range": [50, 1000]
        },
        {
          "id": "max_accel",
          "type": "int",
          "label": "Max Acceleration (mm/s^2)",
          "state_key": "printer.max_accel",
          "default": 3000,
          "range": [500, 50000]
        },
        {
          "id": "max_z_velocity",
          "type": "int",
          "label": "Max Z Velocity (mm/s)",
          "state_key": "printer.max_z_velocity",
          "default": 15,
          "range": [5, 50]
        },
        {
          "id": "max_z_accel",
          "type": "int",
          "label": "Max Z Acceleration (mm/s^2)",
          "state_key": "printer.max_z_accel",
          "default": 350,
          "range": [50, 1000]
        }
      ]
    },

    "probe": {
      "id": "probe",
      "title": "Probe Configuration",
      "state_prefix": "probe",
      "fields": [
        {
          "id": "probe_type",
          "type": "exclusive_choice",
          "group": "probe_types",
          "label": "Probe Type",
          "state_key": "probe.probe_type",
          "required": true
        },
        {
          "id": "location",
          "type": "choice",
          "label": "Probe Location",
          "state_key": "probe.location",
          "options": [
            { "value": "mainboard", "label": "Mainboard" },
            { "value": "toolboard", "label": "Toolboard", "condition": "mcu.toolboard.enabled" }
          ],
          "default": "toolboard",
          "condition": "probe.probe_type not in ['none', 'beacon', 'cartographer', 'btt_eddy']"
        },
        {
          "id": "serial",
          "type": "serial_select",
          "label": "Probe Serial",
          "state_key": "probe.serial",
          "auto_detect_pattern": {
            "beacon": "Beacon",
            "cartographer": "Cartographer",
            "btt_eddy": "BTT"
          },
          "required": true,
          "condition": "probe.probe_type in ['beacon', 'cartographer', 'btt_eddy']"
        },
        {
          "id": "homing_mode",
          "type": "choice",
          "label": "Homing Mode",
          "state_key": "probe.homing_mode",
          "options": [
            { "value": "contact", "label": "Contact (nozzle touches bed)" },
            { "value": "proximity", "label": "Proximity (non-contact)" }
          ],
          "default": "contact",
          "condition": "probe.probe_type == 'beacon'"
        },
        {
          "id": "homing_mode_cartographer",
          "type": "choice",
          "label": "Homing Mode",
          "state_key": "probe.homing_mode",
          "options": [
            { "value": "touch", "label": "Touch (contact homing)" },
            { "value": "scan", "label": "Scan (proximity homing)" }
          ],
          "default": "touch",
          "condition": "probe.probe_type == 'cartographer'"
        },
        {
          "id": "x_offset",
          "type": "float",
          "label": "X Offset from Nozzle (mm)",
          "state_key": "probe.x_offset",
          "default": 0,
          "condition": "probe.probe_type not in ['none', 'tap']"
        },
        {
          "id": "y_offset",
          "type": "float",
          "label": "Y Offset from Nozzle (mm)",
          "state_key": "probe.y_offset",
          "default": 0,
          "condition": "probe.probe_type not in ['none', 'tap']"
        },
        {
          "id": "contact_max_hotend_temperature",
          "type": "int",
          "label": "Max Hotend Temp for Contact (C)",
          "state_key": "probe.contact_max_hotend_temperature",
          "default": 180,
          "range": [150, 200],
          "condition": "probe.probe_type == 'beacon' and probe.homing_mode == 'contact'"
        }
      ],
      "subsections": [
        {
          "id": "bed_mesh",
          "title": "Bed Mesh Settings",
          "condition": "probe.probe_type != 'none'",
          "klipper_section": "[bed_mesh]",
          "fields": [
            {
              "id": "enabled",
              "type": "bool",
              "label": "Enable Bed Mesh",
              "state_key": "probe.bed_mesh.enabled",
              "default": true
            },
            {
              "id": "mesh_min_x",
              "type": "int",
              "label": "Mesh Min X",
              "state_key": "probe.bed_mesh.mesh_min_x",
              "auto_calculate": "probe.x_offset + 5"
            },
            {
              "id": "mesh_min_y",
              "type": "int",
              "label": "Mesh Min Y",
              "state_key": "probe.bed_mesh.mesh_min_y",
              "auto_calculate": "probe.y_offset + 5"
            },
            {
              "id": "mesh_max_x",
              "type": "int",
              "label": "Mesh Max X",
              "state_key": "probe.bed_mesh.mesh_max_x",
              "auto_calculate": "printer.bed_size_x - 5"
            },
            {
              "id": "mesh_max_y",
              "type": "int",
              "label": "Mesh Max Y",
              "state_key": "probe.bed_mesh.mesh_max_y",
              "auto_calculate": "printer.bed_size_y - 5"
            },
            {
              "id": "probe_count",
              "type": "text",
              "label": "Probe Count (X,Y)",
              "state_key": "probe.bed_mesh.probe_count",
              "default": "5,5",
              "help": "Format: X,Y (e.g., 5,5 or 31,31). Eddy probes can use high counts like 25,25 or 31,31 for rapid scanning."
            }
          ]
        }
      ]
    },

    "homing": {
      "id": "homing",
      "title": "Homing Configuration",
      "state_prefix": "homing",
      "fields": [
        {
          "id": "homing_method",
          "type": "exclusive_choice",
          "group": "homing_methods",
          "label": "Z Homing Method",
          "state_key": "homing.homing_method",
          "required": true,
          "auto_select_from_probe": true
        },
        {
          "id": "home_xy_position_x",
          "type": "int",
          "label": "Z Home X Position",
          "state_key": "homing.home_xy_position_x",
          "auto_calculate": "printer.bed_size_x / 2",
          "condition": "homing.homing_method == 'safe_z_home'"
        },
        {
          "id": "home_xy_position_y",
          "type": "int",
          "label": "Z Home Y Position",
          "state_key": "homing.home_xy_position_y",
          "auto_calculate": "printer.bed_size_y / 2",
          "condition": "homing.homing_method == 'safe_z_home'"
        }
      ]
    },

    "bed_leveling": {
      "id": "bed_leveling",
      "title": "Bed Leveling",
      "state_prefix": "bed_leveling",
      "condition": "probe.probe_type != 'none'",
      "fields": [
        {
          "id": "leveling_type",
          "type": "exclusive_choice",
          "group": "leveling_types",
          "label": "Leveling Method",
          "state_key": "bed_leveling.leveling_type",
          "auto_select_from_z_motors": true
        }
      ]
    },

    "stepper_x": {
      "id": "stepper_x",
      "title": "Stepper X Configuration",
      "state_prefix": "stepper_x",
      "klipper_section": "[stepper_x]",
      "fields": [
        {
          "id": "motor_port",
          "type": "port_select",
          "label": "Motor Port",
          "state_key": "stepper_x.motor_port",
          "port_type": "motor_ports",
          "required": true
        },
        {
          "id": "driver_type",
          "type": "exclusive_choice",
          "group": "driver_types",
          "label": "Driver Type",
          "state_key": "stepper_x.driver_type",
          "required": true
        },
        {
          "id": "endstop_type",
          "type": "exclusive_choice",
          "group": "endstop_types_xy",
          "label": "Endstop Type",
          "state_key": "stepper_x.endstop_type",
          "required": true
        },
        {
          "id": "endstop_location",
          "type": "choice",
          "label": "Endstop Location",
          "state_key": "stepper_x.endstop_location",
          "options": [
            { "value": "mainboard", "label": "Mainboard" },
            { "value": "toolboard", "label": "Toolboard", "condition": "mcu.toolboard.enabled" }
          ],
          "condition": "stepper_x.endstop_type == 'physical'"
        },
        {
          "id": "endstop_port",
          "type": "port_select",
          "label": "Endstop Port",
          "state_key": "stepper_x.endstop_port",
          "port_type": "endstop_ports",
          "condition": "stepper_x.endstop_type == 'physical'"
        },
        {
          "id": "endstop_pullup",
          "type": "bool",
          "label": "Enable Endstop Pull-up",
          "state_key": "stepper_x.endstop_pullup",
          "default": true,
          "help": "Enable internal pull-up resistor (recommended for mechanical switches)",
          "condition": "stepper_x.endstop_type == 'physical'"
        },
        {
          "id": "endstop_invert",
          "type": "bool",
          "label": "Invert Endstop Logic",
          "state_key": "stepper_x.endstop_invert",
          "default": false,
          "help": "Invert endstop signal (enable for NC switches, disable for NO switches)",
          "condition": "stepper_x.endstop_type == 'physical'"
        },
        {
          "id": "enable_invert",
          "type": "bool",
          "label": "Invert Enable Pin",
          "state_key": "stepper_x.enable_invert",
          "default": false,
          "help": "Invert the motor enable signal (depends on driver board)"
        },
        {
          "id": "dir_invert",
          "type": "bool",
          "label": "Invert Direction",
          "state_key": "stepper_x.dir_invert",
          "default": false,
          "help": "Invert motor direction if it runs backwards"
        },
        {
          "id": "position_endstop",
          "type": "int",
          "label": "Position Endstop (mm)",
          "state_key": "stepper_x.position_endstop",
          "default": 0
        },
        {
          "id": "position_max",
          "type": "int",
          "label": "Position Max (mm)",
          "state_key": "stepper_x.position_max",
          "auto_calculate": "printer.bed_size_x"
        },
        {
          "id": "homing_speed",
          "type": "int",
          "label": "Homing Speed (mm/s)",
          "state_key": "stepper_x.homing_speed",
          "default": 50
        },
        {
          "id": "rotation_distance",
          "type": "float",
          "label": "Rotation Distance (mm)",
          "state_key": "stepper_x.rotation_distance",
          "default": 40,
          "help": "For GT2-20T pulley: 40mm"
        },
        {
          "id": "microsteps",
          "type": "choice",
          "label": "Microsteps",
          "state_key": "stepper_x.microsteps",
          "options": [
            { "value": 16, "label": "16" },
            { "value": 32, "label": "32" },
            { "value": 64, "label": "64" },
            { "value": 128, "label": "128" },
            { "value": 256, "label": "256" }
          ],
          "default": 32
        }
      ]
    },

    "stepper_x1": {
      "id": "stepper_x1",
      "title": "Stepper X1 Configuration (AWD)",
      "description": "X1 shares belt with X - only motor port and direction differ",
      "state_prefix": "stepper_x1",
      "klipper_section": "[stepper_x1]",
      "condition": "printer.awd_enabled",
      "inherit_from": "stepper_x",
      "inherited_fields": ["driver_type", "microsteps", "rotation_distance", "enable_invert"],
      "fields": [
        {
          "id": "motor_port",
          "type": "port_select",
          "label": "Motor Port",
          "state_key": "stepper_x1.motor_port",
          "port_type": "motor_ports",
          "required": true
        },
        {
          "id": "dir_invert",
          "type": "bool",
          "label": "Invert Direction",
          "state_key": "stepper_x1.dir_invert",
          "default": false,
          "help": "Invert motor direction (usually needed for AWD)"
        }
      ]
    },

    "stepper_y": {
      "id": "stepper_y",
      "title": "Stepper Y Configuration",
      "state_prefix": "stepper_y",
      "klipper_section": "[stepper_y]",
      "copy_from_option": {
        "source": "stepper_x",
        "label": "Use same motor settings as Stepper X?",
        "help": "CoreXY typically uses identical motors. Copy driver, microsteps, rotation distance from X.",
        "fields": ["driver_type", "microsteps", "rotation_distance", "enable_invert", "homing_speed"]
      },
      "fields": [
        {
          "id": "motor_port",
          "type": "port_select",
          "label": "Motor Port",
          "state_key": "stepper_y.motor_port",
          "port_type": "motor_ports",
          "required": true
        },
        {
          "id": "driver_type",
          "type": "exclusive_choice",
          "group": "driver_types",
          "label": "Driver Type",
          "state_key": "stepper_y.driver_type",
          "required": true,
          "skip_if_copied": true
        },
        {
          "id": "endstop_type",
          "type": "exclusive_choice",
          "group": "endstop_types_xy",
          "label": "Endstop Type",
          "state_key": "stepper_y.endstop_type",
          "required": true
        },
        {
          "id": "endstop_location",
          "type": "choice",
          "label": "Endstop Location",
          "state_key": "stepper_y.endstop_location",
          "options": [
            { "value": "mainboard", "label": "Mainboard" },
            { "value": "toolboard", "label": "Toolboard", "condition": "mcu.toolboard.enabled" }
          ],
          "condition": "stepper_y.endstop_type == 'physical'"
        },
        {
          "id": "endstop_port",
          "type": "port_select",
          "label": "Endstop Port",
          "state_key": "stepper_y.endstop_port",
          "port_type": "endstop_ports",
          "condition": "stepper_y.endstop_type == 'physical'"
        },
        {
          "id": "endstop_pullup",
          "type": "bool",
          "label": "Enable Endstop Pull-up",
          "state_key": "stepper_y.endstop_pullup",
          "default": true,
          "help": "Enable internal pull-up resistor (recommended for mechanical switches)",
          "condition": "stepper_y.endstop_type == 'physical'"
        },
        {
          "id": "endstop_invert",
          "type": "bool",
          "label": "Invert Endstop Logic",
          "state_key": "stepper_y.endstop_invert",
          "default": false,
          "help": "Invert endstop signal (enable for NC switches, disable for NO switches)",
          "condition": "stepper_y.endstop_type == 'physical'"
        },
        {
          "id": "enable_invert",
          "type": "bool",
          "label": "Invert Enable Pin",
          "state_key": "stepper_y.enable_invert",
          "default": false,
          "help": "Invert the motor enable signal (depends on driver board)",
          "skip_if_copied": true
        },
        {
          "id": "dir_invert",
          "type": "bool",
          "label": "Invert Direction",
          "state_key": "stepper_y.dir_invert",
          "default": false,
          "help": "Invert motor direction if it runs backwards"
        },
        {
          "id": "position_endstop",
          "type": "int",
          "label": "Position Endstop (mm)",
          "state_key": "stepper_y.position_endstop",
          "default": 0
        },
        {
          "id": "position_max",
          "type": "int",
          "label": "Position Max (mm)",
          "state_key": "stepper_y.position_max",
          "auto_calculate": "printer.bed_size_y"
        },
        {
          "id": "homing_speed",
          "type": "int",
          "label": "Homing Speed (mm/s)",
          "state_key": "stepper_y.homing_speed",
          "default": 50,
          "skip_if_copied": true
        },
        {
          "id": "rotation_distance",
          "type": "float",
          "label": "Rotation Distance (mm)",
          "state_key": "stepper_y.rotation_distance",
          "default": 40,
          "help": "For GT2-20T pulley: 40mm",
          "skip_if_copied": true
        },
        {
          "id": "microsteps",
          "type": "choice",
          "label": "Microsteps",
          "state_key": "stepper_y.microsteps",
          "options": [
            { "value": 16, "label": "16" },
            { "value": 32, "label": "32" },
            { "value": 64, "label": "64" },
            { "value": 128, "label": "128" },
            { "value": 256, "label": "256" }
          ],
          "default": 32,
          "skip_if_copied": true
        }
      ]
    },

    "stepper_y1": {
      "id": "stepper_y1",
      "title": "Stepper Y1 Configuration (AWD)",
      "description": "Y1 shares belt with Y - only motor port and direction differ",
      "state_prefix": "stepper_y1",
      "klipper_section": "[stepper_y1]",
      "condition": "printer.awd_enabled",
      "inherit_from": "stepper_y",
      "inherited_fields": ["driver_type", "microsteps", "rotation_distance", "enable_invert"],
      "fields": [
        {
          "id": "motor_port",
          "type": "port_select",
          "label": "Motor Port",
          "state_key": "stepper_y1.motor_port",
          "port_type": "motor_ports",
          "required": true
        },
        {
          "id": "dir_invert",
          "type": "bool",
          "label": "Invert Direction",
          "state_key": "stepper_y1.dir_invert",
          "default": false,
          "help": "Invert motor direction (usually needed for AWD)"
        }
      ]
    },

    "stepper_z": {
      "id": "stepper_z",
      "title": "Stepper Z Configuration",
      "state_prefix": "stepper_z",
      "klipper_section": "[stepper_z]",
      "fields": [
        {
          "id": "z_motor_count",
          "type": "choice",
          "label": "Number of Z Motors",
          "state_key": "stepper_z.z_motor_count",
          "options": [
            { "value": 1, "label": "1 motor" },
            { "value": 2, "label": "2 motors (Z Tilt)" },
            { "value": 3, "label": "3 motors (Z Tilt)" },
            { "value": 4, "label": "4 motors (Quad Gantry)" }
          ],
          "default": 1,
          "required": true
        },
        {
          "id": "motor_port",
          "type": "port_select",
          "label": "Z Motor Port",
          "state_key": "stepper_z.motor_port",
          "port_type": "motor_ports",
          "required": true
        },
        {
          "id": "driver_type",
          "type": "exclusive_choice",
          "group": "driver_types",
          "label": "Driver Type",
          "state_key": "stepper_z.driver_type",
          "required": true
        },
        {
          "id": "endstop_type",
          "type": "exclusive_choice",
          "group": "endstop_types_z",
          "label": "Z Endstop Type",
          "state_key": "stepper_z.endstop_type",
          "required": true
        },
        {
          "id": "endstop_location",
          "type": "choice",
          "label": "Endstop Location",
          "state_key": "stepper_z.endstop_location",
          "options": [
            { "value": "mainboard", "label": "Mainboard" },
            { "value": "toolboard", "label": "Toolboard", "condition": "mcu.toolboard.enabled" }
          ],
          "condition": "stepper_z.endstop_type in ['physical_mainboard', 'physical_toolboard']"
        },
        {
          "id": "endstop_port",
          "type": "port_select",
          "label": "Endstop Port",
          "state_key": "stepper_z.endstop_port",
          "port_type": "endstop_ports",
          "condition": "stepper_z.endstop_type in ['physical_mainboard', 'physical_toolboard']"
        },
        {
          "id": "endstop_pullup",
          "type": "bool",
          "label": "Enable Endstop Pull-up",
          "state_key": "stepper_z.endstop_pullup",
          "default": true,
          "help": "Enable internal pull-up resistor (recommended for mechanical switches)",
          "condition": "stepper_z.endstop_type in ['physical_mainboard', 'physical_toolboard']"
        },
        {
          "id": "endstop_invert",
          "type": "bool",
          "label": "Invert Endstop Logic",
          "state_key": "stepper_z.endstop_invert",
          "default": false,
          "help": "Invert endstop signal (enable for NC switches, disable for NO switches)",
          "condition": "stepper_z.endstop_type in ['physical_mainboard', 'physical_toolboard']"
        },
        {
          "id": "enable_invert",
          "type": "bool",
          "label": "Invert Enable Pin",
          "state_key": "stepper_z.enable_invert",
          "default": false,
          "help": "Invert the motor enable signal (depends on driver board)"
        },
        {
          "id": "dir_invert",
          "type": "bool",
          "label": "Invert Direction",
          "state_key": "stepper_z.dir_invert",
          "default": false,
          "help": "Invert motor direction if it runs backwards"
        },
        {
          "id": "position_endstop",
          "type": "float",
          "label": "Position Endstop (mm)",
          "state_key": "stepper_z.position_endstop",
          "default": 0,
          "condition": "stepper_z.endstop_type not in ['probe', 'sensorless']"
        },
        {
          "id": "position_max",
          "type": "int",
          "label": "Position Max (mm)",
          "state_key": "stepper_z.position_max",
          "auto_calculate": "printer.max_z"
        },
        {
          "id": "homing_speed",
          "type": "int",
          "label": "Homing Speed (mm/s)",
          "state_key": "stepper_z.homing_speed",
          "default": 10
        },
        {
          "id": "rotation_distance",
          "type": "float",
          "label": "Rotation Distance (mm)",
          "state_key": "stepper_z.rotation_distance",
          "default": 8,
          "help": "For T8 leadscrew: 8mm, for belt: 40mm"
        },
        {
          "id": "microsteps",
          "type": "choice",
          "label": "Microsteps",
          "state_key": "stepper_z.microsteps",
          "options": [
            { "value": 16, "label": "16" },
            { "value": 32, "label": "32" },
            { "value": 64, "label": "64" },
            { "value": 128, "label": "128" },
            { "value": 256, "label": "256" }
          ],
          "default": 32
        }
      ]
    },

    "extruder": {
      "id": "extruder",
      "title": "Extruder Configuration",
      "state_prefix": "extruder",
      "klipper_section": "[extruder]",
      "fields": [
        {
          "id": "extruder_type",
          "type": "board_select",
          "label": "Extruder Type",
          "state_key": "extruder.extruder_type",
          "source": "templates/extruders/",
          "required": true
        },
        {
          "id": "location",
          "type": "choice",
          "label": "Extruder Location",
          "state_key": "extruder.location",
          "options": [
            { "value": "mainboard", "label": "Mainboard" },
            { "value": "toolboard", "label": "Toolboard", "condition": "mcu.toolboard.enabled" }
          ],
          "default": "toolboard"
        },
        {
          "id": "motor_port",
          "type": "port_select",
          "label": "Motor Port",
          "state_key": "extruder.motor_port",
          "port_type": "motor_ports",
          "required": true
        },
        {
          "id": "driver_type",
          "type": "exclusive_choice",
          "group": "driver_types",
          "label": "Driver Type",
          "state_key": "extruder.driver_type",
          "condition": "extruder.location == 'mainboard'",
          "required": true
        },
        {
          "id": "heater_port",
          "type": "port_select",
          "label": "Heater Port",
          "state_key": "extruder.heater_port",
          "port_type": "heater_ports",
          "required": true
        },
        {
          "id": "sensor_port",
          "type": "port_select",
          "label": "Thermistor Port",
          "state_key": "extruder.sensor_port",
          "port_type": "thermistor_ports",
          "required": true
        },
        {
          "id": "sensor_type",
          "type": "choice",
          "label": "Thermistor Type",
          "state_key": "extruder.sensor_type",
          "options": [
            { "value": "ATC Semitec 104NT-4-R025H42G", "label": "ATC Semitec 104NT-4 (Trianglelab)" },
            { "value": "ATC Semitec 104GT-2", "label": "ATC Semitec 104GT-2" },
            { "value": "Generic 3950", "label": "Generic 3950 (NTC 100K)" },
            { "value": "PT1000", "label": "PT1000" },
            { "value": "MAX31865", "label": "MAX31865 (PT100/PT1000 amplifier)" }
          ],
          "default": "ATC Semitec 104NT-4-R025H42G"
        },
        {
          "id": "pullup_resistor",
          "type": "choice",
          "label": "Thermistor Pull-up Resistor",
          "state_key": "extruder.pullup_resistor",
          "options": [
            { "value": "none", "label": "None (use board default)" },
            { "value": 4700, "label": "4700 ohm (standard)" },
            { "value": 2200, "label": "2200 ohm" },
            { "value": "custom", "label": "Custom value" }
          ],
          "default": "none",
          "help": "Override pull-up resistor value for thermistor ADC input (most boards use 4700)",
          "condition": "extruder.sensor_type != 'MAX31865'"
        },
        {
          "id": "pullup_resistor_custom",
          "type": "int",
          "label": "Custom Pull-up Value (ohms)",
          "state_key": "extruder.pullup_resistor_custom",
          "condition": "extruder.pullup_resistor == 'custom'",
          "range": [1000, 10000]
        },
        {
          "id": "heater_invert",
          "type": "bool",
          "label": "Invert Heater Pin",
          "state_key": "extruder.heater_invert",
          "default": false,
          "help": "Invert heater output signal (rarely needed)"
        },
        {
          "id": "enable_invert",
          "type": "bool",
          "label": "Invert Enable Pin",
          "state_key": "extruder.enable_invert",
          "default": false,
          "help": "Invert the motor enable signal (depends on driver board)"
        },
        {
          "id": "dir_invert",
          "type": "bool",
          "label": "Invert Direction",
          "state_key": "extruder.dir_invert",
          "default": false,
          "help": "Invert motor direction for correct extrusion"
        },
        {
          "id": "rotation_distance",
          "type": "float",
          "label": "Rotation Distance (mm)",
          "state_key": "extruder.rotation_distance",
          "default": 22.6789511,
          "help": "Distance filament moves per full motor rotation. Check your extruder docs or calibrate with the extruder calibration macro."
        },
        {
          "id": "microsteps",
          "type": "choice",
          "label": "Microsteps",
          "state_key": "extruder.microsteps",
          "options": [
            { "value": 16, "label": "16" },
            { "value": 32, "label": "32" },
            { "value": 64, "label": "64" }
          ],
          "default": 16
        },
        {
          "id": "nozzle_diameter",
          "type": "choice",
          "label": "Nozzle Diameter (mm)",
          "state_key": "extruder.nozzle_diameter",
          "options": [
            { "value": 0.2, "label": "0.2mm" },
            { "value": 0.3, "label": "0.3mm" },
            { "value": 0.4, "label": "0.4mm" },
            { "value": 0.5, "label": "0.5mm" },
            { "value": 0.6, "label": "0.6mm" },
            { "value": 0.8, "label": "0.8mm" }
          ],
          "default": 0.4
        },
        {
          "id": "max_temp",
          "type": "int",
          "label": "Max Temperature (C)",
          "state_key": "extruder.max_temp",
          "default": 300,
          "range": [200, 350]
        },
        {
          "id": "control",
          "type": "choice",
          "label": "Temperature Control",
          "state_key": "extruder.control",
          "options": [
            { "value": "pid", "label": "PID (standard)" },
            { "value": "mpc", "label": "MPC (Kalico only)", "condition": "tuning.kalico_enabled" }
          ],
          "default": "pid"
        }
      ]
    },

    "heater_bed": {
      "id": "heater_bed",
      "title": "Heater Bed Configuration",
      "state_prefix": "heater_bed",
      "klipper_section": "[heater_bed]",
      "fields": [
        {
          "id": "heater_port",
          "type": "port_select",
          "label": "Heater Port",
          "state_key": "heater_bed.heater_port",
          "port_type": "heater_ports",
          "required": true
        },
        {
          "id": "sensor_port",
          "type": "port_select",
          "label": "Thermistor Port",
          "state_key": "heater_bed.sensor_port",
          "port_type": "thermistor_ports",
          "required": true
        },
        {
          "id": "sensor_type",
          "type": "choice",
          "label": "Thermistor Type",
          "state_key": "heater_bed.sensor_type",
          "options": [
            { "value": "Generic 3950", "label": "Generic 3950 (NTC 100K)" },
            { "value": "ATC Semitec 104NT-4-R025H42G", "label": "ATC Semitec 104NT-4" },
            { "value": "EPCOS 100K B57560G104F", "label": "EPCOS 100K" },
            { "value": "PT1000", "label": "PT1000" }
          ],
          "default": "Generic 3950"
        },
        {
          "id": "pullup_resistor",
          "type": "choice",
          "label": "Thermistor Pull-up Resistor",
          "state_key": "heater_bed.pullup_resistor",
          "options": [
            { "value": "none", "label": "None (use board default)" },
            { "value": 4700, "label": "4700 ohm (standard)" },
            { "value": 2200, "label": "2200 ohm" },
            { "value": "custom", "label": "Custom value" }
          ],
          "default": "none",
          "help": "Override pull-up resistor value for thermistor ADC input (most boards use 4700)"
        },
        {
          "id": "pullup_resistor_custom",
          "type": "int",
          "label": "Custom Pull-up Value (ohms)",
          "state_key": "heater_bed.pullup_resistor_custom",
          "condition": "heater_bed.pullup_resistor == 'custom'",
          "range": [1000, 10000]
        },
        {
          "id": "heater_invert",
          "type": "bool",
          "label": "Invert Heater Pin",
          "state_key": "heater_bed.heater_invert",
          "default": false,
          "help": "Invert heater output signal (rarely needed)"
        },
        {
          "id": "max_temp",
          "type": "int",
          "label": "Max Temperature (C)",
          "state_key": "heater_bed.max_temp",
          "default": 120,
          "range": [80, 130]
        }
      ]
    },

    "fans": {
      "id": "fans",
      "title": "Fan Configuration",
      "state_prefix": "fans",
      "subsections": [
        {
          "id": "part_cooling",
          "title": "Part Cooling Fan",
          "klipper_section": "[fan]",
          "fields": [
            {
              "id": "enabled",
              "type": "bool",
              "label": "Enable Part Cooling Fan",
              "state_key": "fans.part_cooling.enabled",
              "default": true
            },
            {
              "id": "location",
              "type": "choice",
              "label": "Fan Location",
              "state_key": "fans.part_cooling.location",
              "options": [
                { "value": "mainboard", "label": "Mainboard" },
                { "value": "toolboard", "label": "Toolboard", "condition": "mcu.toolboard.enabled" }
              ],
              "default": "toolboard",
              "condition": "fans.part_cooling.enabled"
            },
            {
              "id": "pin_mainboard",
              "type": "port_select",
              "label": "Fan Port (Mainboard)",
              "state_key": "fans.part_cooling.pin_mainboard",
              "port_type": "fan_ports",
              "condition": "fans.part_cooling.enabled and fans.part_cooling.location == 'mainboard'"
            },
            {
              "id": "pin_toolboard",
              "type": "port_select",
              "label": "Fan Port (Toolboard)",
              "state_key": "fans.part_cooling.pin_toolboard",
              "port_type": "fan_ports",
              "condition": "fans.part_cooling.enabled and fans.part_cooling.location == 'toolboard'"
            },
            {
              "id": "max_power",
              "type": "float",
              "label": "Max Power (0.0-1.0)",
              "state_key": "fans.part_cooling.max_power",
              "default": 1.0,
              "range": [0.0, 1.0],
              "condition": "fans.part_cooling.enabled"
            },
            {
              "id": "kick_start_time",
              "type": "float",
              "label": "Kick Start Time (seconds)",
              "state_key": "fans.part_cooling.kick_start_time",
              "default": 0.5,
              "help": "Time to run at full speed when starting",
              "condition": "fans.part_cooling.enabled"
            },
            {
              "id": "off_below",
              "type": "float",
              "label": "Off Below (0.0-1.0)",
              "state_key": "fans.part_cooling.off_below",
              "default": 0.1,
              "help": "Turn off fan below this speed",
              "condition": "fans.part_cooling.enabled"
            },
            {
              "id": "cycle_time",
              "type": "float",
              "label": "PWM Cycle Time (seconds)",
              "state_key": "fans.part_cooling.cycle_time",
              "default": 0.010,
              "condition": "fans.part_cooling.enabled"
            }
          ]
        },
        {
          "id": "hotend",
          "title": "Hotend Cooling Fan",
          "klipper_section": "[heater_fan hotend_fan]",
          "fields": [
            {
              "id": "enabled",
              "type": "bool",
              "label": "Enable Hotend Fan",
              "state_key": "fans.hotend.enabled",
              "default": true
            },
            {
              "id": "location",
              "type": "choice",
              "label": "Fan Location",
              "state_key": "fans.hotend.location",
              "options": [
                { "value": "mainboard", "label": "Mainboard" },
                { "value": "toolboard", "label": "Toolboard", "condition": "mcu.toolboard.enabled" }
              ],
              "default": "toolboard",
              "condition": "fans.hotend.enabled"
            },
            {
              "id": "pin_mainboard",
              "type": "port_select",
              "label": "Fan Port (Mainboard)",
              "state_key": "fans.hotend.pin_mainboard",
              "port_type": "fan_ports",
              "condition": "fans.hotend.enabled and fans.hotend.location == 'mainboard'"
            },
            {
              "id": "pin_toolboard",
              "type": "port_select",
              "label": "Fan Port (Toolboard)",
              "state_key": "fans.hotend.pin_toolboard",
              "port_type": "fan_ports",
              "condition": "fans.hotend.enabled and fans.hotend.location == 'toolboard'"
            },
            {
              "id": "heater",
              "type": "text",
              "label": "Heater to Monitor",
              "state_key": "fans.hotend.heater",
              "default": "extruder",
              "condition": "fans.hotend.enabled"
            },
            {
              "id": "heater_temp",
              "type": "int",
              "label": "Turn On Temperature (C)",
              "state_key": "fans.hotend.heater_temp",
              "default": 50,
              "help": "Fan turns on when heater exceeds this temp",
              "condition": "fans.hotend.enabled"
            },
            {
              "id": "fan_speed",
              "type": "float",
              "label": "Fan Speed (0.0-1.0)",
              "state_key": "fans.hotend.fan_speed",
              "default": 1.0,
              "range": [0.0, 1.0],
              "condition": "fans.hotend.enabled"
            }
          ]
        },
        {
          "id": "controller",
          "title": "Controller/Electronics Fan",
          "klipper_section": "[controller_fan controller_fan]",
          "fields": [
            {
              "id": "enabled",
              "type": "bool",
              "label": "Enable Controller Fan",
              "state_key": "fans.controller.enabled",
              "default": false
            },
            {
              "id": "pin",
              "type": "port_select",
              "label": "Fan Port",
              "state_key": "fans.controller.pin",
              "port_type": "fan_ports",
              "condition": "fans.controller.enabled"
            },
            {
              "id": "kick_start_time",
              "type": "float",
              "label": "Kick Start Time (seconds)",
              "state_key": "fans.controller.kick_start_time",
              "default": 0.5,
              "condition": "fans.controller.enabled"
            },
            {
              "id": "stepper",
              "type": "text",
              "label": "Stepper to Monitor",
              "state_key": "fans.controller.stepper",
              "default": "stepper_x",
              "help": "Fan activates when this stepper is active",
              "condition": "fans.controller.enabled"
            },
            {
              "id": "idle_timeout",
              "type": "int",
              "label": "Idle Timeout (seconds)",
              "state_key": "fans.controller.idle_timeout",
              "default": 60,
              "condition": "fans.controller.enabled"
            },
            {
              "id": "idle_speed",
              "type": "float",
              "label": "Idle Speed (0.0-1.0)",
              "state_key": "fans.controller.idle_speed",
              "default": 0.5,
              "range": [0.0, 1.0],
              "condition": "fans.controller.enabled"
            }
          ]
        }
      ]
    },

    "additional_fans": {
      "id": "additional_fans",
      "title": "Additional Fans",
      "state_prefix": "fans.additional_fans",
      "description": "Configure additional fans like Nevermore filters, RSCS, exhaust fans, etc.",
      "is_list": true,
      "item_template": {
        "fields": [
          {
            "id": "name",
            "type": "text",
            "label": "Fan Name",
            "state_key": "name",
            "help": "e.g., nevermore, rscs, exhaust"
          },
          {
            "id": "control_mode",
            "type": "choice",
            "label": "Control Mode",
            "state_key": "control_mode",
            "options": [
              { "value": "manual", "label": "Manual (fan_generic)" },
              { "value": "heater", "label": "Heater-controlled (heater_fan)" }
            ],
            "default": "manual"
          },
          {
            "id": "pin_type",
            "type": "choice",
            "label": "Pin Type",
            "state_key": "pin_type",
            "options": [
              { "value": "single", "label": "Single Pin" },
              { "value": "multi_pin", "label": "Multi-Pin (combined outputs)" }
            ],
            "default": "single"
          },
          {
            "id": "location",
            "type": "choice",
            "label": "Location",
            "state_key": "location",
            "options": [
              { "value": "mainboard", "label": "Mainboard" },
              { "value": "toolboard", "label": "Toolboard" }
            ],
            "default": "mainboard",
            "condition": "pin_type == 'single'"
          },
          {
            "id": "pin",
            "type": "port_select",
            "label": "Fan Port",
            "state_key": "pin",
            "port_type": "fan_ports",
            "condition": "pin_type == 'single'"
          },
          {
            "id": "multi_pin_name",
            "type": "text",
            "label": "Multi-Pin Group Name",
            "state_key": "multi_pin_name",
            "help": "Name for this multi-pin group (e.g., rscs_fans)",
            "condition": "pin_type == 'multi_pin'"
          },
          {
            "id": "pins",
            "type": "multi_port_select",
            "label": "Select Fan Ports",
            "state_key": "pins",
            "port_type": "fan_ports",
            "help": "Select multiple fan ports to combine",
            "condition": "pin_type == 'multi_pin'"
          },
          {
            "id": "max_power",
            "type": "float",
            "label": "Max Power (0.0-1.0)",
            "state_key": "max_power",
            "default": 1.0,
            "condition": "control_mode == 'manual'"
          },
          {
            "id": "shutdown_speed",
            "type": "float",
            "label": "Shutdown Speed (0.0-1.0)",
            "state_key": "shutdown_speed",
            "default": 0,
            "condition": "control_mode == 'manual'"
          },
          {
            "id": "kick_start_time",
            "type": "float",
            "label": "Kick Start Time (seconds)",
            "state_key": "kick_start_time",
            "default": 0.1
          },
          {
            "id": "off_below",
            "type": "float",
            "label": "Off Below (0.0-1.0)",
            "state_key": "off_below",
            "default": 0.1,
            "condition": "control_mode == 'manual'"
          },
          {
            "id": "heater",
            "type": "text",
            "label": "Heater to Monitor",
            "state_key": "heater",
            "default": "extruder",
            "condition": "control_mode == 'heater'"
          },
          {
            "id": "heater_temp",
            "type": "int",
            "label": "Turn On Temperature (C)",
            "state_key": "heater_temp",
            "default": 50,
            "condition": "control_mode == 'heater'"
          },
          {
            "id": "fan_speed",
            "type": "float",
            "label": "Fan Speed (0.0-1.0)",
            "state_key": "fan_speed",
            "default": 1.0,
            "condition": "control_mode == 'heater'"
          }
        ]
      }
    },

    "leds": {
      "id": "leds",
      "title": "LED Configuration",
      "state_prefix": "leds",
      "fields": [
        {
          "id": "enabled",
          "type": "bool",
          "label": "Enable LEDs",
          "state_key": "leds.enabled",
          "default": false
        },
        {
          "id": "type",
          "type": "choice",
          "label": "LED Type",
          "state_key": "leds.type",
          "options": [
            { "value": "neopixel", "label": "NeoPixel (WS2812)" },
            { "value": "dotstar", "label": "DotStar (APA102)" }
          ],
          "default": "neopixel",
          "condition": "leds.enabled"
        },
        {
          "id": "location",
          "type": "choice",
          "label": "Location",
          "state_key": "leds.location",
          "options": [
            { "value": "mainboard", "label": "Mainboard" },
            { "value": "toolboard", "label": "Toolboard", "condition": "mcu.toolboard.enabled" }
          ],
          "default": "mainboard",
          "condition": "leds.enabled"
        },
        {
          "id": "chain_count",
          "type": "int",
          "label": "Number of LEDs",
          "state_key": "leds.chain_count",
          "default": 1,
          "range": [1, 100],
          "condition": "leds.enabled"
        }
      ]
    },

    "temperature_sensors": {
      "id": "temperature_sensors",
      "title": "Temperature Sensors",
      "state_prefix": "temperature_sensors",
      "subsections": [
        {
          "id": "mcu_sensors",
          "title": "Built-in MCU Temperature Sensors",
          "fields": [
            {
              "id": "mcu_main_enabled",
              "type": "bool",
              "label": "Enable Main MCU Temperature",
              "state_key": "temperature_sensors.mcu_main.enabled",
              "default": true,
              "help": "Monitor main board MCU temperature"
            },
            {
              "id": "host_enabled",
              "type": "bool",
              "label": "Enable Host (RPi) Temperature",
              "state_key": "temperature_sensors.host.enabled",
              "default": true,
              "help": "Monitor Raspberry Pi CPU temperature"
            },
            {
              "id": "toolboard_enabled",
              "type": "bool",
              "label": "Enable Toolboard MCU Temperature",
              "state_key": "temperature_sensors.toolboard.enabled",
              "default": false,
              "condition": "mcu.toolboard.enabled",
              "help": "Monitor toolboard MCU temperature"
            }
          ]
        },
        {
          "id": "chamber",
          "title": "Chamber Temperature Sensor",
          "klipper_section": "[temperature_sensor chamber]",
          "fields": [
            {
              "id": "enabled",
              "type": "bool",
              "label": "Enable Chamber Sensor",
              "state_key": "temperature_sensors.chamber.enabled",
              "default": false
            },
            {
              "id": "sensor_type",
              "type": "choice",
              "label": "Sensor Type",
              "state_key": "temperature_sensors.chamber.sensor_type",
              "options": [
                { "value": "Generic 3950", "label": "Generic 3950 (NTC 100K)" },
                { "value": "NTC 100K beta 3950", "label": "NTC 100K beta 3950" },
                { "value": "ATC Semitec 104GT-2", "label": "ATC Semitec 104GT-2" },
                { "value": "ATC Semitec 104NT-4-R025H42G", "label": "ATC Semitec 104NT-4" },
                { "value": "PT1000", "label": "PT1000 (RTD)" },
                { "value": "DS18B20", "label": "DS18B20 (1-wire digital)" }
              ],
              "default": "Generic 3950",
              "condition": "temperature_sensors.chamber.enabled"
            },
            {
              "id": "sensor_location",
              "type": "choice",
              "label": "Sensor Location",
              "state_key": "temperature_sensors.chamber.sensor_location",
              "options": [
                { "value": "mainboard", "label": "Mainboard" },
                { "value": "rpi", "label": "Raspberry Pi GPIO" }
              ],
              "default": "mainboard",
              "condition": "temperature_sensors.chamber.enabled"
            },
            {
              "id": "sensor_port_mainboard",
              "type": "port_select",
              "label": "Thermistor Port",
              "state_key": "temperature_sensors.chamber.sensor_port_mainboard",
              "port_type": "thermistor_ports",
              "condition": "temperature_sensors.chamber.enabled and temperature_sensors.chamber.sensor_location == 'mainboard'"
            },
            {
              "id": "sensor_pin_rpi",
              "type": "text",
              "label": "GPIO Pin",
              "state_key": "temperature_sensors.chamber.sensor_pin_rpi",
              "default": "gpio4",
              "help": "GPIO pin for DS18B20 (e.g., gpio4)",
              "condition": "temperature_sensors.chamber.enabled and temperature_sensors.chamber.sensor_location == 'rpi'"
            },
            {
              "id": "pullup_resistor",
              "type": "choice",
              "label": "Pullup Resistor",
              "state_key": "temperature_sensors.chamber.pullup_resistor",
              "options": [
                { "value": "4700", "label": "4.7k ohm (standard)" },
                { "value": "2200", "label": "2.2k ohm (for PT1000)" },
                { "value": "10000", "label": "10k ohm" },
                { "value": "none", "label": "None (use board default)" }
              ],
              "default": "4700",
              "condition": "temperature_sensors.chamber.enabled and temperature_sensors.chamber.sensor_type != 'DS18B20'"
            }
          ]
        }
      ]
    },

    "additional_temp_sensors": {
      "id": "additional_temp_sensors",
      "title": "Additional Temperature Sensors",
      "state_prefix": "temperature_sensors.additional",
      "description": "Add custom temperature sensors (BME280, AHT10, additional thermistors, etc.)",
      "is_list": true,
      "item_template": {
        "fields": [
          {
            "id": "name",
            "type": "text",
            "label": "Sensor Name",
            "state_key": "name",
            "help": "e.g., enclosure, electronics_bay"
          },
          {
            "id": "type",
            "type": "choice",
            "label": "Sensor Type",
            "state_key": "type",
            "options": [
              { "value": "temperature_mcu", "label": "MCU Temperature" },
              { "value": "Generic 3950", "label": "Generic 3950 (NTC 100K)" },
              { "value": "NTC 100K beta 3950", "label": "NTC 100K beta 3950" },
              { "value": "PT1000", "label": "PT1000 (RTD)" },
              { "value": "DS18B20", "label": "DS18B20 (1-wire)" },
              { "value": "BME280", "label": "BME280 (I2C - temp/pressure/humidity)" },
              { "value": "AHT10", "label": "AHT10 (I2C - temp/humidity)" }
            ],
            "default": "Generic 3950"
          },
          {
            "id": "mcu",
            "type": "choice",
            "label": "MCU to Monitor",
            "state_key": "mcu",
            "options": [
              { "value": "mcu", "label": "Main MCU" },
              { "value": "toolboard", "label": "Toolboard" },
              { "value": "rpi", "label": "Raspberry Pi" }
            ],
            "default": "mcu",
            "condition": "type == 'temperature_mcu'"
          },
          {
            "id": "location",
            "type": "choice",
            "label": "Location",
            "state_key": "location",
            "options": [
              { "value": "mainboard", "label": "Mainboard" },
              { "value": "toolboard", "label": "Toolboard" },
              { "value": "rpi", "label": "Raspberry Pi" }
            ],
            "default": "mainboard",
            "condition": "type != 'temperature_mcu'"
          },
          {
            "id": "sensor_pin",
            "type": "text",
            "label": "Sensor Pin",
            "state_key": "sensor_pin",
            "help": "Pin for thermistor or 1-wire sensor",
            "condition": "type in ['Generic 3950', 'NTC 100K beta 3950', 'PT1000', 'DS18B20']"
          },
          {
            "id": "i2c_address",
            "type": "text",
            "label": "I2C Address",
            "state_key": "i2c_address",
            "default": "0x76",
            "help": "I2C address (BME280: 0x76 or 0x77, AHT10: 0x38)",
            "condition": "type in ['BME280', 'AHT10']"
          },
          {
            "id": "i2c_bus",
            "type": "text",
            "label": "I2C Bus",
            "state_key": "i2c_bus",
            "help": "e.g., i2c1_PB6_PB7 or i2c_rpi",
            "condition": "type in ['BME280', 'AHT10']"
          }
        ]
      }
    },

    "filament_sensors": {
      "id": "filament_sensors",
      "title": "Filament Sensors",
      "state_prefix": "filament_sensors",
      "subsections": [
        {
          "id": "runout",
          "title": "Runout Sensor",
          "fields": [
            {
              "id": "enabled",
              "type": "bool",
              "label": "Enable Runout Sensor",
              "state_key": "filament_sensors.runout.enabled",
              "default": false
            },
            {
              "id": "sensor_type",
              "type": "choice",
              "label": "Sensor Type",
              "state_key": "filament_sensors.runout.sensor_type",
              "options": [
                { "value": "switch", "label": "Switch (runout only)" },
                { "value": "motion", "label": "Motion (runout + jam detection)" }
              ],
              "default": "switch",
              "condition": "filament_sensors.runout.enabled",
              "help": "Switch sensors detect runout only. Motion sensors also detect jams/clogs."
            },
            {
              "id": "sensor_model",
              "type": "choice",
              "label": "Sensor Model",
              "state_key": "filament_sensors.runout.sensor_model",
              "options": [
                { "value": "btt_sfs_v1", "label": "BTT Smart Filament Sensor v1.0" },
                { "value": "btt_sfs_v2", "label": "BTT Smart Filament Sensor v2.0" },
                { "value": "biqu_motion", "label": "BIQU Filament Motion Sensor" },
                { "value": "generic_switch", "label": "Generic Microswitch Sensor" },
                { "value": "generic_optical", "label": "Generic Optical Sensor" },
                { "value": "custom", "label": "Custom / Other" }
              ],
              "default": "generic_switch",
              "condition": "filament_sensors.runout.enabled"
            },
            {
              "id": "location",
              "type": "choice",
              "label": "Location",
              "state_key": "filament_sensors.runout.location",
              "options": [
                { "value": "mainboard", "label": "Mainboard" },
                { "value": "toolboard", "label": "Toolboard" }
              ],
              "default": "mainboard",
              "condition": "filament_sensors.runout.enabled"
            },
            {
              "id": "pin",
              "type": "port_select",
              "label": "Sensor Pin",
              "state_key": "filament_sensors.runout.pin",
              "port_type": "endstop_ports",
              "condition": "filament_sensors.runout.enabled"
            },
            {
              "id": "pin_pullup",
              "type": "bool",
              "label": "Enable Pullup Resistor",
              "state_key": "filament_sensors.runout.pin_pullup",
              "default": true,
              "condition": "filament_sensors.runout.enabled",
              "help": "Enable internal pullup resistor (^PIN)"
            },
            {
              "id": "pin_invert",
              "type": "bool",
              "label": "Invert Pin Logic",
              "state_key": "filament_sensors.runout.pin_invert",
              "default": false,
              "condition": "filament_sensors.runout.enabled",
              "help": "Invert pin signal (!PIN)"
            },
            {
              "id": "detection_length",
              "type": "float",
              "label": "Detection Length (mm)",
              "state_key": "filament_sensors.runout.detection_length",
              "default": 7.0,
              "condition": "filament_sensors.runout.enabled and filament_sensors.runout.sensor_type == 'motion'",
              "help": "Filament movement threshold before triggering jam detection"
            },
            {
              "id": "pause_on_runout",
              "type": "bool",
              "label": "Pause on Runout",
              "state_key": "filament_sensors.runout.pause_on_runout",
              "default": true,
              "condition": "filament_sensors.runout.enabled"
            }
          ]
        }
      ]
    },

    "input_shaper": {
      "id": "input_shaper",
      "title": "Input Shaper",
      "state_prefix": "input_shaper",
      "klipper_section": "[input_shaper]",
      "subsections": [
        {
          "id": "config",
          "title": "Input Shaper Configuration",
          "fields": [
            {
              "id": "enabled",
              "type": "bool",
              "label": "Enable Input Shaper",
              "state_key": "input_shaper.enabled",
              "default": false,
              "help": "Reduces ringing/ghosting artifacts on prints"
            },
            {
              "id": "shaper_type_x",
              "type": "choice",
              "label": "Shaper Type X",
              "state_key": "input_shaper.shaper_type_x",
              "options": [
                { "value": "mzv", "label": "MZV (recommended)" },
                { "value": "ei", "label": "EI" },
                { "value": "2hump_ei", "label": "2-hump EI" },
                { "value": "3hump_ei", "label": "3-hump EI" },
                { "value": "zv", "label": "ZV" },
                { "value": "zvd", "label": "ZVD" }
              ],
              "default": "mzv",
              "condition": "input_shaper.enabled"
            },
            {
              "id": "shaper_freq_x",
              "type": "float",
              "label": "Shaper Frequency X (Hz)",
              "state_key": "input_shaper.shaper_freq_x",
              "default": 0,
              "condition": "input_shaper.enabled",
              "help": "Run resonance test to determine"
            },
            {
              "id": "damping_ratio_x",
              "type": "float",
              "label": "Damping Ratio X",
              "state_key": "input_shaper.damping_ratio_x",
              "default": 0.1,
              "condition": "input_shaper.enabled"
            },
            {
              "id": "shaper_type_y",
              "type": "choice",
              "label": "Shaper Type Y",
              "state_key": "input_shaper.shaper_type_y",
              "options": [
                { "value": "mzv", "label": "MZV (recommended)" },
                { "value": "ei", "label": "EI" },
                { "value": "2hump_ei", "label": "2-hump EI" },
                { "value": "3hump_ei", "label": "3-hump EI" },
                { "value": "zv", "label": "ZV" },
                { "value": "zvd", "label": "ZVD" }
              ],
              "default": "mzv",
              "condition": "input_shaper.enabled"
            },
            {
              "id": "shaper_freq_y",
              "type": "float",
              "label": "Shaper Frequency Y (Hz)",
              "state_key": "input_shaper.shaper_freq_y",
              "default": 0,
              "condition": "input_shaper.enabled",
              "help": "Run resonance test to determine"
            },
            {
              "id": "damping_ratio_y",
              "type": "float",
              "label": "Damping Ratio Y",
              "state_key": "input_shaper.damping_ratio_y",
              "default": 0.1,
              "condition": "input_shaper.enabled"
            }
          ]
        },
        {
          "id": "accelerometer",
          "title": "Accelerometer",
          "fields": [
            {
              "id": "accel_chip",
              "type": "choice",
              "label": "Accelerometer Type",
              "state_key": "input_shaper.accel_chip",
              "options": [
                { "value": "none", "label": "None / Not configured" },
                { "value": "adxl345", "label": "ADXL345" },
                { "value": "lis2dw", "label": "LIS2DW" },
                { "value": "mpu9250", "label": "MPU9250 / MPU6050" }
              ],
              "default": "none"
            },
            {
              "id": "accel_location",
              "type": "choice",
              "label": "Accelerometer Location",
              "state_key": "input_shaper.accel_location",
              "options": [
                { "value": "mainboard", "label": "Mainboard SPI" },
                { "value": "toolboard", "label": "Toolboard SPI" },
                { "value": "rpi", "label": "Raspberry Pi SPI" }
              ],
              "default": "toolboard",
              "condition": "input_shaper.accel_chip != 'none'"
            },
            {
              "id": "cs_pin",
              "type": "text",
              "label": "CS Pin",
              "state_key": "input_shaper.cs_pin",
              "help": "Chip select pin for SPI accelerometer",
              "condition": "input_shaper.accel_chip != 'none' and input_shaper.accel_location != 'rpi'"
            },
            {
              "id": "spi_bus",
              "type": "text",
              "label": "SPI Bus",
              "state_key": "input_shaper.spi_bus",
              "help": "e.g., spi1, spidev0.0",
              "condition": "input_shaper.accel_chip != 'none'"
            }
          ]
        }
      ]
    },

    "tuning": {
      "id": "tuning",
      "title": "Tuning & Features",
      "state_prefix": "tuning",
      "fields": [
        {
          "id": "kalico_enabled",
          "type": "bool",
          "label": "Using Kalico (Klipper fork)",
          "state_key": "tuning.kalico_enabled",
          "default": false,
          "help": "Enables Kalico-specific features like MPC temperature control"
        }
      ]
    }
  },

  "conflicts": {
    "pin_conflicts": {
      "type": "dynamic",
      "handler": "PinManager",
      "description": "Pin conflicts are detected at runtime by PinManager"
    },

    "logical_conflicts": [
      {
        "id": "eddy_probe_preheat_warning",
        "type": "warning",
        "condition": "probe.probe_type == 'beacon' and probe.homing_mode == 'contact' and macros.extruder_preheat_temp >= probe.contact_max_hotend_temperature - 5",
        "message": "Preheat temp is too close to Beacon contact limit. PID overshoot may cause probing rejection."
      },
      {
        "id": "qgl_requires_4_motors",
        "type": "error",
        "condition": "bed_leveling.leveling_type == 'qgl' and stepper_z.z_motor_count != 4",
        "message": "Quad Gantry Level requires exactly 4 Z motors."
      },
      {
        "id": "z_tilt_requires_2_3_motors",
        "type": "error",
        "condition": "bed_leveling.leveling_type == 'z_tilt' and (stepper_z.z_motor_count < 2 or stepper_z.z_motor_count > 3)",
        "message": "Z Tilt Adjust requires 2 or 3 Z motors."
      },
      {
        "id": "sensorless_needs_stallguard",
        "type": "error",
        "condition": "stepper_x.endstop_type == 'sensorless' and stepper_x.driver_type not in ['TMC2209', 'TMC2240', 'TMC5160']",
        "message": "Sensorless homing requires a TMC driver with StallGuard support."
      },
      {
        "id": "toolboard_features_need_toolboard",
        "type": "error",
        "condition": "(extruder.location == 'toolboard' or fans.part_cooling.location == 'toolboard') and not mcu.toolboard.enabled",
        "message": "Toolboard features require a toolboard to be enabled."
      }
    ]
  },

  "implications": {
    "probe_type_tap": {
      "condition": "probe.probe_type == 'tap'",
      "set": {
        "probe.x_offset": 0,
        "probe.y_offset": 0
      }
    },
    "probe_type_beacon_contact": {
      "condition": "probe.probe_type == 'beacon' and probe.homing_mode == 'contact'",
      "set": {
        "homing.homing_method": "beacon_contact"
      }
    },
    "probe_type_beacon_proximity": {
      "condition": "probe.probe_type == 'beacon' and probe.homing_mode == 'proximity'",
      "set": {
        "homing.homing_method": "safe_z_home"
      }
    },
    "probe_type_cartographer_touch": {
      "condition": "probe.probe_type == 'cartographer' and probe.homing_mode == 'touch'",
      "set": {
        "homing.homing_method": "cartographer_touch"
      }
    },
    "probe_type_cartographer_scan": {
      "condition": "probe.probe_type == 'cartographer' and probe.homing_mode == 'scan'",
      "set": {
        "homing.homing_method": "safe_z_home"
      }
    },
    "kinematics_awd": {
      "condition": "printer.kinematics == 'corexy-awd'",
      "set": {
        "printer.awd_enabled": true
      }
    }
  }
}
