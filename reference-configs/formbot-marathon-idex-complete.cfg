################################################################################
# FORMBOT MARATHON IDEX - COMPLETE SINGLE-FILE KLIPPER CONFIGURATION
################################################################################
#
# This is a comprehensive, standalone IDEX (Independent Dual Extruder) Klipper 
# configuration compiled from Formbot's official Marathon config. All includes 
# have been expanded into this single file for reference purposes.
#
# SOURCE: https://github.com/FORMBOT/Marathon_UpdateManager
# COMPILED: January 2026
# PRINTER: Formbot Marathon IDEX
#
# HARDWARE CONFIGURATION:
# - Control Board: BigTreeTech Manta M8P v1.1
# - Kinematics: Cartesian IDEX
# - Build Volume: 400 x 300 x 300mm
# - Max Velocity: 500mm/s
# - Max Accel: 15000mm/s²
# - Dual Independent X Carriages with copy/mirror modes
# - Extruder 0 & 1: Independent toolheads
# - Heated Bed: 400x300mm
# - Z-Probe: Inductive probe
# - 3-point Z-tilt leveling
#
# KEY IDEX FEATURES:
# - Independent dual X carriages with [dual_carriage] section
# - Tool change macros (T0/T1) with automatic parking
# - COPY mode for duplicate prints
# - MIRROR mode for mirrored prints
# - Independent input shaper settings per toolhead
# - XY offset calibration for T1
# - Bed mesh leveling (6x6)
# - Z-tilt compensation (3-point)
#
# IMPORTANT NOTES:
# - Update MCU serial path in BTT M8P section to match your system
# - Calibrate XY offsets for T1 using XY_Offset_T1 macro
# - Calibrate Z-offset for probe
# - Test tool changes and IDEX modes at low speed initially
# - Verify dual_carriage positions match your printer
#
# SAFETY:
# - Max extruder temp: varies by sensor config
# - Test homing and dual carriage movement carefully
# - Ensure both toolheads clear the bed and each other
# - Verify safe X positions for both carriages
#
################################################################################


################################################################################
### CONTROL BOARD - BigTreeTech Manta M8P v1.1
################################################################################

##############################################
# Expansion Headers BTT Manta M8P V1.1
##############################################
[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE9, EXP1_2=PE10,
    EXP1_3=PE11, EXP1_4=PE12,
    EXP1_5=PE13, EXP1_6=PE14,    # Slot in the socket on this side
    EXP1_7=PE15, EXP1_8=PB10,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PB14, EXP2_2=PB13,
    EXP2_3=PF7, EXP2_4=PB12,
    EXP2_5=PE7, EXP2_6=PB11,      # Slot in the socket on this side
    EXP2_7=PE8, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<NC>

# See the sample-lcd.cfg file for definitions of common LCD displays.


################################################################################
### MARATHON VARIABLES
################################################################################

#####################################################################
#Variables Marathon
#####################################################################

[gcode_macro _MARATHON_VARIABLES] 
variable_sp_tch:     35000  # Speed tool change
variable_x_cop:      198    # X position mirrored Carriage
variable_x_mir:      433    # X position mirrored Carriage
variable_mesh_tmp:   70     # Bed temp for Bed meshing
variable_fil_uld:   -60     # mm Fil unload display Macro
variable_fil_ld:     80     # mm Fil load display Macro
variable_tmp_ld:     235    # temp Fil load display Macro
variable_tmp_uld:    185    # temp Fil unload display Macro
gcode:


################################################################################
### PRINTER SPECS (Kinematics, Limits, Probe, Mesh, Z-Tilt)
################################################################################

##################################
# Specs Marathon 1
##################################

[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 15000 
max_z_velocity: 10
max_z_accel: 100
square_corner_velocity: 5.0

##################################
# Folder to save variables
##################################

[save_variables]
filename:  ~/printer_data/config/variables.cfg

##################################
# Z Stepper Align
##################################

[z_tilt]
z_positions: -32.2, -3.25
               216, 383.45           
              472.8, -3.25
              

points: 80, 20
        216, 280        
        358, 20
       

speed: 230
horizontal_move_z: 7
retries: 5
retry_tolerance: 0.02

##################################
# Bed Mesh
##################################

[bed_mesh]
speed: 230
horizontal_move_z: 10
mesh_min: 30, 0
mesh_max: 358, 285.5         
probe_count: 6, 6
mesh_pps: 3, 3
algorithm: bicubic 
bicubic_tension: 0.2
move_check_distance: 5
split_delta_z: .025
fade_start: 1
fade_end: 10
fade_target: 0

##################################
# Z Probe 
##################################

[probe]
pin: PC0
x_offset: 0
y_offset: -18.5
speed: 7
samples: 3
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.02
samples_tolerance_retries: 10
lift_speed: 10

##################################
# Force Move 
##################################

[force_move]
enable_force_move: True

##################################
# Homming Override
##################################

[homing_override]
axes: z
gcode:
      G90
      SET_KINEMATIC_POSITION Z=0
      G0 Z5 F600
      M204 S500 
      G28 X
      G28 Y
      T0
      G1 X216 Y149 F8000           
      G28 Z
      G1 Z5
      M204 S3000 

##################################
# Support SDCard looping
##################################

[sdcard_loop]

##################################
# Exclude Objects
##################################

[exclude_object]

##################################
# Enable skew correction
##################################

[skew_correction] 

##################################
# Enable arcs support
##################################

[gcode_arcs]
resolution: 0.3

##################################
# Input shaper setup
#################################

[input_shaper]
# Intentionally empty

#[resonance_tester]
#accel_chip:adxl345 T0 # for T1: adxl345 T1
#probe_points:
      #  117.5, 147.5, 20  # 117.5, 147.5, 20 for Mirror/Duplicate

##################################
# Temperature Sensors
##################################

[temperature_sensor Mainboard]
sensor_type: temperature_mcu
sensor_mcu: mcu

[temperature_sensor Host]
sensor_type: temperature_host


################################################################################
### X1 AXIS (Primary X Carriage - Stepper)
################################################################################

##################################
# Axis X -- Carriage T0
##################################

[stepper_x]
step_pin: PE2                               #BTT M8P V1.1
dir_pin: !PB4                               #BTT M8P V1.1
enable_pin: !PC11                           #BTT M8P V1.1
microsteps: 128
rotation_distance: 31.96                    #Califlower Calibration https://www.printables.com/model/682023-califlower-calibration-stl-calculator                    
endstop_pin:~PF3
position_endstop: 0   
position_max: 359  
position_min: -1 
homing_speed: 130
homing_retract_dist: 5.0
homing_retract_speed: 50
second_homing_speed: 10

[tmc2209 stepper_x]
uart_pin: PC10                              #BTT M8P V1.1
diag_pin: PF3                               #BTT M8P V1.1 
run_current: 0.90
interpolate: false
hold_current: 0.500
sense_resistor: 0.11 
stealthchop_threshold: 0
driver_TBL: 0
driver_HEND: 6
driver_HSTRT: 7
driver_TOFF: 4


################################################################################
### X2 AXIS (Secondary X Carriage - Dual Carriage)
################################################################################

################################
# Axis X1 -- Carriage T1
##################################

[dual_carriage]                             
axis: x
step_pin: PF12                                  #BTT M8P V1.1
dir_pin: !PF11                                  #BTT M8P V1.1
enable_pin: !PB3                                #BTT M8P V1.1
microsteps: 128
rotation_distance: 31.96 
endstop_pin:~PF4
position_endstop: 433                           #Califlower Calibration https://www.printables.com/model/682023-califlower-calibration-stl-calculator   
position_max: 434  
position_min: 75  
homing_speed: 130
homing_retract_dist: 5.0
homing_retract_speed: 50
second_homing_speed: 10

[tmc2209 dual_carriage]
uart_pin: PF13                                 #BTT M8P V1.1
diag_pin: PF4                                  #BTT M8P V1.1
run_current: 0.90
interpolate: false
hold_current: 0.500
sense_resistor: 0.11 #**
stealthchop_threshold: 0
driver_TBL: 0
driver_HEND: 6
driver_HSTRT: 7
driver_TOFF: 4


################################################################################
### Y AXIS
################################################################################

##################################
# Axis Y --
#################################

[stepper_y]
step_pin: PD7                       #BTT M8P V1.1
dir_pin: !PD6                       #BTT M8P V1.1
enable_pin: !PF10                   #BTT M8P V1.1
microsteps: 128
rotation_distance: 39.92            #Califlower Calibration https://www.printables.com/model/682023-califlower-calibration-stl-calculator
endstop_pin: ~PF5                   #BTT M8P V1.1
position_endstop: 307
position_max: 308
position_min: 0
homing_speed: 130
homing_retract_dist: 5.0
homing_retract_speed: 50
second_homing_speed: 10

[tmc2209 stepper_y]
uart_pin: PF9                      #BTT M8P V1.1
diag_pin: PF5                      #BTT M8P V1.1
run_current: 1.5
interpolate: false
hold_current: 0.4
stealthchop_threshold: 999999


################################################################################
### Z AXIS (3 Motors for Z-Tilt)
################################################################################

##################################
# Z Axis -- 3 Steppers
##################################

[stepper_z]                                 #Stepper Left
step_pin: PD3                               #BTT M8P V1.1
dir_pin: !PD2                               #BTT M8P V1.1 
enable_pin: !PD5                            #BTT M8P V1.1
microsteps: 128
rotation_distance: 4
endstop_pin: probe:z_virtual_endstop
#position_endstop: 0
position_max: 290
position_min: -5
homing_speed: 10
homing_retract_dist: 5.0
homing_retract_speed: 5
second_homing_speed: 5

[tmc2209 stepper_z]
uart_pin: PD4                              #BTT M8P V1.1
run_current: 0.8
stealthchop_threshold: 999999

[stepper_z1]                                #Stepper Back
step_pin: PC9                               #BTT M8P V1.1
dir_pin: !PC8                               #BTT M8P V1.1
enable_pin: !PD1                            #BTT M8P V1.1
microsteps: 128
rotation_distance: 4

[tmc2209 stepper_z1]
uart_pin: PD0                               #BTT M8P V1.1
run_current: 0.8
stealthchop_threshold: 999999

[stepper_z2]                                #Stepper Right
step_pin: PA10                              #BTT M8P V1.1
dir_pin: !PA14                              #BTT M8P V1.1
enable_pin: !PA15                           #BTT M8P V1.1
microsteps: 128
rotation_distance: 4

[tmc2209 stepper_z2]
uart_pin: PF8                               #BTT M8P V1.1
run_current: 0.8
stealthchop_threshold: 999999


################################################################################
### EXTRUDER T0 (Primary Toolhead)
################################################################################

##################################
# extruder--Carriage T0
##################################

[extruder]
step_pin: PD11                               #BTT M8P V1.1
dir_pin: PD9                                 #BTT M8P V1.1
enable_pin: !PD15                            #BTT M8P V1.1

microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 4.637
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_only_distance: 500
max_extrude_only_velocity: 120
pressure_advance: 0.025 
pressure_advance_smooth_time: 0.03 

heater_pin: PE3                             #BTT M8P V1.1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA1                             #BTT M8P V1.1
min_temp: 0                                 
max_temp: 330
min_extrude_temp:180

[verify_heater extruder]
check_gain_time: 40
hysteresis: 5

[tmc2209 extruder]
uart_pin: PD14                              #BTT M8P V1.1
run_current: 0.7
interpolate: true
hold_current: 0.100
sense_resistor: 0.11 
stealthchop_threshold: 0
driver_TBL: 0
driver_HEND: 6
driver_HSTRT: 7
driver_TOFF: 4


[fan_generic Tool_0_partfan]
pin: PE6                                    #BTT M8P V1.1

[heater_fan hotend_T0_fan]
pin: PE0                                    #BTT M8P V1.1
heater: extruder
heater_temp: 50.0


################################################################################
### EXTRUDER T1 (Secondary Toolhead)
################################################################################

##################################
# extruder1--Carriage T1
##################################

[extruder1]
step_pin: PD8                               #BTT M8P V1.1
dir_pin: PC6                                #BTT M8P V1.1
enable_pin: !PC7                            #BTT M8P V1.1

microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 4.637
nozzle_diameter: 0.400 
filament_diameter: 1.750
max_extrude_only_distance: 500
max_extrude_only_velocity: 120
pressure_advance: 0.025 
pressure_advance_smooth_time: 0.03 

heater_pin: PB5                             #BTT M8P V1.1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA2                             #BTT M8P V1.1
min_temp: 0
max_temp: 330
min_extrude_temp:180

[verify_heater extruder1]
check_gain_time: 40
hysteresis: 5


[tmc2209 extruder1]
uart_pin: PD10                             #BTT M8P V1.1                          
run_current: 0.7
interpolate: true
hold_current: 0.100
sense_resistor: 0.11
stealthchop_threshold: 0
driver_TBL: 0
driver_HEND: 6
driver_HSTRT: 7
driver_TOFF: 4

[fan_generic Tool_1_partfan]
pin: PC12                                   #BTT M8P V1.1

[heater_fan hotend_T1_fan]
pin: PE5                                    #BTT M8P V1.1
heater: extruder1
heater_temp: 50.0


################################################################################
### T0 TEMPERATURE SENSORS & FANS
################################################################################

#################################################################################################################
################################# Orbiter Sensor CONFIGURATION ##################################################
#################################################################################################################

#### CONFIG BASED ON THE OFICIAL ORBITER SENSOR Config ( OrbiterSensorV2.2.03.cfg). https://www.orbiterprojects.com/orbiter-filament-sensor/  ####
                          #### Many Thanks to Dr. Róbert Lőrincz for this great project !!! ###

#########Setting Up For More Tools##################

# 'n' is the tool number begining with 0

#1. Copy the Confing and change the name of the config: 'Tn_OrbiterSensor.cfg'
#2. Overall in the config: replace 'T0' with 'Tn'
#3. Overall in the config: replace 't0' with 'tn'
#4. Overall in the config: replace 'filament_change_state1' with 'filament_change_state1n'
#5. Overall in the config: replace 'filament_change_state2' with 'filament_change_state2n'
#6. Overall in the config: replace  'extruder' with 'extrudern' 
#7. Give the corresponding pin for 'filament_tn_sense' and 'filament_unload_tn'
#8. Insert the config in 'printer.cfg': [include Tn_OrbiterSensor.cfg]

### !!! For Filament Runout Function to work M600 macro and apropriate RESUME macro are needed !!! ###

#################################################################################################################
################################# CHANGE HERE MACRO CONFIGURABLES################################################
#################################################################################################################

[gcode_macro _SENSOR_t0_VARIABLES]         # change here macro configurables, enable disable functions!*************************
variable_t0_load_temp             :235    # temperature to heat up hotend for filament loading, default is 235
variable_t0_unload_temp           :185    # temperature to heat up hotend for filament un-loading, default is 185
variable_t0_load_min_temp         :190    # minimum hotend set temperature allowed in filament load macro, default is 190
variable_t0_purge_length          :80    # filament extrude amount during load sequenc, hotend purge from old filament, default is 200
variable_t0_purge_speed           :450    # filament extrude speed in mm/min adjust this value lower if flow is too high and extruder skips during loading, default is 300
variable_t0_unload_distance       :65     # filament retract distance for unload procedure. this length shall be long enough to extract the filament above the drive gears
variable_t0_disable_autoload      :False  # disable filament autoload feature by setting this variable True
variable_t0_disable_runnout       :False  # disable runnout by setting this variable True
variable_t0_autounload            :False  # disable auto unload filament by setting this variable to True
variable_t0_enable_beep           :False   # uses M300 sound feature, set it True to enable
gcode:

#///////////////////////////filament sensor button macros/////////////////////////////////////////////////
[gcode_button filament_t0_sense]
pin: !PC2 # remove the negation "!" for sensor v1 - use just PA9 as example
press_gcode: # sensor released  -runnout detected!
  ACTIVATE_EXTRUDER EXTRUDER=extruder
  runnout_init_t0
release_gcode: #gcode macro for filament auto-load, sensor pressed
  ACTIVATE_EXTRUDER EXTRUDER=extruder
  startload_t0
#********************************************************************************************************

#////////////////////////////////////////Filament Unload macros/////////////////////////////////////////////////
[gcode_button filament_unload_t0]
pin: !PC1 # remove the negation "!" for sensor v1 - use just PA9 as example
release_gcode:  # filament unload procedure
  ACTIVATE_EXTRUDER EXTRUDER=extruder
  startunload_t0
press_gcode: # do not add any macro call here

#################################################################################################################################
####################################### DO NOT CHANGE ANYTHING BELOW THIS LINE!!! ###############################################
#################################################################################################################################
####################################### UNLESS YOU KNOW WHAT YOU ARE DOING OR YOU ARE BORED AND NEED TO DO SOMETHING OR YOU ARE ALONE AND NEED SOMETHING TO MESS UP YOUR LIFE OR YOU CAN DO IT BETTER THAN ME OR YOU ARE A REAL SMARTASS OR JUST BECAUSE YOU CAN OR YOU RUN OUT OF BEAR OR HAS NOTHING BETTER TO DO OR ANY UNREASONABLE REASON
#################################################################################################################################

[respond]
default_type: echo

[force_move]
enable_force_move: True

[gcode_macro runnout_init_t0]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}  
  {% if (printer.print_stats.state == "printing") %}      
    {% if(sensor.t0_disable_runnout|lower == 'false') %}
    filament_change_state1
    {% else %}
    M118 Filament T0 runnout is disabled in the sensor config file!   
    {% endif %}     
  {% endif %} 
  UPDATE_DELAYED_GCODE ID=clear_loadt0busy DURATION=2
  UPDATE_DELAYED_GCODE ID=clear_unloadt0busy DURATION=2    
  SET_GCODE_VARIABLE MACRO=filament_unload_t0 VARIABLE=filamentt0present VALUE=0

[gcode_macro filament_change_state1]
variable_changebusy: 0
variable_temp_target: 0
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}  
  {% if changebusy == 0 %}
    M600
    SET_GCODE_VARIABLE MACRO=filament_change_state1 VARIABLE=changebusy VALUE=1       
    M118 Filament T0 runnout detected!       
    filament_change_state2     # comment this line if you do not want to automatically unload filament in case there is a runnout detected.
  {% else %}
  {% endif %}

[gcode_macro filament_change_state2]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}  
  SET_GCODE_VARIABLE MACRO=filament_load_t0 VARIABLE=loadt0busy VALUE=1      
  {% if (sensor.t0_enable_beep|lower == 'true') %} 
    M300 # beep sound
  {% endif %}
  M118 Unloading T0 filament...   
  M83
  G92 E0   
  # {% if printer[printer.toolhead.extruder].temperature < 185 %} # hardcoded threshold
  {% if (printer.extruder.can_extrude|lower != 'true')%} # checking for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder config (to about 185)
      M118 Hotend T0 heating!        
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={sensor.t0_unload_temp} # restore user temp if it was set before loading
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={sensor.t0_unload_temp} #wait for reaching filament unload temp
      {% endif %}     
  {% if(printer.extruder.target == 0) %} # checing for set temperature if is zero than set to 200 / hotend hot but cooling due to set target temp 0
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={sensor.t0_unload_temp} # restore user temp if it was set before loading
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={sensor.t0_unload_temp} #wait for reaching filament unload temp
  {% endif %} 
  G0 E-5 F3600 	#extract filament to cold end
  G4 P2000 # wait for two seconds
  G0 E5 F3600 # push the filament back 
  G0 E-5 F3600 	#extract filament to cold end
  G0 E-{sensor.t0_unload_distance} F300	# continue extraction slow allow filament to be cooled enough before reaches the gears  
  M400   
  M118 Load new T0 filament! Wait until is loaded, then resume printing.  
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0 # swicth off heater
  UPDATE_DELAYED_GCODE ID=clear_loadt0busy DURATION=2.5 # timing must be set to clear delay plus 0.5s. is due to wait to remove filament before starting load even in case there is a blob at the tip of the extracted filament which woudl trigger the sensor twice

#############################################END filament auto load macro section END***********************************************************

[gcode_macro startload_t0]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}
  {% if (printer.print_stats.state != "printing") %}
    {% if(sensor.t0_disable_autoload|lower == 'false') %}
      filament_load_t0
    {% else %}
    M118 Filament T0 auto-load is disabled in the sensor config file!   
    {% endif %} 
  {% else %}    
    M118 Printing! Can't load T0 filament right now!    
  {% endif %} 
  SET_GCODE_VARIABLE MACRO=filament_unload_t0 VARIABLE=filamentt0present VALUE=1
  UPDATE_DELAYED_GCODE ID=clear_changebusy DURATION=2  

[gcode_macro filament_load_t0]
variable_loadt0busy: 0
variable_USER_TEMP: 0
variable_LOAD_TEMP: 0
gcode:
    ACTIVATE_EXTRUDER EXTRUDER=extruder    
    {% set sensor = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}
    {% if loadt0busy == 0 %} # requires [virtual_sdcard] 
      SET_GCODE_VARIABLE MACRO=filament_load_t0 VARIABLE=loadt0busy VALUE=1
      SET_GCODE_VARIABLE MACRO=filament_unload_t0 VARIABLE=unloadt0busy VALUE=1    
      {% set USER_TEMP = printer.extruder.target %} # save user set temperature before loading
      {% set LOAD_TEMP = 0 %} 
      #M118 USER TEMP {USER_TEMP}      # echo back for debug only      
        {% if (printer.extruder.can_extrude|lower != 'true') or (printer.extruder.target < sensor.t0_load_min_temp) %} # checking for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder config (to about 185)                        
          SET_HEATER_TEMPERATURE HEATER=extruder TARGET={sensor.t0_load_temp} # set user defined load temperature
          {% set LOAD_TEMP = sensor.t0_load_temp %} # save user set temperature before loading           
         M118 Hotend T0 heating! 
      {% endif %}     
    {% if (sensor.t0_enable_beep|lower == 'true') %} 
      M300 # beep sound
    {% endif %}
    M118 Filament T0 loading!  
    M82           #set extruder to absolute mode
    G92 E0
    G4 P1500        # wait for 1.5 seconds
    FORCE_MOVE STEPPER=extruder DISTANCE=15 VELOCITY=10 ACCEL=1000  # load filament inside the gears force move needs to be enabled    
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={LOAD_TEMP} # wait for reaching set temperature    
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={USER_TEMP} # wait for reaching set temperature    
    G1 E{sensor.t0_purge_length} F{sensor.t0_purge_speed} # extrude preconfigured purge length
    M400 # wait to complete nozzle purge
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={USER_TEMP} # restore user temp if it was set before loading
    M118 Filament T0 load complete!    
    UPDATE_DELAYED_GCODE ID=clear_unloadt0busy DURATION=2   
    {% else %}
      M118 Filament T0 already loaded!    
    {% endif %}  
#############################################END filament auto load macro section END***********************************************************

#############################################filament auto unload macro section*****************************************************************
[gcode_macro startunload_t0]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}
  {% if (printer.print_stats.state != "printing") %}
    {% if(sensor.t0_autounload|lower == 'false') %}
      filament_unload_t0
    {% else %}
      M118 Filament T0 auto-unload is disabled in the sensor config file!   
    {% endif %} 
  {% else %}   
     M118 Printing! Can't unload T0 filament right now!
  {% endif %}

[gcode_macro filament_unload_t0] 
variable_unloadt0busy: 0
variable_filamentt0present: 0
gcode:
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    {% set sensor = printer['gcode_macro _SENSOR_t0_VARIABLES'] %}
    {% if unloadt0busy == 0 %} # requires [virtual_sdcard]  
      SET_GCODE_VARIABLE MACRO=filament_unload_t0 VARIABLE=unloadt0busy VALUE=1
      SET_GCODE_VARIABLE MACRO=filament_load_t0 VARIABLE=loadt0busy VALUE=1
      {% if (sensor.t0_enable_beep|lower == 'true') %} 
        M300 # beep sound
      {% endif %}
      M118 Filament T0 unloading!    
      M83
      G92 E0 
      # {% if (printer.extruder.can_extrude|lower != 'true') or (printer.extruder.target == 0)%} # checing for minimum extrusion temperature
      {% if (printer.extruder.can_extrude|lower != 'true')%} # checing for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder config (to about 185)
        M118 Hotend heating!          
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={sensor.t0_unload_temp} # restore user temp if it was set before loading
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={sensor.t0_unload_temp} # wait for reaching configured unload temperature
      {% endif %}
      {% if(printer.extruder.target == 0) %} # checing for set temperature if is zero than set to 185 / hotend hot but cooling due to set target temp 0
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={sensor.t0_unload_temp} # wait for reaching configured unload temperature
      {% endif %}
      G0 E10 F500 # extruder 20mm of filament before extracting 
      G0 E-5 F3600 	#extract filament to cold end
      G4 P2000 # wait for two seconds
      G0 E6 F3600 # push the filament back 
      G0 E-10 F3600 	#extract filament to cold end
      G0 E-{sensor.t0_unload_distance} F300	# continue extraction slow allow filament to be cooled enough before reaches the gears  
      M104 S0 T0 
      M400 # wait to complete unload
      M118 Filament T0 unload complete!      
      SET_GCODE_VARIABLE MACRO=filament_load_t0 VARIABLE=loadt0busy VALUE=0     
    {% else %}      
      M118 Nothing to unload from T0!
    {% endif %}

#############################################END filament auto unload macro section END***********************************************************

[delayed_gcode clear_unloadt0busy]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_unload_t0 VARIABLE=unloadt0busy VALUE=0
  #M118 Clear Unload busy! 

[delayed_gcode clear_changebusy]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_change_state1 VARIABLE=changebusy VALUE=0
  #M118 Clear Load busy!  

[delayed_gcode set_loadt0busy]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_load_t0 VARIABLE=loadt0busy VALUE=1
  #M118 Set Load busy! 

[delayed_gcode clear_loadt0busy]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_load_t0 VARIABLE=loadt0busy VALUE=0
  #M118 Clear Load busy!


################################################################################
### T1 TEMPERATURE SENSORS & FANS
################################################################################

#################################################################################################################
################################# Orbiter Sensor CONFIGURATION ##################################################
#################################################################################################################

#### CONFIG BASED ON THE OFICIAL ORBITER SENSOR Config ( OrbiterSensorV2.2.03.cfg). https://www.orbiterprojects.com/orbiter-filament-sensor/  ####
                          #### Many Thanks to Dr. Róbert Lőrincz for this great project !!! ###

#########Setting Up For More Tools##################

# 'n' is the tool number begining with 0

#1. Copy the Confing and change the name of the config: 'Tn_OrbiterSensor.cfg'
#2. Overall in the config: replace 'T1' with 'Tn'
#3. Overall in the config: replace 't1' with 'tn'
#4. Overall in the config: replace 'filament_change_state11' with 'filament_change_state1n'
#5. Overall in the config: replace 'filament_change_state21' with 'filament_change_state2n'
#6. Overall in the config: replace  'extruder1' with 'extruder1n' 
#7. Give the corresponding pin for 'filament_tn_sense' and 'filament_unload_tn'
#8. Insert the config in 'printer.cfg': [include Tn_OrbiterSensor.cfg]

### !!! For Filament Runout Function to work M600 macro and apropriate RESUME macro are needed !!! ###

#################################################################################################################
################################# CHANGE HERE MACRO CONFIGURABLES################################################
#################################################################################################################

[gcode_macro _SENSOR_t1_VARIABLES]         # change here macro configurables, enable disable functions!*************************
variable_t1_load_temp             :235    # temperature to heat up hotend for filament loading, default is 235
variable_t1_unload_temp           :185    # temperature to heat up hotend for filament un-loading, default is 185
variable_t1_load_min_temp         :190    # minimum hotend set temperature allowed in filament load macro, default is 190
variable_t1_purge_length          :80    # filament extrude amount during load sequenc, hotend purge from old filament, default is 200
variable_t1_purge_speed           :450    # filament extrude speed in mm/min adjust this value lower if flow is too high and extruder1 skips during loading, default is 300
variable_t1_unload_distance       :65     # filament retract distance for unload procedure. this length shall be long enough to extract the filament above the drive gears
variable_t1_disable_autoload      :False  # disable filament autoload feature by setting this variable True
variable_t1_disable_runnout       :False  # disable runnout by setting this variable True
variable_t1_autounload            :False  # disable auto unload filament by setting this variable to True
variable_t1_enable_beep           :False   # uses M300 sound feature, set it True to enable
gcode:

#///////////////////////////filament sensor button macros/////////////////////////////////////////////////
[gcode_button filament_t1_sense]
pin: !PC5 # remove the negation "!" for sensor v1 - use just PA9 as example
press_gcode: # sensor released  -runnout detected!
  ACTIVATE_EXTRUDER EXTRUDER=extruder1
  runnout_init_t1
release_gcode: #gcode macro for filament auto-load, sensor pressed
  ACTIVATE_EXTRUDER EXTRUDER=extruder1
  startload_t1
#********************************************************************************************************

#////////////////////////////////////////Filament Unload macros/////////////////////////////////////////////////
[gcode_button filament_unload_t1]
pin: !PB0 # remove the negation "!" for sensor v1 - use just PA9 as example
release_gcode:  # filament unload procedure
  ACTIVATE_EXTRUDER EXTRUDER=extruder1
  startunload_t1
press_gcode: # do not add any macro call here

#################################################################################################################################
####################################### DO NOT CHANGE ANYTHING BELOW THIS LINE!!! ###############################################
#################################################################################################################################
####################################### UNLESS YOU KNOW WHAT YOU ARE DOING OR YOU ARE BORED AND NEED TO DO SOMETHING OR YOU ARE ALONE AND NEED SOMETHING TO MESS UP YOUR LIFE OR YOU CAN DO IT BETTER THAN ME OR YOU ARE A REAL SMARTASS OR JUST BECAUSE YOU CAN OR YOU RUN OUT OF BEAR OR HAS NOTHING BETTER TO DO OR ANY UNREASONABLE REASON
#################################################################################################################################

[respond]
default_type: echo

[force_move]
enable_force_move: True

[gcode_macro runnout_init_t1]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}  
  {% if (printer.print_stats.state == "printing") %}      
    {% if(sensor.t1_disable_runnout|lower == 'false') %}
    filament_change_state11
    {% else %}
    M118 Filament T1 runnout is disabled in the sensor config file!   
    {% endif %}     
  {% endif %} 
  UPDATE_DELAYED_GCODE ID=clear_loadt1busy DURATION=2
  UPDATE_DELAYED_GCODE ID=clear_unloadt1busy DURATION=2    
  SET_GCODE_VARIABLE MACRO=filament_unload_t1 VARIABLE=filamentt1present VALUE=0

[gcode_macro filament_change_state11]
variable_changebusy: 0
variable_temp_target: 0
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}  
  {% if changebusy == 0 %}
    M600
    SET_GCODE_VARIABLE MACRO=filament_change_state11 VARIABLE=changebusy VALUE=1       
    M118 Filament T1 runnout detected!       
    filament_change_state21     # comment this line if you do not want to automatically unload filament in case there is a runnout detected.
  {% else %}
  {% endif %}

[gcode_macro filament_change_state21]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}  
  SET_GCODE_VARIABLE MACRO=filament_load_t1 VARIABLE=loadt1busy VALUE=1      
  {% if (sensor.t1_enable_beep|lower == 'true') %} 
    M300 # beep sound
  {% endif %}
  M118 Unloading T1 filament...   
  M83
  G92 E0   
  # {% if printer[printer.toolhead.extruder1].temperature < 185 %} # hardcoded threshold
  {% if (printer.extruder1.can_extrude|lower != 'true')%} # checking for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder1 config (to about 185)
      M118 Hotend T1 heating!        
      SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET={sensor.t1_unload_temp} # restore user temp if it was set before loading
      TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={sensor.t1_unload_temp} #wait for reaching filament unload temp
      {% endif %}     
  {% if(printer.extruder1.target == 0) %} # checing for set temperature if is zero than set to 200 / hotend hot but cooling due to set target temp 0
      SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET={sensor.t1_unload_temp} # restore user temp if it was set before loading
      TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={sensor.t1_unload_temp} #wait for reaching filament unload temp
  {% endif %} 
  G0 E-5 F3600 	#extract filament to cold end
  G4 P2000 # wait for two seconds
  G0 E5 F3600 # push the filament back 
  G0 E-5 F3600 	#extract filament to cold end
  G0 E-{sensor.t1_unload_distance} F300	# continue extraction slow allow filament to be cooled enough before reaches the gears  
  M400   
  M118 Load new T1 filament! Wait until is loaded, then resume printing.  
  SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET=0 # swicth off heater
  UPDATE_DELAYED_GCODE ID=clear_loadt1busy DURATION=2.5 # timing must be set to clear delay plus 0.5s. is due to wait to remove filament before starting load even in case there is a blob at the tip of the extracted filament which woudl trigger the sensor twice

#############################################END filament auto load macro section END***********************************************************

[gcode_macro startload_t1]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}
  {% if (printer.print_stats.state != "printing") %}
    {% if(sensor.t1_disable_autoload|lower == 'false') %}
      filament_load_t1
    {% else %}
    M118 Filament T1 auto-load is disabled in the sensor config file!   
    {% endif %} 
  {% else %}    
    M118 Printing! Can't load T1 filament right now!    
  {% endif %} 
  SET_GCODE_VARIABLE MACRO=filament_unload_t1 VARIABLE=filamentt1present VALUE=1
  UPDATE_DELAYED_GCODE ID=clear_changebusy DURATION=2  

[gcode_macro filament_load_t1]
variable_loadt1busy: 0
variable_USER_TEMP: 0
variable_LOAD_TEMP: 0
gcode:
    ACTIVATE_EXTRUDER EXTRUDER=extruder1    
    {% set sensor = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}
    {% if loadt1busy == 0 %} # requires [virtual_sdcard] 
      SET_GCODE_VARIABLE MACRO=filament_load_t1 VARIABLE=loadt1busy VALUE=1
      SET_GCODE_VARIABLE MACRO=filament_unload_t1 VARIABLE=unloadt1busy VALUE=1    
      {% set USER_TEMP = printer.extruder1.target %} # save user set temperature before loading
      {% set LOAD_TEMP = 0 %} 
      #M118 USER TEMP {USER_TEMP}      # echo back for debug only      
        {% if (printer.extruder1.can_extrude|lower != 'true') or (printer.extruder1.target < sensor.t1_load_min_temp) %} # checking for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder1 config (to about 185)                        
          SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET={sensor.t1_load_temp} # set user defined load temperature
          {% set LOAD_TEMP = sensor.t1_load_temp %} # save user set temperature before loading           
         M118 Hotend T1 heating! 
      {% endif %}     
    {% if (sensor.t1_enable_beep|lower == 'true') %} 
      M300 # beep sound
    {% endif %}
    M118 Filament T1 loading!  
    M82           #set extruder1 to absolute mode
    G92 E0
    G4 P1500        # wait for 1.5 seconds
    FORCE_MOVE STEPPER=extruder1 DISTANCE=15 VELOCITY=10 ACCEL=1000  # load filament inside the gears force move needs to be enabled    
    TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={LOAD_TEMP} # wait for reaching set temperature    
    TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={USER_TEMP} # wait for reaching set temperature    
    G1 E{sensor.t1_purge_length} F{sensor.t1_purge_speed} # extrude preconfigured purge length
    M400 # wait to complete nozzle purge
    SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET={USER_TEMP} # restore user temp if it was set before loading
    M118 Filament T1 load complete!    
    UPDATE_DELAYED_GCODE ID=clear_unloadt1busy DURATION=2   
    {% else %}
      M118 Filament T1 already loaded!    
    {% endif %}  
#############################################END filament auto load macro section END***********************************************************

#############################################filament auto unload macro section*****************************************************************
[gcode_macro startunload_t1]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}
  {% if (printer.print_stats.state != "printing") %}
    {% if(sensor.t1_autounload|lower == 'false') %}
      filament_unload_t1
    {% else %}
      M118 Filament T1 auto-unload is disabled in the sensor config file!   
    {% endif %} 
  {% else %}   
     M118 Printing! Can't unload T1 filament right now!
  {% endif %}

[gcode_macro filament_unload_t1] 
variable_unloadt1busy: 0
variable_filamentt1present: 0
gcode:
    ACTIVATE_EXTRUDER EXTRUDER=extruder1 
    {% set sensor = printer['gcode_macro _SENSOR_t1_VARIABLES'] %}
    {% if unloadt1busy == 0 %} # requires [virtual_sdcard]  
      SET_GCODE_VARIABLE MACRO=filament_unload_t1 VARIABLE=unloadt1busy VALUE=1
      SET_GCODE_VARIABLE MACRO=filament_load_t1 VARIABLE=loadt1busy VALUE=1
      {% if (sensor.t1_enable_beep|lower == 'true') %} 
        M300 # beep sound
      {% endif %}
      M118 Filament T1 unloading!    
      M83
      G92 E0 
      # {% if (printer.extruder1.can_extrude|lower != 'true') or (printer.extruder1.target == 0)%} # checing for minimum extrusion temperature
      {% if (printer.extruder1.can_extrude|lower != 'true')%} # checing for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder1 config (to about 185)
        M118 Hotend heating!          
        SET_HEATER_TEMPERATURE HEATER=extruder1 TARGET={sensor.t1_unload_temp} # restore user temp if it was set before loading
        TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={sensor.t1_unload_temp} # wait for reaching configured unload temperature
      {% endif %}
      {% if(printer.extruder1.target == 0) %} # checing for set temperature if is zero than set to 185 / hotend hot but cooling due to set target temp 0
        TEMPERATURE_WAIT SENSOR=extruder1 MINIMUM={sensor.t1_unload_temp} # wait for reaching configured unload temperature
      {% endif %}
      G0 E10 F500 # extruder1 20mm of filament before extracting 
      G0 E-5 F3600 	#extract filament to cold end
      G4 P2000 # wait for two seconds
      G0 E6 F3600 # push the filament back 
      G0 E-10 F3600 	#extract filament to cold end
      G0 E-{sensor.t1_unload_distance} F300	# continue extraction slow allow filament to be cooled enough before reaches the gears  
      M104 S0 T1 
      M400 # wait to complete unload
      M118 Filament T1 unload complete!      
      SET_GCODE_VARIABLE MACRO=filament_load_t1 VARIABLE=loadt1busy VALUE=0     
    {% else %}      
      M118 Nothing to unload from T1!
    {% endif %}

#############################################END filament auto unload macro section END***********************************************************

[delayed_gcode clear_unloadt1busy]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_unload_t1 VARIABLE=unloadt1busy VALUE=0
  #M118 Clear Unload busy! 

[delayed_gcode clear_changebusy]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_change_state11 VARIABLE=changebusy VALUE=0
  #M118 Clear Load busy!  

[delayed_gcode set_loadt1busy]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_load_t1 VARIABLE=loadt1busy VALUE=1
  #M118 Set Load busy! 

[delayed_gcode clear_loadt1busy]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_load_t1 VARIABLE=loadt1busy VALUE=0
  #M118 Clear Load busy!


################################################################################
### HEATED BED
################################################################################

################################
# print bed heater
##################################

[heater_bed]
heater_pin: PE1                       #BTT M8P V1.1
sensor_type: Generic 3950
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA0                       #BTT M8P V1.1 
control: pid
pid_kp: 58.437
pid_ki: 2.347
pid_kd: 363.769
min_temp: 0
max_temp: 125

[verify_heater heater_bed]
check_gain_time: 90
hysteresis: 5


################################################################################
### CHAMBER FAN
################################################################################

##################################
# Chamber Fab
##################################

[temperature_fan chamber_fan]
pin: PE4                                      #BTT M8P V1.1
max_power: 1.0
shutdown_speed: 0.0
kick_start_time: 5.0
cycle_time:0.01
off_below:0.1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA3                               #BTT M8P V1.1
min_temp: 0
target_temp:30
max_temp: 65
control: watermark
gcode_id: C


################################################################################
### IDEX FUNCTIONALITY (Tool Change, Park, Copy, Mirror)
################################################################################

############################################################
# IDEX Setup
############################################################

##################################
# Park T0
##################################

[gcode_macro PARK_extruder]
gcode:
    {% set marathon = printer['gcode_macro _MARATHON_VARIABLES'] %} 
	SET_DUAL_CARRIAGE CARRIAGE=0
   	{% if not "x" in printer.toolhead.homed_axes %}
	    G28 X
	{% endif %}

    SAVE_GCODE_STATE NAME=park0
    G90
	SET_GCODE_OFFSET X=0
    G1 X0 F{marathon.sp_tch}
    RESTORE_GCODE_STATE NAME=park0

##################################
# Park T1
##################################

[gcode_macro PARK_extruder1]
gcode:
    {% set marathon = printer['gcode_macro _MARATHON_VARIABLES'] %} 
	SET_DUAL_CARRIAGE CARRIAGE=1
    {% if not "x" in printer.toolhead.homed_axes %}
	    G28 X
	{% endif %}

    SAVE_GCODE_STATE NAME=park1
    G90
	SET_GCODE_OFFSET X=0
    G1 X433 F{marathon.sp_tch}
    RESTORE_GCODE_STATE NAME=park1

##################################
# PActivate T0
##################################

[gcode_macro T0]
gcode:
    {% set marathon = printer['gcode_macro _MARATHON_VARIABLES'] %} 
    G1 F{marathon.sp_tch}
	{% if printer.toolhead.extruder != "extruder" %}
	    PARK_{printer.toolhead.extruder}
	{% endif %}
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SET_DUAL_CARRIAGE CARRIAGE=0
    SET_INPUT_SHAPER SHAPER_TYPE_X=mzv SHAPER_FREQ_X=51.6 SHAPER_TYPE_Y=mzv SHAPER_FREQ_Y=41.0
    SET_GCODE_OFFSET X=0 Y=0 Z=0

##################################
# Activate T1
##################################

[gcode_macro T1]
gcode:
 {% set marathon = printer['gcode_macro _MARATHON_VARIABLES'] %} 
 {% set svv = printer.save_variables.variables %}
 G1 F{marathon.sp_tch}
 {% if printer.toolhead.extruder != "extruder1" %}
    PARK_{printer.toolhead.extruder}
  {% endif %}
    ACTIVATE_EXTRUDER EXTRUDER=extruder1
    SET_DUAL_CARRIAGE CARRIAGE=1
    SET_INPUT_SHAPER SHAPER_TYPE_X=mzv SHAPER_FREQ_X=51.8 SHAPER_TYPE_Y=mzv SHAPER_FREQ_Y=41.8
    SET_GCODE_OFFSET  X_ADJUST={ -svv.xoffset } Y_ADJUST={ -svv.yoffset }
    SET_GCODE_OFFSET  Z={ svv.zoffset }

##################################
# Set XY Offsets T1
##################################

[gcode_macro XY_Offset_T1]
gcode:
    {% set svv = printer.save_variables.variables %}

    {% set oldX = svv.xoffset|float %}
    {% set oldY = svv.yoffset|float %}

     {% if params.X is defined %}
        SAVE_VARIABLE VARIABLE=xoffset VALUE={ params.X|float }
    {% endif %}

    {% if params.Y is defined %}
        SAVE_VARIABLE VARIABLE=yoffset VALUE={ params.Y|float }
    {% endif %}
 
    {% if params.X_ADJUST is defined %}
        {% set newX = params.X_ADJUST|float + oldX %}
        SAVE_VARIABLE VARIABLE=xoffset VALUE={ newX|float }
    {% endif %}

    {% if params.Y_ADJUST is defined %}
        {% set newY = params.Y_ADJUST|float + oldY %}
        SAVE_VARIABLE VARIABLE=yoffset VALUE={ newY|float }
    {% endif %}

    M118 XY Offsets for T1 were saved
    M118 Happy printing ! :)
   
####################################################################
# Copy Mode
####################################################################

[gcode_macro ACTIVATE_COPY_MODE]
gcode:
    {% set marathon = printer['gcode_macro _MARATHON_VARIABLES'] %} 
    SET_DUAL_CARRIAGE CARRIAGE=0 MODE=PRIMARY
    G1 X1
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SET_DUAL_CARRIAGE CARRIAGE=1 MODE=PRIMARY
    G1 X{marathon.x_cop}
    SET_DUAL_CARRIAGE CARRIAGE=1 MODE=COPY
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder
    SET_INPUT_SHAPER SHAPER_TYPE_X=mzv SHAPER_FREQ_X=47.2 SHAPER_TYPE_Y=mzv SHAPER_FREQ_Y=41.2

####################################################################
# Mirror Mode
####################################################################

[gcode_macro ACTIVATE_MIRROR_MODE]
gcode:
    {% set marathon = printer['gcode_macro _MARATHON_VARIABLES'] %} 
    SET_DUAL_CARRIAGE CARRIAGE=0 MODE=PRIMARY
    G1 X1
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SET_DUAL_CARRIAGE CARRIAGE=1 MODE=PRIMARY
    G1 X{marathon.x_mir}
    SET_DUAL_CARRIAGE CARRIAGE=1 MODE=MIRROR
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder
    SET_INPUT_SHAPER SHAPER_TYPE_X=mzv SHAPER_FREQ_X=58.6 SHAPER_TYPE_Y=mzv SHAPER_FREQ_Y=41.4


################################################################################
### PRINT MACROS (Start, End, Pause, Resume, etc.)
################################################################################

####################################
# Mesh Bed Leveling
####################################

[gcode_macro mesh_leveling]
gcode:
    {% set marathon = printer['gcode_macro _MARATHON_VARIABLES'] %} 
      G28 # Home All
      T0
      M190 S{marathon.mesh_tmp}
      Z_TILT_ADJUST
      BED_MESH_CALIBRATE PROFILE=mesh1 METHOD=automatic # Start probing

[gcode_macro save_mesh]
gcode:
      BED_MESH_PROFILE SAVE=mesh1
      SAVE_CONFIG

##########################################
#POWER ON/OFF
##########################################

[output_pin Power]
pin: PC3
value: 1

[gcode_macro Power_ON]
gcode:
  SET_PIN PIN=Power VALUE=1

[gcode_macro Power_OFF]
gcode:
  SET_PIN PIN=Power VALUE=0

##########################################
#Case Light
##########################################


[output_pin caselight]
pin: PB6
value: 1
shutdown_value: 0

[gcode_macro CASELIGHT_ON]
description: Helper: Light on
gcode: SET_PIN PIN=caselight VALUE=1
    
[gcode_macro CASELIGHT_OFF]
description: Helper: Light off
gcode:SET_PIN PIN=caselight VALUE=0

##########################################
#Chamber Fan
##########################################

[gcode_macro M141]
gcode:
    SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber_fan" target={params.S}

#######################################
# START_PRINT
#######################################

[gcode_macro START_PRINT]
gcode: 
      M118 Start printing...
      G28                                           # Home the printer 
      G92 E0                                        # Reset extruder 
      Z_TILT_ADJUST
      BED_MESH_PROFILE LOAD=mesh1
     # Move to wait position 
      G28 X
      G90
      G1 Y305 Z50


#######################################
# END_PRINT
#######################################

[gcode_macro END_PRINT]
gcode:
    SET_SKEW CLEAR=1
    M104 T0 S0                                #extruder heater off
    M104 T1 S0                                #extruder heater off
    M140 S0                                   #heated bed heater off 
    M106 S0                                   #FANs OFF
    G91                                       #relative positioning
    G1 E-3 F300                               #retract the filament a bit before lifting the nozzle, to release some of the pressure
    M117 RETRACT
    G1 Z+0.5 E-3 X-10 Y-10 F9000              #move Z up a bit and retract filament even more
    G1 E-10
    M117 WIPE OUT
    G90
    {% set axismax = printer.toolhead.axis_maximum %}
	{% set pos     = printer.toolhead.position     %}
	
	#Move toolhead away from finished print
	{% if pos.z <= ( axismax.z - 120 ) %}
		G1 Z{ pos.z + 100 }
        G28 X;
        G1 Y{axismax.y - 20}
    {% else %}
		G1  Z{ axismax.z }
	    G28 X;
        G1 Y{axismax.y - 20}  
    {% endif %}
        M117 PRESENT ITEM
     BED_MESH_CLEAR
     G4 P120000                                # wait 2min
    SET_DUAL_CARRIAGE CARRIAGE=0               #activate T0
    G1 X11 F5000
    SET_DUAL_CARRIAGE CARRIAGE=1               #activate T1
    G1 X422 F5000
    SET_DUAL_CARRIAGE CARRIAGE=0 MODE=PRIMARY
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1
    M84                                        # Disable steppers
    # Print message on LCD
    M118 MOTORS OFF

#######################################
# END_PRINT Power off
#######################################

[gcode_macro END_PRINT_OFF]
gcode:
    M118 Cooling down and then SHUT DOWN
    G4 P180000                                 # wait 3min
    Power_off                                  # power off



########################################
# Part cooling Fan
########################################

[gcode_macro M106]
gcode:
    {% if params.S is defined %}
        {% if params.S|int == 255 %}
            SET_FAN_SPEED FAN=Tool_0_partfan Speed=1.0
            SET_FAN_SPEED FAN=Tool_1_partfan Speed=1.0
        {% elif params.S|int == 0 %}
            SET_FAN_SPEED FAN=Tool_0_partfan Speed=0.0
            SET_FAN_SPEED FAN=Tool_1_partfan Speed=0.0
        {% else %}
            {% set realspeed = params.S|int / 255 %}
            SET_FAN_SPEED FAN=Tool_0_partfan Speed={realspeed}
            SET_FAN_SPEED FAN=Tool_1_partfan Speed={realspeed}
        {% endif %}
    {% else %}
        SET_FAN_SPEED FAN=Tool_0_partfan Speed=1.0
        SET_FAN_SPEED FAN=Tool_1_partfan Speed=1.0
    {% endif %}

########################################
# Brush_T0 
########################################
[gcode_macro brush_T0]
gcode:
     M118 Brushing T0
     G90
     T0
     G1 Z5
     G1 X135 Y305 F9000
     G1 Z0
     G1 X95 Y305 F12000
     G1 X98 Y307 F12000
     G1 X101 Y302 F12000
     G1 X104 Y307 F12000
     G1 X107 Y302 F12000
     G1 X110 Y307 F12000
     G1 X113 Y302 F12000
     G1 X116 Y307 F12000
     G1 X118 Y302 F12000
     G1 X120 Y307 F12000
     G1 X122 Y302 F12000
     G1 X124 Y307 F12000
     G1 X127 Y302 F12000
     G1 X130 Y307 F12000
     G1 X133 Y302 F12000 
     G1 X135 Y305 F12000
     G1 X95 Y305 F12000
     G1 Z5
     
########################################
# Brush_T1
########################################
[gcode_macro brush_T1]
gcode:
 M118 Brushing T1
     G90
     T1
     G1 Z5
     G1 X334 Y305 F9000
     G1 Z0
     G1 X294 Y305 F12000
     G1 X297 Y307 F12000
     G1 X300 Y302 F12000
     G1 X303 Y307 F12000
     G1 X306 Y302 F12000
     G1 X309 Y307 F12000
     G1 X312 Y302 F12000
     G1 X315 Y307 F12000
     G1 X317 Y302 F12000
     G1 X319 Y307 F12000
     G1 X321 Y302 F12000
     G1 X323 Y307 F12000
     G1 X326 Y302 F12000
     G1 X329 Y307 F12000
     G1 X332 Y302 F12000 
     G1 X334 Y305 F12000
     G1 X294 Y305 F12000
     G1 Z5

######################################################################
# Filament Change M600
######################################################################
# After filament has # been changed, the print can be resumed from its previous position
# with the "RESUME" gcode.

[gcode_macro M600]
gcode:
    {% set z = params.Z|default(10)|int %}                                                   # z hop amount

    {% if printer['pause_resume'].is_paused|int == 0 %}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}                              # set z hop variable for reference in resume macro
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}    # set hotend temp variable for reference in resume macro
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=e1temp VALUE={printer['extruder1'].target}
       
        SAVE_GCODE_STATE NAME=PAUSE                                                          # save current print position for resume
        BASE_PAUSE                                                                           # pause print
        {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}       # check that zhop doesn't exceed z max
            G91                                                                              # relative positioning
            G1 Z{z} F900                                                                     # raise Z up by z hop amount
        {% else %}
            { action_respond_info("Pause zhop exceeds maximum Z height.") }                  # if z max is exceeded, show message and set zhop value for resume to 0
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
        {% endif %}
        G90                                                                                  # absolute positioning    
        G1  X117.5 Y{printer.toolhead.axis_minimum.y+5} F6000                                # move gantry to the front
        SAVE_GCODE_STATE NAME=PAUSEPARK                                                      # save parked position in case toolhead is moved during the pause (otherwise the return zhop can error) 
        SET_IDLE_TIMEOUT TIMEOUT=43200                                                       # set timeout to 12 hours
    {% endif %}
        M118 Print pause for Filament change
        
######################################################################
# Pause
######################################################################

[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    M118 Pause print...
    # Parameters
    {% set z = params.Z|default(10)|int %}                                                             # z hop amount

    {% if printer['pause_resume'].is_paused|int == 0 %}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}                                        # set z hop variable for reference in resume macro
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}              # set hotend temp variable for reference in resume macro
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=e1temp VALUE={printer['extruder1'].target}
        SAVE_GCODE_STATE NAME=PAUSE                                                                    # save current print position for resume
        BASE_PAUSE                                                                                     # pause print
        {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}                 # check that zhop doesn't exceed z max
            G91                                                                                        # relative positioning
            G1 Z{z} F900                                                                               # raise Z up by z hop amount
        {% else %}
            { action_respond_info("Pause zhop exceeds maximum Z height.") }                            # if z max is exceeded, show message and set zhop value for resume to 0
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
        {% endif %}
        G90                                                                                            # absolute positioning    
        G1 X117.5 Y{printer.toolhead.axis_maximum.y-3} F6000                                           # move gantry to the back
        SAVE_GCODE_STATE NAME=PAUSEPARK                                                                # save parked position in case toolhead is moved during the pause (otherwise the return zhop can error) 
        	{% if printer.toolhead.extruder != "extruder1" %}
	    M104 T0 S150
    {% else %}
        M104 T1 S150
	{% endif %}
        #M104 S0                                                                                       # turn off hotend
        SET_IDLE_TIMEOUT TIMEOUT=3600                                                                  # set timeout to 12 hours
    {% endif %}

######################################################################
# Resume
######################################################################    

[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
variable_e1temp: 0

gcode:
      M118 Resuming printing...
        # Parameters
    {% set e = params.E|default(2.5)|int %}                                                                                # hotend prime amount (in mm)

    {% if printer['pause_resume'].is_paused|int == 1 %} 
          SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}                                      # set timeout back to configured value
        {% if etemp > 0 %}
            M109 T0 S{etemp|int}                                                                                           # wait for hotend to heat back up
        {% endif %}
        {% if e1temp > 0 %}
            M109 T1 S{e1temp|int} 
        {% endif %}
        RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=100                                                           # go back to parked position in case toolhead was moved during pause (otherwise the return zhop can error)
        G91                                                                                                                # relative positioning
        M83                                                                                                                # relative extruder positioning
        {% if printer[printer.toolhead.extruder].temperature >= printer.configfile.settings.extruder.min_extrude_temp %}
            G1 Z{zhop * -1} E{e} F900                                                                                      # prime nozzle by E, lower Z back down
        {% else %}
            G1 Z{zhop * -1} F900                                                                                           # lower Z back down without priming (just in case we are testing the macro with cold hotend)
        {% endif %} 
        RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=60                                                                # restore position
        BASE_RESUME                                                                                                        # resume print
    {% endif %}

########################################################################################
# Cancel
########################################################################################

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    M118 CANCEL PRINT !
    SET_SKEW CLEAR=1
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}                                            # set timeout back to configured value
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    M104 T0 S0                                                                                                             #extruder heater off
    M104 T1 S0                                                                                                             #extruder1 heater off
    M140 S0                                                                                                                #heated bed heater off 
    M106 S0                                                                                                                #FANs OFF
    G91                                                                                                                    #relative positioning
    G1 E-3 F300                                                                                                            #retract the filament a bit before lifting the nozzle, to release some of the pressure
    M117 RETRACT
    G1 Z+0.5 E-3 X-10 Y-10 F9000                                                                                           #move Z up a bit and retract filament even more
    G1 E-10
    M117 WIPE OUT
    G90
    {% set axismax = printer.toolhead.axis_maximum %}
	{% set pos     = printer.toolhead.position     %}
	
	#Move toolhead away from finished print
	{% if pos.z <= ( axismax.z - 120 ) %}
		G1 Z{ pos.z + 100 }
        G28 X;
        G1 Y{axismax.y - 20}
    {% else %}
		G1  Z{ axismax.z }
	    G28 X;
        G1 Y{axismax.y - 20}  
    {% endif %}
    PARK_{printer.toolhead.extruder}
    SET_DUAL_CARRIAGE CARRIAGE=0 MODE=PRIMARY
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1
    BED_MESH_CLEAR
    BASE_CANCEL_PRINT

#####################################################################
# Calibrate Probe Offset
####################################################################

[gcode_macro Calibrate_Probe_Offset]
gcode:
      PROBE_CALIBRATE

#####################################################################
# Apply Prope Offset
#####################################################################

[gcode_macro Apply_Probe_Offset]
gcode:
    SAVE_CONFIG

#####################################################################
# Print heads Z-leveling
#####################################################################
[gcode_macro Print_heads_Z_leveling]
gcode:
     G28
     M118 Cleaning the nozzles 
     brush_T1
     brush_T0
     Z_TILT_ADJUST
     M118 Positioning the heads in the middle of the bed
     ACTIVATE_MIRROR_MODE
     G90
     G1 X175 Y149
     M400
     SET_DUAL_CARRIAGE CARRIAGE=0 MODE=PRIMARY
     SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder1                                                                                     
     
#####################################################################
# ‘Marlin’ style M808 compatibility macro for SDCard looping
#####################################################################

[gcode_macro M808]
gcode:
      {% if params.K is not defined and params.L is defined %}SDCARD_LOOP_BEGIN COUNT={params.L|int}
      {% endif %}
      {% if params.K is not defined and params.L is not defined %}SDCARD_LOOP_END
      {% endif %}
      {% if params.K is defined and params.L is not defined %}SDCARD_LOOP_DESIST
      {% endif %}

#####################################################################
# TFT Controller - Filament unload
#####################################################################

[gcode_macro UNLOAD_FILAMENT]
gcode:
      {% set marathon = printer['gcode_macro _MARATHON_VARIABLES'] %} 
      M118 Unloading filament...
      M83
      G92 E0 
      M118 Hotend heating!
      M104 S{marathon.tmp_uld}                                                                                                 #set temperature and wait      
      G0 E-5 F3600 	                                                                                               #extract filament to cold end
      G4 P2000                                                                                                     #wait for two seconds
      G0 E4.5 F3600                                                                                                #push the filament back 
      G0 E-5 F3600 	                                                                                               #extract filament to cold end
      G0 E{marathon.fil_uld} F300	                                                                                               #continue extraction slow allow filament to be cooled enough before reaches the gears  
      M400
      M118 Filament unload complete!
      M117 Filament unload complete!
      #M104 S0                                                                                                      #turn off the hotend 

#####################################################################
# TFT Controller - Filament load
#####################################################################

[gcode_macro LOAD_FILAMENT]
gcode:
      {% set marathon = printer['gcode_macro _MARATHON_VARIABLES'] %} 
      M118 Loading filament...
      M83
      G92 E0 
      M118 Hotend heating!
      M104 S{marathon.tmp_ld}                                                                                                   #set temperature and wait      
      G0 E{marathon.fil_ld} F400	                                                                                               #Load Filament 
      M400
      M118 Filament load complete!
      M117 Filament load complete!
      #M104 S0                                                                                                      #turn off the hotend
      G0 E-5 F3600 	                                                                                               #extract filament to cold end
